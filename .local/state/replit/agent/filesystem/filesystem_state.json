{"file_contents":{"client/src/components/ObjectUploader.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport type { ReactNode } from \"react\";\nimport Uppy from \"@uppy/core\";\nimport { DashboardModal } from \"@uppy/react\";\nimport XHRUpload from \"@uppy/xhr-upload\";\nimport Webcam from \"@uppy/webcam\";\nimport type { UploadResult } from \"@uppy/core\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface ObjectUploaderProps {\n  maxNumberOfFiles?: number;\n  maxFileSize?: number;\n  onComplete?: (\n    result: UploadResult<Record<string, unknown>, Record<string, unknown>>,\n    uppy: Uppy\n  ) => void;\n  buttonClassName?: string;\n  buttonVariant?: \"default\" | \"outline\" | \"ghost\" | \"secondary\";\n  children: ReactNode;\n}\n\nexport function ObjectUploader({\n  maxNumberOfFiles = 1,\n  maxFileSize = 10485760, // 10MB default\n  onComplete,\n  buttonClassName,\n  buttonVariant = \"default\",\n  children,\n}: ObjectUploaderProps) {\n  const [showModal, setShowModal] = useState(false);\n  const [uppy] = useState(() =>\n    new Uppy({\n      restrictions: {\n        maxNumberOfFiles,\n        maxFileSize,\n        allowedFileTypes: ['image/*'],\n      },\n      autoProceed: false,\n    })\n      .use(Webcam, {\n        modes: ['picture'],\n        mirror: true,\n        // @ts-ignore - facingMode is a valid webcam option but missing from types\n        facingMode: 'environment',\n      })\n      .use(XHRUpload, {\n        endpoint: '/api/upload',\n        formData: true,\n        fieldName: 'file',\n        getResponseData: (xhr: XMLHttpRequest) => {\n          const response = JSON.parse(xhr.responseText);\n          return { url: response.url };\n        },\n      })\n      .on(\"complete\", (result: any) => {\n        onComplete?.(result, uppy);\n        setShowModal(false);\n      })\n  );\n\n  useEffect(() => {\n    return () => {\n      try {\n        // @ts-ignore - close() exists but may not be in all type definitions\n        uppy.close({ reason: 'unmount' });\n      } catch (e) {\n        console.warn('Failed to close Uppy instance:', e);\n      }\n    };\n  }, [uppy]);\n\n  return (\n    <div>\n      <Button \n        onClick={() => setShowModal(true)} \n        className={buttonClassName}\n        variant={buttonVariant}\n        type=\"button\"\n      >\n        {children}\n      </Button>\n\n      <DashboardModal\n        uppy={uppy}\n        open={showModal}\n        onRequestClose={() => setShowModal(false)}\n        proudlyDisplayPoweredByUppy={false}\n        note=\"Scatta una foto o seleziona dalla libreria\"\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":2449,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"client/src/components/DailyReportForm.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from \"@/components/ui/alert-dialog\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Plus, Trash2, Send, Camera, X } from \"lucide-react\";\nimport { Client, WorkOrder } from \"@shared/schema\";\nimport StatusBadge from \"./StatusBadge\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { ObjectUploader } from \"./ObjectUploader\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface Operation {\n  id: string;\n  clientId: string;\n  workOrderId: string;\n  workTypes: string[];\n  materials: string[];\n  hours: number; // Ore lavorate per questa operazione (es. 2.5)\n  notes: string;\n  photos: string[]; // Photo paths from object storage\n}\n\ninterface DailyReportFormProps {\n  employeeName: string;\n  date: string;\n  onSubmit: (operations: Operation[]) => void;\n  initialOperations?: Operation[]; // For editing existing reports\n  isEditing?: boolean; // To show different UI for editing\n  isSubmitting?: boolean; // To disable submit button during submission\n}\n\n// Load data from backend\nconst useClients = () => {\n  return useQuery<Client[]>({\n    queryKey: ['/api/clients'],\n    select: (data) => data || []\n  });\n};\n\nconst useAllActiveWorkOrders = () => {\n  return useQuery<WorkOrder[]>({\n    queryKey: ['/api/work-orders/active'],\n    select: (data) => data || []\n  });\n};\n\n// Query per recuperare le lavorazioni globali\nconst useWorkTypes = () => {\n  return useQuery<any[]>({\n    queryKey: ['/api/work-types'],\n    select: (data) => data || []\n  });\n};\n\n// Query per recuperare i materiali globali\nconst useMaterials = () => {\n  return useQuery<any[]>({\n    queryKey: ['/api/materials'],\n    select: (data) => data || []\n  });\n};\n\n// OperationCard component to handle each operation independently\ninterface OperationCardProps {\n  operation: Operation;\n  index: number;\n  operationsLength: number;\n  clients: Client[];\n  clientsLoading: boolean;\n  allWorkOrders: WorkOrder[];\n  workOrdersLoading: boolean;\n  allWorkTypes: any[];\n  allMaterials: any[];\n  onRemove: (id: string) => void;\n  setOperations: React.Dispatch<React.SetStateAction<Operation[]>>;\n  onToggleWorkType: (operationId: string, workType: string) => void;\n  onToggleMaterial: (operationId: string, material: string) => void;\n}\n\nfunction OperationCard({\n  operation,\n  index,\n  operationsLength,\n  clients,\n  clientsLoading,\n  allWorkOrders,\n  workOrdersLoading,\n  allWorkTypes,\n  allMaterials,\n  onRemove,\n  setOperations,\n  onToggleWorkType,\n  onToggleMaterial\n}: OperationCardProps) {\n  const { toast } = useToast();\n  \n  // Filter work orders for the selected client\n  const workOrders = allWorkOrders.filter(wo => wo.clientId === operation.clientId);\n  \n  const selectedWorkOrder = workOrders.find(wo => wo.id === operation.workOrderId);\n  const availableWorkTypes = selectedWorkOrder?.availableWorkTypes || [];\n  const availableMaterials = selectedWorkOrder?.availableMaterials || [];\n\n  // Helper function to get work type name by ID\n  const getWorkTypeName = (id: string) => {\n    const workType = allWorkTypes.find(wt => wt.id === id);\n    return workType?.name || id;\n  };\n\n  // Helper function to get material name by ID\n  const getMaterialName = (id: string) => {\n    const material = allMaterials.find(m => m.id === id);\n    return material?.name || id;\n  };\n  \n  return (\n    <Card className={`p-4 ${index % 2 === 0 ? 'bg-blue-50 dark:bg-blue-950/20' : 'bg-amber-50 dark:bg-amber-950/20'}`}>\n      <div className=\"flex items-start justify-between mb-4\">\n        <h4 className=\"font-medium text-base\">Operazione {index + 1}</h4>\n        {operationsLength > 1 && (\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={() => onRemove(operation.id)}\n            data-testid={`button-remove-operation-${operation.id}`}\n          >\n            <Trash2 className=\"h-4 w-4\" />\n          </Button>\n        )}\n      </div>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n        <div className=\"space-y-2\">\n          <Label className=\"font-semibold text-foreground\">Cliente</Label>\n          <Select\n            value={operation.clientId}\n            onValueChange={(value) => {\n              setOperations(prevOps => prevOps.map(op => \n                op.id === operation.id \n                  ? { ...op, clientId: value, workOrderId: \"\", workTypes: [], materials: [] }\n                  : op\n              ));\n            }}\n          >\n            <SelectTrigger data-testid={`select-client-${operation.id}`}>\n              <SelectValue placeholder=\"Seleziona cliente\" />\n            </SelectTrigger>\n            <SelectContent>\n              {clientsLoading ? (\n                <SelectItem value=\"loading\" disabled>Caricamento...</SelectItem>\n              ) : (\n                clients.map((client) => (\n                  <SelectItem key={client.id} value={client.id}>\n                    {client.name}\n                  </SelectItem>\n                ))\n              )}\n            </SelectContent>\n          </Select>\n        </div>\n        \n        <div className=\"space-y-2\">\n          <Label className=\"font-semibold text-foreground\">Commessa</Label>\n          <Select\n            value={operation.workOrderId}\n            onValueChange={(value) => {\n              setOperations(prevOps => prevOps.map(op => \n                op.id === operation.id \n                  ? { ...op, workOrderId: value, workTypes: [], materials: [] }\n                  : op\n              ));\n            }}\n            disabled={!operation.clientId}\n          >\n            <SelectTrigger data-testid={`select-workorder-${operation.id}`}>\n              <SelectValue placeholder=\"Seleziona commessa\" />\n            </SelectTrigger>\n            <SelectContent>\n              {workOrdersLoading ? (\n                <SelectItem value=\"loading\" disabled>Caricamento...</SelectItem>\n              ) : (\n                workOrders.map((workOrder) => (\n                  <SelectItem key={workOrder.id} value={workOrder.id}>\n                    {workOrder.name}\n                  </SelectItem>\n                ))\n              )}\n            </SelectContent>\n          </Select>\n        </div>\n        \n        <div className=\"space-y-2\">\n          <Label className=\"font-semibold text-foreground\">Lavorazioni</Label>\n          {!operation.workOrderId ? (\n            <div className=\"p-3 border rounded-md text-sm text-muted-foreground\" data-testid={`worktype-empty-${operation.id}`}>\n              Seleziona prima una commessa\n            </div>\n          ) : availableWorkTypes.length === 0 ? (\n            <div className=\"p-3 border rounded-md text-sm text-muted-foreground\" data-testid={`worktype-no-data-${operation.id}`}>\n              Nessuna lavorazione disponibile\n            </div>\n          ) : (\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2 p-3 border rounded-md\" data-testid={`worktype-container-${operation.id}`}>\n              {availableWorkTypes.map(type => (\n                <div key={type} className=\"flex items-center space-x-2\">\n                  <Checkbox\n                    id={`worktype-${operation.id}-${type}`}\n                    checked={operation.workTypes?.includes(type) || false}\n                    onCheckedChange={() => onToggleWorkType(operation.id, type)}\n                    data-testid={`checkbox-worktype-${operation.id}-${type}`}\n                  />\n                  <Label \n                    htmlFor={`worktype-${operation.id}-${type}`}\n                    className=\"text-sm font-normal cursor-pointer\"\n                  >\n                    {getWorkTypeName(type)}\n                  </Label>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      </div>\n      \n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mt-4\">\n        <div className=\"space-y-2\">\n          <Label className=\"font-semibold text-foreground\">Materiali (opzionale)</Label>\n          {!operation.workOrderId ? (\n            <div className=\"p-3 border rounded-md text-sm text-muted-foreground\" data-testid={`material-empty-${operation.id}`}>\n              Seleziona prima una commessa\n            </div>\n          ) : availableMaterials.length === 0 ? (\n            <div className=\"p-3 border rounded-md text-sm text-muted-foreground\" data-testid={`material-no-data-${operation.id}`}>\n              Nessun materiale disponibile\n            </div>\n          ) : (\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2 p-3 border rounded-md\" data-testid={`material-container-${operation.id}`}>\n              {availableMaterials.map(material => (\n                <div key={material} className=\"flex items-center space-x-2\">\n                  <Checkbox\n                    id={`material-${operation.id}-${material}`}\n                    checked={operation.materials?.includes(material) || false}\n                    onCheckedChange={() => onToggleMaterial(operation.id, material)}\n                    data-testid={`checkbox-material-${operation.id}-${material}`}\n                  />\n                  <Label \n                    htmlFor={`material-${operation.id}-${material}`}\n                    className=\"text-sm font-normal cursor-pointer\"\n                  >\n                    {getMaterialName(material)}\n                  </Label>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n        \n        <div className=\"space-y-2\">\n          <Label className=\"font-semibold text-foreground\">Ore lavorate</Label>\n          <Input\n            type=\"number\"\n            step=\"0.5\"\n            min=\"0\"\n            value={operation.hours || ''}\n            onChange={(e) => {\n              const value = e.target.value;\n              setOperations(prevOps => prevOps.map(op => \n                op.id === operation.id \n                  ? { ...op, hours: typeof value === 'string' ? parseFloat(value) || 0 : value }\n                  : op\n              ));\n            }}\n            placeholder=\"Es. 8\"\n            data-testid={`input-hours-${operation.id}`}\n          />\n        </div>\n      </div>\n      \n      <div className=\"mt-4 space-y-2\">\n        <Label className=\"font-semibold text-foreground\">Note</Label>\n        <Textarea\n          value={operation.notes}\n          onChange={(e) => {\n            const value = e.target.value;\n            setOperations(prevOps => prevOps.map(op => \n              op.id === operation.id \n                ? { ...op, notes: value }\n                : op\n            ));\n          }}\n          placeholder=\"Aggiungi note sull'operazione...\"\n          rows={3}\n          data-testid={`textarea-notes-${operation.id}`}\n        />\n      </div>\n      \n      <div className=\"mt-4 space-y-2\">\n        <Label className=\"font-semibold text-foreground\">Foto (max 5)</Label>\n        <div className=\"flex flex-wrap gap-2\">\n          {operation.photos && operation.photos.map((photoPath, idx) => (\n            <div key={idx} className=\"relative\">\n              <img \n                src={photoPath}\n                alt={`Foto ${idx + 1}`} \n                className=\"w-20 h-20 object-cover rounded-md border bg-muted\"\n                data-testid={`photo-preview-${operation.id}-${idx}`}\n                onError={(e) => {\n                  e.currentTarget.src = 'data:image/svg+xml,%3Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"80\" height=\"80\"%3E%3Crect width=\"80\" height=\"80\" fill=\"%23f0f0f0\"/%3E%3Ctext x=\"50%25\" y=\"50%25\" text-anchor=\"middle\" dy=\".3em\" fill=\"%23999\" font-size=\"12\"%3EFoto%3C/text%3E%3C/svg%3E';\n                  e.currentTarget.onerror = null;\n                }}\n              />\n              <Button\n                type=\"button\"\n                variant=\"destructive\"\n                size=\"icon\"\n                className=\"absolute -top-2 -right-2 h-6 w-6\"\n                onClick={() => {\n                  setOperations(prevOps => prevOps.map(op =>\n                    op.id === operation.id\n                      ? { ...op, photos: op.photos.filter((_, i) => i !== idx) }\n                      : op\n                  ));\n                }}\n                data-testid={`button-remove-photo-${operation.id}-${idx}`}\n              >\n                <X className=\"h-3 w-3\" />\n              </Button>\n            </div>\n          ))}\n          \n          {(!operation.photos || operation.photos.length < 5) && (\n            <ObjectUploader\n              maxNumberOfFiles={1}\n              maxFileSize={10485760}\n              buttonVariant=\"outline\"\n              buttonClassName=\"w-20 h-20\"\n              onComplete={async (result: any, uppy) => {\n                try {\n                  if (result.failed && result.failed.length > 0) {\n                    toast({\n                      title: \"Errore upload\",\n                      description: \"Impossibile caricare la foto. Riprova.\",\n                      variant: \"destructive\",\n                    });\n                    return;\n                  }\n                  \n                  if (result.successful && result.successful.length > 0) {\n                    const photoUrl = result.successful[0].response?.body?.url;\n                    \n                    if (!photoUrl) {\n                      throw new Error(\"URL foto non disponibile\");\n                    }\n                    \n                    setOperations(prevOps => prevOps.map(op =>\n                      op.id === operation.id\n                        ? { ...op, photos: [...(op.photos || []), photoUrl] }\n                        : op\n                    ));\n                    \n                    toast({\n                      title: \"Foto caricata\",\n                      description: \"La foto è stata aggiunta con successo\",\n                    });\n                  }\n                } catch (error) {\n                  console.error(\"Errore upload foto:\", error);\n                  toast({\n                    title: \"Errore\",\n                    description: error instanceof Error ? error.message : \"Impossibile caricare la foto\",\n                    variant: \"destructive\",\n                  });\n                } finally {\n                  uppy.cancelAll();\n                }\n              }}\n            >\n              <Camera className=\"h-5 w-5\" />\n            </ObjectUploader>\n          )}\n        </div>\n        <p className=\"text-xs text-muted-foreground\">\n          Carica foto per documentare il lavoro svolto\n        </p>\n      </div>\n    </Card>\n  );\n}\n\nexport default function DailyReportForm({ \n  employeeName, \n  date, \n  onSubmit, \n  initialOperations, \n  isEditing = false,\n  isSubmitting = false\n}: DailyReportFormProps) {\n  // Initialize with provided operations or default empty operation\n  const [operations, setOperations] = useState<Operation[]>(\n    initialOperations && initialOperations.length > 0 \n      ? initialOperations.map((op, index) => ({\n          ...op,\n          id: `${index + 1}`, // Ensure unique IDs for form state\n          materials: op.materials || [], // Ensure materials array exists\n          hours: typeof op.hours === 'string' ? parseFloat(op.hours) || 0 : op.hours, // Ensure numeric\n          photos: op.photos || [], // Ensure photos array exists\n        }))\n      : [{\n          id: \"1\",\n          clientId: \"\",\n          workOrderId: \"\",\n          workTypes: [],\n          materials: [],\n          hours: 0,\n          notes: \"\",\n          photos: [],\n        }]\n  );\n\n  const [showHoursDialog, setShowHoursDialog] = useState(false);\n  const [dialogMessage, setDialogMessage] = useState(\"\");\n\n  // Load clients and all active work orders from backend\n  const { data: clients = [], isLoading: clientsLoading } = useClients();\n  const { data: allWorkOrders = [], isLoading: workOrdersLoading } = useAllActiveWorkOrders();\n  const { data: allWorkTypes = [] } = useWorkTypes();\n  const { data: allMaterials = [] } = useMaterials();\n\n  // Filter clients to show only those with active work orders\n  const clientsWithWorkOrders = clients.filter(client => \n    allWorkOrders.some(wo => wo.clientId === client.id)\n  );\n\n  const addOperation = () => {\n    const newOperation: Operation = {\n      id: Date.now().toString(),\n      clientId: \"\",\n      workOrderId: \"\",\n      workTypes: [],\n      materials: [],\n      hours: 0,\n      notes: \"\",\n      photos: [],\n    };\n    setOperations(prevOps => [...prevOps, newOperation]);\n    console.log(\"Added new operation\");\n  };\n\n  const removeOperation = (id: string) => {\n    setOperations(prevOps => prevOps.filter(op => op.id !== id));\n    console.log(\"Removed operation\", id);\n  };\n\n  const toggleWorkType = (operationId: string, workType: string) => {\n    setOperations(prevOps => prevOps.map(op => {\n      if (op.id === operationId) {\n        const currentTypes = op.workTypes || [];\n        const isSelected = currentTypes.includes(workType);\n        const newTypes = isSelected\n          ? currentTypes.filter(type => type !== workType)\n          : [...currentTypes, workType];\n        return { ...op, workTypes: newTypes };\n      }\n      return op;\n    }));\n    console.log(\"Toggled work type\", operationId, workType);\n  };\n\n  const toggleMaterial = (operationId: string, material: string) => {\n    setOperations(prevOps => prevOps.map(op => {\n      if (op.id === operationId) {\n        const currentMaterials = op.materials || [];\n        const isSelected = currentMaterials.includes(material);\n        const newMaterials = isSelected\n          ? currentMaterials.filter(m => m !== material)\n          : [...currentMaterials, material];\n        return { ...op, materials: newMaterials };\n      }\n      return op;\n    }));\n    console.log(\"Toggled material\", operationId, material);\n  };\n\n\n  // Funzione per validare tutti i campi obbligatori\n  const validateRequiredFields = (): { isValid: boolean; missingFields: string[] } => {\n    const missingFields: string[] = [];\n    \n    operations.forEach((operation, index) => {\n      if (!operation.clientId) missingFields.push(`Operazione ${index + 1}: Cliente`);\n      if (!operation.workOrderId) missingFields.push(`Operazione ${index + 1}: Commessa`);\n      if (!operation.workTypes || operation.workTypes.length === 0) missingFields.push(`Operazione ${index + 1}: Seleziona almeno una Lavorazione`);\n      if (!operation.hours || operation.hours <= 0) missingFields.push(`Operazione ${index + 1}: Inserire ore valide (maggiori di 0)`);\n      // NOTE: materials are optional, so no validation required\n    });\n\n    return {\n      isValid: missingFields.length === 0,\n      missingFields\n    };\n  };\n\n  // Funzione per calcolare ore totali\n  const getTotalHours = (): number => {\n    return operations.reduce((total, operation) => {\n      const hours = typeof operation.hours === 'string' ? parseFloat(operation.hours) || 0 : operation.hours || 0;\n      return total + hours;\n    }, 0);\n  };\n\n  // Funzione per inviare il rapportino (chiamata finale)\n  const submitReport = () => {\n    // Rimuovi il campo 'id' dalle operazioni prima di inviare (serve solo per il form)\n    const operationsToSubmit = operations.map(({ id, ...operation }) => operation) as Operation[];\n    console.log(\"Submitting daily report with operations:\", operationsToSubmit);\n    onSubmit(operationsToSubmit);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    // 1. Validazione campi obbligatori\n    const validation = validateRequiredFields();\n    if (!validation.isValid) {\n      alert(`Compila tutti i campi obbligatori:\\n\\n${validation.missingFields.join('\\n')}`);\n      return;\n    }\n\n    // 2. Controllo ore totali (deve essere 8)\n    const totalHours = getTotalHours();\n    \n    if (totalHours === 8) {\n      // Ore corrette, invia subito\n      submitReport();\n    } else {\n      // Ore diverse da 8, mostra dialog\n      if (totalHours < 8) {\n        setDialogMessage(`Le ore totali sono ${totalHours}, inferiori alle 8 ore standard.`);\n      } else {\n        setDialogMessage(`Le ore totali sono ${totalHours}, superiori alle 8 ore standard.`);\n      }\n      setShowHoursDialog(true);\n    }\n  };\n\n\n  return (\n    <div className=\"max-w-4xl mx-auto px-3 sm:px-4 py-4 space-y-6\">\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between\">\n          <div>\n            <CardTitle>Rapportino Giornaliero</CardTitle>\n            <p className=\"text-sm text-muted-foreground mt-1\">\n              {employeeName} - {date}\n            </p>\n          </div>\n          <StatusBadge status=\"In attesa\" viewMode=\"employee\" />\n        </CardHeader>\n        \n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            <div className=\"space-y-4\">\n              <h3 className=\"text-lg font-medium\">Operazioni</h3>\n              \n              {operations.map((operation, index) => (\n                <OperationCard\n                  key={operation.id}\n                  operation={operation}\n                  index={index}\n                  operationsLength={operations.length}\n                  clients={clientsWithWorkOrders}\n                  clientsLoading={clientsLoading}\n                  allWorkOrders={allWorkOrders}\n                  workOrdersLoading={workOrdersLoading}\n                  allWorkTypes={allWorkTypes}\n                  allMaterials={allMaterials}\n                  onRemove={removeOperation}\n                  setOperations={setOperations}\n                  onToggleWorkType={toggleWorkType}\n                  onToggleMaterial={toggleMaterial}\n                />\n              ))}\n            </div>\n            \n            <div className=\"flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3\">\n              <div className=\"text-sm text-muted-foreground\">\n                <strong>Ore totali: {getTotalHours()}h</strong>\n                <span className=\"ml-2 text-xs\">\n                  {getTotalHours() === 8 ? \"(✓ Standard)\" : getTotalHours() < 8 ? \"(⚠ Sotto standard)\" : \"(⚠ Sopra standard)\"}\n                </span>\n              </div>\n              <div className=\"flex flex-col sm:flex-row gap-2 w-full sm:w-auto\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={addOperation}\n                  data-testid=\"button-add-operation\"\n                  className=\"w-full sm:w-auto\"\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Aggiungi Operazione\n                </Button>\n                <Button \n                  type=\"submit\" \n                  data-testid=\"button-submit-report\" \n                  className=\"w-full sm:w-auto\"\n                  disabled={isSubmitting}\n                >\n                  <Send className=\"h-4 w-4 mr-2\" />\n                  {isSubmitting \n                    ? \"Invio in corso...\" \n                    : isEditing ? \"Aggiorna Rapportino\" : \"Invia Rapportino\"\n                  }\n                </Button>\n              </div>\n            </div>\n          </form>\n        </CardContent>\n      </Card>\n\n      {/* Dialog conferma ore diverse da 8 */}\n      <AlertDialog open={showHoursDialog} onOpenChange={setShowHoursDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Conferma Invio Rapportino</AlertDialogTitle>\n            <AlertDialogDescription>\n              {dialogMessage}\n              <br /><br />\n              Vuoi inviare comunque il rapportino o preferisci modificarlo?\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-hours-dialog\">\n              Modifica Rapportino\n            </AlertDialogCancel>\n            <AlertDialogAction \n              onClick={() => {\n                setShowHoursDialog(false);\n                submitReport();\n              }}\n              data-testid=\"button-confirm-hours-dialog\"\n            >\n              Invia lo Stesso\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":24660,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, timestamp, integer, boolean, numeric, index } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Organizations table (Aziende/Clienti SaaS)\nexport const organizations = pgTable(\"organizations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull().unique(),\n  subdomain: text(\"subdomain\").unique(), // es: \"azienda1\" per azienda1.tuaapp.com\n  logo: text(\"logo\"), // URL del logo aziendale\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\n// Users table\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").references(() => organizations.id),\n  username: text(\"username\").notNull(),\n  password: text(\"password\").notNull(),\n  plainPassword: text(\"plain_password\"), // Only for employees, null for admin\n  role: text(\"role\").notNull().default(\"employee\"), // employee, admin, or superadmin\n  fullName: text(\"full_name\").notNull(),\n  isActive: boolean(\"is_active\").notNull().default(true), // true = attivo, false = licenziato\n});\n\n// Clients table\nexport const clients = pgTable(\"clients\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull().references(() => organizations.id),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n});\n\n// Work types master table (Lavorazioni)\nexport const workTypes = pgTable(\"work_types\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull().references(() => organizations.id),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n});\n\n// Materials master table (Materiali)\nexport const materials = pgTable(\"materials\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull().references(() => organizations.id),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n});\n\n// Work orders (Commesse) table\nexport const workOrders = pgTable(\"work_orders\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull().references(() => organizations.id),\n  clientId: varchar(\"client_id\").notNull().references(() => clients.id),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  availableWorkTypes: text(\"available_work_types\").array().notNull().default(sql`ARRAY[]::text[]`),\n  availableMaterials: text(\"available_materials\").array().notNull().default(sql`ARRAY[]::text[]`),\n}, (table) => ({\n  orgActiveIdx: index(\"work_orders_org_active_idx\").on(table.organizationId, table.isActive),\n  clientIdx: index(\"work_orders_client_idx\").on(table.clientId),\n}));\n\n// Daily reports table\nexport const dailyReports = pgTable(\"daily_reports\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull().references(() => organizations.id),\n  employeeId: varchar(\"employee_id\").notNull().references(() => users.id),\n  date: text(\"date\").notNull(), // YYYY-MM-DD format\n  status: text(\"status\").notNull().default(\"In attesa\"), // \"In attesa\" or \"Approvato\"\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n}, (table) => ({\n  orgDateIdx: index(\"daily_reports_org_date_idx\").on(table.organizationId, table.date),\n  employeeDateIdx: index(\"daily_reports_employee_date_idx\").on(table.employeeId, table.date),\n}));\n\n// Operations table (multiple operations per daily report)\nexport const operations = pgTable(\"operations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  dailyReportId: varchar(\"daily_report_id\").notNull().references(() => dailyReports.id),\n  clientId: varchar(\"client_id\").notNull().references(() => clients.id),\n  workOrderId: varchar(\"work_order_id\").notNull().references(() => workOrders.id),\n  workTypes: text(\"work_types\").array().notNull(), // Multiple work types: [\"Taglio\", \"Saldatura\", \"Montaggio\"]\n  materials: text(\"materials\").array().notNull().default(sql`ARRAY[]::text[]`), // Multiple materials: [\"Acciaio\", \"Alluminio\"]\n  hours: numeric(\"hours\").notNull(), // Ore lavorate per questa operazione (es. 2.5)\n  notes: text(\"notes\"),\n  photos: text(\"photos\").array().notNull().default(sql`ARRAY[]::text[]`), // Photo paths from object storage (max 5)\n}, (table) => ({\n  dailyReportIdx: index(\"operations_daily_report_idx\").on(table.dailyReportId),\n}));\n\n// Attendance entries (Assenze manuali gestite dall'admin)\nexport const attendanceEntries = pgTable(\"attendance_entries\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull().references(() => organizations.id),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  date: text(\"date\").notNull(), // YYYY-MM-DD format\n  absenceType: text(\"absence_type\").notNull(), // A, F, P, M, CP, L104\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\n// Hours adjustments (Aggiustamenti ore per rapportini)\nexport const hoursAdjustments = pgTable(\"hours_adjustments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull().references(() => organizations.id),\n  dailyReportId: varchar(\"daily_report_id\").notNull().references(() => dailyReports.id),\n  adjustment: numeric(\"adjustment\").notNull(), // Valore positivo o negativo (es. +0.5 o -1.5)\n  reason: text(\"reason\"), // Motivo opzionale dell'aggiustamento\n  createdBy: varchar(\"created_by\").notNull().references(() => users.id), // Admin che ha creato l'aggiustamento\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\n// Vehicles table (Mezzi aziendali per gestione carburante)\nexport const vehicles = pgTable(\"vehicles\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull().references(() => organizations.id),\n  name: text(\"name\").notNull(), // Nome del mezzo (es. \"Furgone 1\", \"Camion rosso\")\n  licensePlate: text(\"license_plate\").notNull(), // Targa\n  fuelType: text(\"fuel_type\").notNull(), // Benzina, Diesel, GPL, Metano, Elettrico\n  currentKm: numeric(\"current_km\"), // Km attuali (opzionale)\n  currentEngineHours: numeric(\"current_engine_hours\"), // Ore motore attuali (opzionale, per mezzi da lavoro)\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n}, (table) => ({\n  orgIdx: index(\"vehicles_org_idx\").on(table.organizationId),\n}));\n\n// Fuel refills table (Rifornimenti carburante - scarichi dalla cisterna)\nexport const fuelRefills = pgTable(\"fuel_refills\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull().references(() => organizations.id),\n  vehicleId: varchar(\"vehicle_id\").notNull().references(() => vehicles.id),\n  refillDate: timestamp(\"refill_date\").notNull().default(sql`now()`), // Data e ora rifornimento\n  operatorId: varchar(\"operator_id\").references(() => users.id), // Chi ha fatto il rifornimento (opzionale)\n  litersBefore: numeric(\"liters_before\").notNull(), // Litri nel serbatoio prima del rifornimento\n  litersAfter: numeric(\"liters_after\").notNull(), // Litri nel serbatoio dopo il rifornimento\n  litersRefilled: numeric(\"liters_refilled\").notNull(), // Litri erogati (after - before)\n  kmReading: numeric(\"km_reading\"), // Lettura km al momento del rifornimento\n  engineHoursReading: numeric(\"engine_hours_reading\"), // Lettura ore motore (opzionale)\n  totalCost: numeric(\"total_cost\"), // Costo totale rifornimento (opzionale)\n  notes: text(\"notes\"), // Note aggiuntive\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n}, (table) => ({\n  vehicleIdx: index(\"fuel_refills_vehicle_idx\").on(table.vehicleId),\n  orgDateIdx: index(\"fuel_refills_org_date_idx\").on(table.organizationId, table.refillDate),\n}));\n\n// Fuel tank loads table (Carichi cisterna carburante)\nexport const fuelTankLoads = pgTable(\"fuel_tank_loads\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  organizationId: varchar(\"organization_id\").notNull().references(() => organizations.id),\n  loadDate: timestamp(\"load_date\").notNull().default(sql`now()`), // Data e ora carico\n  liters: numeric(\"liters\").notNull(), // Litri caricati nella cisterna\n  totalCost: numeric(\"total_cost\"), // Costo totale del carico (opzionale)\n  supplier: text(\"supplier\"), // Fornitore (opzionale)\n  notes: text(\"notes\"), // Note aggiuntive\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n}, (table) => ({\n  orgDateIdx: index(\"fuel_tank_loads_org_date_idx\").on(table.organizationId, table.loadDate),\n}));\n\n// Insert schemas\nexport const insertOrganizationSchema = createInsertSchema(organizations).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  organizationId: true, // Will be set automatically from session\n}).extend({\n  // Password validation - no requirements\n  password: z.string().min(1, \"Password è richiesta\"),\n  username: z.string().min(3, \"Username deve essere di almeno 3 caratteri\"),\n  fullName: z.string().min(2, \"Nome e cognome devono essere di almeno 2 caratteri\")\n});\n\n// Update user schema for partial updates\nexport const updateUserSchema = insertUserSchema.partial().extend({\n  id: z.string().optional()\n});\n\nexport const insertClientSchema = createInsertSchema(clients).omit({\n  id: true,\n  organizationId: true, // Will be set automatically from session\n});\n\nexport const insertWorkTypeSchema = createInsertSchema(workTypes).omit({\n  id: true,\n  organizationId: true, // Will be set automatically from session\n});\n\nexport const insertMaterialSchema = createInsertSchema(materials).omit({\n  id: true,\n  organizationId: true, // Will be set automatically from session\n});\n\nexport const insertWorkOrderSchema = createInsertSchema(workOrders).omit({\n  id: true,\n  organizationId: true, // Will be set automatically from session\n});\n\nexport const insertDailyReportSchema = createInsertSchema(dailyReports).omit({\n  id: true,\n  organizationId: true, // Will be set automatically from session\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertOperationSchema = createInsertSchema(operations).omit({\n  id: true,\n}).extend({\n  hours: z.union([z.string(), z.number()]).transform(val => String(val))\n});\n\nexport const insertAttendanceEntrySchema = createInsertSchema(attendanceEntries).omit({\n  id: true,\n  organizationId: true, // Will be set automatically from session\n  createdAt: true,\n}).extend({\n  absenceType: z.string().min(1, \"Tipo assenza richiesto\")\n});\n\nexport const insertHoursAdjustmentSchema = createInsertSchema(hoursAdjustments).omit({\n  id: true,\n  organizationId: true, // Will be set automatically from session\n  createdBy: true, // Will be set automatically from session\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  adjustment: z.union([z.string(), z.number()]).transform(val => String(val))\n});\n\nexport const insertVehicleSchema = createInsertSchema(vehicles).omit({\n  id: true,\n  organizationId: true, // Will be set automatically from session\n  createdAt: true,\n}).extend({\n  currentKm: z.union([z.string(), z.number(), z.null()]).optional().transform(val => val ? String(val) : null),\n  currentEngineHours: z.union([z.string(), z.number(), z.null()]).optional().transform(val => val ? String(val) : null),\n});\n\nexport const insertFuelRefillSchema = createInsertSchema(fuelRefills).omit({\n  id: true,\n  organizationId: true, // Will be set automatically from session\n  createdAt: true,\n}).extend({\n  refillDate: z.union([z.string(), z.date()]).transform(val => {\n    if (typeof val === 'string') return new Date(val);\n    return val;\n  }),\n  litersBefore: z.union([z.string(), z.number()]).transform(val => String(val)),\n  litersAfter: z.union([z.string(), z.number()]).transform(val => String(val)),\n  litersRefilled: z.union([z.string(), z.number()]).transform(val => String(val)),\n  kmReading: z.union([z.string(), z.number(), z.null()]).optional().transform(val => val ? String(val) : null),\n  engineHoursReading: z.union([z.string(), z.number(), z.null()]).optional().transform(val => val ? String(val) : null),\n  totalCost: z.union([z.string(), z.number(), z.null()]).optional().transform(val => val ? String(val) : null),\n});\n\nexport const insertFuelTankLoadSchema = createInsertSchema(fuelTankLoads).omit({\n  id: true,\n  organizationId: true, // Will be set automatically from session\n  createdAt: true,\n}).extend({\n  loadDate: z.union([z.string(), z.date()]).transform(val => {\n    if (typeof val === 'string') return new Date(val);\n    return val;\n  }),\n  liters: z.union([z.string(), z.number()]).transform(val => String(val)),\n  totalCost: z.union([z.string(), z.number(), z.null()]).optional().transform(val => val ? String(val) : null),\n});\n\n// Update schemas for editing\nexport const updateDailyReportSchema = insertDailyReportSchema.partial().extend({\n  id: z.string().optional()\n});\n\nexport const updateOperationSchema = insertOperationSchema.partial().extend({\n  id: z.string().optional()\n});\n\nexport const updateAttendanceEntrySchema = insertAttendanceEntrySchema.partial().extend({\n  id: z.string().optional(),\n  absenceType: z.enum([\"A\", \"F\", \"P\", \"M\", \"CP\", \"L104\"]).optional()\n});\n\nexport const updateHoursAdjustmentSchema = insertHoursAdjustmentSchema.partial().extend({\n  id: z.string().optional()\n});\n\nexport const updateVehicleSchema = insertVehicleSchema.partial().extend({\n  id: z.string().optional()\n});\n\nexport const updateFuelRefillSchema = insertFuelRefillSchema.partial().extend({\n  id: z.string().optional()\n});\n\nexport const updateFuelTankLoadSchema = insertFuelTankLoadSchema.partial().extend({\n  id: z.string().optional()\n});\n\n// Types\nexport type InsertOrganization = z.infer<typeof insertOrganizationSchema>;\nexport type Organization = typeof organizations.$inferSelect;\n\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type UpdateUser = z.infer<typeof updateUserSchema>;\nexport type User = typeof users.$inferSelect;\n\nexport type InsertClient = z.infer<typeof insertClientSchema>;\nexport type Client = typeof clients.$inferSelect;\n\nexport type InsertWorkType = z.infer<typeof insertWorkTypeSchema>;\nexport type WorkType = typeof workTypes.$inferSelect;\n\nexport type InsertMaterial = z.infer<typeof insertMaterialSchema>;\nexport type Material = typeof materials.$inferSelect;\n\nexport type InsertWorkOrder = z.infer<typeof insertWorkOrderSchema>;\nexport type WorkOrder = typeof workOrders.$inferSelect;\n\nexport type InsertDailyReport = z.infer<typeof insertDailyReportSchema>;\nexport type DailyReport = typeof dailyReports.$inferSelect;\n\nexport type InsertOperation = z.infer<typeof insertOperationSchema>;\nexport type Operation = typeof operations.$inferSelect;\n\nexport type InsertAttendanceEntry = z.infer<typeof insertAttendanceEntrySchema>;\nexport type AttendanceEntry = typeof attendanceEntries.$inferSelect;\nexport type UpdateAttendanceEntry = z.infer<typeof updateAttendanceEntrySchema>;\n\nexport type InsertHoursAdjustment = z.infer<typeof insertHoursAdjustmentSchema>;\nexport type HoursAdjustment = typeof hoursAdjustments.$inferSelect;\nexport type UpdateHoursAdjustment = z.infer<typeof updateHoursAdjustmentSchema>;\n\nexport type InsertVehicle = z.infer<typeof insertVehicleSchema>;\nexport type Vehicle = typeof vehicles.$inferSelect;\nexport type UpdateVehicle = z.infer<typeof updateVehicleSchema>;\n\nexport type InsertFuelRefill = z.infer<typeof insertFuelRefillSchema>;\nexport type FuelRefill = typeof fuelRefills.$inferSelect;\nexport type UpdateFuelRefill = z.infer<typeof updateFuelRefillSchema>;\n\nexport type InsertFuelTankLoad = z.infer<typeof insertFuelTankLoadSchema>;\nexport type FuelTankLoad = typeof fuelTankLoads.$inferSelect;\nexport type UpdateFuelTankLoad = z.infer<typeof updateFuelTankLoadSchema>;\n\nexport type UpdateDailyReport = z.infer<typeof updateDailyReportSchema>;\nexport type UpdateOperation = z.infer<typeof updateOperationSchema>;\n\n// Status enum\nexport const StatusEnum = z.enum([\"In attesa\", \"Approvato\"]);\nexport type Status = z.infer<typeof StatusEnum>;\n\n// Absence type enum - AGGIORNATO CON \"A\"\nexport const AbsenceTypeEnum = z.enum([\"A\", \"F\", \"P\", \"M\", \"CP\", \"L104\"]);\nexport type AbsenceType = z.infer<typeof AbsenceTypeEnum>;","path":null,"size_bytes":16963,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ThemeProvider.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\n\ntype Theme = \"light\" | \"dark\";\n\ntype ThemeProviderContextType = {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n  toggleTheme: () => void;\n};\n\nconst ThemeProviderContext = createContext<ThemeProviderContextType | undefined>(undefined);\n\ntype ThemeProviderProps = {\n  children: React.ReactNode;\n  defaultTheme?: Theme;\n};\n\nexport function ThemeProvider({ children, defaultTheme = \"light\" }: ThemeProviderProps) {\n  const [theme, setTheme] = useState<Theme>(defaultTheme);\n\n  useEffect(() => {\n    const savedTheme = localStorage.getItem(\"theme\") as Theme | null;\n    if (savedTheme) {\n      setTheme(savedTheme);\n    }\n  }, []);\n\n  useEffect(() => {\n    const root = document.documentElement;\n    root.classList.remove(\"light\", \"dark\");\n    root.classList.add(theme);\n    localStorage.setItem(\"theme\", theme);\n  }, [theme]);\n\n  const toggleTheme = () => {\n    setTheme(theme === \"light\" ? \"dark\" : \"light\");\n  };\n\n  return (\n    <ThemeProviderContext.Provider value={{ theme, setTheme, toggleTheme }}>\n      {children}\n    </ThemeProviderContext.Provider>\n  );\n}\n\nexport const useTheme = () => {\n  const context = useContext(ThemeProviderContext);\n  if (context === undefined) {\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n  }\n  return context;\n};","path":null,"size_bytes":1350,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ThemeToggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTheme } from \"./ThemeProvider\";\n\nexport default function ThemeToggle() {\n  const { theme, toggleTheme } = useTheme();\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      onClick={toggleTheme}\n      data-testid=\"button-theme-toggle\"\n      aria-label=\"Toggle theme\"\n    >\n      {theme === \"light\" ? (\n        <Moon className=\"h-4 w-4\" />\n      ) : (\n        <Sun className=\"h-4 w-4\" />\n      )}\n    </Button>\n  );\n}","path":null,"size_bytes":534,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport session from \"express-session\";\nimport connectPgSimple from \"connect-pg-simple\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst app = express();\n\n// Disable ETag globally to prevent 304 responses with empty body\napp.set('etag', false);\n\n// ============================================\n// GLOBAL ERROR HANDLERS\n// ============================================\n\nprocess.on(\"unhandledRejection\", (reason, promise) => {\n  console.error(\"⚠️  Unhandled Rejection at:\", promise, \"reason:\", reason);\n  // Log but don't crash - let PM2 or similar handle restarts if needed\n});\n\nprocess.on(\"uncaughtException\", (error) => {\n  console.error(\"❌ Uncaught Exception:\", error);\n  // Log but don't crash - in production you might want graceful shutdown\n});\n\n// ============================================\n// ENVIRONMENT VALIDATION\n// ============================================\n\nif (process.env.NODE_ENV === \"production\") {\n  // Validate critical environment variables\n  const requiredEnvVars = [\n    \"DATABASE_URL\",\n    \"SESSION_SECRET\",\n  ];\n\n  const missingVars = requiredEnvVars.filter(\n    (varName) => !process.env[varName],\n  );\n\n  if (missingVars.length > 0) {\n    console.error(\"❌ FATAL: Missing required environment variables:\");\n    missingVars.forEach((varName) => console.error(`  - ${varName}`));\n    process.exit(1);\n  }\n}\nif (process.env.NODE_ENV === \"production\") {\n  // Validate critical environment variables\n  const requiredEnvVars = [\n    \"DATABASE_URL\",\n    \"SESSION_SECRET\",\n  ];\n\n  const missingVars = requiredEnvVars.filter(\n    (varName) => !process.env[varName],\n  );\n\n  if (missingVars.length > 0) {\n    console.error(\"❌ FATAL: Missing required environment variables:\");\n    missingVars.forEach((varName) => console.error(`  - ${varName}`));\n    process.exit(1);\n  }\n\n  // ADD THIS DEBUG LOG\n  console.log('🔍 DATABASE_URL check:', {\n    host: process.env.DATABASE_URL?.match(/@([^/]+)/)?.[1] || 'unknown',\n    database: process.env.DATABASE_URL?.match(/\\/([^?]+)/)?.[1] || 'unknown'\n  });\n}\n// ============================================\n// PROXY CONFIGURATION\n// ============================================\n\nif (process.env.NODE_ENV === \"production\") {\n  // Trust proxy for secure cookies behind HTTPS reverse proxy\n  app.set(\"trust proxy\", 1);\n  log(\"✓ Trust proxy enabled for production\");\n}\n\n// ============================================\n// BODY PARSERS\n// ============================================\n\napp.use(express.json({ limit: \"10mb\" })); // Increase limit for photo uploads\napp.use(express.urlencoded({ extended: false, limit: \"10mb\" }));\n\n// ============================================\n// SESSION CONFIGURATION\n// ============================================\n\n// Ensure SESSION_SECRET is configured\nif (!process.env.SESSION_SECRET) {\n  if (process.env.NODE_ENV === \"production\") {\n    console.error(\n      \"❌ FATAL: SESSION_SECRET environment variable is required in production\",\n    );\n    process.exit(1);\n  } else {\n    console.warn(\"⚠️  WARNING: Using default SESSION_SECRET in development\");\n    process.env.SESSION_SECRET =\n      \"dev-secret-key-not-for-production-\" + Math.random();\n  }\n}\n\n// Session store configuration\nconst PgSession = connectPgSimple(session);\nconst sessionStore =\n  process.env.NODE_ENV === \"production\" && process.env.DATABASE_URL\n    ? new PgSession({\n        conString: process.env.DATABASE_URL,\n        tableName: \"session\",\n        createTableIfMissing: true,\n        pruneSessionInterval: 60 * 15, // Prune expired sessions every 15 minutes\n      })\n    : undefined; // Use memory store in development\n\nif (sessionStore) {\n  log(\"✓ Using PostgreSQL session store\");\n} else {\n  log(\"⚠️  Using memory session store (development only)\");\n}\n\n// Session middleware - optimized for iOS Safari compatibility\napp.use(\n  session({\n    store: sessionStore,\n    secret: process.env.SESSION_SECRET,\n    resave: false,\n    saveUninitialized: false,\n    name: \"metaltec.sid\", // Custom session name\n    cookie: {\n      secure: process.env.NODE_ENV === \"production\", // HTTPS only in production\n      httpOnly: true, // Prevent XSS attacks\n      maxAge: 24 * 60 * 60 * 1000, // 24 hours\n      sameSite: process.env.NODE_ENV === \"production\" ? \"lax\" : \"lax\", // CSRF protection\n    },\n    rolling: true, // Reset maxAge on every response\n  }),\n);\n\n// ============================================\n// REQUEST LOGGING MIDDLEWARE\n// ============================================\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n\n      // Only log response body in development\n      if (process.env.NODE_ENV === \"development\" && capturedJsonResponse) {\n        const responseStr = JSON.stringify(capturedJsonResponse);\n        if (responseStr.length < 100) {\n          logLine += ` :: ${responseStr}`;\n        }\n      }\n\n      // Truncate long log lines\n      if (logLine.length > 200) {\n        logLine = logLine.slice(0, 199) + \"…\";\n      }\n\n      // Color code by status\n      if (res.statusCode >= 500) {\n        console.error(`❌ ${logLine}`);\n      } else if (res.statusCode >= 400) {\n        console.warn(`⚠️  ${logLine}`);\n      } else if (process.env.NODE_ENV === \"development\") {\n        log(logLine);\n      }\n    }\n  });\n\n  next();\n});\n\n// ============================================\n// SECURITY HEADERS\n// ============================================\n\napp.use((req, res, next) => {\n  // Security headers\n  res.setHeader(\"X-Content-Type-Options\", \"nosniff\");\n  res.setHeader(\"X-Frame-Options\", \"DENY\");\n  res.setHeader(\"X-XSS-Protection\", \"1; mode=block\");\n  res.setHeader(\"Referrer-Policy\", \"strict-origin-when-cross-origin\");\n\n  // Only set CSP in production\n  if (process.env.NODE_ENV === \"production\") {\n    res.setHeader(\n      \"Content-Security-Policy\",\n      \"default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://api.anthropic.com https://storage.googleapis.com;\",\n    );\n  }\n\n  next();\n});\n\n// ============================================\n// HEALTH CHECK ENDPOINT\n// ============================================\n\napp.get(\"/health\", (req, res) => {\n  res.json({\n    status: \"ok\",\n    timestamp: new Date().toISOString(),\n    env: process.env.NODE_ENV || \"development\",\n  });\n});\n\n// ============================================\n// SERVER INITIALIZATION\n// ============================================\n\n(async () => {\n  try {\n    log(\"🚀 Starting Metaltec Rapportini Server...\");\n\n    // Register API routes\n    const server = await registerRoutes(app);\n    log(\"✓ API routes registered\");\n\n    // Global error handler (must be after routes)\n    app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n      const status = err.status || err.statusCode || 500;\n      const message = err.message || \"Internal Server Error\";\n\n      // Log the error for debugging\n      console.error(\"❌ Express error handler:\", {\n        status,\n        message,\n        stack: process.env.NODE_ENV === \"development\" ? err.stack : undefined,\n      });\n\n      // Send error response to client (never expose stack trace in production)\n      res.status(status).json({\n        error: message,\n        ...(process.env.NODE_ENV === \"development\" && { stack: err.stack }),\n      });\n    });\n\n    // Setup Vite dev server (development) or static file serving (production)\n    if (app.get(\"env\") === \"development\") {\n      await setupVite(app, server);\n      log(\"✓ Vite development server configured\");\n    } else {\n      serveStatic(app);\n      log(\"✓ Static file serving configured\");\n    }\n\n    // Start HTTP server\n    const port = parseInt(process.env.PORT || \"5000\", 10);\n\n    server.listen(\n      {\n        port,\n        host: \"0.0.0.0\",\n        reusePort: true,\n      },\n      () => {\n        log(`✅ Server running on port ${port}`);\n        log(`   Environment: ${process.env.NODE_ENV || \"development\"}`);\n        log(`   URL: http://localhost:${port}`);\n\n        if (process.env.NODE_ENV === \"production\") {\n          log(\"   🔒 Security features enabled\");\n          log(\"   🔄 Rate limiting active\");\n          log(\"   📊 PostgreSQL session store active\");\n        }\n      },\n    );\n\n    // Graceful shutdown handler\n    const gracefulShutdown = async (signal: string) => {\n      log(`\\n⚠️  ${signal} received, starting graceful shutdown...`);\n\n      // Stop accepting new connections\n      server.close(() => {\n        log(\"✓ HTTP server closed\");\n      });\n\n      // Give time for in-flight requests to complete\n      setTimeout(() => {\n        log(\"✅ Graceful shutdown complete\");\n        process.exit(0);\n      }, 5000);\n    };\n\n    process.on(\"SIGTERM\", () => gracefulShutdown(\"SIGTERM\"));\n    process.on(\"SIGINT\", () => gracefulShutdown(\"SIGINT\"));\n  } catch (error) {\n    console.error(\"❌ FATAL: Failed to start server:\", error);\n    process.exit(1);\n  }\n})();\n","path":null,"size_bytes":9584,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"client/src/components/AttendanceSheet.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Download, Plus, X } from \"lucide-react\";\nimport { formatDateToItalian } from \"@/lib/dateUtils\";\n\n// Absence type labels - AGGIUNTO \"A: Assente\"\nconst ABSENCE_LABELS: Record<string, string> = {\n  A: \"Assente\",\n  F: \"Ferie\",\n  P: \"Permessi\",\n  M: \"Malattia\",\n  CP: \"Congedo Parentale\",\n  L104: \"Legge 104\"\n};\n\n// Helper to determine if a date is Saturday (6) or Sunday (0)\nfunction getDayOfWeek(year: string, month: string, day: number): number {\n  const date = new Date(parseInt(year), parseInt(month) - 1, day);\n  return date.getDay();\n}\n\n// Simple check for Italian holidays (basic implementation)\nfunction isItalianHoliday(year: string, month: string, day: number): boolean {\n  const monthNum = parseInt(month);\n  const fixedHolidays = [\n    { month: 1, day: 1 },   // Capodanno\n    { month: 1, day: 6 },   // Epifania\n    { month: 4, day: 25 },  // Liberazione\n    { month: 5, day: 1 },   // Festa del Lavoro\n    { month: 6, day: 2 },   // Festa della Repubblica\n    { month: 8, day: 15 },  // Ferragosto\n    { month: 11, day: 1 },  // Tutti i Santi\n    { month: 12, day: 8 },  // Immacolata\n    { month: 12, day: 25 }, // Natale\n    { month: 12, day: 26 }, // Santo Stefano\n  ];\n\n  return fixedHolidays.some(h => h.month === monthNum && h.day === day);\n}\n\n// Get cell background color based on day type\nfunction getCellBgColor(year: string, month: string, day: number): string {\n  if (isItalianHoliday(year, month, day)) {\n    return 'bg-yellow-50 dark:bg-yellow-950/20';\n  }\n\n  const dayOfWeek = getDayOfWeek(year, month, day);\n  if (dayOfWeek === 0) { // Sunday\n    return 'bg-red-50 dark:bg-red-950/20';\n  }\n  if (dayOfWeek === 6) { // Saturday\n    return 'bg-blue-50 dark:bg-blue-950/20';\n  }\n\n  return '';\n}\n\n// Get header background color\nfunction getHeaderBgColor(year: string, month: string, day: number): string {\n  if (isItalianHoliday(year, month, day)) {\n    return 'bg-yellow-200 dark:bg-yellow-900/40';\n  }\n\n  const dayOfWeek = getDayOfWeek(year, month, day);\n  if (dayOfWeek === 0) { // Sunday\n    return 'bg-red-200 dark:bg-red-900/40';\n  }\n  if (dayOfWeek === 6) { // Saturday\n    return 'bg-blue-200 dark:bg-blue-900/40';\n  }\n\n  return 'bg-muted';\n}\n\nexport default function AttendanceSheet() {\n  const currentDate = new Date();\n  const [selectedYear, setSelectedYear] = useState(currentDate.getFullYear().toString());\n  const [selectedMonth, setSelectedMonth] = useState((currentDate.getMonth() + 1).toString());\n  const [absenceDialogOpen, setAbsenceDialogOpen] = useState(false);\n  const [selectedCell, setSelectedCell] = useState<{\n    userId: string;\n    userName: string;\n    date: string;\n    day: number;\n  } | null>(null);\n  const [selectedAbsenceType, setSelectedAbsenceType] = useState<string>(\"\");\n\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Get attendance data\n  const { data: attendanceData = [], isLoading } = useQuery({\n    queryKey: [\"/api/attendance/monthly\", selectedYear, selectedMonth],\n    queryFn: async () => {\n      const res = await fetch(\n        `/api/attendance/monthly?year=${selectedYear}&month=${selectedMonth}`,\n        { credentials: \"include\" }\n      );\n      if (!res.ok) throw new Error(\"Failed to fetch attendance data\");\n      return res.json();\n    }\n  });\n\n  // Get attendance entries for the month\n  const { data: absenceEntries = [] } = useQuery({\n    queryKey: [\"/api/attendance-entries\", selectedYear, selectedMonth],\n    queryFn: async () => {\n      const res = await fetch(\n        `/api/attendance-entries?year=${selectedYear}&month=${selectedMonth}`,\n        { credentials: \"include\" }\n      );\n      if (!res.ok) throw new Error(\"Failed to fetch attendance entries\");\n      return res.json();\n    }\n  });\n\n  // Create absence mutation\n  const createAbsenceMutation = useMutation({\n    mutationFn: async (data: { userId: string; date: string; absenceType: string }) => {\n      return apiRequest(\"POST\", \"/api/attendance-entries\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance/monthly\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance-entries\"] });\n      toast({\n        title: \"Assenza aggiunta\",\n        description: \"L'assenza è stata registrata con successo\",\n      });\n      setAbsenceDialogOpen(false);\n      setSelectedCell(null);\n      setSelectedAbsenceType(\"\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante la registrazione dell'assenza\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delete absence mutation\n  const deleteAbsenceMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/attendance-entries/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance/monthly\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/attendance-entries\"] });\n      toast({\n        title: \"Assenza eliminata\",\n        description: \"L'assenza è stata rimossa con successo\",\n      });\n    },\n  });\n\n  const daysInMonth = new Date(\n    parseInt(selectedYear),\n    parseInt(selectedMonth),\n    0\n  ).getDate();\n\n  const handleCellClick = (userId: string, userName: string, day: number) => {\n    const date = `${selectedYear}-${selectedMonth.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;\n    setSelectedCell({ userId, userName, date, day });\n    setAbsenceDialogOpen(true);\n  };\n\n  const handleAddAbsence = () => {\n    if (!selectedCell || !selectedAbsenceType) return;\n\n    createAbsenceMutation.mutate({\n      userId: selectedCell.userId,\n      date: selectedCell.date,\n      absenceType: selectedAbsenceType,\n    });\n  };\n\n  const handleDeleteAbsence = (entryId: string) => {\n    deleteAbsenceMutation.mutate(entryId);\n  };\n\n  const handleExportExcel = () => {\n    window.open(\n      `/api/attendance/export-excel?year=${selectedYear}&month=${selectedMonth}`,\n      \"_blank\"\n    );\n  };\n\n  const getMonthName = (month: string) => {\n    const months = [\n      'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',\n      'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'\n    ];\n    return months[parseInt(month) - 1];\n  };\n\n  // Find absence entry for a specific user and date\n  const findAbsenceEntry = (userId: string, date: string) => {\n    return absenceEntries.find((e: any) => e.userId === userId && e.date === date);\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <CardTitle>Foglio Presenze</CardTitle>\n            <div className=\"flex gap-2\">\n              <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n                <SelectTrigger className=\"w-32\" data-testid=\"select-month\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {Array.from({ length: 12 }, (_, i) => (\n                    <SelectItem key={i + 1} value={(i + 1).toString()}>\n                      {getMonthName((i + 1).toString())}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <Select value={selectedYear} onValueChange={setSelectedYear}>\n                <SelectTrigger className=\"w-24\" data-testid=\"select-year\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {Array.from({ length: 5 }, (_, i) => (\n                    <SelectItem key={i} value={(currentDate.getFullYear() - 2 + i).toString()}>\n                      {currentDate.getFullYear() - 2 + i}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <Button \n                onClick={handleExportExcel}\n                data-testid=\"button-export-excel\"\n              >\n                <Download className=\"mr-2 h-4 w-4\" />\n                Esporta Excel\n              </Button>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {/* Legend - AGGIORNATA con \"A=Assente\" */}\n          <div className=\"mb-4 p-3 bg-muted rounded-md text-sm\">\n            <strong>Legenda:</strong> A=Assente | F=Ferie | P=Permessi | M=Malattia | CP=Congedo Parentale | L104=Legge 104\n          </div>\n\n          {isLoading ? (\n            <div className=\"text-center py-8\">Caricamento...</div>\n          ) : attendanceData.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Nessun dipendente trovato\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead className=\"sticky left-0 bg-background z-10 min-w-[150px]\">Nome</TableHead>\n                    <TableHead className=\"text-center w-12 bg-muted\">T</TableHead>\n                    {Array.from({ length: daysInMonth }, (_, i) => (\n                      <TableHead \n                        key={i + 1} \n                        className={`text-center w-8 p-1 ${getHeaderBgColor(selectedYear, selectedMonth, i + 1)}`}\n                      >\n                        {i + 1}\n                      </TableHead>\n                    ))}\n                    <TableHead className=\"text-center w-16 bg-muted\">TOT</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {attendanceData.map((employee: any) => {\n                    let totalOrdinary = 0;\n                    let totalOvertime = 0;\n\n                    return (\n                      <>\n                        {/* Row 1: Ordinarie */}\n                        <TableRow key={`${employee.userId}-ordinary`}>\n                          <TableCell rowSpan={2} className=\"sticky left-0 bg-background z-10 font-medium align-middle\">\n                            {employee.fullName}\n                          </TableCell>\n                          <TableCell className=\"text-center text-xs bg-muted/50\">O</TableCell>\n                          {Array.from({ length: daysInMonth }, (_, i) => {\n                            const day = i + 1;\n                            const date = `${selectedYear}-${selectedMonth.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;\n                            const dayData = employee.dailyData[date];\n                            const ordinary = dayData?.ordinary || 0;\n                            totalOrdinary += ordinary;\n\n                            return (\n                              <TableCell \n                                key={day} \n                                className={`text-center p-0.5 text-xs ${getCellBgColor(selectedYear, selectedMonth, day)}`}\n                              >\n                                {ordinary > 0 ? (ordinary === Math.floor(ordinary) ? ordinary : ordinary.toFixed(1)) : '-'}\n                              </TableCell>\n                            );\n                          })}\n                          <TableCell className=\"text-center text-xs font-medium bg-muted/50\">\n                            {totalOrdinary === Math.floor(totalOrdinary) ? totalOrdinary : totalOrdinary.toFixed(1)}\n                          </TableCell>\n                        </TableRow>\n\n                        {/* Row 2: Straordinari/Assenze */}\n                        <TableRow key={`${employee.userId}-overtime`} className=\"border-b-2\">\n                          <TableCell className=\"text-center text-xs bg-muted/30\">S</TableCell>\n                          {Array.from({ length: daysInMonth }, (_, i) => {\n                            const day = i + 1;\n                            const date = `${selectedYear}-${selectedMonth.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;\n                            const dayData = employee.dailyData[date];\n                            const overtime = dayData?.overtime || 0;\n                            const absence = dayData?.absence;\n                            const absenceEntry = findAbsenceEntry(employee.userId, date);\n                            totalOvertime += overtime;\n\n                            return (\n                              <TableCell \n                                key={day} \n                                className={`text-center p-0.5 text-xs ${!absence ? 'cursor-pointer hover-elevate' : ''} relative group ${getCellBgColor(selectedYear, selectedMonth, day)}`}\n                                onClick={() => !absence && !dayData?.ordinary && !overtime && handleCellClick(employee.userId, employee.fullName, day)}\n                                data-testid={`cell-absence-${employee.userId}-${day}`}\n                              >\n                                {absence ? (\n                                  <div className=\"flex items-center justify-center gap-0.5\">\n                                    <span className=\"font-medium\">{absence}</span>\n                                    {absenceEntry && (\n                                      <button\n                                        onClick={(e) => {\n                                          e.stopPropagation();\n                                          handleDeleteAbsence(absenceEntry.id);\n                                        }}\n                                        className=\"opacity-0 group-hover:opacity-100 transition-opacity\"\n                                        data-testid={`button-delete-absence-${absenceEntry.id}`}\n                                      >\n                                        <X className=\"h-3 w-3 text-destructive\" />\n                                      </button>\n                                    )}\n                                  </div>\n                                ) : overtime > 0 ? (\n                                  overtime === Math.floor(overtime) ? overtime : overtime.toFixed(1)\n                                ) : '-'}\n                              </TableCell>\n                            );\n                          })}\n                          <TableCell className=\"text-center text-xs font-medium bg-muted/30\">\n                            {totalOvertime === Math.floor(totalOvertime) ? totalOvertime : totalOvertime.toFixed(1)}\n                          </TableCell>\n                        </TableRow>\n                      </>\n                    );\n                  })}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Absence Dialog */}\n      <Dialog open={absenceDialogOpen} onOpenChange={setAbsenceDialogOpen}>\n        <DialogContent data-testid=\"dialog-add-absence\">\n          <DialogHeader>\n            <DialogTitle>Aggiungi Assenza</DialogTitle>\n            <DialogDescription>\n              {selectedCell && `${selectedCell.userName} - ${formatDateToItalian(selectedCell.date)}`}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label>Tipo Assenza</Label>\n              <Select value={selectedAbsenceType} onValueChange={setSelectedAbsenceType}>\n                <SelectTrigger data-testid=\"select-absence-type\">\n                  <SelectValue placeholder=\"Seleziona tipo assenza\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {Object.entries(ABSENCE_LABELS).map(([key, label]) => (\n                    <SelectItem key={key} value={key}>\n                      {key} - {label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setAbsenceDialogOpen(false)}\n              data-testid=\"button-cancel-absence\"\n            >\n              Annulla\n            </Button>\n            <Button\n              onClick={handleAddAbsence}\n              disabled={!selectedAbsenceType || createAbsenceMutation.isPending}\n              data-testid=\"button-save-absence\"\n            >\n              {createAbsenceMutation.isPending ? \"Salvataggio...\" : \"Salva\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","path":null,"size_bytes":17116,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/components/StatusBadge.tsx":{"content":"import { Badge } from \"@/components/ui/badge\";\nimport { Clock, CheckCircle } from \"lucide-react\";\nimport { Status } from \"@shared/schema\";\n\ninterface StatusBadgeProps {\n  status: Status;\n  viewMode?: 'employee' | 'admin';\n}\n\nexport default function StatusBadge({ status, viewMode = 'admin' }: StatusBadgeProps) {\n  const isPending = status === \"In attesa\";\n  \n  // Testi diversi per dipendente vs admin\n  const pendingText = viewMode === 'employee' ? 'Non inviato' : 'In attesa';\n  const approvedText = viewMode === 'employee' ? 'Inviato' : 'Confermato';\n  \n  return (\n    <Badge \n      variant=\"outline\"\n      className={`flex items-center gap-1 border-0 ${\n        isPending \n          ? 'bg-orange-500 text-white dark:bg-orange-500 dark:text-white' \n          : 'bg-green-500 text-black dark:bg-green-500 dark:text-black'\n      }`}\n      data-testid={`badge-status-${status.toLowerCase().replace(' ', '-')}`}\n    >\n      {isPending ? (\n        <>\n          <Clock className=\"h-3 w-3\" />\n          {pendingText}\n        </>\n      ) : (\n        <>\n          <CheckCircle className=\"h-3 w-3\" />\n          {approvedText}\n        </>\n      )}\n    </Badge>\n  );\n}","path":null,"size_bytes":1160,"size_tokens":null},"client/src/lib/dateUtils.ts":{"content":"/**\n * Re-export shared date utilities\n * This file maintains backward compatibility while using shared utilities\n */\nexport {\n  formatDateToItalian,\n  formatDateToItalianLong,\n  formatDateToISO,\n  getTodayItalian,\n  getTodayISO,\n  isValidItalianDate\n} from '../../../shared/dateUtils';\n","path":null,"size_bytes":287,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/WorkOrderReport.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ArrowLeft, FileText, Download, Loader2 } from \"lucide-react\";\nimport { formatDateToItalian } from \"@/lib/dateUtils\";\n\ninterface WorkOrderReportProps {\n  workOrderId: string;\n  workOrderNumber: string;\n  workOrderDescription: string;\n  clientName: string;\n  onBack: () => void;\n}\n\n// Interface for enriched operation data from API\ninterface EnrichedOperation {\n  id: string;\n  workTypes: string[];\n  materials: string[];\n  hours: number;\n  notes: string | null;\n  employeeName: string;\n  employeeId: string;\n  date: string;\n  clientName: string;\n  workOrderName: string;\n  reportStatus: string;\n}\n\n// Interface for employee row data\ninterface EmployeeReportRow {\n  date: string;\n  employeeName: string;\n  employeeId: string;\n  hours: number;\n  workTypes: string[];\n  materials: string[];\n  employeeNotes: string | null;\n  adminNotes: string;\n}\n\n// Function to create employee rows grouped by date\nfunction createEmployeeRows(operations: EnrichedOperation[]): EmployeeReportRow[] {\n  const groupedByDate = operations.reduce((acc, op) => {\n    if (!acc[op.date]) {\n      acc[op.date] = [];\n    }\n    acc[op.date].push(op);\n    return acc;\n  }, {} as Record<string, EnrichedOperation[]>);\n\n  const rows: EmployeeReportRow[] = [];\n  \n  Object.entries(groupedByDate)\n    .sort(([dateA], [dateB]) => new Date(dateA).getTime() - new Date(dateB).getTime())\n    .forEach(([date, ops]) => {\n      const employeeOps = ops.reduce((acc, op) => {\n        if (!acc[op.employeeId]) {\n          acc[op.employeeId] = [];\n        }\n        acc[op.employeeId].push(op);\n        return acc;\n      }, {} as Record<string, EnrichedOperation[]>);\n\n      Object.entries(employeeOps).forEach(([employeeId, empOps]) => {\n        const totalHours = empOps.reduce((sum, op) => sum + (Number(op.hours) || 0), 0);\n        const workTypes = Array.from(new Set(empOps.flatMap(op => op.workTypes)));\n        const materials = Array.from(new Set(empOps.flatMap(op => op.materials || [])));\n        const notes = empOps.map(op => op.notes).filter(n => n).join(\"; \") || null;\n        \n        rows.push({\n          date,\n          employeeName: empOps[0].employeeName,\n          employeeId,\n          hours: totalHours,\n          workTypes,\n          materials,\n          employeeNotes: notes,\n          adminNotes: \"\"\n        });\n      });\n    });\n\n  return rows;\n}\n\nexport default function WorkOrderReport({ \n  workOrderId,\n  workOrderNumber, \n  workOrderDescription, \n  clientName, \n  onBack \n}: WorkOrderReportProps) {\n  // Fetch operations for this work order\n  const { data: operations = [], isLoading, error } = useQuery<EnrichedOperation[]>({\n    queryKey: ['/api/work-orders', workOrderId, 'operations'],\n    enabled: !!workOrderId\n  });\n\n  // Create employee rows grouped by date\n  const reportData = createEmployeeRows(operations);\n  const [adminNotes, setAdminNotes] = useState<Record<string, string>>({});\n\n  const updateAdminNotes = (rowKey: string, notes: string) => {\n    setAdminNotes(prev => ({\n      ...prev,\n      [rowKey]: notes\n    }));\n  };\n\n  const totalProjectHours = reportData.reduce((sum: number, row: EmployeeReportRow) => sum + row.hours, 0);\n\n  const handleExportReport = async () => {\n    try {\n      const response = await fetch(`/api/export/work-order/${workOrderId}`);\n      \n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.error || 'Errore durante l\\'export');\n      }\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `Commessa_${workOrderNumber}_${new Date().toISOString().split('T')[0]}.docx`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      console.log('Work order export completed');\n    } catch (error: any) {\n      alert(error.message || 'Errore durante l\\'export del report');\n      console.error('Export error:', error);\n    }\n  };\n\n  return (\n    <div className=\"px-3 sm:px-6 py-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n        <div className=\"flex items-center gap-4\">\n          <Button \n            variant=\"outline\" \n            onClick={onBack}\n            data-testid=\"button-back-to-commesse\"\n          >\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Torna alle Commesse\n          </Button>\n          <div>\n            <h1 className=\"text-2xl font-semibold\">Report Finale Commessa</h1>\n            <p className=\"text-muted-foreground\">\n              {workOrderNumber} - {workOrderDescription}\n            </p>\n            <p className=\"text-sm text-muted-foreground\">\n              Cliente: <strong>{clientName}</strong>\n            </p>\n          </div>\n        </div>\n        \n        <div className=\"flex gap-2\">\n          <Button \n            variant=\"outline\"\n            onClick={handleExportReport}\n            data-testid=\"button-export-final-report\"\n          >\n            <Download className=\"h-4 w-4 mr-2\" />\n            Esporta Report\n          </Button>\n        </div>\n      </div>\n\n      {/* Summary Card */}\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div>\n              <p className=\"text-sm font-medium text-muted-foreground\">Giorni Lavorativi</p>\n              <p className=\"text-2xl font-bold\">\n                {new Set(reportData.map(row => row.date)).size}\n              </p>\n            </div>\n            <div>\n              <p className=\"text-sm font-medium text-muted-foreground\">Ore Totali Progetto</p>\n              <p className=\"text-2xl font-bold\">{totalProjectHours}h</p>\n            </div>\n            <div>\n              <p className=\"text-sm font-medium text-muted-foreground\">Dipendenti Coinvolti</p>\n              <p className=\"text-2xl font-bold\">\n                {new Set(reportData.map(row => row.employeeId)).size}\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Main Report Table - Compact Excel Style */}\n      <Card>\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"flex items-center gap-2 text-lg\">\n            <FileText className=\"h-4 w-4\" />\n            Report Giornaliero Commessa\n          </CardTitle>\n          <p className=\"text-xs text-muted-foreground\">\n            Aggregazione di tutti i rapportini approvati per questa commessa\n          </p>\n        </CardHeader>\n        <CardContent className=\"p-0\">\n          <div className=\"overflow-x-auto\" data-testid=\"scroll-table-workorder\">\n            <Table className=\"min-w-[900px]\">\n              <TableHeader>\n                <TableRow className=\"border-b\">\n                  <TableHead className=\"h-8 px-3 text-xs font-semibold w-[90px]\">Data</TableHead>\n                  <TableHead className=\"h-8 px-3 text-xs font-semibold w-[140px]\">Dipendente</TableHead>\n                  <TableHead className=\"h-8 px-3 text-xs font-semibold w-[80px]\">Ore</TableHead>\n                  <TableHead className=\"h-8 px-3 text-xs font-semibold min-w-[160px]\">Lavorazioni</TableHead>\n                  <TableHead className=\"h-8 px-3 text-xs font-semibold min-w-[160px]\">Materiali</TableHead>\n                  <TableHead className=\"h-8 px-3 text-xs font-semibold min-w-[180px]\">Note Dipendente</TableHead>\n                  <TableHead className=\"h-8 px-3 text-xs font-semibold min-w-[180px]\">Note Admin</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {reportData.length === 0 ? (\n                  <TableRow>\n                    <TableCell colSpan={7} className=\"h-20 text-center text-sm text-muted-foreground\">\n                      Nessuna operazione approvata per questa commessa\n                    </TableCell>\n                  </TableRow>\n                ) : (\n                  reportData.map((row: EmployeeReportRow, index: number) => {\n                    const rowKey = `${row.date}-${row.employeeId}`;\n                    const prevRow = index > 0 ? reportData[index - 1] : null;\n                    const showDate = !prevRow || prevRow.date !== row.date;\n                    \n                    return (\n                      <TableRow key={rowKey} className=\"hover-elevate\">\n                        <TableCell className=\"h-10 px-3 py-1 text-xs font-medium\">\n                          {showDate ? formatDateToItalian(row.date) : ''}\n                        </TableCell>\n                        <TableCell className=\"h-10 px-3 py-1 text-xs\">\n                          {row.employeeName}\n                        </TableCell>\n                        <TableCell className=\"h-10 px-3 py-1 text-xs font-medium\">\n                          {row.hours.toFixed(1)}h\n                        </TableCell>\n                        <TableCell className=\"h-10 px-3 py-1\">\n                          <div className=\"flex flex-wrap gap-1\">\n                            {row.workTypes.map((type: string, typeIndex: number) => (\n                              <Badge key={typeIndex} variant=\"secondary\" className=\"text-[10px] h-4 px-1.5 py-0\">\n                                {type}\n                              </Badge>\n                            ))}\n                          </div>\n                        </TableCell>\n                        <TableCell className=\"h-10 px-3 py-1\">\n                          <div className=\"flex flex-wrap gap-1\">\n                            {row.materials.length > 0 ? (\n                              row.materials.map((material: string, matIndex: number) => (\n                                <Badge key={matIndex} variant=\"outline\" className=\"text-[10px] h-4 px-1.5 py-0\">\n                                  {material}\n                                </Badge>\n                              ))\n                            ) : (\n                              <span className=\"text-xs text-muted-foreground\">-</span>\n                            )}\n                          </div>\n                        </TableCell>\n                        <TableCell className=\"h-10 px-3 py-1 text-xs text-muted-foreground\">\n                          {row.employeeNotes || '-'}\n                        </TableCell>\n                        <TableCell className=\"h-10 px-3 py-1\">\n                          <Input\n                            placeholder=\"Note...\"\n                            value={adminNotes[rowKey] || row.adminNotes}\n                            onChange={(e) => updateAdminNotes(rowKey, e.target.value)}\n                            className=\"text-xs h-7 px-2\"\n                            data-testid={`input-admin-notes-${index}`}\n                          />\n                        </TableCell>\n                      </TableRow>\n                    );\n                  })\n                )}\n              </TableBody>\n            </Table>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","path":null,"size_bytes":11491,"size_tokens":null},"server/db.ts":{"content":"import { Pool } from 'pg';\nimport { drizzle } from 'drizzle-orm/node-postgres';\nimport * as schema from \"@shared/schema\";\n\n// Build DATABASE_URL from PG* variables if not set\nlet connectionString = process.env.DATABASE_URL;\nif (!connectionString && process.env.PGHOST && process.env.PGUSER && process.env.PGPASSWORD && process.env.PGDATABASE) {\n  connectionString = `postgresql://${process.env.PGUSER}:${process.env.PGPASSWORD}@${process.env.PGHOST}:${process.env.PGPORT || 5432}/${process.env.PGDATABASE}?sslmode=require`;\n}\n\nif (!connectionString) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\n// Neon database requires SSL\nexport const pool = new Pool({ \n  connectionString,\n  max: 10,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 10000,\n  ssl: { rejectUnauthorized: false },\n});\n\npool.on('error', (err) => {\n  console.error('Unexpected database pool error:', err);\n});\n\npool.on('connect', (client) => {\n  client.on('error', (err) => {\n    console.error('Database client error:', err);\n  });\n});\n\nexport const db = drizzle(pool, { schema });\n","path":null,"size_bytes":1111,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"server/objectAcl.ts":{"content":"import { File } from \"@google-cloud/storage\";\n\nconst ACL_POLICY_METADATA_KEY = \"custom:aclPolicy\";\n\nexport enum ObjectAccessGroupType {\n  ORGANIZATION = \"organization\",\n}\n\nexport interface ObjectAccessGroup {\n  type: ObjectAccessGroupType;\n  id: string;\n}\n\nexport enum ObjectPermission {\n  READ = \"read\",\n  WRITE = \"write\",\n}\n\nexport interface ObjectAclRule {\n  group: ObjectAccessGroup;\n  permission: ObjectPermission;\n}\n\nexport interface ObjectAclPolicy {\n  owner: string;\n  organizationId: string;\n  visibility: \"public\" | \"private\";\n  aclRules?: Array<ObjectAclRule>;\n}\n\nfunction isPermissionAllowed(\n  requested: ObjectPermission,\n  granted: ObjectPermission,\n): boolean {\n  if (requested === ObjectPermission.READ) {\n    return [ObjectPermission.READ, ObjectPermission.WRITE].includes(granted);\n  }\n\n  return granted === ObjectPermission.WRITE;\n}\n\nabstract class BaseObjectAccessGroup implements ObjectAccessGroup {\n  constructor(\n    public readonly type: ObjectAccessGroupType,\n    public readonly id: string,\n  ) {}\n\n  public abstract hasMember(userId: string, organizationId: string): Promise<boolean>;\n}\n\nclass OrganizationAccessGroup extends BaseObjectAccessGroup {\n  constructor(organizationId: string) {\n    super(ObjectAccessGroupType.ORGANIZATION, organizationId);\n  }\n\n  public async hasMember(userId: string, organizationId: string): Promise<boolean> {\n    return this.id === organizationId;\n  }\n}\n\nfunction createObjectAccessGroup(\n  group: ObjectAccessGroup,\n): BaseObjectAccessGroup {\n  switch (group.type) {\n    case ObjectAccessGroupType.ORGANIZATION:\n      return new OrganizationAccessGroup(group.id);\n    default:\n      throw new Error(`Unknown access group type: ${group.type}`);\n  }\n}\n\nexport async function setObjectAclPolicy(\n  objectFile: File,\n  aclPolicy: ObjectAclPolicy,\n): Promise<void> {\n  const [exists] = await objectFile.exists();\n  if (!exists) {\n    throw new Error(`Object not found: ${objectFile.name}`);\n  }\n\n  await objectFile.setMetadata({\n    metadata: {\n      [ACL_POLICY_METADATA_KEY]: JSON.stringify(aclPolicy),\n    },\n  });\n}\n\nexport async function getObjectAclPolicy(\n  objectFile: File,\n): Promise<ObjectAclPolicy | null> {\n  const [metadata] = await objectFile.getMetadata();\n  const aclPolicy = metadata?.metadata?.[ACL_POLICY_METADATA_KEY];\n  if (!aclPolicy) {\n    return null;\n  }\n  return JSON.parse(aclPolicy as string);\n}\n\nexport async function canAccessObject({\n  userId,\n  organizationId,\n  objectFile,\n  requestedPermission,\n}: {\n  userId?: string;\n  organizationId?: string;\n  objectFile: File;\n  requestedPermission: ObjectPermission;\n}): Promise<boolean> {\n  const aclPolicy = await getObjectAclPolicy(objectFile);\n  if (!aclPolicy) {\n    return false;\n  }\n\n  if (\n    aclPolicy.visibility === \"public\" &&\n    requestedPermission === ObjectPermission.READ\n  ) {\n    return true;\n  }\n\n  if (!userId || !organizationId) {\n    return false;\n  }\n\n  if (aclPolicy.organizationId !== organizationId) {\n    return false;\n  }\n\n  if (aclPolicy.owner === userId) {\n    return true;\n  }\n\n  for (const rule of aclPolicy.aclRules || []) {\n    const accessGroup = createObjectAccessGroup(rule.group);\n    if (\n      (await accessGroup.hasMember(userId, organizationId)) &&\n      isPermissionAllowed(requestedPermission, rule.permission)\n    ) {\n      return true;\n    }\n  }\n\n  return false;\n}\n","path":null,"size_bytes":3346,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"server/objectStorage.ts":{"content":"import { Storage, File } from \"@google-cloud/storage\";\nimport { Response } from \"express\";\nimport { randomUUID } from \"crypto\";\nimport {\n  ObjectAclPolicy,\n  ObjectPermission,\n  canAccessObject,\n  getObjectAclPolicy,\n  setObjectAclPolicy,\n} from \"./objectAcl\";\n\nconst REPLIT_SIDECAR_ENDPOINT = \"http://127.0.0.1:1106\";\n\nexport const objectStorageClient = new Storage({\n  credentials: {\n    audience: \"replit\",\n    subject_token_type: \"access_token\",\n    token_url: `${REPLIT_SIDECAR_ENDPOINT}/token`,\n    type: \"external_account\",\n    credential_source: {\n      url: `${REPLIT_SIDECAR_ENDPOINT}/credential`,\n      format: {\n        type: \"json\",\n        subject_token_field_name: \"access_token\",\n      },\n    },\n    universe_domain: \"googleapis.com\",\n  },\n  projectId: \"\",\n});\n\nexport class ObjectNotFoundError extends Error {\n  constructor() {\n    super(\"Object not found\");\n    this.name = \"ObjectNotFoundError\";\n    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);\n  }\n}\n\nexport class ObjectStorageService {\n  constructor() {}\n\n  getPublicObjectSearchPaths(): Array<string> {\n    const pathsStr = process.env.PUBLIC_OBJECT_SEARCH_PATHS || \"\";\n    const paths = Array.from(\n      new Set(\n        pathsStr\n          .split(\",\")\n          .map((path) => path.trim())\n          .filter((path) => path.length > 0)\n      )\n    );\n    if (paths.length === 0) {\n      throw new Error(\n        \"PUBLIC_OBJECT_SEARCH_PATHS not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PUBLIC_OBJECT_SEARCH_PATHS env var (comma-separated paths).\"\n      );\n    }\n    return paths;\n  }\n\n  getPrivateObjectDir(): string {\n    const dir = process.env.PRIVATE_OBJECT_DIR || \"\";\n    if (!dir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n    return dir;\n  }\n\n  async searchPublicObject(filePath: string): Promise<File | null> {\n    for (const searchPath of this.getPublicObjectSearchPaths()) {\n      const fullPath = `${searchPath}/${filePath}`;\n\n      const { bucketName, objectName } = parseObjectPath(fullPath);\n      const bucket = objectStorageClient.bucket(bucketName);\n      const file = bucket.file(objectName);\n\n      const [exists] = await file.exists();\n      if (exists) {\n        return file;\n      }\n    }\n\n    return null;\n  }\n\n  async downloadObject(file: File, res: Response, cacheTtlSec: number = 3600) {\n    try {\n      const [metadata] = await file.getMetadata();\n      const aclPolicy = await getObjectAclPolicy(file);\n      const isPublic = aclPolicy?.visibility === \"public\";\n      \n      res.set({\n        \"Content-Type\": metadata.contentType || \"application/octet-stream\",\n        \"Content-Length\": metadata.size,\n        \"Cache-Control\": `${\n          isPublic ? \"public\" : \"private\"\n        }, max-age=${cacheTtlSec}`,\n      });\n\n      const stream = file.createReadStream();\n\n      stream.on(\"error\", (err: Error) => {\n        console.error(\"Stream error:\", err);\n        if (!res.headersSent) {\n          res.status(500).json({ error: \"Error streaming file\" });\n        }\n      });\n\n      stream.pipe(res);\n    } catch (error) {\n      console.error(\"Error downloading file:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ error: \"Error downloading file\" });\n      }\n    }\n  }\n\n  async getObjectEntityUploadURL(): Promise<string> {\n    const privateObjectDir = this.getPrivateObjectDir();\n    if (!privateObjectDir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n\n    const objectId = randomUUID();\n    const fullPath = `${privateObjectDir}/uploads/${objectId}`;\n\n    const { bucketName, objectName } = parseObjectPath(fullPath);\n\n    return signObjectURL({\n      bucketName,\n      objectName,\n      method: \"PUT\",\n      ttlSec: 900,\n    });\n  }\n\n  async getObjectEntityFile(objectPath: string): Promise<File> {\n    if (!objectPath.startsWith(\"/objects/\")) {\n      throw new ObjectNotFoundError();\n    }\n\n    const parts = objectPath.slice(1).split(\"/\");\n    if (parts.length < 2) {\n      throw new ObjectNotFoundError();\n    }\n\n    const entityId = parts.slice(1).join(\"/\");\n    let entityDir = this.getPrivateObjectDir();\n    if (!entityDir.endsWith(\"/\")) {\n      entityDir = `${entityDir}/`;\n    }\n    const objectEntityPath = `${entityDir}${entityId}`;\n    const { bucketName, objectName } = parseObjectPath(objectEntityPath);\n    const bucket = objectStorageClient.bucket(bucketName);\n    const objectFile = bucket.file(objectName);\n    const [exists] = await objectFile.exists();\n    if (!exists) {\n      throw new ObjectNotFoundError();\n    }\n    return objectFile;\n  }\n\n  normalizeObjectEntityPath(rawPath: string): string {\n    if (!rawPath.startsWith(\"https://storage.googleapis.com/\")) {\n      return rawPath;\n    }\n  \n    const url = new URL(rawPath);\n    const rawObjectPath = url.pathname;\n  \n    let objectEntityDir = this.getPrivateObjectDir();\n    // Ensure objectEntityDir has leading slash for comparison\n    if (!objectEntityDir.startsWith(\"/\")) {\n      objectEntityDir = `/${objectEntityDir}`;\n    }\n    if (!objectEntityDir.endsWith(\"/\")) {\n      objectEntityDir = `${objectEntityDir}/`;\n    }\n  \n    if (!rawObjectPath.startsWith(objectEntityDir)) {\n      return rawObjectPath;\n    }\n\n    const entityId = rawObjectPath.slice(objectEntityDir.length);\n    return `/objects/${entityId}`;\n  }\n\n  async trySetObjectEntityAclPolicy(\n    rawPath: string,\n    aclPolicy: ObjectAclPolicy\n  ): Promise<string> {\n    const normalizedPath = this.normalizeObjectEntityPath(rawPath);\n    if (!normalizedPath.startsWith(\"/\")) {\n      return normalizedPath;\n    }\n\n    const objectFile = await this.getObjectEntityFile(normalizedPath);\n    await setObjectAclPolicy(objectFile, aclPolicy);\n    return normalizedPath;\n  }\n\n  async canAccessObjectEntity({\n    userId,\n    organizationId,\n    objectFile,\n    requestedPermission,\n  }: {\n    userId?: string;\n    organizationId?: string;\n    objectFile: File;\n    requestedPermission?: ObjectPermission;\n  }): Promise<boolean> {\n    return canAccessObject({\n      userId,\n      organizationId,\n      objectFile,\n      requestedPermission: requestedPermission ?? ObjectPermission.READ,\n    });\n  }\n}\n\nfunction parseObjectPath(path: string): {\n  bucketName: string;\n  objectName: string;\n} {\n  if (!path.startsWith(\"/\")) {\n    path = `/${path}`;\n  }\n  const pathParts = path.split(\"/\");\n  if (pathParts.length < 3) {\n    throw new Error(\"Invalid path: must contain at least a bucket name\");\n  }\n\n  const bucketName = pathParts[1];\n  const objectName = pathParts.slice(2).join(\"/\");\n\n  return {\n    bucketName,\n    objectName,\n  };\n}\n\nasync function signObjectURL({\n  bucketName,\n  objectName,\n  method,\n  ttlSec,\n}: {\n  bucketName: string;\n  objectName: string;\n  method: \"GET\" | \"PUT\" | \"DELETE\" | \"HEAD\";\n  ttlSec: number;\n}): Promise<string> {\n  const request = {\n    bucket_name: bucketName,\n    object_name: objectName,\n    method,\n    expires_at: new Date(Date.now() + ttlSec * 1000).toISOString(),\n  };\n  const response = await fetch(\n    `${REPLIT_SIDECAR_ENDPOINT}/object-storage/signed-object-url`,\n    {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(request),\n    }\n  );\n  if (!response.ok) {\n    throw new Error(\n      `Failed to sign object URL, errorcode: ${response.status}, ` +\n        `make sure you're running on Replit`\n    );\n  }\n\n  const { signed_url: signedURL } = await response.json();\n  return signedURL;\n}\n","path":null,"size_bytes":7664,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"server/wordService.ts":{"content":"import { Document, Packer, Paragraph, Table, TableCell, TableRow, TextRun, ImageRun, HeadingLevel, AlignmentType, WidthType, BorderStyle } from 'docx';\nimport { storage } from './storage';\nimport { DailyReport, Operation, User, Client, WorkOrder } from '@shared/schema';\nimport { formatDateToItalianLong } from '../shared/dateUtils';\nimport { objectStorageClient } from './objectStorage';\nimport sharp from 'sharp';\nimport fs from 'fs';\nimport path from 'path';\n\nexport class WordService {\n  \n  async generateDailyReportWord(date: string, organizationId: string): Promise<Buffer> {\n    const reports = await storage.getDailyReportsByDate(date, organizationId);\n    \n    if (reports.length === 0) {\n      // Format date in Italian format for user-friendly error message\n      const [year, month, day] = date.split('-');\n      const italianDate = `${day}/${month}/${year}`;\n      throw new Error(`Nessun rapportino trovato per la data ${italianDate}. Verifica che ci siano rapportini approvati per questa data.`);\n    }\n\n    // Get all related data\n    const clients = await storage.getAllClients(organizationId);\n    const clientsMap = new Map(clients.map(c => [c.id, c]));\n    \n    // Get all work orders\n    const allWorkOrders: WorkOrder[] = [];\n    for (const client of clients) {\n      const workOrders = await storage.getWorkOrdersByClient(client.id, organizationId);\n      allWorkOrders.push(...workOrders);\n    }\n    const workOrdersMap = new Map(allWorkOrders.map(wo => [wo.id, wo]));\n\n    // Get all hours adjustments for these reports\n    const adjustmentsPromises = reports.map(r => storage.getHoursAdjustment(r.id, organizationId));\n    const adjustments = await Promise.all(adjustmentsPromises);\n    const adjustmentsMap = new Map(\n      adjustments\n        .filter((adj): adj is NonNullable<typeof adj> => adj !== undefined && adj !== null)\n        .map(adj => [adj.dailyReportId, adj])\n    );\n\n    // Build document sections\n    const documentSections: Paragraph[] = [];\n    \n    // Document header\n    documentSections.push(\n      new Paragraph({\n        text: 'METALTEC Scoccia S.R.L.',\n        heading: HeadingLevel.HEADING_1,\n        alignment: AlignmentType.CENTER,\n      }),\n      new Paragraph({\n        text: `Rapportini Giornalieri - ${this.formatDate(date)}`,\n        alignment: AlignmentType.CENTER,\n        spacing: { after: 400 }\n      }),\n      new Paragraph({ text: '' }) // Empty line\n    );\n    \n    // Build content for each employee\n    for (let i = 0; i < reports.length; i++) {\n      const report = reports[i];\n      const user = await storage.getUser(report.employeeId);\n      const operations = await storage.getOperationsByReportId(report.id);\n      const adjustment = adjustmentsMap.get(report.id);\n      \n      if (user && operations.length > 0) {\n        const employeeSection = await this.createEmployeeSection(\n          user,\n          report,\n          operations,\n          clientsMap,\n          workOrdersMap,\n          adjustment\n        );\n        documentSections.push(...employeeSection);\n        \n        // Add minimal spacing between employees\n        if (i < reports.length - 1) {\n          documentSections.push(\n            new Paragraph({\n              text: '─────────────────────────────────────────────────────────',\n              alignment: AlignmentType.CENTER,\n              spacing: { before: 100, after: 100 }\n            })\n          );\n        }\n      }\n    }\n\n    const doc = new Document({\n      sections: [{\n        properties: {},\n        children: documentSections\n      }]\n    });\n\n    return await Packer.toBuffer(doc);\n  }\n\n  // Calculate hours from the hours field (which is already a string like \"3.5\")\n  private parseHours(hoursStr: string): number {\n    const hours = parseFloat(hoursStr);\n    return isNaN(hours) ? 0 : hours;\n  }\n\n  private async createEmployeeSection(\n    user: User,\n    report: DailyReport,\n    operations: Operation[],\n    clientsMap: Map<string, Client>,\n    workOrdersMap: Map<string, WorkOrder>,\n    adjustment?: any\n  ): Promise<Paragraph[]> {\n    \n    let totalHours = operations.reduce((sum, op) => sum + this.parseHours(op.hours), 0);\n    const originalHours = totalHours;\n    \n    // Apply hours adjustment if exists\n    if (adjustment) {\n      const adjustmentValue = parseFloat(adjustment.adjustment);\n      if (!isNaN(adjustmentValue)) {\n        totalHours += adjustmentValue;\n      }\n    }\n    \n    const sections: Paragraph[] = [];\n    \n    // Employee name and status\n    sections.push(\n      new Paragraph({\n        children: [\n          new TextRun({\n            text: user.fullName,\n            bold: true,\n            size: 28\n          }),\n          new TextRun({\n            text: `     [${report.status}]`,\n            bold: true,\n            size: 24,\n            color: report.status === 'Approvato' ? '16a34a' : 'eab308'\n          })\n        ],\n        spacing: { before: 300, after: 200 }\n      })\n    );\n\n    // Create operations table\n    const tableRows: TableRow[] = [];\n    \n    // Header row\n    tableRows.push(\n      new TableRow({\n        tableHeader: true,\n        children: [\n          new TableCell({\n            children: [new Paragraph({ text: 'Cliente', alignment: AlignmentType.CENTER })],\n            shading: { fill: 'E5E7EB' },\n            width: { size: 15, type: WidthType.PERCENTAGE }\n          }),\n          new TableCell({\n            children: [new Paragraph({ text: 'Commessa', alignment: AlignmentType.CENTER })],\n            shading: { fill: 'E5E7EB' },\n            width: { size: 20, type: WidthType.PERCENTAGE }\n          }),\n          new TableCell({\n            children: [new Paragraph({ text: 'Lavorazione', alignment: AlignmentType.CENTER })],\n            shading: { fill: 'E5E7EB' },\n            width: { size: 25, type: WidthType.PERCENTAGE }\n          }),\n          new TableCell({\n            children: [new Paragraph({ text: 'Ore', alignment: AlignmentType.CENTER })],\n            shading: { fill: 'E5E7EB' },\n            width: { size: 10, type: WidthType.PERCENTAGE }\n          }),\n          new TableCell({\n            children: [new Paragraph({ text: 'Note', alignment: AlignmentType.CENTER })],\n            shading: { fill: 'E5E7EB' },\n            width: { size: 30, type: WidthType.PERCENTAGE }\n          })\n        ]\n      })\n    );\n\n    // Add operation rows\n    operations.forEach(op => {\n      const client = clientsMap.get(op.clientId);\n      const workOrder = workOrdersMap.get(op.workOrderId);\n      const hours = this.parseHours(op.hours);\n      \n      tableRows.push(\n        new TableRow({\n          children: [\n            new TableCell({\n              children: [new Paragraph({ text: client?.name || 'N/A' })]\n            }),\n            new TableCell({\n              children: [new Paragraph({ text: workOrder?.name || 'N/A' })]\n            }),\n            new TableCell({\n              children: [new Paragraph({ text: op.workTypes.join(', ') })]\n            }),\n            new TableCell({\n              children: [new Paragraph({ text: hours.toFixed(1) + 'h', alignment: AlignmentType.CENTER })]\n            }),\n            new TableCell({\n              children: [new Paragraph({ text: op.notes || '-' })]\n            })\n          ]\n        })\n      );\n    });\n\n    // Add total row\n    tableRows.push(\n      new TableRow({\n        children: [\n          new TableCell({ children: [new Paragraph({ text: '' })] }),\n          new TableCell({ children: [new Paragraph({ text: '' })] }),\n          new TableCell({\n            children: [new Paragraph({\n              children: [new TextRun({ text: 'TOTALE:', bold: true })],\n              alignment: AlignmentType.RIGHT\n            })],\n            shading: { fill: 'F3F4F6' }\n          }),\n          new TableCell({\n            children: [new Paragraph({\n              children: adjustment ? [\n                new TextRun({ text: originalHours.toFixed(1) + 'h ', bold: true }),\n                new TextRun({ \n                  text: `(aggiustamento: ${parseFloat(adjustment.adjustment) >= 0 ? '+' : ''}${parseFloat(adjustment.adjustment).toFixed(1)}h) `,\n                  size: 20\n                }),\n                new TextRun({ text: '= ' + totalHours.toFixed(1) + 'h', bold: true })\n              ] : [\n                new TextRun({ text: totalHours.toFixed(1) + 'h', bold: true })\n              ],\n              alignment: AlignmentType.CENTER\n            })],\n            shading: { fill: 'F3F4F6' }\n          }),\n          new TableCell({\n            children: [new Paragraph({ text: '' })],\n            shading: { fill: 'F3F4F6' }\n          })\n        ]\n      })\n    );\n\n    // Add the table directly (not inside a Paragraph)\n    sections.push(\n      new Table({\n        width: { size: 100, type: WidthType.PERCENTAGE },\n        rows: tableRows,\n        borders: {\n          top: { style: BorderStyle.SINGLE, size: 1, color: 'CCCCCC' },\n          bottom: { style: BorderStyle.SINGLE, size: 1, color: 'CCCCCC' },\n          left: { style: BorderStyle.SINGLE, size: 1, color: 'CCCCCC' },\n          right: { style: BorderStyle.SINGLE, size: 1, color: 'CCCCCC' },\n          insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: 'EEEEEE' },\n          insideVertical: { style: BorderStyle.SINGLE, size: 1, color: 'EEEEEE' }\n        }\n      }) as any\n    );\n    \n\n    // Add photos for each operation that has them\n    for (let i = 0; i < operations.length; i++) {\n      const op = operations[i];\n      if (op.photos && op.photos.length > 0) {\n        const client = clientsMap.get(op.clientId);\n        const workOrder = workOrdersMap.get(op.workOrderId);\n        \n        // Load photos in parallel\n        const photoPromises = op.photos.map(photoPath => this.getPhotoAsBuffer(photoPath, 300));\n        const photoData = await Promise.all(photoPromises);\n        \n        // Filter out null values\n        const validPhotos = photoData.filter(data => data !== null) as { buffer: Buffer; width: number; height: number }[];\n        \n        if (validPhotos.length > 0) {\n          // Add section header for photos\n          sections.push(\n            new Paragraph({\n              children: [new TextRun({\n                text: `Foto Operazione ${i + 1} - ${client?.name || 'N/A'} / ${workOrder?.name || 'N/A'}`,\n                bold: true\n              })],\n              spacing: { before: 300, after: 100 }\n            })\n          );\n          \n          // Add images in a paragraph (horizontal layout) with preserved aspect ratio\n          const imageRuns: ImageRun[] = validPhotos.map(photo => \n            new ImageRun({\n              type: 'jpg',\n              data: photo.buffer,\n              transformation: {\n                width: photo.width,\n                height: photo.height\n              }\n            })\n          );\n          \n          // Create paragraph with images (with spacing between them using TextRun spacers)\n          const imageChildren: (ImageRun | TextRun)[] = [];\n          imageRuns.forEach((img, idx) => {\n            imageChildren.push(img);\n            if (idx < imageRuns.length - 1) {\n              // Add spacing between images\n              imageChildren.push(new TextRun({ text: '  ' }));\n            }\n          });\n          \n          sections.push(\n            new Paragraph({\n              children: imageChildren,\n              spacing: { after: 200 }\n            })\n          );\n        }\n      }\n    }\n\n    return sections;\n  }\n\n  private formatDate(dateStr: string): string {\n    return formatDateToItalianLong(dateStr);\n  }\n\n  private async getPhotoAsBuffer(photoPath: string, maxWidth: number = 300): Promise<{ buffer: Buffer; width: number; height: number } | null> {\n    try {\n      // Parse bucket name and object path from the photo path\n      // photoPath format: \"operations/photos/xxxxx.jpg\"\n      const bucketId = process.env.DEFAULT_OBJECT_STORAGE_BUCKET_ID;\n      if (!bucketId) {\n        console.warn('DEFAULT_OBJECT_STORAGE_BUCKET_ID not set');\n        return null;\n      }\n\n      const bucket = objectStorageClient.bucket(bucketId);\n      const file = bucket.file(photoPath);\n      \n      // Check if file exists\n      const [exists] = await file.exists();\n      if (!exists) {\n        console.warn(`Photo not found: ${photoPath}`);\n        return null;\n      }\n\n      // Download file as buffer\n      const [buffer] = await file.download();\n      \n      // Resize and compress image using Sharp\n      const resizedBuffer = await sharp(buffer)\n        .resize(maxWidth, null, { \n          fit: 'inside',\n          withoutEnlargement: true \n        })\n        .jpeg({ quality: 80 })\n        .toBuffer({ resolveWithObject: true });\n      \n      // Return buffer with actual dimensions\n      return {\n        buffer: resizedBuffer.data,\n        width: resizedBuffer.info.width,\n        height: resizedBuffer.info.height\n      };\n    } catch (error) {\n      console.error(`Error loading photo ${photoPath}:`, error);\n      return null;\n    }\n  }\n\n  async generateWorkOrderReportWord(workOrderId: string, organizationId: string): Promise<Buffer> {\n    const workOrder = await storage.getWorkOrder(workOrderId, organizationId);\n    \n    if (!workOrder) {\n      throw new Error(`Commessa non trovata`);\n    }\n\n    const client = (await storage.getAllClients(organizationId)).find(c => c.id === workOrder.clientId);\n    const operations = await storage.getOperationsByWorkOrderId(workOrderId, organizationId);\n\n    // Filter only operations from approved reports\n    const dailyReports = await storage.getAllDailyReports(organizationId);\n    const approvedOperations = operations.filter(op => {\n      const report = dailyReports.find(r => r.id === op.dailyReportId);\n      return report?.status === 'Approvato';\n    });\n\n    if (approvedOperations.length === 0) {\n      throw new Error(`Nessuna operazione approvata trovata per la commessa \"${workOrder.name}\"`);\n    }\n\n    // Get employee data for each operation\n    const enrichedOperations = await Promise.all(\n      approvedOperations.map(async (op) => {\n        const report = dailyReports.find(r => r.id === op.dailyReportId);\n        const employee = report ? await storage.getUser(report.employeeId) : null;\n        return {\n          ...op,\n          employeeName: employee?.fullName || 'Dipendente sconosciuto',\n          date: report?.date || 'N/A'\n        };\n      })\n    );\n\n    // Sort by date\n    enrichedOperations.sort((a, b) => a.date.localeCompare(b.date));\n\n    const documentSections: (Paragraph | Table)[] = [];\n    \n    // Document header\n    documentSections.push(\n      new Paragraph({\n        text: 'METALTEC Scoccia S.R.L.',\n        heading: HeadingLevel.HEADING_1,\n        alignment: AlignmentType.CENTER,\n      }),\n      new Paragraph({\n        text: `Report Commessa`,\n        alignment: AlignmentType.CENTER,\n        spacing: { after: 200 }\n      }),\n      new Paragraph({ text: '' })\n    );\n\n    // Work order details\n    documentSections.push(\n      new Paragraph({\n        children: [\n          new TextRun({ text: 'Commessa: ', bold: true }),\n          new TextRun({ text: workOrder.name })\n        ]\n      }),\n      new Paragraph({\n        children: [\n          new TextRun({ text: 'Cliente: ', bold: true }),\n          new TextRun({ text: client?.name || 'N/A' })\n        ]\n      })\n    );\n\n    if (workOrder.description) {\n      documentSections.push(\n        new Paragraph({\n          children: [\n            new TextRun({ text: 'Descrizione: ', bold: true }),\n            new TextRun({ text: workOrder.description })\n          ]\n        })\n      );\n    }\n\n    documentSections.push(new Paragraph({ text: '', spacing: { after: 300 } }));\n\n    // Operations table\n    const tableRows: TableRow[] = [];\n    \n    // Header row\n    tableRows.push(\n      new TableRow({\n        tableHeader: true,\n        children: [\n          new TableCell({\n            children: [new Paragraph({ text: 'Data', alignment: AlignmentType.CENTER })],\n            shading: { fill: 'E5E7EB' },\n            width: { size: 12, type: WidthType.PERCENTAGE }\n          }),\n          new TableCell({\n            children: [new Paragraph({ text: 'Dipendente', alignment: AlignmentType.CENTER })],\n            shading: { fill: 'E5E7EB' },\n            width: { size: 18, type: WidthType.PERCENTAGE }\n          }),\n          new TableCell({\n            children: [new Paragraph({ text: 'Tipo Lavorazione', alignment: AlignmentType.CENTER })],\n            shading: { fill: 'E5E7EB' },\n            width: { size: 22, type: WidthType.PERCENTAGE }\n          }),\n          new TableCell({\n            children: [new Paragraph({ text: 'Materiali', alignment: AlignmentType.CENTER })],\n            shading: { fill: 'E5E7EB' },\n            width: { size: 18, type: WidthType.PERCENTAGE }\n          }),\n          new TableCell({\n            children: [new Paragraph({ text: 'Ore', alignment: AlignmentType.CENTER })],\n            shading: { fill: 'E5E7EB' },\n            width: { size: 8, type: WidthType.PERCENTAGE }\n          }),\n          new TableCell({\n            children: [new Paragraph({ text: 'Note', alignment: AlignmentType.CENTER })],\n            shading: { fill: 'E5E7EB' },\n            width: { size: 22, type: WidthType.PERCENTAGE }\n          })\n        ]\n      })\n    );\n\n    // Add operation rows\n    let totalHours = 0;\n    enrichedOperations.forEach(op => {\n      const hours = this.parseHours(op.hours);\n      totalHours += hours;\n      \n      const [year, month, day] = op.date.split('-');\n      const formattedDate = `${day}/${month}/${year}`;\n      \n      tableRows.push(\n        new TableRow({\n          children: [\n            new TableCell({\n              children: [new Paragraph({ text: formattedDate })]\n            }),\n            new TableCell({\n              children: [new Paragraph({ text: op.employeeName })]\n            }),\n            new TableCell({\n              children: [new Paragraph({ text: op.workTypes.join(', ') })]\n            }),\n            new TableCell({\n              children: [new Paragraph({ text: (op.materials && op.materials.length > 0) ? op.materials.join(', ') : '-' })]\n            }),\n            new TableCell({\n              children: [new Paragraph({ text: hours.toFixed(1) + 'h', alignment: AlignmentType.CENTER })]\n            }),\n            new TableCell({\n              children: [new Paragraph({ text: op.notes || '-' })]\n            })\n          ]\n        })\n      );\n    });\n\n    // Add total row\n    tableRows.push(\n      new TableRow({\n        children: [\n          new TableCell({ children: [new Paragraph({ text: '' })] }),\n          new TableCell({ children: [new Paragraph({ text: '' })] }),\n          new TableCell({ children: [new Paragraph({ text: '' })] }),\n          new TableCell({\n            children: [new Paragraph({\n              children: [new TextRun({ text: 'TOTALE ORE:', bold: true })],\n              alignment: AlignmentType.RIGHT\n            })],\n            shading: { fill: 'F3F4F6' }\n          }),\n          new TableCell({\n            children: [new Paragraph({\n              children: [new TextRun({ text: totalHours.toFixed(1) + 'h', bold: true })],\n              alignment: AlignmentType.CENTER\n            })],\n            shading: { fill: 'F3F4F6' }\n          }),\n          new TableCell({\n            children: [new Paragraph({ text: '' })],\n            shading: { fill: 'F3F4F6' }\n          })\n        ]\n      })\n    );\n\n    // Add table\n    documentSections.push(\n      new Table({\n        width: { size: 100, type: WidthType.PERCENTAGE },\n        rows: tableRows,\n        borders: {\n          top: { style: BorderStyle.SINGLE, size: 1, color: 'CCCCCC' },\n          bottom: { style: BorderStyle.SINGLE, size: 1, color: 'CCCCCC' },\n          left: { style: BorderStyle.SINGLE, size: 1, color: 'CCCCCC' },\n          right: { style: BorderStyle.SINGLE, size: 1, color: 'CCCCCC' },\n          insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: 'EEEEEE' },\n          insideVertical: { style: BorderStyle.SINGLE, size: 1, color: 'EEEEEE' }\n        }\n      }) as any\n    );\n\n\n    const doc = new Document({\n      sections: [{\n        properties: {},\n        children: documentSections\n      }]\n    });\n\n    return await Packer.toBuffer(doc);\n  }\n\n  async generateDailyReportWordRange(filters: {\n    fromDate?: string;\n    toDate?: string;\n    status?: string;\n    searchTerm?: string;\n  }, organizationId: string): Promise<Buffer> {\n    // Get all reports\n    let allReports = await storage.getAllDailyReports(organizationId);\n    \n    // Apply filters\n    let filteredReports = allReports;\n    \n    // Filter by date range\n    // Use string comparison directly since YYYY-MM-DD is lexicographically sortable\n    if (filters.fromDate || filters.toDate) {\n      filteredReports = filteredReports.filter(report => {\n        const reportDate = report.date;\n        \n        if (filters.fromDate && filters.toDate) {\n          return reportDate >= filters.fromDate && reportDate <= filters.toDate;\n        } else if (filters.fromDate) {\n          return reportDate >= filters.fromDate;\n        } else if (filters.toDate) {\n          return reportDate <= filters.toDate;\n        }\n        return true;\n      });\n    }\n    \n    // Filter by status\n    if (filters.status && filters.status !== 'all') {\n      filteredReports = filteredReports.filter(report => report.status === filters.status);\n    }\n    \n    // Filter by search term (employee name)\n    if (filters.searchTerm) {\n      const users = await storage.getAllUsers(organizationId);\n      const usersMap = new Map(users.map(u => [u.id, u]));\n      filteredReports = filteredReports.filter(report => {\n        const user = usersMap.get(report.employeeId);\n        return user?.fullName.toLowerCase().includes(filters.searchTerm!.toLowerCase());\n      });\n    }\n    \n    if (filteredReports.length === 0) {\n      throw new Error('Nessun rapportino trovato con i filtri specificati.');\n    }\n\n    // Get all related data\n    const clients = await storage.getAllClients(organizationId);\n    const clientsMap = new Map(clients.map(c => [c.id, c]));\n    \n    // Get all work orders\n    const allWorkOrders: WorkOrder[] = [];\n    for (const client of clients) {\n      const workOrders = await storage.getWorkOrdersByClient(client.id, organizationId);\n      allWorkOrders.push(...workOrders);\n    }\n    const workOrdersMap = new Map(allWorkOrders.map(wo => [wo.id, wo]));\n\n    // Get all hours adjustments for these reports\n    const adjustmentsPromises = filteredReports.map(r => storage.getHoursAdjustment(r.id, organizationId));\n    const adjustments = await Promise.all(adjustmentsPromises);\n    const adjustmentsMap = new Map(\n      adjustments\n        .filter((adj): adj is NonNullable<typeof adj> => adj !== undefined && adj !== null)\n        .map(adj => [adj.dailyReportId, adj])\n    );\n\n    // Build document sections\n    const documentSections: Paragraph[] = [];\n    \n    // Document header\n    let dateRange = '';\n    if (filters.fromDate && filters.toDate) {\n      dateRange = `${this.formatDate(filters.fromDate)} - ${this.formatDate(filters.toDate)}`;\n    } else if (filters.fromDate) {\n      dateRange = `da ${this.formatDate(filters.fromDate)}`;\n    } else if (filters.toDate) {\n      dateRange = `fino a ${this.formatDate(filters.toDate)}`;\n    } else {\n      dateRange = 'Tutti i rapportini';\n    }\n    \n    documentSections.push(\n      new Paragraph({\n        text: 'METALTEC Scoccia S.R.L.',\n        heading: HeadingLevel.HEADING_1,\n        alignment: AlignmentType.CENTER,\n      }),\n      new Paragraph({\n        text: `Rapportini Giornalieri - ${dateRange}`,\n        alignment: AlignmentType.CENTER,\n        spacing: { after: 400 }\n      }),\n      new Paragraph({ text: '' }) // Empty line\n    );\n    \n    // Build content for each report\n    for (let i = 0; i < filteredReports.length; i++) {\n      const report = filteredReports[i];\n      const user = await storage.getUser(report.employeeId);\n      const operations = await storage.getOperationsByReportId(report.id);\n      const adjustment = adjustmentsMap.get(report.id);\n      \n      if (user && operations.length > 0) {\n        const employeeSection = await this.createEmployeeSection(\n          user,\n          report,\n          operations,\n          clientsMap,\n          workOrdersMap,\n          adjustment\n        );\n        documentSections.push(...employeeSection);\n        \n        // Add minimal spacing between employees\n        if (i < filteredReports.length - 1) {\n          documentSections.push(\n            new Paragraph({\n              text: '─────────────────────────────────────────────────────────',\n              alignment: AlignmentType.CENTER,\n              spacing: { before: 100, after: 100 }\n            })\n          );\n        }\n      }\n    }\n\n    const doc = new Document({\n      sections: [{\n        properties: {},\n        children: documentSections\n      }]\n    });\n\n    return await Packer.toBuffer(doc);\n  }\n}\n","path":null,"size_bytes":25166,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"design_guidelines.md":{"content":"# Daily Work Report Management App - Design Guidelines\n\n## Design Approach\n**Utility-Focused Design System Approach** - This application prioritizes efficiency and usability for daily work tasks. Drawing inspiration from productivity tools like Linear and Notion, with emphasis on clean data entry and clear administrative workflows.\n\n## Core Design Elements\n\n### A. Color Palette\n**Primary Colors:**\n- Dark mode: 220 15% 95% (light text)\n- Light mode: 220 15% 15% (dark text)\n- Background dark: 220 15% 8%\n- Background light: 220 15% 98%\n\n**Accent Colors:**\n- Success (approved reports): 142 76% 36%\n- Warning (pending reports): 38 92% 50%\n- Primary action: 217 91% 60%\n\n### B. Typography\n- **Primary Font:** Inter (Google Fonts)\n- **Headers:** font-semibold (600) for section titles\n- **Body:** font-normal (400) for content\n- **Labels:** font-medium (500) for form labels\n- **Sizes:** text-sm for labels, text-base for inputs, text-lg for headers\n\n### C. Layout System\n**Spacing Units:** Consistent use of Tailwind units 2, 4, 6, and 8\n- Form spacing: p-4, gap-4\n- Section spacing: p-6, mb-8\n- Component margins: m-2, mt-4\n\n### D. Component Library\n\n**Mobile Employee Interface:**\n- **Daily Report Cards:** Clean white/dark cards with rounded-lg borders\n- **Operation Entry Forms:** Stacked layout with full-width inputs\n- **Dropdown Menus:** Native mobile-friendly selectors with clear labels\n- **Time Input:** Number inputs with clear hour indicators\n- **Status Badges:** Rounded-full badges with appropriate color coding\n\n**Desktop Admin Interface:**\n- **Data Tables:** Stripe pattern with hover states for row scanning\n- **Filter Panels:** Sidebar or top-bar filters with clear reset options\n- **Report Cards:** Grid layout with expandable details\n- **Action Buttons:** Primary (solid) for approve, secondary (outline) for edit\n\n**Navigation:**\n- **Mobile:** Bottom tab navigation for employees\n- **Desktop:** Sidebar navigation for admin with collapsible sections\n\n### E. User Experience Patterns\n\n**Employee Workflow:**\n- Single-page report creation with progressive disclosure\n- Auto-save drafts functionality indication\n- Clear visual hierarchy: Client → Commessa → Work Type → Hours\n- Prominent submit button with confirmation states\n\n**Admin Workflow:**\n- Dashboard overview with key metrics cards\n- Batch operations for report approval\n- Quick-filter chips for common searches\n- Expandable report details without page navigation\n\n**Form Design:**\n- Grouped related fields with subtle background differentiation\n- Required field indicators with asterisks\n- Inline validation with clear error messaging\n- Mobile-optimized touch targets (minimum 44px)\n\n## Key Design Principles\n1. **Mobile-First:** Employee interface optimized for smartphone data entry\n2. **Information Density:** Admin interface balances detail with scannability\n3. **Status Clarity:** Visual indicators for report states throughout the interface\n4. **Workflow Efficiency:** Minimize clicks and cognitive load for daily tasks\n5. **Consistent Patterns:** Unified component behavior across user roles\n\n## Images\nNo hero images required. This is a utility application focusing on clean interface design with occasional small icons for work types (cutting, welding, assembly) using Heroicons library.","path":null,"size_bytes":3282,"size_tokens":null},"client/src/components/examples/AdminDashboard.tsx":{"content":"import AdminDashboard from \"../AdminDashboard\";\n\nexport default function AdminDashboardExample() {\n  return <AdminDashboard />;\n}","path":null,"size_bytes":129,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"server/excelService.ts":{"content":"import ExcelJS from 'exceljs';\nimport { storage } from './storage';\nimport { formatDateToItalian } from '../shared/dateUtils';\nimport { isItalianHoliday, isSaturday, isSunday, getDaysInMonth } from '../shared/holidays';\n\nexport async function generateAttendanceExcel(\n  organizationId: string,\n  year: string,\n  month: string\n): Promise<ExcelJS.Buffer> {\n  const workbook = new ExcelJS.Workbook();\n  const worksheet = workbook.addWorksheet('Foglio Presenze');\n\n  // Get attendance data\n  const attendanceData = await storage.getMonthlyAttendance(organizationId, year, month);\n  \n  const yearNum = parseInt(year);\n  const monthNum = parseInt(month);\n  const daysInMonth = getDaysInMonth(yearNum, monthNum);\n\n  // Set column widths (ultra-compact: 2 characters)\n  worksheet.getColumn(1).width = 15; // Nome column\n  worksheet.getColumn(2).width = 5;  // Tipo column (O/S)\n  for (let i = 3; i <= daysInMonth + 2; i++) {\n    worksheet.getColumn(i).width = 4; // Day columns (ultra-compact)\n  }\n  worksheet.getColumn(daysInMonth + 3).width = 6; // TOT column\n\n  // Title row\n  const titleRow = worksheet.addRow([`FOGLIO PRESENZE - ${getMonthName(monthNum)} ${year}`]);\n  titleRow.font = { bold: true, size: 14 };\n  worksheet.mergeCells(1, 1, 1, daysInMonth + 3);\n  titleRow.alignment = { horizontal: 'center', vertical: 'middle' };\n  titleRow.height = 25;\n\n  // Legend row\n  const legendRow = worksheet.addRow(['Legenda: F=Ferie | P=Permessi | M=Malattia | CP=Cong.Parent. | L104=Legge104']);\n  legendRow.font = { size: 9, italic: true };\n  worksheet.mergeCells(2, 1, 2, daysInMonth + 3);\n  legendRow.alignment = { horizontal: 'left', vertical: 'middle' };\n  legendRow.height = 18;\n\n  // Empty row\n  worksheet.addRow([]);\n\n  // Header row\n  const headerRow = worksheet.addRow(['Nome', 'T', ...Array.from({ length: daysInMonth }, (_, i) => i + 1), 'TOT']);\n  headerRow.font = { bold: true, size: 10 };\n  headerRow.alignment = { horizontal: 'center', vertical: 'middle' };\n  headerRow.height = 20;\n  \n  // Style header row\n  headerRow.eachCell((cell) => {\n    cell.fill = {\n      type: 'pattern',\n      pattern: 'solid',\n      fgColor: { argb: 'FFD9D9D9' }\n    };\n    cell.border = {\n      top: { style: 'thin' },\n      left: { style: 'thin' },\n      bottom: { style: 'thin' },\n      right: { style: 'thin' }\n    };\n  });\n\n  // Color day columns based on day of week and holidays\n  for (let day = 1; day <= daysInMonth; day++) {\n    const dateStr = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;\n    const colIndex = day + 2; // +2 because first two columns are Nome and Tipo\n    const cell = headerRow.getCell(colIndex);\n    \n    if (isItalianHoliday(dateStr)) {\n      cell.fill = {\n        type: 'pattern',\n        pattern: 'solid',\n        fgColor: { argb: 'FFFFD700' } // Gold for holidays\n      };\n    } else if (isSunday(dateStr)) {\n      cell.fill = {\n        type: 'pattern',\n        pattern: 'solid',\n        fgColor: { argb: 'FFFFC0CB' } // Light pink for Sundays\n      };\n    } else if (isSaturday(dateStr)) {\n      cell.fill = {\n        type: 'pattern',\n        pattern: 'solid',\n        fgColor: { argb: 'FFADD8E6' } // Light blue for Saturdays\n      };\n    }\n  }\n\n  // Add employee rows\n  attendanceData.forEach((employee: any) => {\n    // Row 1: Ordinarie\n    const ordinaryValues: (string | number)[] = [employee.fullName, 'O'];\n    let totalOrdinary = 0;\n    \n    for (let day = 1; day <= daysInMonth; day++) {\n      const dateStr = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;\n      const dayData = employee.dailyData[dateStr];\n      \n      if (dayData && dayData.ordinary > 0) {\n        ordinaryValues.push(dayData.ordinary === Math.floor(dayData.ordinary) \n          ? dayData.ordinary \n          : dayData.ordinary.toFixed(1));\n        totalOrdinary += dayData.ordinary;\n      } else {\n        ordinaryValues.push('-');\n      }\n    }\n    \n    ordinaryValues.push(totalOrdinary === Math.floor(totalOrdinary) \n      ? totalOrdinary \n      : totalOrdinary.toFixed(1));\n    \n    const row1 = worksheet.addRow(ordinaryValues);\n    row1.height = 16;\n    row1.alignment = { horizontal: 'center', vertical: 'middle' };\n    row1.font = { size: 9 };\n    \n    // Row 2: Straordinari/Assenze\n    const overtimeValues: (string | number)[] = ['', 'S'];\n    let totalOvertime = 0;\n    \n    for (let day = 1; day <= daysInMonth; day++) {\n      const dateStr = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;\n      const dayData = employee.dailyData[dateStr];\n      \n      if (dayData) {\n        if (dayData.absence) {\n          overtimeValues.push(dayData.absence);\n        } else if (dayData.overtime > 0) {\n          overtimeValues.push(dayData.overtime === Math.floor(dayData.overtime) \n            ? dayData.overtime \n            : dayData.overtime.toFixed(1));\n          totalOvertime += dayData.overtime;\n        } else {\n          overtimeValues.push('-');\n        }\n      } else {\n        overtimeValues.push('-');\n      }\n    }\n    \n    overtimeValues.push(totalOvertime === Math.floor(totalOvertime) \n      ? totalOvertime \n      : totalOvertime.toFixed(1));\n    \n    const row2 = worksheet.addRow(overtimeValues);\n    row2.height = 16;\n    row2.alignment = { horizontal: 'center', vertical: 'middle' };\n    row2.font = { size: 9 };\n\n    // Merge name cell across both rows\n    worksheet.mergeCells(row1.number, 1, row2.number, 1);\n    const mergedNameCell = worksheet.getCell(row1.number, 1);\n    mergedNameCell.alignment = { horizontal: 'left', vertical: 'middle' };\n\n    // Apply borders and background colors to both rows\n    [row1, row2].forEach(row => {\n      row.eachCell((cell, colNumber) => {\n        cell.border = {\n          top: { style: 'thin' },\n          left: { style: 'thin' },\n          bottom: { style: 'thin' },\n          right: { style: 'thin' }\n        };\n        \n        // Apply day colors to data cells\n        if (colNumber > 2 && colNumber <= daysInMonth + 2) {\n          const day = colNumber - 2;\n          const dateStr = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;\n          \n          if (isItalianHoliday(dateStr)) {\n            cell.fill = {\n              type: 'pattern',\n              pattern: 'solid',\n              fgColor: { argb: 'FFFFF4CC' } // Light gold for holidays\n            };\n          } else if (isSunday(dateStr)) {\n            cell.fill = {\n              type: 'pattern',\n              pattern: 'solid',\n              fgColor: { argb: 'FFFFE4E1' } // Light pink for Sundays\n            };\n          } else if (isSaturday(dateStr)) {\n            cell.fill = {\n              type: 'pattern',\n              pattern: 'solid',\n              fgColor: { argb: 'FFE0F2F7' } // Light blue for Saturdays\n            };\n          }\n        }\n      });\n    });\n    \n    // Make second row tipo cell slightly lighter\n    row2.getCell(2).fill = {\n      type: 'pattern',\n      pattern: 'solid',\n      fgColor: { argb: 'FFF5F5F5' }\n    };\n  });\n\n  // Generate buffer\n  return await workbook.xlsx.writeBuffer();\n}\n\nfunction getMonthName(month: number): string {\n  const months = [\n    'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',\n    'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'\n  ];\n  return months[month - 1];\n}\n","path":null,"size_bytes":7301,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport rateLimit from \"express-rate-limit\";\nimport { storage } from \"./storage\";\nimport { WordService } from \"./wordService\";\nimport { txtService } from \"./txtService\";\nimport { generateAttendanceExcel } from \"./excelService\";\nimport { v2 as cloudinary } from 'cloudinary';\nimport multer from 'multer';\nimport streamifier from 'streamifier';\nimport { getTodayISO } from \"@shared/dateUtils\";\nimport {\n  insertUserSchema,\n  updateUserSchema,\n  insertDailyReportSchema,\n  updateDailyReportSchema,\n  insertOperationSchema,\n  updateOperationSchema,\n  insertClientSchema,\n  insertWorkTypeSchema,\n  insertMaterialSchema,\n  insertWorkOrderSchema,\n  insertAttendanceEntrySchema,\n  updateAttendanceEntrySchema,\n  insertHoursAdjustmentSchema,\n  updateHoursAdjustmentSchema,\n  insertVehicleSchema,\n  updateVehicleSchema,\n  insertFuelRefillSchema,\n  updateFuelRefillSchema,\n  insertFuelTankLoadSchema,\n  updateFuelTankLoadSchema,\n  insertOrganizationSchema,\n} from \"@shared/schema\";\nimport { validatePassword, verifyPassword, hashPassword } from \"./auth\";\n\n// ============================================\n// CLOUDINARY & MULTER CONFIGURATION\n// ============================================\n\ncloudinary.config({\n  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,\n  api_key: process.env.CLOUDINARY_API_KEY,\n  api_secret: process.env.CLOUDINARY_API_SECRET,\n});\n\nconst upload = multer({ storage: multer.memoryStorage() });\n\n// ============================================\n// RATE LIMITING - Protezione contro brute force\n// ============================================\n\n// Rate limiter generale per API: max 100 richieste per 15 minuti\nconst apiLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000,\n  max: 100,\n  message: { error: \"Troppi richieste. Riprova più tardi.\" },\n  standardHeaders: true,\n  legacyHeaders: false,\n  skip: (req) => process.env.NODE_ENV === \"development\",\n});\n\n// ============================================\n// MIDDLEWARE DI AUTENTICAZIONE\n// ============================================\n\nconst requireAuth = (req: any, res: any, next: any) => {\n  if (!req.session.userId) {\n    return res.status(401).json({ error: \"Autenticazione richiesta\" });\n  }\n  next();\n};\n\nconst requireAdmin = (req: any, res: any, next: any) => {\n  if (!req.session.userId) {\n    return res.status(401).json({ error: \"Autenticazione richiesta\" });\n  }\n  if (req.session.userRole !== \"admin\") {\n    return res\n      .status(403)\n      .json({ error: \"Accesso riservato agli amministratori\" });\n  }\n  next();\n};\n\nconst requireSuperAdmin = (req: any, res: any, next: any) => {\n  if (!req.session.userId) {\n    return res.status(401).json({ error: \"Autenticazione richiesta\" });\n  }\n  if (req.session.userRole !== \"superadmin\") {\n    return res\n      .status(403)\n      .json({ error: \"Accesso riservato ai super amministratori\" });\n  }\n  next();\n};\n\n// ============================================\n// ROUTES\n// ============================================\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  const wordService = new WordService();\n\n  // ============================================\n  // AUTHENTICATION (senza rate limiting)\n  // ============================================\n\n  // Login route (senza rate limiting)\n  app.post(\"/api/login\", async (req, res) => {\n    try {\n      const { username, password } = req.body;\n\n      if (!username) {\n        return res.status(400).json({ error: \"Username è richiesto\" });\n      }\n\n      if (!password) {\n        return res.status(400).json({ error: \"Password è richiesta\" });\n      }\n\n      // Get user by username\n      const user = await storage.getUserByUsername(username);\n      if (!user) {\n        return res.status(401).json({ error: \"Credenziali non valide\" });\n      }\n\n      // Check if user is active\n      if (!user.isActive) {\n        return res.status(403).json({ error: \"Account disabilitato. Contattare l'amministratore.\" });\n      }\n\n      // Verify password for ALL users (including admin)\n      const isValidPassword = await verifyPassword(password, user.password);\n      if (!isValidPassword) {\n        return res.status(401).json({ error: \"Credenziali non valide\" });\n      }\n\n      // Create session\n      (req as any).session.userId = user.id;\n      (req as any).session.userRole = user.role;\n      (req as any).session.organizationId = user.organizationId;\n\n      // Return user data without password\n      const { password: _, plainPassword: __, ...userWithoutPassword } = user;\n      res.json({\n        success: true,\n        user: userWithoutPassword,\n      });\n    } catch (error) {\n      console.error(\"Error during login:\", error);\n      res.status(500).json({ error: \"Errore interno del server\" });\n    }\n  });\n\n  // Logout route\n  app.post(\"/api/logout\", (req: any, res: any) => {\n    req.session.destroy((err: any) => {\n      if (err) {\n        console.error(\"Error during logout:\", err);\n        return res.status(500).json({ error: \"Logout failed\" });\n      }\n      res.json({ success: true, message: \"Logout effettuato con successo\" });\n    });\n  });\n\n  // Applica rate limiting generale a tutte le altre API\n  app.use(\"/api\", apiLimiter);\n\n  // ============================================\n  // SUPER ADMIN - GESTIONE ORGANIZZAZIONI\n  // ============================================\n\n  // Get all organizations (super admin only)\n  app.get(\"/api/superadmin/organizations\", requireSuperAdmin, async (req, res) => {\n    try {\n      const organizations = await storage.getAllOrganizations();\n      res.json(organizations);\n    } catch (error) {\n      console.error(\"Error fetching organizations:\", error);\n      res.status(500).json({ error: \"Failed to fetch organizations\" });\n    }\n  });\n\n  // Create new organization (super admin only)\n  app.post(\"/api/superadmin/organizations\", requireSuperAdmin, async (req, res) => {\n    try {\n      const result = insertOrganizationSchema.safeParse(req.body);\n\n      if (!result.success) {\n        return res.status(400).json({ error: \"Invalid organization data\", issues: result.error.issues });\n      }\n\n      // Check if organization name already exists\n      const existingOrg = await storage.getOrganizationByName(result.data.name);\n      if (existingOrg) {\n        return res.status(400).json({ error: \"Un'organizzazione con questo nome esiste già\" });\n      }\n\n      const organization = await storage.createOrganization(result.data);\n      res.status(201).json(organization);\n    } catch (error) {\n      console.error(\"Error creating organization:\", error);\n      res.status(500).json({ error: \"Failed to create organization\" });\n    }\n  });\n\n  // Toggle organization active status (super admin only) - NO DELETE\n  app.put(\"/api/superadmin/organizations/:id/status\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { isActive } = req.body;\n\n      if (typeof isActive !== \"boolean\") {\n        return res.status(400).json({ error: \"isActive deve essere true o false\" });\n      }\n\n      const organization = await storage.updateOrganizationStatus(id, isActive);\n      if (!organization) {\n        return res.status(404).json({ error: \"Organizzazione non trovata\" });\n      }\n\n      res.json(organization);\n    } catch (error) {\n      console.error(\"Error updating organization status:\", error);\n      res.status(500).json({ error: \"Failed to update organization status\" });\n    }\n  });\n\n  // Create admin for organization (super admin only)\n  app.post(\"/api/superadmin/organizations/:id/admin\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { id: organizationId } = req.params;\n      const { username, password, fullName } = req.body;\n\n      if (!username || !password || !fullName) {\n        return res.status(400).json({ error: \"username, password e fullName sono richiesti\" });\n      }\n\n      // Check if organization exists\n      const organization = await storage.getOrganization(organizationId);\n      if (!organization) {\n        return res.status(404).json({ error: \"Organizzazione non trovata\" });\n      }\n\n      // Check if username already exists\n      const existingUser = await storage.getUserByUsername(username);\n      if (existingUser) {\n        return res.status(400).json({ error: \"Username già in uso\" });\n      }\n\n      // Hash password and create admin\n      const hashedPassword = await hashPassword(password);\n      const admin = await storage.createUser({\n        username,\n        password: hashedPassword,\n        fullName,\n        role: \"admin\",\n      }, organizationId);\n\n      const { password: _, ...adminWithoutPassword } = admin;\n      res.status(201).json(adminWithoutPassword);\n    } catch (error) {\n      console.error(\"Error creating admin:\", error);\n      res.status(500).json({ error: \"Failed to create admin\" });\n    }\n  });\n\n  // Get organization details with admin count (super admin only)\n  app.get(\"/api/superadmin/organizations/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const organization = await storage.getOrganization(id);\n      \n      if (!organization) {\n        return res.status(404).json({ error: \"Organizzazione non trovata\" });\n      }\n\n      // Get admin and employee counts for this organization\n      const users = await storage.getAllUsers(id);\n      const adminCount = users.filter(u => u.role === \"admin\").length;\n      const employeeCount = users.filter(u => u.role === \"employee\" && u.isActive !== false).length;\n\n      res.json({\n        ...organization,\n        adminCount,\n        employeeCount,\n      });\n    } catch (error) {\n      console.error(\"Error fetching organization:\", error);\n      res.status(500).json({ error: \"Failed to fetch organization\" });\n    }\n  });\n\n  // ============================================\n  // USER MANAGEMENT\n  // ============================================\n\n  // Get current user info\n  app.get(\"/api/me\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req as any).session.userId;\n      const user = await storage.getUser(userId);\n\n      if (!user) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching current user:\", error);\n      res.status(500).json({ error: \"Failed to fetch user\" });\n    }\n  });\n\n  // Get all users (admin only)\n  app.get(\"/api/users\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const users = await storage.getAllUsers(organizationId);\n      res.json(users);\n    } catch (error) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ error: \"Failed to fetch users\" });\n    }\n  });\n\n  app.get(\"/api/users/active\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const users = await storage.getActiveUsers(organizationId);\n      res.json(users);\n    } catch (error) {\n      console.error(\"Error fetching active users:\", error);\n      res.status(500).json({ error: \"Failed to fetch active users\" });\n    }\n  });\n\n  // Create new user (admin only)\n  app.post(\"/api/users\", requireAdmin, async (req, res) => {\n    try {\n      const result = insertUserSchema.safeParse(req.body);\n\n      if (!result.success) {\n        console.error(\"User validation failed:\", result.error.issues);\n        return res\n          .status(400)\n          .json({ error: \"Invalid user data\", issues: result.error.issues });\n      }\n\n      // Check if username already exists\n      const existingUser = await storage.getUserByUsername(\n        result.data.username,\n      );\n      if (existingUser) {\n        return res.status(400).json({ error: \"Username già esistente\" });\n      }\n\n      const organizationId = (req as any).session.organizationId;\n      const user = await storage.createUser(result.data, organizationId);\n\n      res.json(user);\n    } catch (error: any) {\n      console.error(\"Error creating user:\", error);\n      res.status(500).json({ error: \"Failed to create user\" });\n    }\n  });\n\n  // Update user (admin only)\n  app.put(\"/api/users/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const result = updateUserSchema.safeParse(req.body);\n\n      if (!result.success) {\n        return res\n          .status(400)\n          .json({ error: \"Invalid user data\", issues: result.error.issues });\n      }\n\n      const existingUser = await storage.getUser(id);\n      if (!existingUser) {\n        return res.status(404).json({ error: \"Utente non trovato\" });\n      }\n\n      // If updating username, check it doesn't exist\n      if (\n        result.data.username &&\n        result.data.username !== existingUser.username\n      ) {\n        const existingUserWithUsername = await storage.getUserByUsername(\n          result.data.username,\n        );\n        if (existingUserWithUsername) {\n          return res.status(400).json({ error: \"Username già esistente\" });\n        }\n      }\n\n      const updatedUser = await storage.updateUser(id, result.data);\n      res.json(updatedUser);\n    } catch (error) {\n      console.error(\"Error updating user:\", error);\n      res.status(500).json({ error: \"Failed to update user\" });\n    }\n  });\n\n  // Get daily reports count for a user (admin only)\n  app.get(\n    \"/api/users/:id/daily-reports/count\",\n    requireAdmin,\n    async (req, res) => {\n      try {\n        const { id } = req.params;\n        const count = await storage.getDailyReportsCountByEmployeeId(id);\n        res.json({ count });\n      } catch (error) {\n        console.error(\"Error counting daily reports:\", error);\n        res.status(500).json({ error: \"Failed to count daily reports\" });\n      }\n    },\n  );\n\n  // Delete user (admin only)\n  app.delete(\"/api/users/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n\n      const existingUser = await storage.getUser(id);\n      if (!existingUser) {\n        return res.status(404).json({ error: \"Utente non trovato\" });\n      }\n\n      // Prevent deletion of admin users\n      if (existingUser.role === \"admin\") {\n        return res\n          .status(403)\n          .json({ error: \"Non è possibile eliminare utenti amministratori\" });\n      }\n\n      await storage.deleteDailyReportsByEmployeeId(id);\n      const deleted = await storage.deleteUser(id);\n\n      if (deleted) {\n        res.json({ success: true, message: \"Utente eliminato con successo\" });\n      } else {\n        res.status(500).json({ error: \"Failed to delete user\" });\n      }\n    } catch (error) {\n      console.error(\"Error deleting user:\", error);\n      res.status(500).json({ error: \"Failed to delete user\" });\n    }\n  });\n\n  // Update user status (enable/disable account) - admin only\n  app.put(\"/api/users/:id/status\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { isActive } = req.body;\n\n      if (typeof isActive !== 'boolean') {\n        return res.status(400).json({ error: \"isActive deve essere true o false\" });\n      }\n\n      const existingUser = await storage.getUser(id);\n      if (!existingUser) {\n        return res.status(404).json({ error: \"Utente non trovato\" });\n      }\n\n      // Prevent disabling admin users\n      if (existingUser.role === \"admin\") {\n        return res\n          .status(403)\n          .json({ error: \"Non è possibile disabilitare utenti amministratori\" });\n      }\n\n      const updatedUser = await storage.updateUserStatus(id, isActive);\n\n      res.json({\n        success: true,\n        message: isActive ? \"Utente abilitato con successo\" : \"Utente disabilitato con successo\",\n        user: updatedUser,\n      });\n    } catch (error) {\n      console.error(\"Error updating user status:\", error);\n      res.status(500).json({ error: \"Failed to update user status\" });\n    }\n  });\n\n  // Reset user password (admin only)\n  app.post(\"/api/users/:id/reset-password\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { newPassword } = req.body;\n\n      if (!newPassword || newPassword.trim().length === 0) {\n        return res.status(400).json({ error: \"Password non può essere vuota\" });\n      }\n\n      const existingUser = await storage.getUser(id);\n      if (!existingUser) {\n        return res.status(404).json({ error: \"Utente non trovato\" });\n      }\n\n      // Prevent reset of admin password\n      if (existingUser.role === \"admin\") {\n        return res\n          .status(403)\n          .json({\n            error: \"Non è possibile resettare la password dell'amministratore\",\n          });\n      }\n\n      const updatedUser = await storage.updateUser(id, {\n        password: newPassword.trim(),\n      });\n\n      res.json({\n        success: true,\n        message: \"Password aggiornata con successo.\",\n        username: existingUser.username,\n        fullName: existingUser.fullName,\n      });\n    } catch (error) {\n      console.error(\"Error resetting password:\", error);\n      res.status(500).json({ error: \"Errore interno del server\" });\n    }\n  });\n\n  // ============================================\n  // CLIENTS\n  // ============================================\n\n  app.get(\"/api/clients\", requireAuth, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const clients = await storage.getAllClients(organizationId);\n      res.json(clients);\n    } catch (error) {\n      console.error(\"Error fetching clients:\", error);\n      res.status(500).json({ error: \"Failed to fetch clients\" });\n    }\n  });\n\n  app.post(\"/api/clients\", requireAdmin, async (req, res) => {\n    try {\n      const result = insertClientSchema.safeParse(req.body);\n\n      if (!result.success) {\n        return res\n          .status(400)\n          .json({\n            error: \"Dati cliente non validi\",\n            issues: result.error.issues,\n          });\n      }\n\n      const organizationId = (req as any).session.organizationId;\n      const client = await storage.createClient(result.data, organizationId);\n      res.status(201).json(client);\n    } catch (error: any) {\n      console.error(\"Error creating client:\", error);\n      res.status(500).json({ error: \"Failed to create client\" });\n    }\n  });\n\n  app.get(\n    \"/api/clients/:id/work-orders/count\",\n    requireAdmin,\n    async (req, res) => {\n      try {\n        const { id } = req.params;\n        const count = await storage.getWorkOrdersCountByClientId(id);\n        res.json({ count });\n      } catch (error) {\n        console.error(\"Error counting work orders:\", error);\n        res.status(500).json({ error: \"Failed to count work orders\" });\n      }\n    },\n  );\n\n  app.get(\n    \"/api/clients/:id/operations/count\",\n    requireAdmin,\n    async (req, res) => {\n      try {\n        const { id } = req.params;\n        const count = await storage.getOperationsCountByClientId(id);\n        res.json({ count });\n      } catch (error) {\n        console.error(\"Error counting operations:\", error);\n        res.status(500).json({ error: \"Failed to count operations\" });\n      }\n    },\n  );\n\n  app.delete(\"/api/clients/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n\n      await storage.deleteOperationsByClientId(id);\n      await storage.deleteWorkOrdersByClientId(id);\n      const deleted = await storage.deleteClient(id);\n\n      if (!deleted) {\n        return res.status(404).json({ error: \"Cliente non trovato\" });\n      }\n\n      res.json({ success: true, message: \"Cliente eliminato con successo\" });\n    } catch (error: any) {\n      console.error(\"Error deleting client:\", error);\n      res\n        .status(500)\n        .json({ error: error.message || \"Failed to delete client\" });\n    }\n  });\n\n  // ============================================\n  // WORK TYPES (Lavorazioni)\n  // ============================================\n\n  app.get(\"/api/work-types\", requireAuth, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const workTypes = await storage.getAllWorkTypes(organizationId);\n      res.json(workTypes);\n    } catch (error) {\n      console.error(\"Error fetching work types:\", error);\n      res.status(500).json({ error: \"Failed to fetch work types\" });\n    }\n  });\n\n  app.post(\"/api/work-types\", requireAdmin, async (req, res) => {\n    try {\n      const result = insertWorkTypeSchema.safeParse(req.body);\n\n      if (!result.success) {\n        return res\n          .status(400)\n          .json({\n            error: \"Dati lavorazione non validi\",\n            issues: result.error.issues,\n          });\n      }\n\n      const organizationId = (req as any).session.organizationId;\n      const workType = await storage.createWorkType(\n        result.data,\n        organizationId,\n      );\n      res.status(201).json(workType);\n    } catch (error: any) {\n      console.error(\"Error creating work type:\", error);\n      res.status(500).json({ error: \"Failed to create work type\" });\n    }\n  });\n\n  app.patch(\"/api/work-types/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const updatedWorkType = await storage.updateWorkType(id, req.body);\n      res.json(updatedWorkType);\n    } catch (error: any) {\n      console.error(\"Error updating work type:\", error);\n      res.status(500).json({ error: \"Failed to update work type\" });\n    }\n  });\n\n  app.delete(\"/api/work-types/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const deleted = await storage.deleteWorkType(id);\n\n      if (!deleted) {\n        return res.status(404).json({ error: \"Lavorazione non trovata\" });\n      }\n\n      res.json({\n        success: true,\n        message: \"Lavorazione eliminata con successo\",\n      });\n    } catch (error: any) {\n      console.error(\"Error deleting work type:\", error);\n      res.status(500).json({ error: \"Failed to delete work type\" });\n    }\n  });\n\n  // ============================================\n  // MATERIALS (Materiali)\n  // ============================================\n\n  app.get(\"/api/materials\", requireAuth, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const materials = await storage.getAllMaterials(organizationId);\n      res.json(materials);\n    } catch (error) {\n      console.error(\"Error fetching materials:\", error);\n      res.status(500).json({ error: \"Failed to fetch materials\" });\n    }\n  });\n\n  app.post(\"/api/materials\", requireAdmin, async (req, res) => {\n    try {\n      const result = insertMaterialSchema.safeParse(req.body);\n\n      if (!result.success) {\n        return res\n          .status(400)\n          .json({\n            error: \"Dati materiale non validi\",\n            issues: result.error.issues,\n          });\n      }\n\n      const organizationId = (req as any).session.organizationId;\n      const material = await storage.createMaterial(\n        result.data,\n        organizationId,\n      );\n      res.status(201).json(material);\n    } catch (error: any) {\n      console.error(\"Error creating material:\", error);\n      res.status(500).json({ error: \"Failed to create material\" });\n    }\n  });\n\n  app.patch(\"/api/materials/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const updatedMaterial = await storage.updateMaterial(id, req.body);\n      res.json(updatedMaterial);\n    } catch (error: any) {\n      console.error(\"Error updating material:\", error);\n      res.status(500).json({ error: \"Failed to update material\" });\n    }\n  });\n\n  app.delete(\"/api/materials/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const deleted = await storage.deleteMaterial(id);\n\n      if (!deleted) {\n        return res.status(404).json({ error: \"Materiale non trovato\" });\n      }\n\n      res.json({ success: true, message: \"Materiale eliminato con successo\" });\n    } catch (error: any) {\n      console.error(\"Error deleting material:\", error);\n      res.status(500).json({ error: \"Failed to delete material\" });\n    }\n  });\n\n  // ============================================\n  // WORK ORDERS (Commesse)\n  // ============================================\n\n  app.get(\n    \"/api/clients/:clientId/work-orders\",\n    requireAuth,\n    async (req, res) => {\n      try {\n        const organizationId = (req as any).session.organizationId;\n        const workOrders = await storage.getWorkOrdersByClient(\n          req.params.clientId,\n          organizationId,\n        );\n        res.json(workOrders);\n      } catch (error) {\n        console.error(\"Error fetching work orders:\", error);\n        res.status(500).json({ error: \"Failed to fetch work orders\" });\n      }\n    },\n  );\n\n  app.post(\n    \"/api/clients/:clientId/work-orders\",\n    requireAdmin,\n    async (req, res) => {\n      try {\n        const { clientId } = req.params;\n        const result = insertWorkOrderSchema.safeParse({\n          ...req.body,\n          clientId,\n        });\n\n        if (!result.success) {\n          return res\n            .status(400)\n            .json({\n              error: \"Dati commessa non validi\",\n              issues: result.error.issues,\n            });\n        }\n\n        const organizationId = (req as any).session.organizationId;\n        const workOrder = await storage.createWorkOrder(\n          result.data,\n          organizationId,\n        );\n        res.status(201).json(workOrder);\n      } catch (error: any) {\n        console.error(\"Error creating work order:\", error);\n        res.status(500).json({ error: \"Failed to create work order\" });\n      }\n    },\n  );\n\n  app.get(\"/api/work-orders\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const workOrders = await storage.getAllWorkOrders(organizationId);\n      res.json(workOrders);\n    } catch (error: any) {\n      console.error(\"Error fetching work orders:\", error);\n      res.status(500).json({ error: \"Failed to fetch work orders\" });\n    }\n  });\n\n  app.get(\"/api/work-orders/active\", requireAuth, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const workOrders = await storage.getAllActiveWorkOrders(organizationId);\n      res.json(workOrders);\n    } catch (error: any) {\n      console.error(\"Error fetching active work orders:\", error);\n      res.status(500).json({ error: \"Failed to fetch active work orders\" });\n    }\n  });\n\n  app.get(\"/api/work-orders/stats\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const stats = await storage.getWorkOrdersStats(organizationId);\n      res.json(stats);\n    } catch (error: any) {\n      console.error(\"Error fetching work order stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch work order statistics\" });\n    }\n  });\n\n  app.put(\"/api/work-orders/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const result = insertWorkOrderSchema.safeParse(req.body);\n\n      if (!result.success) {\n        return res\n          .status(400)\n          .json({\n            error: \"Dati commessa non validi\",\n            issues: result.error.issues,\n          });\n      }\n\n      const updatedWorkOrder = await storage.updateWorkOrder(id, result.data);\n      res.json(updatedWorkOrder);\n    } catch (error: any) {\n      console.error(\"Error updating work order:\", error);\n      res.status(500).json({ error: \"Failed to update work order\" });\n    }\n  });\n\n  app.patch(\"/api/work-orders/:id/status\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { isActive } = req.body;\n\n      if (typeof isActive !== \"boolean\") {\n        return res\n          .status(400)\n          .json({ error: \"isActive deve essere un valore booleano\" });\n      }\n\n      const updatedWorkOrder = await storage.updateWorkOrderStatus(\n        id,\n        isActive,\n      );\n      res.json(updatedWorkOrder);\n    } catch (error: any) {\n      console.error(\"Error updating work order status:\", error);\n      res.status(500).json({ error: \"Failed to update work order status\" });\n    }\n  });\n\n  app.delete(\"/api/work-orders/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n\n      await storage.deleteOperationsByWorkOrderId(id);\n      const deleted = await storage.deleteWorkOrder(id);\n      if (deleted) {\n        res.json({ success: true });\n      } else {\n        res.status(404).json({ error: \"Commessa non trovata\" });\n      }\n    } catch (error: any) {\n      console.error(\"Error deleting work order:\", error);\n      res.status(500).json({ error: \"Failed to delete work order\" });\n    }\n  });\n\n  // ============================================\n  // DAILY REPORTS (Rapportini)\n  // ============================================\n\n  app.get(\"/api/daily-reports/today\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req as any).session.userId;\n      const organizationId = (req as any).session.organizationId;\n      const today = getTodayISO();\n\n      const report = await storage.getDailyReportByEmployeeAndDate(\n        userId,\n        today,\n        organizationId,\n      );\n\n      if (!report) {\n        return res\n          .status(404)\n          .json({ error: \"Nessun rapportino trovato per oggi\" });\n      }\n\n      const operations = await storage.getOperationsByReportId(report.id);\n\n      res.json({\n        ...report,\n        operations,\n      });\n    } catch (error) {\n      console.error(\"Error fetching today's daily report:\", error);\n      res.status(500).json({ error: \"Failed to fetch today's daily report\" });\n    }\n  });\n\n  app.get(\"/api/daily-reports\", requireAuth, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const daysParam = req.query.days as string;\n\n      let days: number | null = null;\n\n      if (daysParam === \"all\") {\n        days = null;\n      } else {\n        const parsedDays = parseInt(daysParam || \"7\", 10);\n\n        if (isNaN(parsedDays) || parsedDays < 0) {\n          return res.status(400).json({\n            error: \"Il parametro 'days' deve essere un numero positivo o 'all'\",\n          });\n        }\n\n        days = parsedDays;\n      }\n\n      let reports = await storage.getAllDailyReports(organizationId);\n\n      if (days !== null) {\n        const cutoffDate = new Date();\n        cutoffDate.setDate(cutoffDate.getDate() - (days - 1));\n        const cutoffDateStr = cutoffDate.toISOString().split(\"T\")[0];\n\n        reports = reports.filter((report) => report.date >= cutoffDateStr);\n      }\n\n      const enrichedReports = await Promise.all(\n        reports.map(async (report) => {\n          const employee = await storage.getUser(report.employeeId);\n          const operations = await storage.getOperationsByReportId(report.id);\n\n          const totalHours = operations.reduce((total, op) => {\n            return total + (Number(op.hours) || 0);\n          }, 0);\n\n          return {\n            ...report,\n            employeeName: employee?.fullName || \"Unknown\",\n            operations: operations.length,\n            totalHours: Math.round(totalHours * 10) / 10,\n          };\n        }),\n      );\n\n      res.json(enrichedReports);\n    } catch (error) {\n      console.error(\"Error fetching daily reports:\", error);\n      res.status(500).json({ error: \"Failed to fetch daily reports\" });\n    }\n  });\n\n  app.get(\n    \"/api/daily-reports/missing-employees\",\n    requireAdmin,\n    async (req, res) => {\n      try {\n        const organizationId = (req as any).session.organizationId;\n        const date = (req.query.date as string) || getTodayISO();\n\n        const allUsers = await storage.getAllUsers(organizationId);\n        const employees = allUsers.filter((user) => user.role === \"employee\" && user.isActive !== false);\n\n        const reportsForDate = await storage.getDailyReportsByDate(\n          date,\n          organizationId,\n        );\n        const employeeIdsWithReports = new Set(\n          reportsForDate.map((report) => report.employeeId),\n        );\n\n        // Get attendance entries (absences, leaves, etc.) for this date\n        const attendanceForDate = await storage.getAttendanceEntriesByDate(\n          date,\n          organizationId,\n        );\n        const employeeIdsWithAttendance = new Set(\n          attendanceForDate.map((entry) => entry.userId),\n        );\n\n        // Exclude employees who have either a report OR an attendance entry\n        const missingEmployees = employees\n          .filter((employee) => \n            !employeeIdsWithReports.has(employee.id) && \n            !employeeIdsWithAttendance.has(employee.id)\n          )\n          .map((employee) => ({\n            id: employee.id,\n            fullName: employee.fullName,\n            username: employee.username,\n          }));\n\n        res.json({\n          date,\n          missingCount: missingEmployees.length,\n          missingEmployees,\n        });\n      } catch (error) {\n        console.error(\"Error fetching missing employees:\", error);\n        res.status(500).json({ error: \"Failed to fetch missing employees\" });\n      }\n    },\n  );\n\n  app.post(\"/api/daily-reports\", requireAuth, async (req, res) => {\n    try {\n      const { operations, date, employeeId } = req.body;\n\n      const userId = (req as any).session.userId;\n      const userRole = (req as any).session.userRole;\n      const organizationId = (req as any).session.organizationId;\n\n      let actualEmployeeId = userId;\n\n      if (employeeId && employeeId !== userId) {\n        if (userRole !== \"admin\") {\n          return res.status(403).json({\n            error:\n              \"Solo gli amministratori possono creare rapportini per altri dipendenti\",\n          });\n        }\n\n        const targetEmployee = await storage.getUser(employeeId);\n        if (!targetEmployee) {\n          return res.status(404).json({ error: \"Dipendente non trovato\" });\n        }\n        if (targetEmployee.organizationId !== organizationId) {\n          return res.status(403).json({ error: \"Accesso negato\" });\n        }\n\n        actualEmployeeId = employeeId;\n      }\n\n      const reportData = {\n        employeeId: actualEmployeeId,\n        date: date || new Date().toISOString().split(\"T\")[0],\n        status: \"In attesa\",\n      };\n\n      const reportResult = insertDailyReportSchema.safeParse(reportData);\n      if (!reportResult.success) {\n        return res\n          .status(400)\n          .json({\n            error: \"Dati rapportino non validi\",\n            issues: reportResult.error.issues,\n          });\n      }\n\n      const newReport = await storage.createDailyReport(\n        reportResult.data,\n        organizationId,\n      );\n\n      if (operations && Array.isArray(operations)) {\n        for (const operation of operations) {\n          const operationData = {\n            ...operation,\n            dailyReportId: newReport.id,\n          };\n\n          const operationResult =\n            insertOperationSchema.safeParse(operationData);\n\n          if (operationResult.success) {\n            await storage.createOperation(operationResult.data);\n          }\n        }\n      }\n\n      const finalOperations = await storage.getOperationsByReportId(\n        newReport.id,\n      );\n\n      res.status(201).json({\n        ...newReport,\n        operations: finalOperations,\n      });\n    } catch (error) {\n      console.error(\"Error creating daily report:\", error);\n      res.status(500).json({ error: \"Failed to create daily report\" });\n    }\n  });\n\n  app.post(\"/api/operations\", requireAuth, async (req, res) => {\n    try {\n      const operationData = req.body;\n\n      const operationResult = insertOperationSchema.safeParse(operationData);\n      if (!operationResult.success) {\n        return res.status(400).json({\n          error: \"Dati operazione non validi\",\n          issues: operationResult.error.issues,\n        });\n      }\n\n      const newOperation = await storage.createOperation(operationResult.data);\n\n      res.status(201).json(newOperation);\n    } catch (error) {\n      console.error(\"Error creating operation:\", error);\n      res.status(500).json({ error: \"Failed to create operation\" });\n    }\n  });\n\n  // Export daily reports as Word document (admin only)\n  app.get(\"/api/export/daily-reports/:date\", requireAdmin, async (req, res) => {\n    try {\n      const { date } = req.params;\n      const organizationId = (req as any).session.organizationId;\n\n      if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(date)) {\n        return res\n          .status(400)\n          .json({ error: \"Invalid date format. Use YYYY-MM-DD\" });\n      }\n\n      const docBuffer = await wordService.generateDailyReportWord(\n        date,\n        organizationId,\n      );\n\n      const filename = `Rapportini_${date}.docx`;\n\n      res.setHeader(\n        \"Content-Type\",\n        \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n      );\n      res.setHeader(\n        \"Content-Disposition\",\n        `attachment; filename=\"${filename}\"`,\n      );\n      res.setHeader(\"Content-Length\", docBuffer.length);\n\n      res.send(docBuffer);\n    } catch (error) {\n      console.error(\"Error generating Word document:\", error);\n      if (error instanceof Error) {\n        res.status(500).json({ error: error.message });\n      } else {\n        res.status(500).json({ error: \"Failed to generate Word report\" });\n      }\n    }\n  });\n\n  // Export daily reports as TXT document (admin only)\n  app.get(\"/api/export/daily-reports-txt/:date\", requireAdmin, async (req, res) => {\n    try {\n      const { date } = req.params;\n      const organizationId = (req as any).session.organizationId;\n\n      if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(date)) {\n        return res\n          .status(400)\n          .json({ error: \"Invalid date format. Use YYYY-MM-DD\" });\n      }\n\n      const txtContent = await txtService.generateDailyReportTxt(\n        date,\n        organizationId,\n      );\n\n      const filename = `Rapportini_${date}.txt`;\n\n      res.setHeader(\"Content-Type\", \"text/plain; charset=utf-8\");\n      res.setHeader(\n        \"Content-Disposition\",\n        `attachment; filename=\"${filename}\"`,\n      );\n      res.setHeader(\"Content-Length\", Buffer.byteLength(txtContent, 'utf8'));\n\n      res.send(txtContent);\n    } catch (error) {\n      console.error(\"Error generating TXT document:\", error);\n      if (error instanceof Error) {\n        res.status(500).json({ error: error.message });\n      } else {\n        res.status(500).json({ error: \"Failed to generate TXT report\" });\n      }\n    }\n  });\n\n  app.get(\"/api/export/daily-reports-range\", requireAdmin, async (req, res) => {\n    try {\n      const { from, to, status, search } = req.query;\n      const organizationId = (req as any).session.organizationId;\n\n      const docBuffer = await wordService.generateDailyReportWordRange(\n        {\n          fromDate: from as string | undefined,\n          toDate: to as string | undefined,\n          status: status as string | undefined,\n          searchTerm: search as string | undefined,\n        },\n        organizationId,\n      );\n\n      let filename = \"Rapportini\";\n      if (from && to) {\n        filename += `_${from}_${to}`;\n      } else if (from) {\n        filename += `_da_${from}`;\n      } else if (to) {\n        filename += `_fino_${to}`;\n      } else {\n        filename += `_${new Date().toISOString().split(\"T\")[0]}`;\n      }\n      filename += \".docx\";\n\n      res.setHeader(\n        \"Content-Type\",\n        \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n      );\n      res.setHeader(\n        \"Content-Disposition\",\n        `attachment; filename=\"${filename}\"`,\n      );\n      res.setHeader(\"Content-Length\", docBuffer.length);\n\n      res.send(docBuffer);\n    } catch (error) {\n      console.error(\"Error generating filtered Word document:\", error);\n      if (error instanceof Error) {\n        res.status(500).json({ error: error.message });\n      } else {\n        res\n          .status(500)\n          .json({ error: \"Failed to generate filtered Word report\" });\n      }\n    }\n  });\n\n  app.get(\"/api/export/daily-reports-txt-range\", requireAdmin, async (req, res) => {\n    try {\n      const { from, to, status, search } = req.query;\n      const organizationId = (req as any).session.organizationId;\n\n      const txtContent = await txtService.generateDailyReportTxtRange(\n        {\n          fromDate: from as string | undefined,\n          toDate: to as string | undefined,\n          status: status as string | undefined,\n          searchTerm: search as string | undefined,\n        },\n        organizationId,\n      );\n\n      let filename = \"Rapportini\";\n      if (from && to) {\n        filename += `_${from}_${to}`;\n      } else if (from) {\n        filename += `_da_${from}`;\n      } else if (to) {\n        filename += `_fino_${to}`;\n      } else {\n        filename += `_${new Date().toISOString().split(\"T\")[0]}`;\n      }\n      filename += \".txt\";\n\n      res.setHeader(\"Content-Type\", \"text/plain; charset=utf-8\");\n      res.setHeader(\n        \"Content-Disposition\",\n        `attachment; filename=\"${filename}\"`,\n      );\n      res.setHeader(\"Content-Length\", Buffer.byteLength(txtContent, 'utf8'));\n\n      res.send(txtContent);\n    } catch (error) {\n      console.error(\"Error generating filtered TXT document:\", error);\n      if (error instanceof Error) {\n        res.status(500).json({ error: error.message });\n      } else {\n        res\n          .status(500)\n          .json({ error: \"Failed to generate filtered TXT report\" });\n      }\n    }\n  });\n\n  app.get(\n    \"/api/export/work-order/:workOrderId\",\n    requireAdmin,\n    async (req, res) => {\n      try {\n        const { workOrderId } = req.params;\n        const organizationId = (req as any).session.organizationId;\n\n        const docBuffer = await wordService.generateWorkOrderReportWord(\n          workOrderId,\n          organizationId,\n        );\n\n        const workOrder = await storage.getWorkOrder(\n          workOrderId,\n          organizationId,\n        );\n        const filename = `Commessa_${workOrder?.name.replace(/[^a-zA-Z0-9]/g, \"_\")}_${new Date().toISOString().split(\"T\")[0]}.docx`;\n\n        res.setHeader(\n          \"Content-Type\",\n          \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n        );\n        res.setHeader(\n          \"Content-Disposition\",\n          `attachment; filename=\"${filename}\"`,\n        );\n        res.setHeader(\"Content-Length\", docBuffer.length);\n\n        res.send(docBuffer);\n      } catch (error) {\n        console.error(\"Error generating work order Word document:\", error);\n        if (error instanceof Error) {\n          res.status(500).json({ error: error.message });\n        } else {\n          res\n            .status(500)\n            .json({ error: \"Failed to generate work order report\" });\n        }\n      }\n    },\n  );\n\n  app.get(\"/api/daily-reports/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const organizationId = (req as any).session.organizationId;\n\n      const report = await storage.getDailyReport(id);\n      if (!report) {\n        return res.status(404).json({ error: \"Rapportino non trovato\" });\n      }\n\n      const operations = await storage.getOperationsByReportId(id);\n\n      const enrichedOperations = await Promise.all(\n        operations.map(async (op) => {\n          const client = await storage\n            .getAllClients(organizationId)\n            .then((clients) => clients.find((c) => c.id === op.clientId));\n          const workOrder = await storage\n            .getWorkOrdersByClient(op.clientId, organizationId)\n            .then((orders) => orders.find((wo) => wo.id === op.workOrderId));\n\n          return {\n            ...op,\n            clientName: client?.name || \"Cliente eliminato\",\n            workOrderName: workOrder?.name || \"Commessa sconosciuta\",\n          };\n        }),\n      );\n\n      res.json({\n        ...report,\n        operations: enrichedOperations,\n      });\n    } catch (error) {\n      console.error(\"Error fetching daily report:\", error);\n      res.status(500).json({ error: \"Failed to fetch daily report\" });\n    }\n  });\n\n  app.put(\"/api/daily-reports/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { operations } = req.body;\n\n      const existingReport = await storage.getDailyReport(id);\n      if (!existingReport) {\n        return res.status(404).json({ error: \"Rapportino non trovato\" });\n      }\n\n      if (\n        (req as any).session.userRole !== \"admin\" &&\n        (req as any).session.userId !== existingReport.employeeId\n      ) {\n        return res\n          .status(403)\n          .json({ error: \"Non autorizzato a modificare questo rapportino\" });\n      }\n\n      if (operations && Array.isArray(operations)) {\n        await storage.deleteOperationsByReportId(id);\n\n        for (const operation of operations) {\n          const operationResult = insertOperationSchema.safeParse({\n            ...operation,\n            dailyReportId: id,\n          });\n\n          if (operationResult.success) {\n            await storage.createOperation(operationResult.data);\n          }\n        }\n      }\n\n      const finalOperations = await storage.getOperationsByReportId(id);\n      res.json({\n        ...existingReport,\n        operations: finalOperations,\n      });\n    } catch (error) {\n      console.error(\"Error updating daily report:\", error);\n      res.status(500).json({ error: \"Failed to update daily report\" });\n    }\n  });\n\n  app.patch(\n    \"/api/daily-reports/:id/approve\",\n    requireAdmin,\n    async (req, res) => {\n      try {\n        const updatedReport = await storage.updateDailyReportStatus(\n          req.params.id,\n          \"Approvato\",\n        );\n        res.json(updatedReport);\n      } catch (error) {\n        console.error(\"Error approving report:\", error);\n        res.status(500).json({ error: \"Failed to approve report\" });\n      }\n    },\n  );\n\n  app.patch(\n    \"/api/daily-reports/:id/change-date\",\n    requireAdmin,\n    async (req, res) => {\n      try {\n        const { id } = req.params;\n        const { newDate } = req.body;\n        const organizationId = (req as any).session.organizationId;\n\n        if (!newDate || typeof newDate !== \"string\") {\n          return res.status(400).json({ error: \"Data non valida\" });\n        }\n\n        const existingReport = await storage.getDailyReport(id);\n        if (!existingReport) {\n          return res.status(404).json({ error: \"Rapportino non trovato\" });\n        }\n\n        const conflictingReport = await storage.getDailyReportByEmployeeAndDate(\n          existingReport.employeeId,\n          newDate,\n          organizationId,\n        );\n\n        if (conflictingReport && conflictingReport.id !== id) {\n          return res.status(409).json({\n            error:\n              \"Esiste già un rapportino per questo dipendente in questa data\",\n          });\n        }\n\n        const updatedReport = await storage.updateDailyReport(id, {\n          date: newDate,\n        });\n        res.json(updatedReport);\n      } catch (error) {\n        console.error(\"Error changing report date:\", error);\n        res\n          .status(500)\n          .json({ error: \"Impossibile modificare la data del rapportino\" });\n      }\n    },\n  );\n\n  app.patch(\"/api/daily-reports/hours\", requireAdmin, async (req, res) => {\n    try {\n      const { userId, date, ordinary, overtime } = req.body;\n      const organizationId = (req as any).session.organizationId;\n\n      if (!userId || !date || ordinary === undefined) {\n        return res\n          .status(400)\n          .json({ error: \"userId, date, and ordinary are required\" });\n      }\n\n      const report = await storage.getDailyReportByEmployeeAndDate(\n        userId,\n        date,\n        organizationId,\n      );\n      if (!report) {\n        return res\n          .status(404)\n          .json({ error: \"Rapportino non trovato per questa data\" });\n      }\n\n      if (report.status !== \"Approvato\") {\n        return res\n          .status(400)\n          .json({\n            error: \"Solo i rapportini approvati possono essere modificati\",\n          });\n      }\n\n      const operations = await storage.getOperationsByReportId(report.id);\n      if (operations.length === 0) {\n        return res\n          .status(400)\n          .json({ error: \"Nessuna operazione trovata per questo rapportino\" });\n      }\n\n      const currentTotal = operations.reduce(\n        (sum, op) => sum + Number(op.hours),\n        0,\n      );\n      const targetTotal = Number(ordinary) + Number(overtime || 0);\n\n      if (operations.length === 1) {\n        await storage.updateOperation(operations[0].id, {\n          hours: String(targetTotal),\n        });\n      } else {\n        if (currentTotal > 0) {\n          const scaleFactor = targetTotal / currentTotal;\n          for (const op of operations) {\n            const newHours = Number(op.hours) * scaleFactor;\n            await storage.updateOperation(op.id, { hours: String(newHours) });\n          }\n        } else {\n          await storage.updateOperation(operations[0].id, {\n            hours: String(targetTotal),\n          });\n          for (let i = 1; i < operations.length; i++) {\n            await storage.updateOperation(operations[i].id, { hours: \"0\" });\n          }\n        }\n      }\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error updating report hours:\", error);\n      res.status(500).json({ error: \"Impossibile aggiornare le ore\" });\n    }\n  });\n\n  app.delete(\"/api/daily-reports/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n\n      const existingReport = await storage.getDailyReport(id);\n      if (!existingReport) {\n        return res.status(404).json({ error: \"Rapportino non trovato\" });\n      }\n\n      await storage.deleteOperationsByReportId(id);\n      const deleted = await storage.deleteDailyReport(id);\n\n      if (deleted) {\n        res.json({ success: true });\n      } else {\n        res.status(500).json({ error: \"Failed to delete report\" });\n      }\n    } catch (error) {\n      console.error(\"Error deleting daily report:\", error);\n      res.status(500).json({ error: \"Failed to delete daily report\" });\n    }\n  });\n\n  app.get(\n    \"/api/work-orders/:workOrderId/operations/count\",\n    requireAuth,\n    async (req, res) => {\n      try {\n        const { workOrderId } = req.params;\n        const count =\n          await storage.getOperationsCountByWorkOrderId(workOrderId);\n        res.json({ count });\n      } catch (error) {\n        console.error(\"Error fetching work order operations count:\", error);\n        res.status(500).json({ error: \"Failed to fetch operations count\" });\n      }\n    },\n  );\n\n  app.get(\n    \"/api/work-orders/:workOrderId/operations\",\n    requireAuth,\n    async (req, res) => {\n      try {\n        const { workOrderId } = req.params;\n        const organizationId = (req as any).session.organizationId;\n        const operations = await storage.getOperationsByWorkOrderId(\n          workOrderId,\n          organizationId,\n        );\n\n        const enrichedOperations = await Promise.all(\n          operations.map(async (op) => {\n            const dailyReport = await storage\n              .getAllDailyReports(organizationId)\n              .then((reports) =>\n                reports.find((r) => r.id === op.dailyReportId),\n              );\n            const employee = dailyReport\n              ? await storage.getUser(dailyReport.employeeId)\n              : null;\n            const client = await storage\n              .getAllClients(organizationId)\n              .then((clients) => clients.find((c) => c.id === op.clientId));\n            const workOrder = await storage\n              .getWorkOrdersByClient(op.clientId, organizationId)\n              .then((orders) => orders.find((wo) => wo.id === op.workOrderId));\n\n            return {\n              ...op,\n              employeeName: employee?.fullName || \"Dipendente sconosciuto\",\n              employeeId: dailyReport?.employeeId,\n              date: dailyReport?.date,\n              clientName: client?.name || \"Cliente eliminato\",\n              workOrderName: workOrder?.name || \"Commessa sconosciuta\",\n              reportStatus: dailyReport?.status || \"Stato sconosciuto\",\n            };\n          }),\n        );\n\n        const approvedOperations = enrichedOperations.filter(\n          (op) => op.reportStatus === \"Approvato\",\n        );\n\n        res.json(approvedOperations);\n      } catch (error) {\n        console.error(\"Error fetching work order operations:\", error);\n        res\n          .status(500)\n          .json({ error: \"Failed to fetch work order operations\" });\n      }\n    },\n  );\n\n  // ============================================\n  // ATTENDANCE ENTRIES (ASSENZE)\n  // ============================================\n\n  app.get(\"/api/attendance-entries\", requireAdmin, async (req, res) => {\n    try {\n      const { year, month } = req.query;\n\n      if (!year || !month) {\n        return res.status(400).json({ error: \"Year and month are required\" });\n      }\n\n      const organizationId = (req as any).session.organizationId;\n      const entries = await storage.getAllAttendanceEntries(\n        organizationId,\n        year as string,\n        month as string,\n      );\n\n      res.json(entries);\n    } catch (error) {\n      console.error(\"Error fetching attendance entries:\", error);\n      res.status(500).json({ error: \"Failed to fetch attendance entries\" });\n    }\n  });\n\n  app.post(\"/api/attendance-entries\", requireAdmin, async (req, res) => {\n    try {\n      const result = insertAttendanceEntrySchema.safeParse(req.body);\n\n      if (!result.success) {\n        return res.status(400).json({\n          error: \"Dati assenza non validi\",\n          issues: result.error.issues,\n        });\n      }\n\n      const organizationId = (req as any).session.organizationId;\n\n      const existing = await storage.getAttendanceEntry(\n        result.data.userId,\n        result.data.date,\n        organizationId,\n      );\n\n      if (existing) {\n        return res.status(400).json({\n          error: \"Esiste già un'assenza per questo dipendente in questa data\",\n        });\n      }\n\n      const entry = await storage.createAttendanceEntry(\n        result.data,\n        organizationId,\n      );\n      res.json(entry);\n    } catch (error) {\n      console.error(\"Error creating attendance entry:\", error);\n      res.status(500).json({ error: \"Failed to create attendance entry\" });\n    }\n  });\n\n  app.put(\"/api/attendance-entries/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const result = updateAttendanceEntrySchema.safeParse(req.body);\n\n      if (!result.success) {\n        return res.status(400).json({\n          error: \"Dati assenza non validi\",\n          issues: result.error.issues,\n        });\n      }\n\n      const entry = await storage.updateAttendanceEntry(id, result.data);\n      res.json(entry);\n    } catch (error) {\n      console.error(\"Error updating attendance entry:\", error);\n      res.status(500).json({ error: \"Failed to update attendance entry\" });\n    }\n  });\n\n  app.delete(\"/api/attendance-entries/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const deleted = await storage.deleteAttendanceEntry(id);\n\n      if (deleted) {\n        res.json({ success: true });\n      } else {\n        res.status(500).json({ error: \"Failed to delete attendance entry\" });\n      }\n    } catch (error) {\n      console.error(\"Error deleting attendance entry:\", error);\n      res.status(500).json({ error: \"Failed to delete attendance entry\" });\n    }\n  });\n\n  // ============================================\n  // HOURS ADJUSTMENTS\n  // ============================================\n\n  app.get(\n    \"/api/hours-adjustment/:dailyReportId\",\n    requireAdmin,\n    async (req, res) => {\n      try {\n        const { dailyReportId } = req.params;\n        const organizationId = (req as any).session.organizationId;\n\n        const adjustment = await storage.getHoursAdjustment(\n          dailyReportId,\n          organizationId,\n        );\n        res.json(adjustment || null);\n      } catch (error) {\n        console.error(\"Error fetching hours adjustment:\", error);\n        res.status(500).json({ error: \"Failed to fetch hours adjustment\" });\n      }\n    },\n  );\n\n  app.post(\"/api/hours-adjustment\", requireAdmin, async (req, res) => {\n    try {\n      const result = insertHoursAdjustmentSchema.safeParse(req.body);\n\n      if (!result.success) {\n        return res.status(400).json({\n          error: \"Dati aggiustamento non validi\",\n          issues: result.error.issues,\n        });\n      }\n\n      const organizationId = (req as any).session.organizationId;\n      const userId = (req as any).session.userId;\n\n      const existing = await storage.getHoursAdjustment(\n        result.data.dailyReportId,\n        organizationId,\n      );\n\n      if (existing) {\n        return res.status(400).json({\n          error: \"Esiste già un aggiustamento per questo rapportino\",\n        });\n      }\n\n      const adjustment = await storage.createHoursAdjustment(\n        {\n          dailyReportId: result.data.dailyReportId,\n          adjustment: result.data.adjustment,\n          reason: result.data.reason,\n        },\n        organizationId,\n        userId,\n      );\n      res.json(adjustment);\n    } catch (error) {\n      console.error(\"Error creating hours adjustment:\", error);\n      res.status(500).json({ error: \"Failed to create hours adjustment\" });\n    }\n  });\n\n  app.patch(\"/api/hours-adjustment/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const result = updateHoursAdjustmentSchema.safeParse(req.body);\n\n      if (!result.success) {\n        return res.status(400).json({\n          error: \"Dati aggiustamento non validi\",\n          issues: result.error.issues,\n        });\n      }\n\n      const adjustment = await storage.updateHoursAdjustment(id, result.data);\n      res.json(adjustment);\n    } catch (error) {\n      console.error(\"Error updating hours adjustment:\", error);\n      res.status(500).json({ error: \"Failed to update hours adjustment\" });\n    }\n  });\n\n  app.delete(\"/api/hours-adjustment/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const deleted = await storage.deleteHoursAdjustment(id);\n\n      if (deleted) {\n        res.json({ success: true });\n      } else {\n        res.status(500).json({ error: \"Failed to delete hours adjustment\" });\n      }\n    } catch (error) {\n      console.error(\"Error deleting hours adjustment:\", error);\n      res.status(500).json({ error: \"Failed to delete hours adjustment\" });\n    }\n  });\n\n  // ============================================\n  // MONTHLY ATTENDANCE (FOGLIO PRESENZE)\n  // ============================================\n\n  app.get(\"/api/attendance/monthly\", requireAdmin, async (req, res) => {\n    try {\n      const { year, month } = req.query;\n\n      if (!year || !month) {\n        return res.status(400).json({ error: \"Year and month are required\" });\n      }\n\n      const organizationId = (req as any).session.organizationId;\n      const data = await storage.getMonthlyAttendance(\n        organizationId,\n        year as string,\n        month as string,\n      );\n\n      res.json(data);\n    } catch (error) {\n      console.error(\"Error fetching monthly attendance:\", error);\n      res.status(500).json({ error: \"Failed to fetch monthly attendance\" });\n    }\n  });\n\n  app.get(\"/api/attendance/export-excel\", requireAdmin, async (req, res) => {\n    try {\n      const { year, month } = req.query;\n\n      if (!year || !month) {\n        return res.status(400).json({ error: \"Year and month are required\" });\n      }\n\n      const organizationId = (req as any).session.organizationId;\n      const buffer = await generateAttendanceExcel(\n        organizationId,\n        year as string,\n        month as string,\n      );\n\n      res.setHeader(\n        \"Content-Type\",\n        \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n      );\n      res.setHeader(\n        \"Content-Disposition\",\n        `attachment; filename=Presenze_${year}-${month}.xlsx`,\n      );\n\n      res.send(Buffer.from(buffer));\n    } catch (error) {\n      console.error(\"Error exporting attendance to Excel:\", error);\n      res.status(500).json({ error: \"Failed to export attendance to Excel\" });\n    }\n  });\n\n  // Get attendance statistics (absences) for admin dashboard\n  app.get(\"/api/attendance/stats\", requireAdmin, async (req, res) => {\n    try {\n      // Header anti-cache aggressivi\n      res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');\n      res.setHeader('Pragma', 'no-cache');\n      res.setHeader('Expires', '0');\n      res.setHeader('Surrogate-Control', 'no-store');\n      \n      const { days } = req.query;\n      const organizationId = (req as any).session.organizationId;\n      \n      const daysNum = days ? parseInt(days as string, 10) : 90;\n      const stats = await storage.getAttendanceStats(organizationId, daysNum);\n      \n      console.log(\"[DEBUG] Attendance stats for org\", organizationId, \":\", JSON.stringify({\n        totalAbsences: stats.totalAbsences,\n        byEmployeeCount: stats.byEmployee?.length,\n        byTypeKeys: Object.keys(stats.byType || {}),\n        byMonthCount: stats.byMonth?.length\n      }));\n      \n      res.status(200).json(stats);\n    } catch (error) {\n      console.error(\"Error fetching attendance stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch attendance statistics\" });\n    }\n  });\n\n  // Get attendance statistics for a specific employee\n  app.get(\"/api/attendance/stats/:userId\", requireAdmin, async (req, res) => {\n    try {\n      res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');\n      res.setHeader('Pragma', 'no-cache');\n      res.setHeader('Expires', '0');\n      \n      const { userId } = req.params;\n      const { days } = req.query;\n      const organizationId = (req as any).session.organizationId;\n      \n      const daysNum = days ? parseInt(days as string, 10) : 90;\n      const stats = await storage.getEmployeeAttendanceStats(organizationId, userId, daysNum);\n      \n      res.status(200).json(stats);\n    } catch (error) {\n      console.error(\"Error fetching employee attendance stats:\", error);\n      res.status(500).json({ error: \"Failed to fetch employee attendance statistics\" });\n    }\n  });\n\n  // Export strategic absences report as text\n  app.get(\"/api/attendance/strategic-report\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const { days } = req.query;\n      const daysNum = days ? parseInt(days as string, 10) : 90;\n      \n      const report = await storage.getStrategicAbsencesReport(organizationId, daysNum);\n      \n      res.setHeader('Content-Type', 'text/plain; charset=utf-8');\n      res.setHeader('Content-Disposition', `attachment; filename=\"report_assenze_strategiche_${new Date().toISOString().split('T')[0]}.txt\"`);\n      res.send(report);\n    } catch (error) {\n      console.error(\"Error generating strategic absences report:\", error);\n      res.status(500).json({ error: \"Failed to generate strategic absences report\" });\n    }\n  });\n\n  // ============================================\n  // PHOTO UPLOADS (Cloudinary)\n  // ============================================\n\n  app.post(\"/api/upload\", requireAuth, upload.single(\"file\"), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: \"Nessun file caricato\" });\n      }\n\n      const uploadFromBuffer = (buffer: Buffer): Promise<any> => {\n        return new Promise((resolve, reject) => {\n          const uploadStream = cloudinary.uploader.upload_stream(\n            {\n              folder: \"operation-photos\",\n              resource_type: \"image\",\n            },\n            (error, result) => {\n              if (error) {\n                reject(error);\n              } else {\n                resolve(result);\n              }\n            }\n          );\n          streamifier.createReadStream(buffer).pipe(uploadStream);\n        });\n      };\n\n      const result = await uploadFromBuffer(req.file.buffer);\n      res.json({ url: result.secure_url });\n    } catch (error) {\n      console.error(\"Error uploading to Cloudinary:\", error);\n      res.status(500).json({ error: \"Errore durante il caricamento dell'immagine\" });\n    }\n  });\n\n  // ============================================\n  // VEHICLES (MEZZI)\n  // ============================================\n\n  app.get(\"/api/vehicles\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const vehiclesList = await storage.getAllVehicles(organizationId);\n      res.json(vehiclesList);\n    } catch (error) {\n      console.error(\"Error fetching vehicles:\", error);\n      res.status(500).json({ error: \"Failed to fetch vehicles\" });\n    }\n  });\n\n  app.post(\"/api/vehicles\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const parsed = insertVehicleSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res\n          .status(400)\n          .json({ error: \"Invalid vehicle data\", details: parsed.error });\n      }\n      const vehicle = await storage.createVehicle(parsed.data, organizationId);\n      res.json(vehicle);\n    } catch (error) {\n      console.error(\"Error creating vehicle:\", error);\n      res.status(500).json({ error: \"Failed to create vehicle\" });\n    }\n  });\n\n  app.patch(\"/api/vehicles/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const organizationId = (req as any).session.organizationId;\n      const parsed = updateVehicleSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res\n          .status(400)\n          .json({ error: \"Invalid vehicle data\", details: parsed.error });\n      }\n      const vehicle = await storage.updateVehicle(\n        id,\n        parsed.data,\n        organizationId,\n      );\n      res.json(vehicle);\n    } catch (error) {\n      console.error(\"Error updating vehicle:\", error);\n      res.status(500).json({ error: \"Failed to update vehicle\" });\n    }\n  });\n\n  app.delete(\"/api/vehicles/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const organizationId = (req as any).session.organizationId;\n      const deleted = await storage.deleteVehicle(id, organizationId);\n      if (deleted) {\n        res.json({ success: true });\n      } else {\n        res.status(404).json({ error: \"Vehicle not found\" });\n      }\n    } catch (error) {\n      console.error(\"Error deleting vehicle:\", error);\n      res.status(500).json({ error: \"Failed to delete vehicle\" });\n    }\n  });\n\n  // ============================================\n  // FUEL REFILLS (RIFORNIMENTI)\n  // ============================================\n\n  app.get(\"/api/fuel-refills\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const refills = await storage.getAllFuelRefills(organizationId);\n      res.json(refills);\n    } catch (error) {\n      console.error(\"Error fetching fuel refills:\", error);\n      res.status(500).json({ error: \"Failed to fetch fuel refills\" });\n    }\n  });\n\n  app.get(\n    \"/api/fuel-refills/vehicle/:vehicleId\",\n    requireAdmin,\n    async (req, res) => {\n      try {\n        const organizationId = (req as any).session.organizationId;\n        const { vehicleId } = req.params;\n        const refills = await storage.getFuelRefillsByVehicle(\n          vehicleId,\n          organizationId,\n        );\n        res.json(refills);\n      } catch (error) {\n        console.error(\"Error fetching fuel refills for vehicle:\", error);\n        res.status(500).json({ error: \"Failed to fetch fuel refills\" });\n      }\n    },\n  );\n\n  app.post(\"/api/fuel-refills\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const parsed = insertFuelRefillSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res\n          .status(400)\n          .json({ error: \"Invalid fuel refill data\", details: parsed.error });\n      }\n      const refill = await storage.createFuelRefill(\n        parsed.data,\n        organizationId,\n      );\n      res.json(refill);\n    } catch (error) {\n      console.error(\"Error creating fuel refill:\", error);\n      res.status(500).json({ error: \"Failed to create fuel refill\" });\n    }\n  });\n\n  app.patch(\"/api/fuel-refills/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const organizationId = (req as any).session.organizationId;\n      const parsed = updateFuelRefillSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res\n          .status(400)\n          .json({ error: \"Invalid fuel refill data\", details: parsed.error });\n      }\n      const refill = await storage.updateFuelRefill(\n        id,\n        parsed.data,\n        organizationId,\n      );\n      res.json(refill);\n    } catch (error) {\n      console.error(\"Error updating fuel refill:\", error);\n      res.status(500).json({ error: \"Failed to update fuel refill\" });\n    }\n  });\n\n  app.delete(\"/api/fuel-refills/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const organizationId = (req as any).session.organizationId;\n      const deleted = await storage.deleteFuelRefill(id, organizationId);\n      if (deleted) {\n        res.json({ success: true });\n      } else {\n        res.status(404).json({ error: \"Fuel refill not found\" });\n      }\n    } catch (error) {\n      console.error(\"Error deleting fuel refill:\", error);\n      res.status(500).json({ error: \"Failed to delete fuel refill\" });\n    }\n  });\n\n  app.get(\"/api/fuel-refills/export\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const vehicleId = req.query.vehicleId as string | undefined;\n      const month = req.query.month as string | undefined;\n      const year = req.query.year as string | undefined;\n\n      const allRefills = await storage.getAllFuelRefills(organizationId);\n      const allTankLoads = await storage.getAllFuelTankLoads(organizationId);\n      const allVehicles = await storage.getAllVehicles(organizationId);\n\n      const filteredRefills = allRefills.filter((refill: any) => {\n        const refillDate = new Date(refill.refillDate);\n        const refillMonth = (refillDate.getMonth() + 1).toString();\n        const refillYear = refillDate.getFullYear().toString();\n\n        if (vehicleId && vehicleId !== \"all\" && refill.vehicleId !== vehicleId)\n          return false;\n        if (month && refillMonth !== month) return false;\n        if (year && refillYear !== year) return false;\n\n        return true;\n      });\n\n      const filteredTankLoads = allTankLoads.filter((load: any) => {\n        const loadDate = new Date(load.loadDate);\n        const loadMonth = (loadDate.getMonth() + 1).toString();\n        const loadYear = loadDate.getFullYear().toString();\n\n        if (month && loadMonth !== month) return false;\n        if (year && loadYear !== year) return false;\n\n        return true;\n      });\n\n      const ExcelJS = await import(\"exceljs\");\n      const workbook = new ExcelJS.default.Workbook();\n\n      const refillsSheet = workbook.addWorksheet(\"Rifornimenti (Scarichi)\");\n\n      refillsSheet.columns = [\n        { header: \"Data/Ora\", key: \"date\", width: 18 },\n        { header: \"Mezzo\", key: \"vehicle\", width: 30 },\n        { header: \"Litri Prima\", key: \"litersBefore\", width: 14 },\n        { header: \"Litri Dopo\", key: \"litersAfter\", width: 14 },\n        { header: \"Litri Erogati\", key: \"litersRefilled\", width: 14 },\n        { header: \"Km\", key: \"km\", width: 12 },\n        { header: \"Ore Motore\", key: \"hours\", width: 14 },\n        { header: \"Note\", key: \"notes\", width: 35 },\n      ];\n\n      const headerStyle = {\n        font: { bold: true, color: { argb: \"FFFFFFFF\" }, size: 11 },\n        fill: { type: \"pattern\" as const, pattern: \"solid\" as const, fgColor: { argb: \"FF2E7D32\" } },\n        alignment: { horizontal: \"center\" as const, vertical: \"middle\" as const },\n        border: {\n          top: { style: \"thin\" as const, color: { argb: \"FF1B5E20\" } },\n          bottom: { style: \"thin\" as const, color: { argb: \"FF1B5E20\" } },\n          left: { style: \"thin\" as const, color: { argb: \"FF1B5E20\" } },\n          right: { style: \"thin\" as const, color: { argb: \"FF1B5E20\" } },\n        },\n      };\n\n      const thinBorder = {\n        top: { style: \"thin\" as const, color: { argb: \"FFB0BEC5\" } },\n        bottom: { style: \"thin\" as const, color: { argb: \"FFB0BEC5\" } },\n        left: { style: \"thin\" as const, color: { argb: \"FFB0BEC5\" } },\n        right: { style: \"thin\" as const, color: { argb: \"FFB0BEC5\" } },\n      };\n\n      refillsSheet.getRow(1).height = 22;\n      refillsSheet.getRow(1).eachCell((cell: any) => {\n        cell.font = headerStyle.font;\n        cell.fill = headerStyle.fill;\n        cell.alignment = headerStyle.alignment;\n        cell.border = headerStyle.border;\n      });\n\n      let totalLitersRefilled = 0;\n      filteredRefills.forEach((refill: any, index: number) => {\n        const vehicle = allVehicles.find((v: any) => v.id === refill.vehicleId);\n        const vehicleName = vehicle\n          ? `${vehicle.name} (${vehicle.licensePlate})`\n          : \"Sconosciuto\";\n        const refillDate = new Date(refill.refillDate);\n        const dateStr = refillDate.toLocaleDateString(\"it-IT\", {\n          day: \"2-digit\",\n          month: \"2-digit\",\n          year: \"numeric\",\n        });\n        const timeStr = refillDate.toLocaleTimeString(\"it-IT\", {\n          hour: \"2-digit\",\n          minute: \"2-digit\",\n        });\n\n        const litersRefilled = refill.litersRefilled != null ? parseFloat(refill.litersRefilled) : 0;\n        totalLitersRefilled += litersRefilled;\n\n        const row = refillsSheet.addRow({\n          date: `${dateStr} ${timeStr}`,\n          vehicle: vehicleName,\n          litersBefore: refill.litersBefore != null ? parseFloat(refill.litersBefore).toFixed(2) : \"-\",\n          litersAfter: refill.litersAfter != null ? parseFloat(refill.litersAfter).toFixed(2) : \"-\",\n          litersRefilled: refill.litersRefilled != null ? parseFloat(refill.litersRefilled).toFixed(2) : \"-\",\n          km: refill.kmReading != null ? parseFloat(refill.kmReading).toFixed(0) : \"-\",\n          hours: refill.engineHoursReading != null ? parseFloat(refill.engineHoursReading).toFixed(1) : \"-\",\n          notes: refill.notes || \"\",\n        });\n\n        const rowFill = index % 2 === 0 \n          ? { type: \"pattern\" as const, pattern: \"solid\" as const, fgColor: { argb: \"FFF5F5F5\" } }\n          : { type: \"pattern\" as const, pattern: \"solid\" as const, fgColor: { argb: \"FFFFFFFF\" } };\n\n        row.eachCell((cell: any, colNumber: number) => {\n          cell.border = thinBorder;\n          cell.fill = rowFill;\n          if (colNumber >= 3 && colNumber <= 7) {\n            cell.alignment = { horizontal: \"center\" as const };\n          }\n        });\n      });\n\n      if (filteredRefills.length > 0) {\n        const totalRow = refillsSheet.addRow({\n          date: \"\",\n          vehicle: \"TOTALE\",\n          litersBefore: \"\",\n          litersAfter: \"\",\n          litersRefilled: totalLitersRefilled.toFixed(2),\n          km: \"\",\n          hours: \"\",\n          notes: \"\",\n        });\n        totalRow.font = { bold: true };\n        totalRow.eachCell((cell: any) => {\n          cell.fill = { type: \"pattern\" as const, pattern: \"solid\" as const, fgColor: { argb: \"FFE8F5E9\" } };\n          cell.border = thinBorder;\n        });\n        totalRow.getCell(5).alignment = { horizontal: \"center\" as const };\n      }\n\n      const loadsSheet = workbook.addWorksheet(\"Carichi Cisterna\");\n\n      loadsSheet.columns = [\n        { header: \"Data/Ora\", key: \"date\", width: 18 },\n        { header: \"Litri Caricati\", key: \"liters\", width: 16 },\n        { header: \"Costo Totale\", key: \"cost\", width: 14 },\n        { header: \"Fornitore\", key: \"supplier\", width: 30 },\n        { header: \"Note\", key: \"notes\", width: 40 },\n      ];\n\n      const loadsHeaderStyle = {\n        font: { bold: true, color: { argb: \"FFFFFFFF\" }, size: 11 },\n        fill: { type: \"pattern\" as const, pattern: \"solid\" as const, fgColor: { argb: \"FF1565C0\" } },\n        alignment: { horizontal: \"center\" as const, vertical: \"middle\" as const },\n        border: {\n          top: { style: \"thin\" as const, color: { argb: \"FF0D47A1\" } },\n          bottom: { style: \"thin\" as const, color: { argb: \"FF0D47A1\" } },\n          left: { style: \"thin\" as const, color: { argb: \"FF0D47A1\" } },\n          right: { style: \"thin\" as const, color: { argb: \"FF0D47A1\" } },\n        },\n      };\n\n      loadsSheet.getRow(1).height = 22;\n      loadsSheet.getRow(1).eachCell((cell: any) => {\n        cell.font = loadsHeaderStyle.font;\n        cell.fill = loadsHeaderStyle.fill;\n        cell.alignment = loadsHeaderStyle.alignment;\n        cell.border = loadsHeaderStyle.border;\n      });\n\n      let totalLitersLoaded = 0;\n      let totalCost = 0;\n      filteredTankLoads.forEach((load: any, index: number) => {\n        const loadDate = new Date(load.loadDate);\n        const dateStr = loadDate.toLocaleDateString(\"it-IT\", {\n          day: \"2-digit\",\n          month: \"2-digit\",\n          year: \"numeric\",\n        });\n        const timeStr = loadDate.toLocaleTimeString(\"it-IT\", {\n          hour: \"2-digit\",\n          minute: \"2-digit\",\n        });\n\n        const liters = load.liters != null ? parseFloat(load.liters) : 0;\n        const cost = load.totalCost ? parseFloat(load.totalCost) : 0;\n        totalLitersLoaded += liters;\n        totalCost += cost;\n\n        const row = loadsSheet.addRow({\n          date: `${dateStr} ${timeStr}`,\n          liters: load.liters != null ? parseFloat(load.liters).toFixed(2) : \"-\",\n          cost: load.totalCost ? `€${parseFloat(load.totalCost).toFixed(2)}` : \"-\",\n          supplier: load.supplier || \"\",\n          notes: load.notes || \"\",\n        });\n\n        const rowFill = index % 2 === 0 \n          ? { type: \"pattern\" as const, pattern: \"solid\" as const, fgColor: { argb: \"FFF5F5F5\" } }\n          : { type: \"pattern\" as const, pattern: \"solid\" as const, fgColor: { argb: \"FFFFFFFF\" } };\n\n        row.eachCell((cell: any, colNumber: number) => {\n          cell.border = thinBorder;\n          cell.fill = rowFill;\n          if (colNumber === 2 || colNumber === 3) {\n            cell.alignment = { horizontal: \"center\" as const };\n          }\n        });\n      });\n\n      if (filteredTankLoads.length > 0) {\n        const totalRow = loadsSheet.addRow({\n          date: \"TOTALE\",\n          liters: totalLitersLoaded.toFixed(2),\n          cost: `€${totalCost.toFixed(2)}`,\n          supplier: \"\",\n          notes: \"\",\n        });\n        totalRow.font = { bold: true };\n        totalRow.eachCell((cell: any) => {\n          cell.fill = { type: \"pattern\" as const, pattern: \"solid\" as const, fgColor: { argb: \"FFE3F2FD\" } };\n          cell.border = thinBorder;\n        });\n        totalRow.getCell(2).alignment = { horizontal: \"center\" as const };\n        totalRow.getCell(3).alignment = { horizontal: \"center\" as const };\n      }\n\n      const buffer = await workbook.xlsx.writeBuffer();\n\n      const monthName = month\n        ? [\n            \"Gen\",\n            \"Feb\",\n            \"Mar\",\n            \"Apr\",\n            \"Mag\",\n            \"Giu\",\n            \"Lug\",\n            \"Ago\",\n            \"Set\",\n            \"Ott\",\n            \"Nov\",\n            \"Dic\",\n          ][parseInt(month) - 1]\n        : \"\";\n      const fileName = `gestione_carburante${monthName ? `_${monthName}` : \"\"}${year ? `_${year}` : \"\"}.xlsx`;\n\n      res.setHeader(\n        \"Content-Type\",\n        \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n      );\n      res.setHeader(\n        \"Content-Disposition\",\n        `attachment; filename=\"${fileName}\"`,\n      );\n      res.send(buffer);\n    } catch (error) {\n      console.error(\"Error exporting fuel data:\", error);\n      res.status(500).json({ error: \"Failed to export fuel data\" });\n    }\n  });\n\n  // ============================================\n  // FUEL TANK LOADS (CARICHI CISTERNA)\n  // ============================================\n\n  app.get(\"/api/fuel-tank-loads\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const loads = await storage.getAllFuelTankLoads(organizationId);\n      res.json(loads);\n    } catch (error) {\n      console.error(\"Error fetching fuel tank loads:\", error);\n      res.status(500).json({ error: \"Failed to fetch fuel tank loads\" });\n    }\n  });\n\n  app.post(\"/api/fuel-tank-loads\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const parsed = insertFuelTankLoadSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res\n          .status(400)\n          .json({\n            error: \"Invalid fuel tank load data\",\n            details: parsed.error,\n          });\n      }\n      const load = await storage.createFuelTankLoad(\n        parsed.data,\n        organizationId,\n      );\n      res.json(load);\n    } catch (error) {\n      console.error(\"Error creating fuel tank load:\", error);\n      res.status(500).json({ error: \"Failed to create fuel tank load\" });\n    }\n  });\n\n  app.delete(\"/api/fuel-tank-loads/:id\", requireAdmin, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const organizationId = (req as any).session.organizationId;\n      const deleted = await storage.deleteFuelTankLoad(id, organizationId);\n      if (deleted) {\n        res.json({ success: true });\n      } else {\n        res.status(404).json({ error: \"Fuel tank load not found\" });\n      }\n    } catch (error) {\n      console.error(\"Error deleting fuel tank load:\", error);\n      res.status(500).json({ error: \"Failed to delete fuel tank load\" });\n    }\n  });\n\n  app.get(\"/api/fuel-remaining\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const remaining = await storage.getRemainingFuelLiters(organizationId);\n      res.json({ remaining });\n    } catch (error) {\n      console.error(\"Error fetching remaining fuel:\", error);\n      res.status(500).json({ error: \"Failed to fetch remaining fuel\" });\n    }\n  });\n\n  app.get(\"/api/fuel-refills/statistics\", requireAdmin, async (req, res) => {\n    try {\n      const organizationId = (req as any).session.organizationId;\n      const year = req.query.year as string | undefined;\n      const month = req.query.month as string | undefined;\n      const statistics = await storage.getFuelRefillsStatistics(\n        organizationId,\n        year,\n        month,\n      );\n      res.json(statistics);\n    } catch (error) {\n      console.error(\"Error fetching fuel refills statistics:\", error);\n      res\n        .status(500)\n        .json({ error: \"Failed to fetch fuel refills statistics\" });\n    }\n  });\n\n  const httpServer = createServer(app);\n\n  return httpServer;\n}\n","path":null,"size_bytes":83350,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* ============================================\n   LIGHT MODE THEME\n   ============================================ */\n:root {\n  --button-outline: rgba(0, 0, 0, .10);\n  --badge-outline: rgba(0, 0, 0, .05);\n\n  /* Automatic computation of border around primary / danger buttons */\n  --opaque-button-border-intensity: -8;\n  /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(0, 0, 0, .03);\n  --elevate-2: rgba(0, 0, 0, .08);\n\n  --background: 220 15% 98%;\n  --foreground: 220 15% 15%;\n  --border: 220 15% 85%;\n  --card: 220 15% 95%;\n  --card-foreground: 220 15% 15%;\n  --card-border: 220 15% 88%;\n\n  --sidebar: 220 15% 92%;\n  --sidebar-foreground: 220 15% 15%;\n  --sidebar-border: 220 15% 85%;\n  --sidebar-primary: 217 91% 60%;\n  --sidebar-primary-foreground: 220 15% 98%;\n  --sidebar-accent: 220 15% 88%;\n  --sidebar-accent-foreground: 220 15% 15%;\n  --sidebar-ring: 217 91% 60%;\n\n  --popover: 220 15% 90%;\n  --popover-foreground: 220 15% 15%;\n  --popover-border: 220 15% 82%;\n\n  --primary: 217 91% 60%;\n  --primary-foreground: 220 15% 98%;\n\n  --secondary: 220 15% 87%;\n  --secondary-foreground: 220 15% 15%;\n\n  --muted: 220 15% 89%;\n  --muted-foreground: 220 15% 45%;\n\n  --accent: 220 15% 91%;\n  --accent-foreground: 220 15% 15%;\n\n  --destructive: 0 84% 60%;\n  --destructive-foreground: 0 0% 98%;\n\n  --input: 220 15% 78%;\n  --ring: 217 91% 60%;\n\n  --chart-1: 217 91% 60%;\n  --chart-2: 142 76% 36%;\n  --chart-3: 38 92% 50%;\n  --chart-4: 280 65% 60%;\n  --chart-5: 12 76% 61%;\n\n  /* Optimized Font Stack */\n  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n  --font-serif: Georgia, 'Times New Roman', serif;\n  --font-mono: 'JetBrains Mono', 'Courier New', monospace;\n\n  --radius: .5rem;\n  /* 8px */\n\n  /* Shadows */\n  --shadow-2xs: 0px 1px 2px 0px hsl(220 15% 15% / 0.05);\n  --shadow-xs: 0px 1px 3px 0px hsl(220 15% 15% / 0.10);\n  --shadow-sm: 0px 1px 2px 0px hsl(220 15% 15% / 0.05), 0px 2px 4px -1px hsl(220 15% 15% / 0.10);\n  --shadow: 0px 1px 3px 0px hsl(220 15% 15% / 0.10), 0px 4px 6px -2px hsl(220 15% 15% / 0.10);\n  --shadow-md: 0px 4px 6px -1px hsl(220 15% 15% / 0.10), 0px 2px 4px -1px hsl(220 15% 15% / 0.06);\n  --shadow-lg: 0px 10px 15px -3px hsl(220 15% 15% / 0.10), 0px 4px 6px -2px hsl(220 15% 15% / 0.05);\n  --shadow-xl: 0px 20px 25px -5px hsl(220 15% 15% / 0.10), 0px 10px 10px -5px hsl(220 15% 15% / 0.04);\n  --shadow-2xl: 0px 25px 50px -12px hsl(220 15% 15% / 0.25);\n\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n  /* Automatically computed borders */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n/* ============================================\n   DARK MODE THEME\n   ============================================ */\n.dark {\n  --button-outline: rgba(255, 255, 255, .10);\n  --badge-outline: rgba(255, 255, 255, .05);\n  --opaque-button-border-intensity: 9;\n\n  --elevate-1: rgba(255, 255, 255, .04);\n  --elevate-2: rgba(255, 255, 255, .09);\n\n  --background: 220 15% 8%;\n  --foreground: 220 15% 95%;\n  --border: 220 15% 18%;\n  --card: 220 15% 12%;\n  --card-foreground: 220 15% 95%;\n  --card-border: 220 15% 20%;\n\n  --sidebar: 220 15% 10%;\n  --sidebar-foreground: 220 15% 95%;\n  --sidebar-border: 220 15% 16%;\n  --sidebar-primary: 217 91% 60%;\n  --sidebar-primary-foreground: 220 15% 95%;\n  --sidebar-accent: 220 15% 14%;\n  --sidebar-accent-foreground: 220 15% 95%;\n  --sidebar-ring: 217 91% 60%;\n\n  --popover: 220 15% 15%;\n  --popover-foreground: 220 15% 95%;\n  --popover-border: 220 15% 22%;\n\n  --primary: 217 91% 60%;\n  --primary-foreground: 220 15% 95%;\n\n  --secondary: 220 15% 16%;\n  --secondary-foreground: 220 15% 95%;\n\n  --muted: 220 15% 14%;\n  --muted-foreground: 220 15% 65%;\n\n  --accent: 220 15% 13%;\n  --accent-foreground: 220 15% 95%;\n\n  --destructive: 0 84% 60%;\n  --destructive-foreground: 220 15% 95%;\n\n  --input: 220 15% 24%;\n  --ring: 217 91% 60%;\n\n  --chart-1: 217 91% 70%;\n  --chart-2: 142 76% 50%;\n  --chart-3: 38 92% 60%;\n  --chart-4: 280 65% 70%;\n  --chart-5: 12 76% 70%;\n\n  --shadow-2xs: 0px 1px 2px 0px hsl(220 15% 3% / 0.20);\n  --shadow-xs: 0px 1px 3px 0px hsl(220 15% 3% / 0.30);\n  --shadow-sm: 0px 1px 2px 0px hsl(220 15% 3% / 0.20), 0px 2px 4px -1px hsl(220 15% 3% / 0.30);\n  --shadow: 0px 1px 3px 0px hsl(220 15% 3% / 0.30), 0px 4px 6px -2px hsl(220 15% 3% / 0.30);\n  --shadow-md: 0px 4px 6px -1px hsl(220 15% 3% / 0.30), 0px 2px 4px -1px hsl(220 15% 3% / 0.20);\n  --shadow-lg: 0px 10px 15px -3px hsl(220 15% 3% / 0.30), 0px 4px 6px -2px hsl(220 15% 3% / 0.20);\n  --shadow-xl: 0px 20px 25px -5px hsl(220 15% 3% / 0.30), 0px 10px 10px -5px hsl(220 15% 3% / 0.15);\n  --shadow-2xl: 0px 25px 50px -12px hsl(220 15% 3% / 0.40);\n}\n\n/* ============================================\n   BASE STYLES\n   ============================================ */\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n\n  /* Better font rendering */\n  body {\n    -webkit-font-smoothing: antialiased;\n    -moz-osx-font-smoothing: grayscale;\n    text-rendering: optimizeLegibility;\n  }\n}\n\n/* ============================================\n   UTILITY CLASSES\n   ============================================ */\n@layer utilities {\n\n  /* Hide search cancel button in Chrome */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* Elevation system - for hover/active states */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    border-radius: inherit;\n    z-index: -1;\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    border-radius: inherit;\n    z-index: 999;\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n\n  /* ============================================\n     UPPY MODAL CUSTOMIZATION\n     ============================================ */\n  .uppy-Dashboard-isFixed {\n    z-index: 9999 !important;\n  }\n\n  /* Mobile-friendly modal */\n  @media (max-width: 768px) {\n    .uppy-Dashboard-inner {\n      max-height: 85vh !important;\n      max-width: 95vw !important;\n      margin: auto !important;\n      border-radius: 12px !important;\n    }\n\n    .uppy-Dashboard-isFixed .uppy-Dashboard-inner {\n      top: 50% !important;\n      left: 50% !important;\n      transform: translate(-50%, -50%) !important;\n      position: fixed !important;\n    }\n\n    .uppy-Dashboard-Item-action--remove,\n    .uppy-DashboardContent-addMore {\n      min-width: 44px !important;\n      min-height: 44px !important;\n    }\n\n    .uppy-DashboardTab {\n      padding: 12px 16px !important;\n      font-size: 15px !important;\n    }\n  }\n\n  /* Desktop modal */\n  @media (min-width: 769px) {\n    .uppy-Dashboard-inner {\n      max-width: 650px !important;\n      max-height: 90vh !important;\n      border-radius: 16px !important;\n    }\n\n    .uppy-Dashboard-isFixed .uppy-Dashboard-inner {\n      top: 50% !important;\n      left: 50% !important;\n      transform: translate(-50%, -50%) !important;\n    }\n  }\n\n  /* Theme integration */\n  .uppy-Dashboard-inner {\n    background-color: hsl(var(--popover)) !important;\n    border: 1px solid hsl(var(--popover-border)) !important;\n  }\n\n  .uppy-Dashboard-AddFiles-title {\n    color: hsl(var(--popover-foreground)) !important;\n  }\n\n  .uppy-DashboardTab-btn {\n    color: hsl(var(--muted-foreground)) !important;\n  }\n\n  .uppy-DashboardTab-btn:hover {\n    background-color: hsl(var(--accent)) !important;\n    color: hsl(var(--accent-foreground)) !important;\n  }\n\n  .uppy-size--md .uppy-Dashboard-note {\n    color: hsl(var(--muted-foreground)) !important;\n    font-size: 14px !important;\n    margin-top: 8px !important;\n  }\n}","path":null,"size_bytes":10423,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"shared/holidays.ts":{"content":"// Italian national holidays and utility functions\n\nexport function getEasterDate(year: number): Date {\n  // Meeus/Jones/Butcher algorithm for calculating Easter\n  const a = year % 19;\n  const b = Math.floor(year / 100);\n  const c = year % 100;\n  const d = Math.floor(b / 4);\n  const e = b % 4;\n  const f = Math.floor((b + 8) / 25);\n  const g = Math.floor((b - f + 1) / 3);\n  const h = (19 * a + b - d - g + 15) % 30;\n  const i = Math.floor(c / 4);\n  const k = c % 4;\n  const l = (32 + 2 * e + 2 * i - h - k) % 7;\n  const m = Math.floor((a + 11 * h + 22 * l) / 451);\n  const month = Math.floor((h + l - 7 * m + 114) / 31);\n  const day = ((h + l - 7 * m + 114) % 31) + 1;\n  return new Date(year, month - 1, day);\n}\n\nexport function isItalianHoliday(date: string): boolean {\n  // date is in YYYY-MM-DD format\n  const [year, month, day] = date.split('-').map(Number);\n  \n  // Fixed holidays\n  const fixedHolidays = [\n    '01-01', // Capodanno\n    '01-06', // Epifania\n    '04-25', // Liberazione\n    '05-01', // Festa del Lavoro\n    '06-02', // Festa della Repubblica\n    '08-15', // Ferragosto\n    '11-01', // Tutti i Santi\n    '12-08', // Immacolata\n    '12-25', // Natale\n    '12-26', // Santo Stefano\n  ];\n  \n  const monthDay = `${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;\n  if (fixedHolidays.includes(monthDay)) {\n    return true;\n  }\n  \n  // Easter Monday (Pasquetta)\n  const easter = getEasterDate(year);\n  const easterMonday = new Date(easter);\n  easterMonday.setDate(easter.getDate() + 1);\n  \n  if (month === easterMonday.getMonth() + 1 && day === easterMonday.getDate()) {\n    return true;\n  }\n  \n  return false;\n}\n\nexport function getDayOfWeek(date: string): number {\n  // date is in YYYY-MM-DD format\n  // Returns 0 (Sunday) to 6 (Saturday)\n  const [year, month, day] = date.split('-').map(Number);\n  return new Date(year, month - 1, day).getDay();\n}\n\nexport function isSaturday(date: string): boolean {\n  return getDayOfWeek(date) === 6;\n}\n\nexport function isSunday(date: string): boolean {\n  return getDayOfWeek(date) === 0;\n}\n\nexport function getDaysInMonth(year: number, month: number): number {\n  return new Date(year, month, 0).getDate();\n}\n","path":null,"size_bytes":2186,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n        // Work report specific colors\n        success: \"142 76% 36%\",\n        warning: \"38 92% 50%\",\n        pending: \"38 92% 50%\",\n        approved: \"142 76% 36%\",\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4216,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"client/src/components/examples/StatusBadge.tsx":{"content":"import StatusBadge from \"../StatusBadge\";\n\nexport default function StatusBadgeExample() {\n  return (\n    <div className=\"p-4 space-y-4 bg-background\">\n      <div className=\"space-y-2\">\n        <h3 className=\"font-medium\">Status Badge Examples</h3>\n        <div className=\"flex gap-4\">\n          <StatusBadge status=\"In attesa\" />\n          <StatusBadge status=\"Approvato\" />\n        </div>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":420,"size_tokens":null},"client/src/components/examples/LoginForm.tsx":{"content":"import LoginForm from \"../LoginForm\";\n\nexport default function LoginFormExample() {\n  const handleLogin = (username: string, password: string, role: string) => {\n    console.log(\"Login example - User:\", username, \"Role:\", role);\n    alert(`Login simulato: ${username} come ${role === 'employee' ? 'Dipendente' : 'Amministratore'}`);\n  };\n\n  return <LoginForm onLogin={handleLogin} />;\n}","path":null,"size_bytes":386,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/App.tsx":{"content":"import { useState } from \"react\";\nimport { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport {\n  QueryClientProvider,\n  useMutation,\n  useQuery,\n} from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { ThemeProvider } from \"@/components/ThemeProvider\";\nimport { Button } from \"@/components/ui/button\";\nimport { LogOut } from \"lucide-react\";\nimport NotFound from \"@/pages/not-found\";\nimport LoginForm from \"@/components/LoginForm\";\nimport DailyReportForm from \"@/components/DailyReportForm\";\nimport AdminDashboard from \"@/components/AdminDashboard\";\nimport SuperAdminDashboard from \"@/components/SuperAdminDashboard\";\nimport ThemeToggle from \"@/components/ThemeToggle\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { formatDateToItalian } from \"@/lib/dateUtils\";\n\ntype User = {\n  username: string;\n  role: \"employee\" | \"admin\" | \"superadmin\";\n  fullName: string;\n};\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\n// ============================================\n// AUTHENTICATED APP COMPONENT\n// ============================================\n\nfunction AuthenticatedApp({\n  currentUser,\n  onLogout,\n}: {\n  currentUser: User;\n  onLogout: () => void;\n}) {\n  const { toast } = useToast();\n\n  const handleLogout = async () => {\n    try {\n      // Call logout API to destroy session\n      await fetch(\"/api/logout\", {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n    } catch (error) {\n      console.error(\"Error during logout:\", error);\n    } finally {\n      // Always clear frontend state regardless of API call result\n      onLogout();\n      toast({\n        title: \"Logout effettuato\",\n        description: \"Sei stato disconnesso con successo.\",\n      });\n    }\n  };\n\n  // Load today's report if exists (only for employees)\n  const {\n    data: todayReport,\n    isLoading: loadingTodayReport,\n    error: reportError,\n    isError: hasReportError,\n  } = useQuery<any>({\n    queryKey: [\"/api/daily-reports/today\"],\n    enabled: currentUser.role === \"employee\",\n    retry: false,\n    staleTime: 0,\n  });\n\n  // Determine if the error is a 404 (no report exists) or a real server error\n  // The queryClient throws errors in format \"404: error message\"\n  const isReportNotFound = hasReportError && (reportError as Error)?.message?.startsWith('404');\n  const hasServerError = hasReportError && !isReportNotFound;\n\n  // Mutation to create new daily report\n  const createReportMutation = useMutation({\n    mutationFn: async (operations: any[]) => {\n      if (!currentUser) throw new Error(\"User not logged in\");\n\n      const response = await apiRequest(\"POST\", \"/api/daily-reports\", {\n        operations,\n      });\n\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-reports/today\"] });\n      toast({\n        title: \"Rapportino creato\",\n        description:\n          \"Il rapportino è stato inviato con successo e è in attesa di approvazione.\",\n      });\n    },\n    onError: (error: any) => {\n      console.error(\"Error creating report:\", error);\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile creare il rapportino. Riprova più tardi.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation to update existing daily report\n  const updateReportMutation = useMutation({\n    mutationFn: async ({\n      reportId,\n      operations,\n    }: {\n      reportId: string;\n      operations: any[];\n    }) => {\n      const response = await apiRequest(\n        \"PUT\",\n        `/api/daily-reports/${reportId}`,\n        {\n          operations,\n        },\n      );\n\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-reports/today\"] });\n      toast({\n        title: \"Rapportino aggiornato\",\n        description: \"Le lavorazioni sono state aggiunte con successo.\",\n      });\n    },\n    onError: (error: any) => {\n      console.error(\"Error updating report:\", error);\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile aggiornare il rapportino. Riprova più tardi.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleReportSubmit = (operations: any[]) => {\n    if (todayReport) {\n      // Update existing report\n      updateReportMutation.mutate({ reportId: todayReport.id, operations });\n    } else {\n      // Create new report\n      createReportMutation.mutate(operations);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <header className=\"border-b bg-card\">\n        <div className=\"container mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h1 className=\"text-xl font-semibold\">\n                {currentUser.role === \"superadmin\"\n                  ? \"Super Admin\"\n                  : currentUser.role === \"admin\"\n                  ? \"Dashboard Amministratore\"\n                  : \"Rapportini Giornalieri\"}\n              </h1>\n              <p className=\"text-sm text-muted-foreground\">\n                Benvenuto, {currentUser.fullName}\n              </p>\n            </div>\n\n            <div className=\"flex items-center gap-2\">\n              <ThemeToggle />\n              <Button\n                variant=\"outline\"\n                onClick={handleLogout}\n                data-testid=\"button-logout\"\n              >\n                <LogOut className=\"h-4 w-4 mr-2\" />\n                Esci\n              </Button>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      {/* Main Content */}\n      <main className=\"container mx-auto\">\n        {currentUser.role === \"superadmin\" ? (\n          <SuperAdminDashboard />\n        ) : currentUser.role === \"admin\" ? (\n          <AdminDashboard />\n        ) : (\n          <div className=\"py-6\">\n            {loadingTodayReport ? (\n              <div className=\"flex items-center justify-center p-8\">\n                <div className=\"text-center\">\n                  <div className=\"inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent motion-reduce:animate-[spin_1.5s_linear_infinite]\" />\n                  <p className=\"text-muted-foreground mt-2\">Caricamento...</p>\n                </div>\n              </div>\n            ) : hasServerError ? (\n              <div className=\"flex items-center justify-center p-8\">\n                <div className=\"text-center\">\n                  <p className=\"text-destructive mb-2\">Errore di caricamento</p>\n                  <p className=\"text-muted-foreground text-sm\">\n                    Si è verificato un errore durante il caricamento del rapportino. Riprova più tardi.\n                  </p>\n                </div>\n              </div>\n            ) : (\n              <DailyReportForm\n                employeeName={currentUser.fullName}\n                date={formatDateToItalian(\n                  new Date().toISOString().split(\"T\")[0],\n                )}\n                onSubmit={handleReportSubmit}\n                initialOperations={todayReport?.operations}\n                isEditing={!!todayReport}\n                isSubmitting={\n                  createReportMutation.isPending ||\n                  updateReportMutation.isPending\n                }\n              />\n            )}\n          </div>\n        )}\n      </main>\n    </div>\n  );\n}\n\n// ============================================\n// MAIN APP COMPONENT\n// ============================================\n\nfunction App() {\n  const [currentUser, setCurrentUser] = useState<User | null>(null);\n  const { toast } = useToast();\n\n  const handleLogin = async (\n    username: string,\n    password: string,\n  ): Promise<{ success: boolean; error?: string }> => {\n    try {\n      const response = await fetch(\"/api/login\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        credentials: \"include\", // Include session cookies\n        body: JSON.stringify({ username, password }),\n      });\n\n      const data = await response.json();\n\n      if (response.ok && data.success) {\n        setCurrentUser(data.user);\n        toast({\n          title: \"Login effettuato\",\n          description: `Benvenuto, ${data.user.fullName}!`,\n        });\n        return { success: true };\n      } else {\n        return { success: false, error: data.error || \"Login fallito\" };\n      }\n    } catch (error) {\n      console.error(\"Error during login:\", error);\n      return { success: false, error: \"Errore di connessione al server\" };\n    }\n  };\n\n  const handleLogout = () => {\n    setCurrentUser(null);\n  };\n\n  // Show login form if not authenticated\n  if (!currentUser) {\n    return (\n      <QueryClientProvider client={queryClient}>\n        <TooltipProvider>\n          <ThemeProvider>\n            <LoginForm onLogin={handleLogin} />\n            <Toaster />\n          </ThemeProvider>\n        </TooltipProvider>\n      </QueryClientProvider>\n    );\n  }\n\n  // Show authenticated app\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <ThemeProvider>\n          <AuthenticatedApp currentUser={currentUser} onLogout={handleLogout} />\n          <Toaster />\n        </ThemeProvider>\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":9518,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"server/storage.ts":{"content":"import { \n  users,\n  clients,\n  workTypes,\n  materials,\n  workOrders,\n  dailyReports,\n  operations,\n  attendanceEntries,\n  hoursAdjustments,\n  vehicles,\n  fuelRefills,\n  fuelTankLoads,\n  organizations,\n  type User, \n  type InsertUser,\n  type Client,\n  type InsertClient,\n  type WorkType,\n  type InsertWorkType,\n  type Material,\n  type InsertMaterial,\n  type WorkOrder,\n  type InsertWorkOrder,\n  type DailyReport,\n  type InsertDailyReport,\n  type Operation,\n  type InsertOperation,\n  type AttendanceEntry,\n  type InsertAttendanceEntry,\n  type UpdateAttendanceEntry,\n  type HoursAdjustment,\n  type InsertHoursAdjustment,\n  type UpdateHoursAdjustment,\n  type Vehicle,\n  type InsertVehicle,\n  type UpdateVehicle,\n  type FuelRefill,\n  type InsertFuelRefill,\n  type UpdateFuelRefill,\n  type FuelTankLoad,\n  type InsertFuelTankLoad,\n  type UpdateFuelTankLoad,\n  type UpdateDailyReport,\n  type UpdateOperation,\n  type Organization,\n  type InsertOrganization\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, and, desc } from \"drizzle-orm\";\nimport { hashPassword } from \"./auth\";\n\n// Helper functions for strategic absences detection\n// Cache holidays by year to avoid recomputation\nconst holidaysCache = new Map<number, Set<string>>();\n\nfunction getItalianHolidays(year: number): Set<string> {\n  if (holidaysCache.has(year)) {\n    return holidaysCache.get(year)!;\n  }\n  \n  const holidays = new Set<string>();\n  \n  // Fixed Italian national holidays\n  holidays.add(`${year}-01-01`); // Capodanno\n  holidays.add(`${year}-01-06`); // Epifania\n  holidays.add(`${year}-04-25`); // Liberazione\n  holidays.add(`${year}-05-01`); // Festa del Lavoro\n  holidays.add(`${year}-06-02`); // Festa della Repubblica\n  holidays.add(`${year}-08-15`); // Ferragosto\n  holidays.add(`${year}-11-01`); // Ognissanti\n  holidays.add(`${year}-12-08`); // Immacolata\n  holidays.add(`${year}-12-25`); // Natale\n  holidays.add(`${year}-12-26`); // Santo Stefano\n  \n  // Easter and Easter Monday (calculated)\n  const easter = calculateEaster(year);\n  const easterMonday = new Date(easter);\n  easterMonday.setDate(easterMonday.getDate() + 1);\n  holidays.add(formatDateToString(easter));\n  holidays.add(formatDateToString(easterMonday));\n  \n  holidaysCache.set(year, holidays);\n  return holidays;\n}\n\nfunction formatDateToString(date: Date): string {\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  return `${year}-${month}-${day}`;\n}\n\nfunction calculateEaster(year: number): Date {\n  // Anonymous Gregorian algorithm\n  const a = year % 19;\n  const b = Math.floor(year / 100);\n  const c = year % 100;\n  const d = Math.floor(b / 4);\n  const e = b % 4;\n  const f = Math.floor((b + 8) / 25);\n  const g = Math.floor((b - f + 1) / 3);\n  const h = (19 * a + b - d - g + 15) % 30;\n  const i = Math.floor(c / 4);\n  const k = c % 4;\n  const l = (32 + 2 * e + 2 * i - h - k) % 7;\n  const m = Math.floor((a + 11 * h + 22 * l) / 451);\n  const month = Math.floor((h + l - 7 * m + 114) / 31);\n  const day = ((h + l - 7 * m + 114) % 31) + 1;\n  return new Date(year, month - 1, day);\n}\n\nfunction getAllHolidaysForDateRange(dateStr: string): Set<string> {\n  // Get holidays for current year and adjacent years to handle year boundaries\n  const date = new Date(dateStr + 'T12:00:00'); // Use noon to avoid timezone issues\n  const year = date.getFullYear();\n  const allHolidays = new Set<string>();\n  \n  // Always include current year and adjacent years for boundary cases\n  [year - 1, year, year + 1].forEach(y => {\n    getItalianHolidays(y).forEach(h => allHolidays.add(h));\n  });\n  \n  return allHolidays;\n}\n\nfunction isNonWorkingDay(date: Date, holidays: Set<string>): boolean {\n  const dayOfWeek = date.getDay();\n  // Weekend (Saturday = 6, Sunday = 0)\n  if (dayOfWeek === 0 || dayOfWeek === 6) return true;\n  // Holiday\n  const dateStr = formatDateToString(date);\n  return holidays.has(dateStr);\n}\n\nfunction isStrategicAbsence(dateStr: string): boolean {\n  // Parse date at noon to avoid timezone issues\n  const date = new Date(dateStr + 'T12:00:00');\n  const holidays = getAllHolidaysForDateRange(dateStr);\n  \n  // Check if the day before is non-working\n  const dayBefore = new Date(date);\n  dayBefore.setDate(dayBefore.getDate() - 1);\n  const beforeIsNonWorking = isNonWorkingDay(dayBefore, holidays);\n  \n  // Check if the day after is non-working\n  const dayAfter = new Date(date);\n  dayAfter.setDate(dayAfter.getDate() + 1);\n  const afterIsNonWorking = isNonWorkingDay(dayAfter, holidays);\n  \n  // Strategic if adjacent to non-working day\n  return beforeIsNonWorking || afterIsNonWorking;\n}\n\nexport interface IStorage {\n  // Organizations (Super Admin)\n  getAllOrganizations(): Promise<Organization[]>;\n  getOrganization(id: string): Promise<Organization | undefined>;\n  getOrganizationByName(name: string): Promise<Organization | undefined>;\n  createOrganization(org: InsertOrganization): Promise<Organization>;\n  updateOrganizationStatus(id: string, isActive: boolean): Promise<Organization | undefined>;\n\n  // Users\n  getAllUsers(organizationId: string): Promise<User[]>;\n  getActiveUsers(organizationId: string): Promise<User[]>;\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  createUser(user: InsertUser, organizationId: string): Promise<User>;\n  updateUser(id: string, updates: Partial<InsertUser>): Promise<User>;\n  updateUserStatus(id: string, isActive: boolean): Promise<User>;\n  deleteUser(id: string): Promise<boolean>;\n  \n  // Clients\n  getAllClients(organizationId: string): Promise<Client[]>;\n  createClient(client: InsertClient, organizationId: string): Promise<Client>;\n  deleteClient(id: string): Promise<boolean>;\n  \n  // Work Types (Lavorazioni)\n  getAllWorkTypes(organizationId: string): Promise<WorkType[]>;\n  getWorkType(id: string): Promise<WorkType | undefined>;\n  createWorkType(workType: InsertWorkType, organizationId: string): Promise<WorkType>;\n  updateWorkType(id: string, updates: Partial<InsertWorkType>): Promise<WorkType>;\n  deleteWorkType(id: string): Promise<boolean>;\n  \n  // Materials (Materiali)\n  getAllMaterials(organizationId: string): Promise<Material[]>;\n  getMaterial(id: string): Promise<Material | undefined>;\n  createMaterial(material: InsertMaterial, organizationId: string): Promise<Material>;\n  updateMaterial(id: string, updates: Partial<InsertMaterial>): Promise<Material>;\n  deleteMaterial(id: string): Promise<boolean>;\n  \n  // Work Orders\n  getAllWorkOrders(organizationId: string): Promise<WorkOrder[]>;\n  getWorkOrdersByClient(clientId: string, organizationId: string): Promise<WorkOrder[]>;\n  getWorkOrder(id: string, organizationId: string): Promise<WorkOrder | undefined>;\n  createWorkOrder(workOrder: InsertWorkOrder, organizationId: string): Promise<WorkOrder>;\n  updateWorkOrder(id: string, updates: Partial<InsertWorkOrder>): Promise<WorkOrder>;\n  updateWorkOrderStatus(id: string, isActive: boolean): Promise<WorkOrder>;\n  deleteWorkOrder(id: string): Promise<boolean>;\n  \n  // Daily Reports\n  getAllDailyReports(organizationId: string): Promise<DailyReport[]>;\n  getDailyReportsByDate(date: string, organizationId: string): Promise<DailyReport[]>;\n  getDailyReport(id: string): Promise<DailyReport | undefined>;\n  getDailyReportByEmployeeAndDate(employeeId: string, date: string, organizationId: string): Promise<DailyReport | undefined>;\n  createDailyReport(report: InsertDailyReport, organizationId: string): Promise<DailyReport>;\n  updateDailyReport(id: string, updates: UpdateDailyReport): Promise<DailyReport>;\n  updateDailyReportStatus(id: string, status: string): Promise<DailyReport>;\n  deleteDailyReport(id: string): Promise<boolean>;\n  \n  // Operations\n  getOperationsByReportId(reportId: string): Promise<Operation[]>;\n  getOperationsByWorkOrderId(workOrderId: string, organizationId: string): Promise<Operation[]>;\n  getOperationsCountByWorkOrderId(workOrderId: string): Promise<number>;\n  getOperationsCountByClientId(clientId: string): Promise<number>;\n  getOperation(id: string): Promise<Operation | undefined>;\n  createOperation(operation: InsertOperation): Promise<Operation>;\n  updateOperation(id: string, updates: UpdateOperation): Promise<Operation>;\n  deleteOperation(id: string): Promise<boolean>;\n  deleteOperationsByReportId(reportId: string): Promise<boolean>;\n  deleteOperationsByWorkOrderId(workOrderId: string): Promise<boolean>;\n  deleteOperationsByClientId(clientId: string): Promise<boolean>;\n  \n  // Counts for cascade delete\n  getDailyReportsCountByEmployeeId(employeeId: string): Promise<number>;\n  getWorkOrdersCountByClientId(clientId: string): Promise<number>;\n  deleteDailyReportsByEmployeeId(employeeId: string): Promise<boolean>;\n  deleteWorkOrdersByClientId(clientId: string): Promise<boolean>;\n  \n  // Statistics\n  getWorkOrdersStats(organizationId: string): Promise<Array<{\n    workOrderId: string;\n    totalOperations: number;\n    totalHours: number;\n    lastActivity: string | null;\n  }>>;\n  \n  // Attendance Entries (Assenze)\n  getAllAttendanceEntries(organizationId: string, year: string, month: string): Promise<AttendanceEntry[]>;\n  getAttendanceEntriesByDate(date: string, organizationId: string): Promise<AttendanceEntry[]>;\n  getAttendanceEntry(userId: string, date: string, organizationId: string): Promise<AttendanceEntry | undefined>;\n  createAttendanceEntry(entry: InsertAttendanceEntry, organizationId: string): Promise<AttendanceEntry>;\n  updateAttendanceEntry(id: string, updates: UpdateAttendanceEntry): Promise<AttendanceEntry>;\n  deleteAttendanceEntry(id: string): Promise<boolean>;\n  deleteAttendanceEntriesByUserId(userId: string, organizationId: string): Promise<boolean>;\n  \n  // Hours adjustments\n  getHoursAdjustment(dailyReportId: string, organizationId: string): Promise<HoursAdjustment | undefined>;\n  createHoursAdjustment(adjustment: InsertHoursAdjustment, organizationId: string, createdBy: string): Promise<HoursAdjustment>;\n  updateHoursAdjustment(id: string, updates: UpdateHoursAdjustment): Promise<HoursAdjustment>;\n  deleteHoursAdjustment(id: string): Promise<boolean>;\n  deleteHoursAdjustmentsByReportId(reportId: string): Promise<boolean>;\n  \n  // Vehicles (Mezzi)\n  getAllVehicles(organizationId: string): Promise<Vehicle[]>;\n  getVehicle(id: string): Promise<Vehicle | undefined>;\n  createVehicle(vehicle: InsertVehicle, organizationId: string): Promise<Vehicle>;\n  updateVehicle(id: string, updates: UpdateVehicle, organizationId: string): Promise<Vehicle>;\n  deleteVehicle(id: string, organizationId: string): Promise<boolean>;\n  \n  // Fuel Refills (Rifornimenti)\n  getAllFuelRefills(organizationId: string): Promise<FuelRefill[]>;\n  getFuelRefillsByVehicle(vehicleId: string, organizationId: string): Promise<FuelRefill[]>;\n  getFuelRefill(id: string): Promise<FuelRefill | undefined>;\n  createFuelRefill(refill: InsertFuelRefill, organizationId: string): Promise<FuelRefill>;\n  updateFuelRefill(id: string, updates: UpdateFuelRefill, organizationId: string): Promise<FuelRefill>;\n  deleteFuelRefill(id: string, organizationId: string): Promise<boolean>;\n  deleteFuelRefillsByVehicleId(vehicleId: string): Promise<boolean>;\n  \n  // Fuel Tank Loads (Carichi cisterna)\n  getAllFuelTankLoads(organizationId: string): Promise<FuelTankLoad[]>;\n  getFuelTankLoad(id: string): Promise<FuelTankLoad | undefined>;\n  createFuelTankLoad(load: InsertFuelTankLoad, organizationId: string): Promise<FuelTankLoad>;\n  updateFuelTankLoad(id: string, updates: UpdateFuelTankLoad, organizationId: string): Promise<FuelTankLoad>;\n  deleteFuelTankLoad(id: string, organizationId: string): Promise<boolean>;\n  getRemainingFuelLiters(organizationId: string): Promise<number>;\n  getFuelRefillsStatistics(organizationId: string, year?: string, month?: string): Promise<{\n    byVehicle: Array<{\n      vehicleId: string;\n      vehicleName: string;\n      totalLiters: number;\n      totalCost: number;\n      refillCount: number;\n    }>;\n    byMonth: Array<{\n      month: string;\n      year: string;\n      totalLiters: number;\n      totalCost: number;\n      refillCount: number;\n    }>;\n  }>;\n  \n  // Monthly Attendance (Foglio Presenze)\n  getMonthlyAttendance(organizationId: string, year: string, month: string): Promise<any>;\n  \n  // Attendance Statistics (Statistiche Assenze)\n  getAttendanceStats(organizationId: string, days?: number): Promise<{\n    byEmployee: Array<{\n      userId: string;\n      fullName: string;\n      totalAbsences: number;\n      strategicAbsences: number;\n      byType: Record<string, number>;\n      byDayOfWeek: Record<number, number>;\n    }>;\n    byType: Record<string, number>;\n    byDayOfWeek: Record<number, number>;\n    byMonth: Array<{\n      month: string;\n      year: string;\n      count: number;\n    }>;\n    totalAbsences: number;\n    totalStrategicAbsences: number;\n  }>;\n  \n  // Strategic Absences Report (text format)\n  getStrategicAbsencesReport(organizationId: string, days?: number): Promise<string>;\n  \n  // Employee-specific Attendance Statistics\n  getEmployeeAttendanceStats(organizationId: string, userId: string, days?: number): Promise<{\n    userId: string;\n    fullName: string;\n    byType: Record<string, number>;\n    byDayOfWeek: Record<number, number>;\n    byMonth: Array<{\n      month: string;\n      year: string;\n      count: number;\n    }>;\n    totalAbsences: number;\n    strategicAbsences: number;\n    strategicPercentage: number;\n  }>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  private initialized: boolean = false;\n\n  private async ensureInitialized() {\n    if (!this.initialized) {\n      await this.initializeAdmin();\n      this.initialized = true;\n    }\n  }\n\n  private async initializeAdmin() {\n    // Use default organization ID\n    const defaultOrgId = \"b578579d-c664-4382-8504-bd7740dbfd9b\";\n    \n    // First, ensure the default organization exists\n    const existingOrg = await db.select().from(organizations).where(eq(organizations.id, defaultOrgId));\n    if (existingOrg.length === 0) {\n      await db.insert(organizations).values({\n        id: defaultOrgId,\n        name: \"Metaltec\",\n        subdomain: \"default\",\n        isActive: true\n      });\n      console.log(\"✓ Organizzazione predefinita 'Metaltec' creata\");\n    }\n    \n    // Then, ensure the admin user exists\n    const existingAdmin = await db.select().from(users).where(eq(users.username, \"admin\"));\n    if (existingAdmin.length === 0) {\n      const hashedPassword = await hashPassword(\"Metaltec11\");\n      await db.insert(users).values({\n        username: \"admin\",\n        password: hashedPassword,\n        plainPassword: null,\n        role: \"admin\",\n        fullName: \"Amministratore\",\n        organizationId: defaultOrgId\n      });\n      console.log(\"✓ Utente admin predefinito creato\");\n    }\n  }\n\n  // Organizations (Super Admin)\n  async getAllOrganizations(): Promise<Organization[]> {\n    await this.ensureInitialized();\n    return await db.select().from(organizations).orderBy(desc(organizations.createdAt));\n  }\n\n  async getOrganization(id: string): Promise<Organization | undefined> {\n    await this.ensureInitialized();\n    const [org] = await db.select().from(organizations).where(eq(organizations.id, id));\n    return org || undefined;\n  }\n\n  async getOrganizationByName(name: string): Promise<Organization | undefined> {\n    await this.ensureInitialized();\n    const [org] = await db.select().from(organizations).where(eq(organizations.name, name));\n    return org || undefined;\n  }\n\n  async createOrganization(org: InsertOrganization): Promise<Organization> {\n    await this.ensureInitialized();\n    const [newOrg] = await db.insert(organizations).values(org).returning();\n    return newOrg;\n  }\n\n  async updateOrganizationStatus(id: string, isActive: boolean): Promise<Organization | undefined> {\n    await this.ensureInitialized();\n    const [updated] = await db.update(organizations)\n      .set({ isActive })\n      .where(eq(organizations.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  // Users\n  async getAllUsers(organizationId: string): Promise<User[]> {\n    await this.ensureInitialized();\n    return await db.select().from(users).where(eq(users.organizationId, organizationId));\n  }\n\n  async getUser(id: string): Promise<User | undefined> {\n    await this.ensureInitialized();\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user || undefined;\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    await this.ensureInitialized();\n    const [user] = await db.select().from(users).where(eq(users.username, username));\n    return user || undefined;\n  }\n\n  async createUser(insertUser: InsertUser, organizationId: string): Promise<User> {\n    await this.ensureInitialized();\n    const hashedPassword = await hashPassword(insertUser.password);\n    const role = insertUser.role || \"employee\";\n    \n    const [user] = await db.insert(users).values({\n      ...insertUser,\n      password: hashedPassword,\n      plainPassword: role === 'employee' ? insertUser.password : null,\n      role: role,\n      organizationId\n    }).returning();\n    \n    return user;\n  }\n\n  async updateUser(id: string, updates: Partial<InsertUser>): Promise<User> {\n    await this.ensureInitialized();\n    const existingUser = await this.getUser(id);\n    if (!existingUser) {\n      throw new Error(\"Utente non trovato\");\n    }\n    \n    const updatedData: any = { ...updates };\n    if (updates.password) {\n      updatedData.password = await hashPassword(updates.password);\n      if (existingUser.role === 'employee') {\n        updatedData.plainPassword = updates.password;\n      }\n    }\n    \n    const [updatedUser] = await db.update(users)\n      .set(updatedData)\n      .where(eq(users.id, id))\n      .returning();\n    \n    return updatedUser;\n  }\n\n  async getActiveUsers(organizationId: string): Promise<User[]> {\n    await this.ensureInitialized();\n    return await db.select()\n      .from(users)\n      .where(and(\n        eq(users.organizationId, organizationId),\n        eq(users.isActive, true)\n      ));\n  }\n\n  async updateUserStatus(id: string, isActive: boolean): Promise<User> {\n    await this.ensureInitialized();\n    const [updatedUser] = await db.update(users)\n      .set({ isActive })\n      .where(eq(users.id, id))\n      .returning();\n    \n    if (!updatedUser) {\n      throw new Error(\"Utente non trovato\");\n    }\n    \n    return updatedUser;\n  }\n\n  async deleteUser(id: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const user = await this.getUser(id);\n    if (!user) {\n      return false;\n    }\n    await this.deleteDailyReportsByEmployeeId(id);\n    if (user.organizationId) {\n      await this.deleteAttendanceEntriesByUserId(id, user.organizationId);\n    }\n    const result = await db.delete(users).where(eq(users.id, id));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  // Clients\n  async getAllClients(organizationId: string): Promise<Client[]> {\n    await this.ensureInitialized();\n    return await db.select().from(clients).where(eq(clients.organizationId, organizationId));\n  }\n\n  async createClient(insertClient: InsertClient, organizationId: string): Promise<Client> {\n    await this.ensureInitialized();\n    const [client] = await db.insert(clients).values({\n      ...insertClient,\n      organizationId\n    }).returning();\n    return client;\n  }\n\n  async deleteClient(id: string): Promise<boolean> {\n    await this.ensureInitialized();\n    await this.deleteWorkOrdersByClientId(id);\n    const result = await db.delete(clients).where(eq(clients.id, id));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  // Work Types (Lavorazioni)\n  async getAllWorkTypes(organizationId: string): Promise<WorkType[]> {\n    await this.ensureInitialized();\n    return await db.select().from(workTypes).where(eq(workTypes.organizationId, organizationId));\n  }\n\n  async getWorkType(id: string): Promise<WorkType | undefined> {\n    await this.ensureInitialized();\n    const [workType] = await db.select().from(workTypes).where(eq(workTypes.id, id));\n    return workType || undefined;\n  }\n\n  async createWorkType(insertWorkType: InsertWorkType, organizationId: string): Promise<WorkType> {\n    await this.ensureInitialized();\n    const [workType] = await db.insert(workTypes).values({\n      ...insertWorkType,\n      organizationId\n    }).returning();\n    return workType;\n  }\n\n  async updateWorkType(id: string, updates: Partial<InsertWorkType>): Promise<WorkType> {\n    await this.ensureInitialized();\n    const [updatedWorkType] = await db.update(workTypes)\n      .set(updates)\n      .where(eq(workTypes.id, id))\n      .returning();\n    \n    if (!updatedWorkType) {\n      throw new Error(\"Lavorazione non trovata\");\n    }\n    \n    return updatedWorkType;\n  }\n\n  async deleteWorkType(id: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const result = await db.delete(workTypes).where(eq(workTypes.id, id));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  // Materials (Materiali)\n  async getAllMaterials(organizationId: string): Promise<Material[]> {\n    await this.ensureInitialized();\n    return await db.select().from(materials).where(eq(materials.organizationId, organizationId));\n  }\n\n  async getMaterial(id: string): Promise<Material | undefined> {\n    await this.ensureInitialized();\n    const [material] = await db.select().from(materials).where(eq(materials.id, id));\n    return material || undefined;\n  }\n\n  async createMaterial(insertMaterial: InsertMaterial, organizationId: string): Promise<Material> {\n    await this.ensureInitialized();\n    const [material] = await db.insert(materials).values({\n      ...insertMaterial,\n      organizationId\n    }).returning();\n    return material;\n  }\n\n  async updateMaterial(id: string, updates: Partial<InsertMaterial>): Promise<Material> {\n    await this.ensureInitialized();\n    const [updatedMaterial] = await db.update(materials)\n      .set(updates)\n      .where(eq(materials.id, id))\n      .returning();\n    \n    if (!updatedMaterial) {\n      throw new Error(\"Materiale non trovato\");\n    }\n    \n    return updatedMaterial;\n  }\n\n  async deleteMaterial(id: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const result = await db.delete(materials).where(eq(materials.id, id));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  // Work Orders\n  async getAllWorkOrders(organizationId: string): Promise<WorkOrder[]> {\n    await this.ensureInitialized();\n    return await db.select().from(workOrders).where(eq(workOrders.organizationId, organizationId));\n  }\n\n  async getAllActiveWorkOrders(organizationId: string): Promise<WorkOrder[]> {\n    await this.ensureInitialized();\n    return await db.select().from(workOrders).where(\n      and(eq(workOrders.organizationId, organizationId), eq(workOrders.isActive, true))\n    );\n  }\n\n  async getWorkOrdersByClient(clientId: string, organizationId: string): Promise<WorkOrder[]> {\n    await this.ensureInitialized();\n    return await db.select().from(workOrders).where(\n      and(eq(workOrders.clientId, clientId), eq(workOrders.organizationId, organizationId))\n    );\n  }\n\n  async getWorkOrder(id: string, organizationId: string): Promise<WorkOrder | undefined> {\n    await this.ensureInitialized();\n    const [workOrder] = await db.select().from(workOrders).where(\n      and(eq(workOrders.id, id), eq(workOrders.organizationId, organizationId))\n    );\n    return workOrder || undefined;\n  }\n\n  async createWorkOrder(insertWorkOrder: InsertWorkOrder, organizationId: string): Promise<WorkOrder> {\n    await this.ensureInitialized();\n    const [workOrder] = await db.insert(workOrders).values({\n      ...insertWorkOrder,\n      organizationId\n    }).returning();\n    return workOrder;\n  }\n\n  async updateWorkOrder(id: string, updates: Partial<InsertWorkOrder>): Promise<WorkOrder> {\n    await this.ensureInitialized();\n    const [updatedWorkOrder] = await db.update(workOrders)\n      .set(updates)\n      .where(eq(workOrders.id, id))\n      .returning();\n    \n    if (!updatedWorkOrder) {\n      throw new Error(\"Commessa non trovata\");\n    }\n    \n    return updatedWorkOrder;\n  }\n\n  async updateWorkOrderStatus(id: string, isActive: boolean): Promise<WorkOrder> {\n    await this.ensureInitialized();\n    const [updatedWorkOrder] = await db.update(workOrders)\n      .set({ isActive })\n      .where(eq(workOrders.id, id))\n      .returning();\n    \n    if (!updatedWorkOrder) {\n      throw new Error(\"Commessa non trovata\");\n    }\n    \n    return updatedWorkOrder;\n  }\n\n  async deleteWorkOrder(id: string): Promise<boolean> {\n    await this.ensureInitialized();\n    await this.deleteOperationsByWorkOrderId(id);\n    const result = await db.delete(workOrders).where(eq(workOrders.id, id));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  // Daily Reports\n  async getAllDailyReports(organizationId: string): Promise<DailyReport[]> {\n    await this.ensureInitialized();\n    return await db.select().from(dailyReports)\n      .where(eq(dailyReports.organizationId, organizationId))\n      .orderBy(desc(dailyReports.date));\n  }\n\n  async getDailyReportsByDate(date: string, organizationId: string): Promise<DailyReport[]> {\n    await this.ensureInitialized();\n    return await db.select().from(dailyReports).where(\n      and(eq(dailyReports.date, date), eq(dailyReports.organizationId, organizationId))\n    );\n  }\n\n  async getDailyReport(id: string): Promise<DailyReport | undefined> {\n    await this.ensureInitialized();\n    const [report] = await db.select().from(dailyReports).where(eq(dailyReports.id, id));\n    return report || undefined;\n  }\n\n  async getDailyReportByEmployeeAndDate(employeeId: string, date: string, organizationId: string): Promise<DailyReport | undefined> {\n    await this.ensureInitialized();\n    const [report] = await db.select().from(dailyReports).where(\n      and(\n        eq(dailyReports.employeeId, employeeId), \n        eq(dailyReports.date, date),\n        eq(dailyReports.organizationId, organizationId)\n      )\n    );\n    return report || undefined;\n  }\n\n  async createDailyReport(insertReport: InsertDailyReport, organizationId: string): Promise<DailyReport> {\n    await this.ensureInitialized();\n    const [report] = await db.insert(dailyReports).values({\n      ...insertReport,\n      organizationId\n    }).returning();\n    return report;\n  }\n\n  async updateDailyReport(id: string, updates: UpdateDailyReport): Promise<DailyReport> {\n    await this.ensureInitialized();\n    const [updatedReport] = await db.update(dailyReports)\n      .set(updates)\n      .where(eq(dailyReports.id, id))\n      .returning();\n    \n    if (!updatedReport) {\n      throw new Error(\"Report not found\");\n    }\n    \n    return updatedReport;\n  }\n\n  async updateDailyReportStatus(id: string, status: string): Promise<DailyReport> {\n    await this.ensureInitialized();\n    const [updatedReport] = await db.update(dailyReports)\n      .set({ status })\n      .where(eq(dailyReports.id, id))\n      .returning();\n    \n    if (!updatedReport) {\n      throw new Error(\"Report not found\");\n    }\n    \n    return updatedReport;\n  }\n\n  async deleteDailyReport(id: string): Promise<boolean> {\n    await this.ensureInitialized();\n    await this.deleteOperationsByReportId(id);\n    await this.deleteHoursAdjustmentsByReportId(id);\n    const result = await db.delete(dailyReports).where(eq(dailyReports.id, id));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  // Operations\n  async getOperationsByReportId(reportId: string): Promise<Operation[]> {\n    await this.ensureInitialized();\n    return await db.select().from(operations).where(eq(operations.dailyReportId, reportId));\n  }\n\n  async getOperationsByWorkOrderId(workOrderId: string, organizationId: string): Promise<Operation[]> {\n    await this.ensureInitialized();\n    // Join with workOrders to ensure organization filtering\n    const result = await db.select({ operations })\n      .from(operations)\n      .innerJoin(workOrders, eq(operations.workOrderId, workOrders.id))\n      .where(\n        and(\n          eq(operations.workOrderId, workOrderId),\n          eq(workOrders.organizationId, organizationId)\n        )\n      );\n    return result.map(r => r.operations);\n  }\n\n  async getOperation(id: string): Promise<Operation | undefined> {\n    await this.ensureInitialized();\n    const [operation] = await db.select().from(operations).where(eq(operations.id, id));\n    return operation || undefined;\n  }\n\n  async createOperation(insertOperation: InsertOperation): Promise<Operation> {\n    await this.ensureInitialized();\n    const [operation] = await db.insert(operations).values(insertOperation).returning();\n    return operation;\n  }\n\n  async updateOperation(id: string, updates: UpdateOperation): Promise<Operation> {\n    await this.ensureInitialized();\n    const [updatedOperation] = await db.update(operations)\n      .set(updates)\n      .where(eq(operations.id, id))\n      .returning();\n    \n    if (!updatedOperation) {\n      throw new Error(\"Operation not found\");\n    }\n    \n    return updatedOperation;\n  }\n\n  async deleteOperation(id: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const result = await db.delete(operations).where(eq(operations.id, id));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  async deleteOperationsByReportId(reportId: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const result = await db.delete(operations).where(eq(operations.dailyReportId, reportId));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  async getOperationsCountByWorkOrderId(workOrderId: string): Promise<number> {\n    await this.ensureInitialized();\n    const ops = await db.select().from(operations).where(eq(operations.workOrderId, workOrderId));\n    return ops.length;\n  }\n\n  async deleteOperationsByWorkOrderId(workOrderId: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const result = await db.delete(operations).where(eq(operations.workOrderId, workOrderId));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  async getOperationsCountByClientId(clientId: string): Promise<number> {\n    await this.ensureInitialized();\n    const clientWorkOrders = await db.select().from(workOrders).where(eq(workOrders.clientId, clientId));\n    const workOrderIds = clientWorkOrders.map(wo => wo.id);\n    \n    if (workOrderIds.length === 0) {\n      return 0;\n    }\n    \n    const ops = await db.select().from(operations);\n    const count = ops.filter(op => workOrderIds.includes(op.workOrderId)).length;\n    return count;\n  }\n\n  async deleteOperationsByClientId(clientId: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const clientWorkOrders = await db.select().from(workOrders).where(eq(workOrders.clientId, clientId));\n    const workOrderIds = clientWorkOrders.map(wo => wo.id);\n    \n    if (workOrderIds.length === 0) {\n      return true;\n    }\n    \n    let totalDeleted = 0;\n    for (const workOrderId of workOrderIds) {\n      const result = await db.delete(operations).where(eq(operations.workOrderId, workOrderId));\n      if (result.rowCount) totalDeleted += result.rowCount;\n    }\n    \n    return totalDeleted > 0;\n  }\n\n  async getDailyReportsCountByEmployeeId(employeeId: string): Promise<number> {\n    await this.ensureInitialized();\n    const reports = await db.select().from(dailyReports).where(eq(dailyReports.employeeId, employeeId));\n    return reports.length;\n  }\n\n  async getWorkOrdersCountByClientId(clientId: string): Promise<number> {\n    await this.ensureInitialized();\n    const orders = await db.select().from(workOrders).where(eq(workOrders.clientId, clientId));\n    return orders.length;\n  }\n\n  async deleteDailyReportsByEmployeeId(employeeId: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const employeeReports = await db.select().from(dailyReports).where(eq(dailyReports.employeeId, employeeId));\n    \n    for (const report of employeeReports) {\n      await this.deleteOperationsByReportId(report.id);\n      await this.deleteHoursAdjustmentsByReportId(report.id);\n    }\n    \n    const result = await db.delete(dailyReports).where(eq(dailyReports.employeeId, employeeId));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  async deleteWorkOrdersByClientId(clientId: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const clientWorkOrders = await db.select().from(workOrders).where(eq(workOrders.clientId, clientId));\n    \n    for (const workOrder of clientWorkOrders) {\n      await this.deleteOperationsByWorkOrderId(workOrder.id);\n    }\n    \n    const result = await db.delete(workOrders).where(eq(workOrders.clientId, clientId));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  async getWorkOrdersStats(organizationId: string): Promise<Array<{\n    workOrderId: string;\n    totalOperations: number;\n    totalHours: number;\n    lastActivity: string | null;\n  }>> {\n    await this.ensureInitialized();\n    \n    const allWorkOrders = await db.select().from(workOrders).where(eq(workOrders.organizationId, organizationId));\n    const allOperations = await db.select().from(operations);\n    const allReports = await db.select().from(dailyReports).where(eq(dailyReports.organizationId, organizationId));\n    \n    const approvedReportIds = new Set(\n      allReports.filter(r => r.status === \"Approvato\").map(r => r.id)\n    );\n    \n    const approvedOperations = allOperations.filter(op => \n      approvedReportIds.has(op.dailyReportId)\n    );\n    \n    const statsMap = new Map<string, {\n      totalOperations: number;\n      totalHours: number;\n      dates: string[];\n    }>();\n    \n    for (const op of approvedOperations) {\n      if (!op.workOrderId) continue;\n      \n      const existing = statsMap.get(op.workOrderId) || {\n        totalOperations: 0,\n        totalHours: 0,\n        dates: []\n      };\n      \n      const report = allReports.find(r => r.id === op.dailyReportId);\n      if (report) {\n        existing.totalOperations++;\n        existing.totalHours += Number(op.hours) || 0;\n        existing.dates.push(report.date);\n        statsMap.set(op.workOrderId, existing);\n      }\n    }\n    \n    return allWorkOrders.map(wo => {\n      const stats = statsMap.get(wo.id);\n      return {\n        workOrderId: wo.id,\n        totalOperations: stats?.totalOperations || 0,\n        totalHours: stats?.totalHours || 0,\n        lastActivity: stats?.dates.length ? \n          stats.dates.sort().reverse()[0] : null\n      };\n    });\n  }\n\n  // Attendance Entries (Assenze)\n  async getAllAttendanceEntries(organizationId: string, year: string, month: string): Promise<AttendanceEntry[]> {\n    await this.ensureInitialized();\n    const startDate = `${year}-${month.padStart(2, '0')}-01`;\n    const endDate = `${year}-${month.padStart(2, '0')}-31`;\n    \n    const allEntries = await db.select()\n      .from(attendanceEntries)\n      .where(eq(attendanceEntries.organizationId, organizationId));\n    \n    return allEntries.filter(entry => entry.date >= startDate && entry.date <= endDate);\n  }\n\n  async getAttendanceEntriesByDate(date: string, organizationId: string): Promise<AttendanceEntry[]> {\n    await this.ensureInitialized();\n    const entries = await db.select()\n      .from(attendanceEntries)\n      .where(\n        and(\n          eq(attendanceEntries.date, date),\n          eq(attendanceEntries.organizationId, organizationId)\n        )\n      );\n    return entries;\n  }\n\n  async getAttendanceEntry(userId: string, date: string, organizationId: string): Promise<AttendanceEntry | undefined> {\n    await this.ensureInitialized();\n    const entries = await db.select()\n      .from(attendanceEntries)\n      .where(\n        and(\n          eq(attendanceEntries.userId, userId),\n          eq(attendanceEntries.date, date),\n          eq(attendanceEntries.organizationId, organizationId)\n        )\n      );\n    return entries[0];\n  }\n\n  async createAttendanceEntry(entry: InsertAttendanceEntry, organizationId: string): Promise<AttendanceEntry> {\n    await this.ensureInitialized();\n    const result = await db.insert(attendanceEntries).values({\n      ...entry,\n      organizationId\n    }).returning();\n    return result[0];\n  }\n\n  async updateAttendanceEntry(id: string, updates: UpdateAttendanceEntry): Promise<AttendanceEntry> {\n    await this.ensureInitialized();\n    const result = await db.update(attendanceEntries)\n      .set(updates)\n      .where(eq(attendanceEntries.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async deleteAttendanceEntry(id: string): Promise<boolean> {\n    await this.ensureInitialized();\n    await db.delete(attendanceEntries).where(eq(attendanceEntries.id, id));\n    return true;\n  }\n\n  async deleteAttendanceEntriesByUserId(userId: string, organizationId: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const result = await db.delete(attendanceEntries).where(\n      and(\n        eq(attendanceEntries.userId, userId),\n        eq(attendanceEntries.organizationId, organizationId)\n      )\n    );\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  async getHoursAdjustment(dailyReportId: string, organizationId: string): Promise<HoursAdjustment | undefined> {\n    await this.ensureInitialized();\n    const adjustments = await db.select()\n      .from(hoursAdjustments)\n      .where(\n        and(\n          eq(hoursAdjustments.dailyReportId, dailyReportId),\n          eq(hoursAdjustments.organizationId, organizationId)\n        )\n      );\n    return adjustments[0];\n  }\n\n  async createHoursAdjustment(adjustment: InsertHoursAdjustment, organizationId: string, createdBy: string): Promise<HoursAdjustment> {\n    await this.ensureInitialized();\n    const result = await db.insert(hoursAdjustments).values({\n      ...adjustment,\n      organizationId,\n      createdBy\n    }).returning();\n    return result[0];\n  }\n\n  async updateHoursAdjustment(id: string, updates: UpdateHoursAdjustment): Promise<HoursAdjustment> {\n    await this.ensureInitialized();\n    const result = await db.update(hoursAdjustments)\n      .set({\n        ...updates,\n        updatedAt: new Date()\n      })\n      .where(eq(hoursAdjustments.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async deleteHoursAdjustment(id: string): Promise<boolean> {\n    await this.ensureInitialized();\n    await db.delete(hoursAdjustments).where(eq(hoursAdjustments.id, id));\n    return true;\n  }\n\n  async deleteHoursAdjustmentsByReportId(reportId: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const result = await db.delete(hoursAdjustments).where(eq(hoursAdjustments.dailyReportId, reportId));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  // Vehicles (Mezzi)\n  async getAllVehicles(organizationId: string): Promise<Vehicle[]> {\n    await this.ensureInitialized();\n    return await db.select().from(vehicles).where(eq(vehicles.organizationId, organizationId));\n  }\n\n  async getVehicle(id: string): Promise<Vehicle | undefined> {\n    await this.ensureInitialized();\n    const [vehicle] = await db.select().from(vehicles).where(eq(vehicles.id, id));\n    return vehicle || undefined;\n  }\n\n  async createVehicle(vehicle: InsertVehicle, organizationId: string): Promise<Vehicle> {\n    await this.ensureInitialized();\n    const [created] = await db.insert(vehicles).values({\n      ...vehicle,\n      organizationId\n    }).returning();\n    return created;\n  }\n\n  async updateVehicle(id: string, updates: UpdateVehicle, organizationId: string): Promise<Vehicle> {\n    await this.ensureInitialized();\n    const [updated] = await db.update(vehicles)\n      .set(updates)\n      .where(\n        and(\n          eq(vehicles.id, id),\n          eq(vehicles.organizationId, organizationId)\n        )\n      )\n      .returning();\n    if (!updated) {\n      throw new Error(\"Vehicle not found or access denied\");\n    }\n    return updated;\n  }\n\n  async deleteVehicle(id: string, organizationId: string): Promise<boolean> {\n    await this.ensureInitialized();\n    // First verify vehicle exists and belongs to the organization\n    const [existing] = await db.select().from(vehicles).where(\n      and(\n        eq(vehicles.id, id),\n        eq(vehicles.organizationId, organizationId)\n      )\n    );\n    if (!existing) {\n      return false; // Vehicle not found or access denied\n    }\n    // Now safe to delete fuel refills (we know vehicle belongs to this org)\n    await this.deleteFuelRefillsByVehicleId(id);\n    // Finally delete the vehicle\n    const result = await db.delete(vehicles).where(eq(vehicles.id, id));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  // Fuel Refills (Rifornimenti)\n  async getAllFuelRefills(organizationId: string): Promise<FuelRefill[]> {\n    await this.ensureInitialized();\n    return await db.select()\n      .from(fuelRefills)\n      .where(eq(fuelRefills.organizationId, organizationId))\n      .orderBy(desc(fuelRefills.refillDate));\n  }\n\n  async getFuelRefillsByVehicle(vehicleId: string, organizationId: string): Promise<FuelRefill[]> {\n    await this.ensureInitialized();\n    return await db.select()\n      .from(fuelRefills)\n      .where(\n        and(\n          eq(fuelRefills.vehicleId, vehicleId),\n          eq(fuelRefills.organizationId, organizationId)\n        )\n      )\n      .orderBy(desc(fuelRefills.refillDate));\n  }\n\n  async getFuelRefill(id: string): Promise<FuelRefill | undefined> {\n    await this.ensureInitialized();\n    const [refill] = await db.select().from(fuelRefills).where(eq(fuelRefills.id, id));\n    return refill || undefined;\n  }\n\n  async createFuelRefill(refill: InsertFuelRefill, organizationId: string): Promise<FuelRefill> {\n    await this.ensureInitialized();\n    const [created] = await db.insert(fuelRefills).values({\n      ...refill,\n      organizationId\n    }).returning();\n    return created;\n  }\n\n  async updateFuelRefill(id: string, updates: UpdateFuelRefill, organizationId: string): Promise<FuelRefill> {\n    await this.ensureInitialized();\n    const [updated] = await db.update(fuelRefills)\n      .set(updates)\n      .where(\n        and(\n          eq(fuelRefills.id, id),\n          eq(fuelRefills.organizationId, organizationId)\n        )\n      )\n      .returning();\n    if (!updated) {\n      throw new Error(\"Fuel refill not found or access denied\");\n    }\n    return updated;\n  }\n\n  async deleteFuelRefill(id: string, organizationId: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const result = await db.delete(fuelRefills).where(\n      and(\n        eq(fuelRefills.id, id),\n        eq(fuelRefills.organizationId, organizationId)\n      )\n    );\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  async deleteFuelRefillsByVehicleId(vehicleId: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const result = await db.delete(fuelRefills).where(eq(fuelRefills.vehicleId, vehicleId));\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  // Fuel Tank Loads (Carichi cisterna)\n  async getAllFuelTankLoads(organizationId: string): Promise<FuelTankLoad[]> {\n    await this.ensureInitialized();\n    return await db.select()\n      .from(fuelTankLoads)\n      .where(eq(fuelTankLoads.organizationId, organizationId))\n      .orderBy(desc(fuelTankLoads.loadDate));\n  }\n\n  async getFuelTankLoad(id: string): Promise<FuelTankLoad | undefined> {\n    await this.ensureInitialized();\n    const [load] = await db.select().from(fuelTankLoads).where(eq(fuelTankLoads.id, id));\n    return load || undefined;\n  }\n\n  async createFuelTankLoad(load: InsertFuelTankLoad, organizationId: string): Promise<FuelTankLoad> {\n    await this.ensureInitialized();\n    const [created] = await db.insert(fuelTankLoads).values({\n      ...load,\n      organizationId\n    }).returning();\n    return created;\n  }\n\n  async updateFuelTankLoad(id: string, updates: UpdateFuelTankLoad, organizationId: string): Promise<FuelTankLoad> {\n    await this.ensureInitialized();\n    const [updated] = await db.update(fuelTankLoads)\n      .set(updates)\n      .where(\n        and(\n          eq(fuelTankLoads.id, id),\n          eq(fuelTankLoads.organizationId, organizationId)\n        )\n      )\n      .returning();\n    if (!updated) {\n      throw new Error(\"Fuel tank load not found or access denied\");\n    }\n    return updated;\n  }\n\n  async deleteFuelTankLoad(id: string, organizationId: string): Promise<boolean> {\n    await this.ensureInitialized();\n    const result = await db.delete(fuelTankLoads).where(\n      and(\n        eq(fuelTankLoads.id, id),\n        eq(fuelTankLoads.organizationId, organizationId)\n      )\n    );\n    return result.rowCount !== null && result.rowCount > 0;\n  }\n\n  async getRemainingFuelLiters(organizationId: string): Promise<number> {\n    await this.ensureInitialized();\n    \n    // Get all tank loads (carichi)\n    const loads = await db.select()\n      .from(fuelTankLoads)\n      .where(eq(fuelTankLoads.organizationId, organizationId));\n    \n    const totalLoads = loads.reduce((sum, load) => {\n      return sum + parseFloat(load.liters || '0');\n    }, 0);\n    \n    // Get all fuel refills (scarichi)\n    const refills = await db.select()\n      .from(fuelRefills)\n      .where(eq(fuelRefills.organizationId, organizationId));\n    \n    const totalRefills = refills.reduce((sum, refill) => {\n      return sum + parseFloat(refill.litersRefilled || '0');\n    }, 0);\n    \n    return totalLoads - totalRefills;\n  }\n\n  async getFuelRefillsStatistics(organizationId: string, year?: string, month?: string) {\n    await this.ensureInitialized();\n    \n    // Get all refills for the organization\n    let refills = await db.select()\n      .from(fuelRefills)\n      .where(eq(fuelRefills.organizationId, organizationId))\n      .orderBy(desc(fuelRefills.refillDate));\n    \n    // Filter by year and month if provided (skip if \"all\")\n    if (year && year !== 'all') {\n      refills = refills.filter(r => {\n        const refillDate = new Date(r.refillDate);\n        return refillDate.getFullYear().toString() === year;\n      });\n    }\n    if (month && month !== 'all') {\n      refills = refills.filter(r => {\n        const refillDate = new Date(r.refillDate);\n        return (refillDate.getMonth() + 1).toString().padStart(2, '0') === month.padStart(2, '0');\n      });\n    }\n    \n    // Get all vehicles\n    const allVehicles = await db.select()\n      .from(vehicles)\n      .where(eq(vehicles.organizationId, organizationId));\n    \n    // Aggregate by vehicle\n    const vehicleStats = new Map<string, { totalLiters: number; totalCost: number; refillCount: number; vehicleName: string }>();\n    \n    for (const refill of refills) {\n      const vehicleId = refill.vehicleId;\n      const vehicle = allVehicles.find(v => v.id === vehicleId);\n      const vehicleName = vehicle ? `${vehicle.name} (${vehicle.licensePlate})` : 'Sconosciuto';\n      \n      if (!vehicleStats.has(vehicleId)) {\n        vehicleStats.set(vehicleId, {\n          totalLiters: 0,\n          totalCost: 0,\n          refillCount: 0,\n          vehicleName\n        });\n      }\n      \n      const stats = vehicleStats.get(vehicleId)!;\n      stats.totalLiters += parseFloat(refill.litersRefilled || '0');\n      // Calculate cost from litersRefilled (assuming price per liter can be calculated)\n      // For now, we don't have cost data in refills, so we'll set it to 0\n      stats.totalCost += 0;\n      stats.refillCount += 1;\n    }\n    \n    const byVehicle = Array.from(vehicleStats.entries()).map(([vehicleId, stats]) => ({\n      vehicleId,\n      vehicleName: stats.vehicleName,\n      totalLiters: stats.totalLiters,\n      totalCost: stats.totalCost,\n      refillCount: stats.refillCount\n    }));\n    \n    // Aggregate by month\n    const monthStats = new Map<string, { totalLiters: number; totalCost: number; refillCount: number; year: string }>();\n    \n    for (const refill of refills) {\n      const refillDate = new Date(refill.refillDate);\n      const monthKey = refillDate.toISOString().substring(0, 7); // YYYY-MM\n      const [yearStr, monthStr] = monthKey.split('-');\n      \n      if (!monthStats.has(monthKey)) {\n        monthStats.set(monthKey, {\n          totalLiters: 0,\n          totalCost: 0,\n          refillCount: 0,\n          year: yearStr\n        });\n      }\n      \n      const stats = monthStats.get(monthKey)!;\n      stats.totalLiters += parseFloat(refill.litersRefilled || '0');\n      stats.totalCost += 0;\n      stats.refillCount += 1;\n    }\n    \n    const byMonth = Array.from(monthStats.entries())\n      .map(([monthKey, stats]) => {\n        const [year, month] = monthKey.split('-');\n        return {\n          month,\n          year,\n          totalLiters: stats.totalLiters,\n          totalCost: stats.totalCost,\n          refillCount: stats.refillCount\n        };\n      })\n      .sort((a, b) => `${a.year}-${a.month}`.localeCompare(`${b.year}-${b.month}`));\n    \n    return {\n      byVehicle,\n      byMonth\n    };\n  }\n\n  async getMonthlyAttendance(organizationId: string, year: string, month: string): Promise<any> {\n    await this.ensureInitialized();\n    \n    // Get all employees\n    const allEmployees = await db.select()\n      .from(users)\n      .where(\n        and(\n          eq(users.organizationId, organizationId),\n          eq(users.role, 'employee')\n        )\n      );\n    \n    // Get daily reports for the month\n    const startDate = `${year}-${month.padStart(2, '0')}-01`;\n    const endDate = `${year}-${month.padStart(2, '0')}-31`;\n    \n    const reports = await db.select()\n      .from(dailyReports)\n      .where(\n        and(\n          eq(dailyReports.organizationId, organizationId),\n          eq(dailyReports.status, 'Approvato')\n        )\n      );\n    \n    const monthReports = reports.filter(r => r.date >= startDate && r.date <= endDate);\n    \n    // Get all operations for these reports\n    const reportIds = monthReports.map(r => r.id);\n    const allOperations = await db.select().from(operations);\n    const monthOperations = allOperations.filter(op => reportIds.includes(op.dailyReportId));\n    \n    // Get attendance entries for the month\n    const absences = await this.getAllAttendanceEntries(organizationId, year, month);\n    \n    // Get all hours adjustments for these reports\n    const allAdjustments = await db.select().from(hoursAdjustments);\n    const monthAdjustments = allAdjustments.filter(adj => reportIds.includes(adj.dailyReportId));\n    \n    // Get employee IDs who have reports or absences in this month\n    const employeeIdsWithReports = new Set(monthReports.map(r => r.employeeId));\n    const employeeIdsWithAbsences = new Set(absences.map(a => a.userId));\n    \n    // Filter employees: show active ones OR disabled ones with activity in this month\n    const relevantUsers = allEmployees.filter(user => \n      user.isActive !== false || \n      employeeIdsWithReports.has(user.id) || \n      employeeIdsWithAbsences.has(user.id)\n    );\n    \n    // Build attendance data\n    const attendanceData = relevantUsers.map(user => {\n      const userReports = monthReports.filter(r => r.employeeId === user.id);\n      const userAbsences = absences.filter(a => a.userId === user.id);\n      \n      const dailyData: Record<string, { ordinary: number; overtime: number; absence?: string; adjustment?: number }> = {};\n      \n      // Process daily reports\n      userReports.forEach(report => {\n        const reportOps = monthOperations.filter(op => op.dailyReportId === report.id);\n        let totalHours = reportOps.reduce((sum, op) => sum + Number(op.hours), 0);\n        \n        // Apply hours adjustment if exists\n        const adjustment = monthAdjustments.find(adj => adj.dailyReportId === report.id);\n        if (adjustment) {\n          const adjustmentValue = Number(adjustment.adjustment);\n          totalHours += adjustmentValue;\n        }\n        \n        const ordinary = Math.min(totalHours, 8);\n        const overtime = Math.max(totalHours - 8, 0);\n        \n        dailyData[report.date] = { \n          ordinary, \n          overtime,\n          ...(adjustment && { adjustment: Number(adjustment.adjustment) })\n        };\n      });\n      \n      // Add absences\n      userAbsences.forEach(absence => {\n        if (!dailyData[absence.date]) {\n          dailyData[absence.date] = { ordinary: 0, overtime: 0 };\n        }\n        dailyData[absence.date].absence = absence.absenceType;\n      });\n      \n      return {\n        userId: user.id,\n        fullName: user.fullName,\n        dailyData\n      };\n    });\n    \n    return attendanceData;\n  }\n\n  // Attendance Statistics (Statistiche Assenze)\n  async getAttendanceStats(organizationId: string, days: number = 90): Promise<{\n    byEmployee: Array<{\n      userId: string;\n      fullName: string;\n      totalAbsences: number;\n      strategicAbsences: number;\n      byType: Record<string, number>;\n      byDayOfWeek: Record<number, number>;\n    }>;\n    byType: Record<string, number>;\n    byDayOfWeek: Record<number, number>;\n    byMonth: Array<{\n      month: string;\n      year: string;\n      count: number;\n    }>;\n    totalAbsences: number;\n    totalStrategicAbsences: number;\n  }> {\n    await this.ensureInitialized();\n    \n    // Calculate date range\n    const endDate = new Date();\n    const startDate = new Date();\n    startDate.setDate(startDate.getDate() - days);\n    \n    const startDateStr = startDate.toISOString().split('T')[0];\n    const endDateStr = endDate.toISOString().split('T')[0];\n    \n    // Get all attendance entries for the organization in the date range\n    const allEntries = await db.select()\n      .from(attendanceEntries)\n      .where(eq(attendanceEntries.organizationId, organizationId));\n    \n    // Filter entries by date range\n    const entries = allEntries.filter(entry => \n      entry.date >= startDateStr && entry.date <= endDateStr\n    );\n    \n    // Get all active users for this organization\n    const allUsers = await this.getAllUsers(organizationId);\n    const userMap = new Map(allUsers.map(u => [u.id, u]));\n    \n    // Initialize aggregations\n    const byType: Record<string, number> = {};\n    const byDayOfWeek: Record<number, number> = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };\n    const byMonthMap: Map<string, number> = new Map();\n    const byEmployeeMap: Map<string, {\n      totalAbsences: number;\n      strategicAbsences: number;\n      byType: Record<string, number>;\n      byDayOfWeek: Record<number, number>;\n    }> = new Map();\n    let totalStrategicAbsences = 0;\n    \n    // Process each entry\n    for (const entry of entries) {\n      // By type\n      byType[entry.absenceType] = (byType[entry.absenceType] || 0) + 1;\n      \n      // By day of week\n      const entryDate = new Date(entry.date);\n      const dayOfWeek = entryDate.getDay();\n      byDayOfWeek[dayOfWeek]++;\n      \n      // By month\n      const monthKey = `${entry.date.substring(0, 7)}`; // YYYY-MM\n      byMonthMap.set(monthKey, (byMonthMap.get(monthKey) || 0) + 1);\n      \n      // Check if strategic absence (exclude Ferie 'F')\n      const isStrategic = entry.absenceType !== 'F' && isStrategicAbsence(entry.date);\n      if (isStrategic) {\n        totalStrategicAbsences++;\n      }\n      \n      // By employee\n      if (!byEmployeeMap.has(entry.userId)) {\n        byEmployeeMap.set(entry.userId, {\n          totalAbsences: 0,\n          strategicAbsences: 0,\n          byType: {},\n          byDayOfWeek: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 }\n        });\n      }\n      const empStats = byEmployeeMap.get(entry.userId)!;\n      empStats.totalAbsences++;\n      if (isStrategic) {\n        empStats.strategicAbsences++;\n      }\n      empStats.byType[entry.absenceType] = (empStats.byType[entry.absenceType] || 0) + 1;\n      empStats.byDayOfWeek[dayOfWeek]++;\n    }\n    \n    // Build byEmployee array\n    const byEmployee = Array.from(byEmployeeMap.entries()).map(([userId, stats]) => ({\n      userId,\n      fullName: userMap.get(userId)?.fullName || 'Utente sconosciuto',\n      totalAbsences: stats.totalAbsences,\n      strategicAbsences: stats.strategicAbsences,\n      byType: stats.byType,\n      byDayOfWeek: stats.byDayOfWeek\n    })).sort((a, b) => b.totalAbsences - a.totalAbsences);\n    \n    // Build byMonth array sorted by date (month in YYYY-MM format for frontend charts)\n    const byMonth = Array.from(byMonthMap.entries())\n      .map(([key, count]) => ({\n        month: key,  // Keep as YYYY-MM format for frontend charts\n        year: key.substring(0, 4),\n        count\n      }))\n      .sort((a, b) => a.month.localeCompare(b.month));\n    \n    return {\n      byEmployee,\n      byType,\n      byDayOfWeek,\n      byMonth,\n      totalAbsences: entries.length,\n      totalStrategicAbsences\n    };\n  }\n\n  async getEmployeeAttendanceStats(organizationId: string, userId: string, days: number = 90): Promise<{\n    userId: string;\n    fullName: string;\n    byType: Record<string, number>;\n    byDayOfWeek: Record<number, number>;\n    byMonth: Array<{\n      month: string;\n      year: string;\n      count: number;\n    }>;\n    totalAbsences: number;\n    strategicAbsences: number;\n    strategicPercentage: number;\n  }> {\n    await this.ensureInitialized();\n    \n    // Calculate date range\n    const endDate = new Date();\n    const startDate = new Date();\n    startDate.setDate(startDate.getDate() - days);\n    \n    const startDateStr = startDate.toISOString().split('T')[0];\n    const endDateStr = endDate.toISOString().split('T')[0];\n    \n    // Get user info\n    const user = await this.getUser(userId);\n    const fullName = user?.fullName || 'Utente sconosciuto';\n    \n    // Get attendance entries for this specific user\n    const allEntries = await db.select()\n      .from(attendanceEntries)\n      .where(and(\n        eq(attendanceEntries.organizationId, organizationId),\n        eq(attendanceEntries.userId, userId)\n      ));\n    \n    // Filter entries by date range\n    const entries = allEntries.filter(entry => \n      entry.date >= startDateStr && entry.date <= endDateStr\n    );\n    \n    // Initialize aggregations\n    const byType: Record<string, number> = {};\n    const byDayOfWeek: Record<number, number> = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };\n    const byMonthMap: Map<string, number> = new Map();\n    let strategicAbsences = 0;\n    \n    // Process each entry\n    for (const entry of entries) {\n      // By type\n      byType[entry.absenceType] = (byType[entry.absenceType] || 0) + 1;\n      \n      // By day of week\n      const entryDate = new Date(entry.date);\n      const dayOfWeek = entryDate.getDay();\n      byDayOfWeek[dayOfWeek]++;\n      \n      // By month\n      const monthKey = `${entry.date.substring(0, 7)}`; // YYYY-MM\n      byMonthMap.set(monthKey, (byMonthMap.get(monthKey) || 0) + 1);\n      \n      // Check if strategic absence (exclude Ferie 'F')\n      if (entry.absenceType !== 'F' && isStrategicAbsence(entry.date)) {\n        strategicAbsences++;\n      }\n    }\n    \n    // Build byMonth array sorted by date\n    const byMonth = Array.from(byMonthMap.entries())\n      .map(([key, count]) => ({\n        month: key,\n        year: key.substring(0, 4),\n        count\n      }))\n      .sort((a, b) => a.month.localeCompare(b.month));\n    \n    // Calculate strategic percentage (excluding Ferie from total for percentage calculation)\n    const absencesExcludingFerie = entries.filter(e => e.absenceType !== 'F').length;\n    const strategicPercentage = absencesExcludingFerie > 0 \n      ? Math.round((strategicAbsences / absencesExcludingFerie) * 100) \n      : 0;\n    \n    return {\n      userId,\n      fullName,\n      byType,\n      byDayOfWeek,\n      byMonth,\n      totalAbsences: entries.length,\n      strategicAbsences,\n      strategicPercentage\n    };\n  }\n\n  async getStrategicAbsencesReport(organizationId: string, days: number = 90): Promise<string> {\n    await this.ensureInitialized();\n    \n    const dayNames = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];\n    const absenceTypeNames: Record<string, string> = {\n      'A': 'Assenza',\n      'P': 'Permesso',\n      'M': 'Malattia',\n      'CP': 'Cassa Integrazione/Permesso',\n      'L104': 'Legge 104',\n      'F': 'Ferie'\n    };\n    \n    // Calculate date range\n    const endDate = new Date();\n    const startDate = new Date();\n    startDate.setDate(startDate.getDate() - days);\n    const startDateStr = startDate.toISOString().split('T')[0];\n    const endDateStr = endDate.toISOString().split('T')[0];\n    \n    // Get all users for this organization\n    const allUsers = await db.select().from(users).where(eq(users.organizationId, organizationId));\n    const userMap = new Map(allUsers.map(u => [u.id, u.fullName]));\n    \n    // Get all attendance entries (excluding Ferie)\n    const allEntries = await db.select()\n      .from(attendanceEntries)\n      .where(eq(attendanceEntries.organizationId, organizationId));\n    \n    const entries = allEntries.filter(entry => \n      entry.date >= startDateStr && \n      entry.date <= endDateStr && \n      entry.absenceType !== 'F'\n    );\n    \n    // Find strategic absences\n    const strategicAbsences: Array<{\n      date: string;\n      dayOfWeek: string;\n      employee: string;\n      type: string;\n      typeName: string;\n      reason: string;\n    }> = [];\n    \n    for (const entry of entries) {\n      const info = this.getAdjacentInfo(entry.date);\n      if (info.isStrategic) {\n        const date = new Date(entry.date + 'T12:00:00');\n        strategicAbsences.push({\n          date: entry.date,\n          dayOfWeek: dayNames[date.getDay()],\n          employee: userMap.get(entry.userId) || 'Utente sconosciuto',\n          type: entry.absenceType,\n          typeName: absenceTypeNames[entry.absenceType] || entry.absenceType,\n          reason: info.reason\n        });\n      }\n    }\n    \n    // Sort by date descending\n    strategicAbsences.sort((a, b) => b.date.localeCompare(a.date));\n    \n    // Generate report\n    const lines: string[] = [];\n    lines.push('='.repeat(80));\n    lines.push('REPORT ASSENZE STRATEGICHE');\n    lines.push('Assenze (escluse Ferie) registrate il giorno prima o dopo weekend/festività');\n    lines.push('='.repeat(80));\n    lines.push(`Generato il: ${new Date().toLocaleString('it-IT')}`);\n    lines.push(`Periodo: ultimi ${days} giorni`);\n    lines.push(`Totale assenze strategiche: ${strategicAbsences.length}`);\n    lines.push('');\n    lines.push('-'.repeat(80));\n    lines.push('');\n    \n    // Group by employee\n    const byEmployee = new Map<string, typeof strategicAbsences>();\n    for (const absence of strategicAbsences) {\n      if (!byEmployee.has(absence.employee)) {\n        byEmployee.set(absence.employee, []);\n      }\n      byEmployee.get(absence.employee)!.push(absence);\n    }\n    \n    // Sort employees by count descending\n    const sortedEmployees = Array.from(byEmployee.entries()).sort((a, b) => b[1].length - a[1].length);\n    \n    lines.push('RIEPILOGO PER DIPENDENTE:');\n    lines.push('');\n    for (let i = 0; i < sortedEmployees.length; i++) {\n      const [employee, absences] = sortedEmployees[i];\n      lines.push(`  ${employee}: ${absences.length} assenze strategiche`);\n    }\n    lines.push('');\n    lines.push('-'.repeat(80));\n    lines.push('');\n    lines.push('DETTAGLIO ASSENZE STRATEGICHE:');\n    lines.push('');\n    \n    for (let i = 0; i < sortedEmployees.length; i++) {\n      const [employee, absences] = sortedEmployees[i];\n      lines.push(`\\n${employee} (${absences.length} assenze):`);\n      lines.push('-'.repeat(40));\n      for (let j = 0; j < absences.length; j++) {\n        const absence = absences[j];\n        const dateFormatted = absence.date.split('-').reverse().join('/');\n        lines.push(`  ${dateFormatted} (${absence.dayOfWeek}) - ${absence.typeName}`);\n        lines.push(`    Motivo: ${absence.reason}`);\n      }\n    }\n    \n    lines.push('');\n    lines.push('='.repeat(80));\n    lines.push('LEGENDA TIPI ASSENZA:');\n    lines.push('  A  = Assenza');\n    lines.push('  P  = Permesso');\n    lines.push('  M  = Malattia');\n    lines.push('  CP = Cassa Integrazione/Permesso');\n    lines.push('  L104 = Legge 104');\n    lines.push('='.repeat(80));\n    \n    return lines.join('\\n');\n  }\n  \n  private getAdjacentInfo(dateStr: string): { isStrategic: boolean; reason: string } {\n    const date = new Date(dateStr + 'T12:00:00');\n    const holidays = this.getAllHolidaysForDate(dateStr);\n    \n    const dayBefore = new Date(date);\n    dayBefore.setDate(dayBefore.getDate() - 1);\n    const dayBeforeStr = formatDateToString(dayBefore);\n    const beforeDayOfWeek = dayBefore.getDay();\n    const beforeIsWeekend = beforeDayOfWeek === 0 || beforeDayOfWeek === 6;\n    const beforeIsHoliday = holidays.has(dayBeforeStr);\n    \n    const dayAfter = new Date(date);\n    dayAfter.setDate(dayAfter.getDate() + 1);\n    const dayAfterStr = formatDateToString(dayAfter);\n    const afterDayOfWeek = dayAfter.getDay();\n    const afterIsWeekend = afterDayOfWeek === 0 || afterDayOfWeek === 6;\n    const afterIsHoliday = holidays.has(dayAfterStr);\n    \n    const reasons: string[] = [];\n    \n    if (beforeIsWeekend) {\n      reasons.push(`giorno prima (${dayBeforeStr}) è weekend`);\n    } else if (beforeIsHoliday) {\n      reasons.push(`giorno prima (${dayBeforeStr}) è festività`);\n    }\n    \n    if (afterIsWeekend) {\n      reasons.push(`giorno dopo (${dayAfterStr}) è weekend`);\n    } else if (afterIsHoliday) {\n      reasons.push(`giorno dopo (${dayAfterStr}) è festività`);\n    }\n    \n    return {\n      isStrategic: reasons.length > 0,\n      reason: reasons.join('; ')\n    };\n  }\n  \n  private getAllHolidaysForDate(dateStr: string): Set<string> {\n    const date = new Date(dateStr + 'T12:00:00');\n    const year = date.getFullYear();\n    const allHolidays = new Set<string>();\n    \n    [year - 1, year, year + 1].forEach(y => {\n      getItalianHolidays(y).forEach(h => allHolidays.add(h));\n    });\n    \n    return allHolidays;\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":65833,"size_tokens":null},"shared/dateUtils.ts":{"content":"/**\n * Shared date utility functions for both client and server\n * Italian format: DD/MM/YYYY\n * Database format: YYYY-MM-DD\n */\n\n/**\n * Convert date from YYYY-MM-DD to DD/MM/YYYY format\n * Parses manually to avoid timezone issues\n */\nexport function formatDateToItalian(dateStr: string): string {\n  if (!dateStr) return '';\n  \n  // If already in DD/MM/YYYY format, return as is\n  if (/^\\d{2}\\/\\d{2}\\/\\d{4}$/.test(dateStr)) {\n    return dateStr;\n  }\n  \n  // Parse YYYY-MM-DD format manually to avoid timezone issues\n  const isoMatch = dateStr.match(/^(\\d{4})-(\\d{2})-(\\d{2})/);\n  if (isoMatch) {\n    const [, year, month, day] = isoMatch;\n    return `${day}/${month}/${year}`;\n  }\n  \n  // Fallback: return original string\n  return dateStr;\n}\n\n/**\n * Convert date from YYYY-MM-DD to Italian long format\n * Example: \"2025-10-08\" -> \"martedì 08 ottobre 2025\"\n */\nexport function formatDateToItalianLong(dateStr: string): string {\n  if (!dateStr) return '';\n  \n  // Parse YYYY-MM-DD format manually to avoid timezone issues\n  const isoMatch = dateStr.match(/^(\\d{4})-(\\d{2})-(\\d{2})/);\n  if (!isoMatch) return dateStr;\n  \n  const [, yearStr, monthStr, dayStr] = isoMatch;\n  const year = parseInt(yearStr, 10);\n  const month = parseInt(monthStr, 10);\n  const day = parseInt(dayStr, 10);\n  \n  // Italian day names\n  const dayNames = ['domenica', 'lunedì', 'martedì', 'mercoledì', 'giovedì', 'venerdì', 'sabato'];\n  \n  // Italian month names\n  const monthNames = [\n    'gennaio', 'febbraio', 'marzo', 'aprile', 'maggio', 'giugno',\n    'luglio', 'agosto', 'settembre', 'ottobre', 'novembre', 'dicembre'\n  ];\n  \n  // Calculate day of week (Zeller's congruence)\n  let m = month;\n  let y = year;\n  if (m < 3) {\n    m += 12;\n    y -= 1;\n  }\n  const q = day;\n  const K = y % 100;\n  const J = Math.floor(y / 100);\n  const h = (q + Math.floor((13 * (m + 1)) / 5) + K + Math.floor(K / 4) + Math.floor(J / 4) - 2 * J) % 7;\n  \n  // Convert Zeller's result to day of week (0 = Saturday in Zeller's)\n  const dayOfWeek = ((h + 5) % 7 + 1) % 7; // Convert to 0 = Sunday\n  \n  const dayName = dayNames[dayOfWeek];\n  const monthName = monthNames[month - 1];\n  \n  return `${dayName} ${String(day).padStart(2, '0')} ${monthName} ${year}`;\n}\n\n/**\n * Convert date from DD/MM/YYYY to YYYY-MM-DD format\n * Validates input before conversion\n */\nexport function formatDateToISO(dateStr: string): string {\n  if (!dateStr) return '';\n  \n  // If already in ISO format, return as is\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(dateStr)) {\n    return dateStr;\n  }\n  \n  // Parse DD/MM/YYYY format\n  const parts = dateStr.split('/');\n  if (parts.length !== 3) return '';\n  \n  const [day, month, year] = parts;\n  \n  // Basic validation\n  const d = parseInt(day, 10);\n  const m = parseInt(month, 10);\n  const y = parseInt(year, 10);\n  \n  if (isNaN(d) || isNaN(m) || isNaN(y)) return '';\n  if (d < 1 || d > 31 || m < 1 || m > 12 || y < 1900) return '';\n  \n  return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;\n}\n\n/**\n * Get today's date in DD/MM/YYYY format (local timezone)\n */\nexport function getTodayItalian(): string {\n  return formatDateToItalian(getTodayISO());\n}\n\n/**\n * Get today's date in YYYY-MM-DD format (local timezone)\n */\nexport function getTodayISO(): string {\n  const today = new Date();\n  const year = today.getFullYear();\n  const month = String(today.getMonth() + 1).padStart(2, '0');\n  const day = String(today.getDate()).padStart(2, '0');\n  return `${year}-${month}-${day}`;\n}\n\n/**\n * Validate DD/MM/YYYY format\n */\nexport function isValidItalianDate(dateStr: string): boolean {\n  if (!dateStr) return false;\n  \n  const regex = /^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/;\n  const match = dateStr.match(regex);\n  \n  if (!match) return false;\n  \n  const [, day, month, year] = match;\n  const d = parseInt(day, 10);\n  const m = parseInt(month, 10);\n  const y = parseInt(year, 10);\n  \n  if (m < 1 || m > 12) return false;\n  if (d < 1 || d > 31) return false;\n  if (y < 1900 || y > 2100) return false;\n  \n  // Check actual date validity (this will create a Date object but only for validation)\n  const date = new Date(y, m - 1, d);\n  return date.getFullYear() === y && date.getMonth() === m - 1 && date.getDate() === d;\n}\n","path":null,"size_bytes":4193,"size_tokens":null},"server/pdfService.ts":{"content":"import { TDocumentDefinitions, Content } from 'pdfmake/interfaces';\nimport { storage } from './storage';\nimport { DailyReport, Operation, User, Client, WorkOrder } from '@shared/schema';\nimport { formatDateToItalianLong } from '../shared/dateUtils';\nimport { objectStorageClient } from './objectStorage';\nimport sharp from 'sharp';\nimport fs from 'fs';\nimport path from 'path';\n\nexport class PDFService {\n  \n  async generateDailyReportPDF(date: string, organizationId: string): Promise<Buffer> {\n    const reports = await storage.getDailyReportsByDate(date, organizationId);\n    \n    if (reports.length === 0) {\n      // Format date in Italian format for user-friendly error message\n      const [year, month, day] = date.split('-');\n      const italianDate = `${day}/${month}/${year}`;\n      throw new Error(`Nessun rapportino trovato per la data ${italianDate}. Verifica che ci siano rapportini approvati per questa data.`);\n    }\n\n    // Get all related data\n    const clients = await storage.getAllClients(organizationId);\n    const clientsMap = new Map(clients.map(c => [c.id, c]));\n    \n    // Get all work orders\n    const allWorkOrders: WorkOrder[] = [];\n    for (const client of clients) {\n      const workOrders = await storage.getWorkOrdersByClient(client.id, organizationId);\n      allWorkOrders.push(...workOrders);\n    }\n    const workOrdersMap = new Map(allWorkOrders.map(wo => [wo.id, wo]));\n\n    // Build content for each employee\n    const employeeReports: Content[] = [];\n    \n    for (const report of reports) {\n      const user = await storage.getUser(report.employeeId);\n      const operations = await storage.getOperationsByReportId(report.id);\n      \n      if (user && operations.length > 0) {\n        const employeeSection = await this.createEmployeeSection(\n          user,\n          report,\n          operations,\n          clientsMap,\n          workOrdersMap\n        );\n        employeeReports.push(employeeSection);\n        \n        // Add page break between employees (except for the last one)\n        if (reports.indexOf(report) < reports.length - 1) {\n          employeeReports.push({ text: '', pageBreak: 'after' });\n        }\n      }\n    }\n\n    const docDefinition: TDocumentDefinitions = {\n      pageSize: 'A4',\n      pageMargins: [40, 60, 40, 60],\n      \n      header: {\n        columns: [\n          {\n            image: await this.getLogoBase64(),\n            width: 80,\n            margin: [40, 20, 0, 0]\n          },\n          {\n            stack: [\n              { text: 'METALTEC Scoccia S.R.L.', style: 'companyName' },\n              { text: `Rapportini Giornalieri - ${this.formatDate(date)}`, style: 'reportTitle' }\n            ],\n            margin: [0, 25, 40, 0]\n          }\n        ],\n        margin: [0, 0, 0, 20]\n      },\n\n      content: employeeReports,\n      \n      styles: {\n        companyName: {\n          fontSize: 16,\n          bold: true,\n          color: '#1e40af'\n        },\n        reportTitle: {\n          fontSize: 12,\n          color: '#666666',\n          margin: [0, 5, 0, 0]\n        },\n        employeeName: {\n          fontSize: 14,\n          bold: true,\n          margin: [0, 20, 0, 10]\n        },\n        sectionHeader: {\n          fontSize: 12,\n          bold: true,\n          margin: [0, 15, 0, 5]\n        },\n        tableHeader: {\n          fontSize: 10,\n          bold: true,\n          fillColor: '#f3f4f6'\n        },\n        tableCell: {\n          fontSize: 9,\n          margin: [2, 4, 2, 4]\n        },\n        statusBadge: {\n          fontSize: 9,\n          bold: true,\n          margin: [0, 2, 0, 2]\n        }\n      }\n    };\n\n    return new Promise(async (resolve, reject) => {\n      try {\n        // Use dynamic imports to avoid ES module restrictions\n        const [PdfMake, pdfFonts] = await Promise.all([\n          import('pdfmake/build/pdfmake'),\n          import('pdfmake/build/vfs_fonts').catch(() => null)\n        ]);\n        \n        // Get VFS fonts if available\n        const vfs = pdfFonts && (pdfFonts as any).pdfMake?.vfs ? (pdfFonts as any).pdfMake.vfs : undefined;\n        \n        // Create PDF document with vfs parameter instead of mutating the import\n        const pdfDoc = PdfMake.default.createPdf(docDefinition, undefined, undefined, vfs);\n        \n        pdfDoc.getBuffer((buffer: Buffer) => {\n          resolve(buffer);\n        });\n      } catch (error) {\n        console.warn('PDFMake initialization error:', error);\n        reject(error);\n      }\n    });\n  }\n\n\n  private async createEmployeeSection(\n    user: User,\n    report: DailyReport,\n    operations: Operation[],\n    clientsMap: Map<string, Client>,\n    workOrdersMap: Map<string, WorkOrder>\n  ): Promise<Content> {\n    \n    const totalHours = operations.reduce((sum, op) => sum + Number(op.hours), 0);\n    \n    // Operations table\n    const tableBody = [\n      // Header\n      [\n        { text: 'Cliente', style: 'tableHeader' },\n        { text: 'Commessa', style: 'tableHeader' },\n        { text: 'Lavorazione', style: 'tableHeader' },\n        { text: 'Ore', style: 'tableHeader' },\n        { text: 'Note', style: 'tableHeader' }\n      ]\n    ];\n\n    // Add operation rows\n    operations.forEach(op => {\n      const client = clientsMap.get(op.clientId);\n      const workOrder = workOrdersMap.get(op.workOrderId);\n      const hours = Number(op.hours);\n      \n      tableBody.push([\n        { text: client?.name || 'N/A', style: 'tableCell' },\n        { text: workOrder?.name || 'N/A', style: 'tableCell' },\n        { text: op.workTypes.join(', '), style: 'tableCell' },\n        { text: hours.toString() + 'h', style: 'tableCell' },\n        { text: op.notes || '-', style: 'tableCell' }\n      ]);\n    });\n\n    // Add total row\n    tableBody.push([\n      { text: '', style: 'tableCell' },\n      { text: '', style: 'tableCell' },\n      { text: 'TOTALE:', style: 'tableHeader' },\n      { text: totalHours.toString() + 'h', style: 'tableHeader' },\n      { text: '', style: 'tableCell' }\n    ]);\n\n    // Build stack content\n    const stackContent: Content[] = [\n      // Employee header\n      {\n        columns: [\n          { text: user.fullName, style: 'employeeName' },\n          { \n            text: report.status, \n            style: 'statusBadge',\n            color: report.status === 'Approvato' ? '#16a34a' : '#eab308',\n            alignment: 'right'\n          }\n        ]\n      },\n      \n      // Operations table\n      {\n        table: {\n          headerRows: 1,\n          widths: ['*', '*', 'auto', 'auto', '*'],\n          body: tableBody\n        },\n        layout: 'lightHorizontalLines'\n      },\n      \n      // Summary\n      {\n        text: `Operazioni: ${operations.length} | Ore totali: ${totalHours}`,\n        style: 'sectionHeader',\n        margin: [0, 10, 0, 0]\n      }\n    ];\n\n    // Add photos for each operation that has them\n    for (let i = 0; i < operations.length; i++) {\n      const op = operations[i];\n      if (op.photos && op.photos.length > 0) {\n        const client = clientsMap.get(op.clientId);\n        const workOrder = workOrdersMap.get(op.workOrderId);\n        \n        // Load photos in parallel with bounded concurrency\n        const photoPromises = op.photos.map(photoPath => this.getPhotoAsBase64(photoPath, 200));\n        const photoBase64Array = await Promise.all(photoPromises);\n        \n        // Build photo images array (filter out null values)\n        const photoImages: any[] = photoBase64Array\n          .filter(base64 => base64 !== null)\n          .map(base64 => ({\n            image: base64,\n            width: 100,\n            margin: [0, 0, 10, 0]\n          }));\n\n        if (photoImages.length > 0) {\n          stackContent.push({\n            stack: [\n              {\n                text: `Foto Operazione ${i + 1} - ${client?.name || 'N/A'} / ${workOrder?.name || 'N/A'}`,\n                style: 'sectionHeader',\n                margin: [0, 10, 0, 5]\n              },\n              {\n                columns: photoImages,\n                columnGap: 10\n              }\n            ],\n            margin: [0, 5, 0, 10]\n          });\n        }\n      }\n    }\n\n    return {\n      stack: stackContent\n    };\n  }\n\n  private async getLogoBase64(): Promise<string> {\n    try {\n      // Try to read the logo file\n      const logoPath = path.join(process.cwd(), 'attached_assets', '3F8AF681-7737-41D8-A852-3AEB802C183F_1759092829478.png');\n      const logoBuffer = fs.readFileSync(logoPath);\n      return `data:image/png;base64,${logoBuffer.toString('base64')}`;\n    } catch (error) {\n      console.warn('Logo not found, using placeholder');\n      // Return a small placeholder base64 image if logo is not found\n      return 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';\n    }\n  }\n\n  private formatDate(dateStr: string): string {\n    return formatDateToItalianLong(dateStr);\n  }\n\n  private async getPhotoAsBase64(photoPath: string, maxWidth: number = 200): Promise<string | null> {\n    try {\n      // Parse bucket name and object path from the photo path\n      // photoPath format: \"operations/photos/xxxxx.jpg\"\n      const bucketId = process.env.DEFAULT_OBJECT_STORAGE_BUCKET_ID;\n      if (!bucketId) {\n        console.warn('DEFAULT_OBJECT_STORAGE_BUCKET_ID not set');\n        return null;\n      }\n\n      const bucket = objectStorageClient.bucket(bucketId);\n      const file = bucket.file(photoPath);\n      \n      // Check if file exists\n      const [exists] = await file.exists();\n      if (!exists) {\n        console.warn(`Photo not found: ${photoPath}`);\n        return null;\n      }\n\n      // Download file as buffer\n      const [buffer] = await file.download();\n      \n      // Resize and compress image using Sharp\n      const resizedBuffer = await sharp(buffer)\n        .resize(maxWidth, null, { \n          fit: 'inside',\n          withoutEnlargement: true \n        })\n        .jpeg({ quality: 80 })\n        .toBuffer();\n      \n      // Convert to base64\n      return `data:image/jpeg;base64,${resizedBuffer.toString('base64')}`;\n    } catch (error) {\n      console.error(`Error loading photo ${photoPath}:`, error);\n      return null;\n    }\n  }\n}","path":null,"size_bytes":10130,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/LoginForm.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Card,\n  CardContent,\n  CardHeader,\n  CardTitle,\n  CardDescription,\n} from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { LogIn, Loader2, AlertCircle, Shield } from \"lucide-react\";\nimport logoPath from \"@assets/3F8AF681-7737-41D8-A852-3AEB802C183F_1759092829478.png\";\n\ninterface LoginFormProps {\n  onLogin: (\n    username: string,\n    password: string,\n  ) => Promise<{ success: boolean; error?: string }>;\n}\n\nexport default function LoginForm({ onLogin }: LoginFormProps) {\n  const [username, setUsername] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [rememberMe, setRememberMe] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n  const [errorMessage, setErrorMessage] = useState(\"\");\n\n  // Load saved credentials on mount\n  useEffect(() => {\n    const savedCredentials = localStorage.getItem(\"metaltec_login_credentials\");\n    if (savedCredentials) {\n      try {\n        const { username: savedUsername } = JSON.parse(savedCredentials);\n        setUsername(savedUsername || \"\");\n        setRememberMe(true);\n      } catch (error) {\n        console.warn(\"Error loading saved credentials:\", error);\n        localStorage.removeItem(\"metaltec_login_credentials\");\n      }\n    }\n  }, []);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n    setErrorMessage(\"\");\n\n    try {\n      const result = await onLogin(username, password);\n\n      if (result.success) {\n        // Save only username if remember me is checked (NEVER save password)\n        if (rememberMe) {\n          localStorage.setItem(\n            \"metaltec_login_credentials\",\n            JSON.stringify({\n              username,\n            }),\n          );\n        } else {\n          localStorage.removeItem(\"metaltec_login_credentials\");\n        }\n      } else {\n        setErrorMessage(result.error || \"Login fallito\");\n      }\n    } catch (error) {\n      setErrorMessage(\"Errore di connessione al server\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleUsernameChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    setUsername(e.target.value);\n    // Clear error when user starts typing\n    if (errorMessage) {\n      setErrorMessage(\"\");\n    }\n  };\n\n  const handlePasswordChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    setPassword(e.target.value);\n    // Clear error when user starts typing\n    if (errorMessage) {\n      setErrorMessage(\"\");\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-background p-4\">\n      <Card className=\"w-full max-w-md shadow-lg\">\n        <CardHeader className=\"text-center space-y-4\">\n          <div className=\"flex justify-center\">\n            <img\n              src={logoPath}\n              alt=\"METALTEC Scoccia S.R.L.\"\n              className=\"h-20 w-auto object-contain\"\n            />\n          </div>\n          <div>\n            <CardTitle className=\"flex items-center justify-center gap-2 text-xl\">\n              <LogIn className=\"h-5 w-5\" />\n              Gestione Rapportini\n            </CardTitle>\n            <CardDescription className=\"mt-2\">\n              Accedi per gestire i rapportini giornalieri\n            </CardDescription>\n          </div>\n        </CardHeader>\n\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            {/* Username Field */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"username\">Username</Label>\n              <Input\n                id=\"username\"\n                type=\"text\"\n                value={username}\n                onChange={handleUsernameChange}\n                placeholder=\"Inserisci username\"\n                required\n                disabled={isLoading}\n                autoComplete=\"username\"\n                data-testid=\"input-username\"\n                className=\"transition-all\"\n              />\n            </div>\n\n            {/* Password Field */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\">Password</Label>\n              <Input\n                id=\"password\"\n                type=\"password\"\n                value={password}\n                onChange={handlePasswordChange}\n                placeholder=\"Inserisci password\"\n                required\n                disabled={isLoading}\n                autoComplete=\"current-password\"\n                data-testid=\"input-password\"\n                className=\"transition-all\"\n              />\n            </div>\n\n            {/* Remember Me Checkbox */}\n            <div className=\"flex items-center space-x-2\">\n              <Checkbox\n                id=\"remember-me\"\n                checked={rememberMe}\n                onCheckedChange={(checked) => setRememberMe(checked as boolean)}\n                disabled={isLoading}\n                data-testid=\"checkbox-remember-me\"\n              />\n              <Label\n                htmlFor=\"remember-me\"\n                className=\"text-sm font-normal cursor-pointer select-none\"\n              >\n                Ricorda username\n              </Label>\n            </div>\n\n            {/* Error Message */}\n            {errorMessage && (\n              <Alert\n                variant=\"destructive\"\n                className=\"animate-in fade-in slide-in-from-top-2\"\n              >\n                <AlertCircle className=\"h-4 w-4\" />\n                <AlertDescription>{errorMessage}</AlertDescription>\n              </Alert>\n            )}\n\n            {/* Security Notice */}\n            {!errorMessage && (\n              <div className=\"flex items-start gap-2 p-3 bg-muted rounded-lg text-sm text-muted-foreground\">\n                <Shield className=\"h-4 w-4 mt-0.5 flex-shrink-0\" />\n                <p>\n                  Accesso sicuro con protezione contro accessi non autorizzati.\n                </p>\n              </div>\n            )}\n\n            {/* Submit Button */}\n            <Button\n              type=\"submit\"\n              className=\"w-full\"\n              disabled={isLoading}\n              data-testid=\"button-login\"\n            >\n              {isLoading ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Accesso in corso...\n                </>\n              ) : (\n                <>\n                  <LogIn className=\"h-4 w-4 mr-2\" />\n                  Accedi\n                </>\n              )}\n            </Button>\n          </form>\n\n          {/* Footer */}\n          <div className=\"mt-6 text-center text-xs text-muted-foreground\">\n            <p>METALTEC Scoccia S.R.L. © {new Date().getFullYear()}</p>\n            <p className=\"mt-1\">Sistema di gestione rapportini v2.0</p>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":7064,"size_tokens":null},"replit.md":{"content":"# Daily Work Report Management Application\n\n## Overview\nThis project is a daily work report management system for employees and administrators. It enables employees to create detailed daily reports with operation entries (client work, work orders, time tracking), while administrators can review, approve, and export these reports. The system features a mobile-first design for employees and a comprehensive desktop interface for administrators, aiming to streamline work tracking and reporting processes.\n\n## User Preferences\nPreferred communication style: Simple, everyday language.\nDate format: DD/MM/YYYY (Italian format) for all date displays in the application.\n\n## System Architecture\n\n### Frontend\n- **Technology**: React 18+ with TypeScript, Shadcn/ui (built on Radix UI), Tailwind CSS for styling (with light/dark mode), Wouter for routing.\n- **State Management**: TanStack Query for server state, React hooks for local state.\n- **Design**: Mobile-first responsive design for employees; desktop-optimized for administrators.\n- **Forms**: React Hook Form with Zod validation.\n\n### Backend\n- **Technology**: Express.js with TypeScript.\n- **Database**: PostgreSQL (Neon serverless) via Drizzle ORM.\n- **Data Model**: Includes Users (employee/admin roles), Clients, Work Orders, Daily Reports, and Operations (individual work entries).\n- **PDF/Word Generation**: PDFMake for PDF exports, Docx for Word exports (with image support via Sharp).\n- **Session Management**: Express sessions with PostgreSQL store.\n- **Authentication**: Simple username/password login with role-based access control.\n- **Multi-tenancy**: Strict `organizationId` filtering at all data access and export layers to ensure data isolation.\n- **Push Notifications**: Browser-native push notifications for employees, reminding them to submit daily reports, scheduled daily at 19:00.\n- **Performance**: Database indexes for common queries, optimized API calls for report submission, and UI-level duplicate submission prevention.\n\n### Key Features\n- **Daily Report Creation**: Employees can create reports with detailed operations including time and work types.\n- **Report Approval Workflow**: Administrators can review and approve daily reports.\n- **Data Export**: Reports can be exported as PDF or Word documents.\n- **Photo Upload**: Supports uploading up to 5 photos per operation, integrated into Word exports, with camera capture capabilities.\n- **Automated Reminders**: Push notification system to remind employees to submit reports.\n\n## External Dependencies\n\n### Core Technologies\n- **Frontend**: React, TypeScript, Vite.\n- **Backend**: Express.js, Node.js.\n\n### Database & ORM\n- **Database**: Neon (PostgreSQL).\n- **ORM**: Drizzle ORM, Drizzle Kit.\n\n### UI & Styling\n- **Component Libraries**: Radix UI, Shadcn/ui.\n- **Styling**: Tailwind CSS.\n- **Icons**: Lucide React.\n\n### Form & Validation\n- **Form Management**: React Hook Form.\n- **Validation**: Zod, Hookform Resolvers.\n\n### Utilities\n- **Server State**: TanStack Query.\n- **Date Handling**: Date-fns.\n- **CSS Utilities**: Class Variance Authority, clsx, Tailwind Merge.\n- **Scheduling**: Node-cron.\n\n### Document Generation & Image Processing\n- **Word Export**: Docx.\n- **Image Processing**: Sharp.\n- **PDF Export**: PDFMake.\n\n### Push Notifications\n- **Library**: Web-push.\n\n### Development Tools\n- TSX, ESBuild, PostCSS.","path":null,"size_bytes":3362,"size_tokens":null},"client/src/components/examples/ThemeToggle.tsx":{"content":"import { ThemeProvider } from \"../ThemeProvider\";\nimport ThemeToggle from \"../ThemeToggle\";\n\nexport default function ThemeToggleExample() {\n  return (\n    <ThemeProvider>\n      <div className=\"p-4 bg-background\">\n        <ThemeToggle />\n      </div>\n    </ThemeProvider>\n  );\n}","path":null,"size_bytes":277,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1383,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/examples/DailyReportForm.tsx":{"content":"import DailyReportForm from \"../DailyReportForm\";\n\nexport default function DailyReportFormExample() {\n  const handleSubmit = (operations: any[]) => {\n    console.log(\"Daily report submitted with operations:\", operations);\n    alert(`Rapportino inviato con ${operations.length} operazioni!`);\n  };\n\n  return (\n    <DailyReportForm\n      employeeName=\"Marco Rossi\"\n      date=\"15 Marzo 2024\"\n      onSubmit={handleSubmit}\n    />\n  );\n}","path":null,"size_bytes":433,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\nimport \"@uppy/core/css/style.min.css\";\nimport \"@uppy/dashboard/css/style.min.css\";\nimport \"@uppy/webcam/css/style.min.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":281,"size_tokens":null},"client/src/components/AdminDashboard.tsx":{"content":"import { useState, useRef, Fragment, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from \"@/components/ui/alert-dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { formatDateToItalian, formatDateToISO } from \"@/lib/dateUtils\";\nimport { \n  Users, \n  FileText, \n  Building,\n  Building2, \n  Briefcase, \n  Search, \n  Filter,\n  CheckCircle,\n  Clock,\n  Plus,\n  Edit,\n  Trash,\n  Calendar,\n  Wrench,\n  Eye,\n  Key,\n  Hammer,\n  Package,\n  ChevronDown,\n  ChevronUp,\n  ChevronLeft,\n  ChevronRight,\n  MapPin,\n  ClipboardList,\n  Camera,\n  Calculator,\n  Bell,\n  UserX,\n  UserCheck,\n  BarChart2,\n  TrendingUp,\n  AlertTriangle,\n  Download\n} from \"lucide-react\";\nimport { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, ResponsiveContainer, BarChart, Bar } from \"recharts\";\nimport StatusBadge from \"./StatusBadge\";\nimport WorkOrderReport from \"./WorkOrderReport\";\nimport DailyReportForm from \"./DailyReportForm\";\nimport AttendanceSheet from \"./AttendanceSheet\";\nimport { HoursAdjustmentDialog } from \"./HoursAdjustmentDialog\";\nimport VehiclesManagement from \"./VehiclesManagement\";\nimport FuelRefillsManagement from \"./FuelRefillsManagement\";\nimport FuelStatistics from \"./FuelStatistics\";\n\n// Schema per form aggiunta dipendente\nconst addEmployeeSchema = z.object({\n  fullName: z.string().min(2, \"Il nome deve essere di almeno 2 caratteri\"),\n  username: z.string().min(3, \"L'username deve essere di almeno 3 caratteri\"),\n  password: z.string().min(1, \"Password è richiesta\"),\n});\n\n// Schema per modifica dipendente (password opzionale)\nconst editEmployeeSchema = z.object({\n  fullName: z.string().min(2, \"Il nome deve essere di almeno 2 caratteri\"),\n  username: z.string().min(3, \"L'username deve essere di almeno 3 caratteri\"),\n  password: z.string().min(1, \"Password è richiesta\").optional().or(z.literal(\"\")),\n  isActive: z.boolean().default(true),\n});\n\n// Schema per creazione commessa\nconst addWorkOrderSchema = z.object({\n  clientId: z.string().min(1, \"Cliente è richiesto\"),\n  name: z.string().min(2, \"Il nome deve essere di almeno 2 caratteri\"),\n  description: z.string().optional(),\n  isActive: z.boolean().default(true),\n  availableWorkTypes: z.array(z.string()).default([]),\n  availableMaterials: z.array(z.string()).default([]),\n});\n\n// Schema per creazione cliente\nconst addClientSchema = z.object({\n  name: z.string().min(2, \"Il nome deve essere di almeno 2 caratteri\"),\n});\n\n// Schema per lavorazioni (work types)\nconst workTypeSchema = z.object({\n  name: z.string().min(2, \"Il nome deve essere di almeno 2 caratteri\"),\n  description: z.string().optional(),\n  isActive: z.boolean().default(true),\n});\n\n// Schema per materiali\nconst materialSchema = z.object({\n  name: z.string().min(2, \"Il nome deve essere di almeno 2 caratteri\"),\n  description: z.string().optional(),\n  isActive: z.boolean().default(true),\n});\n\n// Schema per registrazione assenze\nconst registerAbsenceSchema = z.object({\n  date: z.string().min(1, \"Data è richiesta\"),\n  userIds: z.array(z.string()).min(1, \"Seleziona almeno un dipendente\"),\n  absenceType: z.string().min(1, \"Tipo assenza è richiesto\"),\n  notes: z.string().optional(),\n});\n\ntype AddEmployeeForm = z.infer<typeof addEmployeeSchema>;\ntype EditEmployeeForm = z.infer<typeof editEmployeeSchema>;\ntype AddWorkOrderForm = z.infer<typeof addWorkOrderSchema>;\ntype AddClientForm = z.infer<typeof addClientSchema>;\ntype WorkTypeForm = z.infer<typeof workTypeSchema>;\ntype MaterialForm = z.infer<typeof materialSchema>;\ntype RegisterAbsenceForm = z.infer<typeof registerAbsenceSchema>;\n\n\n// Mock data removed - now using real data from API\n\nexport default function AdminDashboard() {\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n  const [fromDate, setFromDate] = useState<string>(\"\");\n  const [toDate, setToDate] = useState<string>(\"\");\n  const [employeeStatusFilter, setEmployeeStatusFilter] = useState(\"all\"); // all, active, inactive\n  const [mainSection, setMainSection] = useState(\"rapportini\"); // rapportini or rifornimenti\n  const [selectedTab, setSelectedTab] = useState(\"reports\");\n  const [selectedWorkOrder, setSelectedWorkOrder] = useState<{\n    id: string;\n    number: string;\n    description: string;\n    clientName: string;\n  } | null>(null);\n  const [addEmployeeDialogOpen, setAddEmployeeDialogOpen] = useState(false);\n  const [editEmployeeDialogOpen, setEditEmployeeDialogOpen] = useState(false);\n  const [deleteEmployeeDialogOpen, setDeleteEmployeeDialogOpen] = useState(false);\n  const [toggleStatusDialogOpen, setToggleStatusDialogOpen] = useState(false);\n  const [employeeToToggle, setEmployeeToToggle] = useState<any>(null);\n  const [selectedEmployee, setSelectedEmployee] = useState<any>(null);\n  const [resetPasswordDialogOpen, setResetPasswordDialogOpen] = useState(false);\n  const [newPassword, setNewPassword] = useState<string>(\"\");\n  const [employeeStatsDialogOpen, setEmployeeStatsDialogOpen] = useState(false);\n  const [selectedEmployeeForStats, setSelectedEmployeeForStats] = useState<any>(null);\n  const [editReportDialogOpen, setEditReportDialogOpen] = useState(false);\n  const [selectedReport, setSelectedReport] = useState<any>(null);\n  const [reportOperations, setReportOperations] = useState<any[]>([]);\n  const [createReportDialogOpen, setCreateReportDialogOpen] = useState(false);\n  const [selectedEmployeeForReport, setSelectedEmployeeForReport] = useState<any>(null);\n\n  // Filtri per commesse\n  const [workOrderStatusFilter, setWorkOrderStatusFilter] = useState(\"all\");\n  const [workOrderDateFilter, setWorkOrderDateFilter] = useState(\"all\"); // all, last7days, last30days, last90days\n  const [addWorkOrderDialogOpen, setAddWorkOrderDialogOpen] = useState(false);\n  const [editWorkOrderDialogOpen, setEditWorkOrderDialogOpen] = useState(false);\n  const [deleteWorkOrderDialogOpen, setDeleteWorkOrderDialogOpen] = useState(false);\n  const [selectedWorkOrderToEdit, setSelectedWorkOrderToEdit] = useState<any>(null);\n  const [selectedWorkOrderToDelete, setSelectedWorkOrderToDelete] = useState<any>(null);\n  const [deleteReportDialogOpen, setDeleteReportDialogOpen] = useState(false);\n  const [selectedReportToDelete, setSelectedReportToDelete] = useState<any>(null);\n  const [changeDateDialogOpen, setChangeDateDialogOpen] = useState(false);\n  const [selectedReportToChangeDate, setSelectedReportToChangeDate] = useState<any>(null);\n  const [newReportDate, setNewReportDate] = useState<string>(\"\");\n  const [addClientDialogOpen, setAddClientDialogOpen] = useState(false);\n  const [deleteClientDialogOpen, setDeleteClientDialogOpen] = useState(false);\n  const [selectedClientToDelete, setSelectedClientToDelete] = useState<any>(null);\n  const [clientWorkOrdersCount, setClientWorkOrdersCount] = useState<number>(0);\n  const [clientOperationsCount, setClientOperationsCount] = useState<number>(0);\n  const [employeeReportsCount, setEmployeeReportsCount] = useState<number>(0);\n\n  // Ref for auto-focus on toDate input\n  const toDateInputRef = useRef<HTMLInputElement>(null);\n\n  // State for work types management\n  const [addWorkTypeDialogOpen, setAddWorkTypeDialogOpen] = useState(false);\n  const [editWorkTypeDialogOpen, setEditWorkTypeDialogOpen] = useState(false);\n  const [deleteWorkTypeDialogOpen, setDeleteWorkTypeDialogOpen] = useState(false);\n  const [selectedWorkType, setSelectedWorkType] = useState<any>(null);\n\n  // State for materials management\n  const [addMaterialDialogOpen, setAddMaterialDialogOpen] = useState(false);\n  const [editMaterialDialogOpen, setEditMaterialDialogOpen] = useState(false);\n  const [deleteMaterialDialogOpen, setDeleteMaterialDialogOpen] = useState(false);\n  const [selectedMaterial, setSelectedMaterial] = useState<any>(null);\n\n  // State for inline quick-add forms in work order dialog\n  const [showQuickAddWorkType, setShowQuickAddWorkType] = useState(false);\n  const [quickAddWorkTypeName, setQuickAddWorkTypeName] = useState(\"\");\n  const [showQuickAddMaterial, setShowQuickAddMaterial] = useState(false);\n  const [quickAddMaterialName, setQuickAddMaterialName] = useState(\"\");\n\n  // State for expandable report rows\n  const [expandedReportId, setExpandedReportId] = useState<string | null>(null);\n  const [expandedReportData, setExpandedReportData] = useState<any>(null);\n\n  // State for hours adjustment dialog\n  const [hoursAdjustmentDialogOpen, setHoursAdjustmentDialogOpen] = useState(false);\n  const [selectedReportForAdjustment, setSelectedReportForAdjustment] = useState<string | null>(null);\n  const [currentHoursAdjustment, setCurrentHoursAdjustment] = useState<any>(null);\n\n  // State for missing employees dialog\n  const [missingEmployeesDialogOpen, setMissingEmployeesDialogOpen] = useState(false);\n\n  // State for register absence dialog\n  const [registerAbsenceDialogOpen, setRegisterAbsenceDialogOpen] = useState(false);\n  const [selectedUserIds, setSelectedUserIds] = useState<string[]>([]);\n  const [missingEmployeesDate, setMissingEmployeesDate] = useState<string>(() => {\n    const today = new Date();\n    return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;\n  });\n\n  // State for reports time filter (7 days or all)\n  const [showAllReports, setShowAllReports] = useState(false);\n\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n\n  // Form per aggiunta dipendente\n  const form = useForm<AddEmployeeForm>({\n    resolver: zodResolver(addEmployeeSchema),\n    defaultValues: {\n      fullName: \"\",\n      username: \"\",\n      password: \"\",\n    },\n  });\n\n  // Form per aggiunta commessa\n  const workOrderForm = useForm<AddWorkOrderForm>({\n    resolver: zodResolver(addWorkOrderSchema),\n    defaultValues: {\n      clientId: \"\",\n      name: \"\",\n      description: \"\",\n      isActive: true,\n      availableWorkTypes: [],\n      availableMaterials: [],\n    },\n  });\n\n  // Form per modifica commessa\n  const editWorkOrderForm = useForm<AddWorkOrderForm>({\n    resolver: zodResolver(addWorkOrderSchema),\n    defaultValues: {\n      clientId: \"\",\n      name: \"\",\n      description: \"\",\n      isActive: true,\n      availableWorkTypes: [],\n      availableMaterials: [],\n    },\n  });\n\n  // Form per modifica dipendente\n  const editForm = useForm<EditEmployeeForm>({\n    resolver: zodResolver(editEmployeeSchema),\n    defaultValues: {\n      fullName: \"\",\n      username: \"\",\n      password: \"\",\n      isActive: true,\n    },\n  });\n\n  // Form per aggiunta cliente\n  const clientForm = useForm<AddClientForm>({\n    resolver: zodResolver(addClientSchema),\n    defaultValues: {\n      name: \"\",\n    },\n  });\n\n  // Form per lavorazioni\n  const workTypeForm = useForm<WorkTypeForm>({\n    resolver: zodResolver(workTypeSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      isActive: true,\n    },\n  });\n\n  // Form per materiali\n  const materialForm = useForm<MaterialForm>({\n    resolver: zodResolver(materialSchema),\n    defaultValues: {\n      name: \"\",\n      description: \"\",\n      isActive: true,\n    },\n  });\n\n  // Form per registrazione assenze\n  const registerAbsenceForm = useForm<RegisterAbsenceForm>({\n    resolver: zodResolver(registerAbsenceSchema),\n    defaultValues: {\n      date: new Date().toISOString().split('T')[0], // YYYY-MM-DD format (today)\n      userIds: [],\n      absenceType: \"\",\n      notes: \"\",\n    },\n  });\n\n  // Query per recuperare tutti i dipendenti\n  const { data: employees = [], isLoading: isLoadingEmployees } = useQuery<any[]>({\n    queryKey: ['/api/users'],\n  });\n\n  // Query per recuperare solo i dipendenti attivi (per form creazione rapportini)\n  const { data: activeEmployees = [], isLoading: isLoadingActiveEmployees } = useQuery<any[]>({\n    queryKey: ['/api/users/active'],\n  });\n\n  // Query per recuperare tutti i rapportini\n  const { data: reports = [], isLoading: isLoadingReports } = useQuery<any[]>({\n    queryKey: ['/api/daily-reports', showAllReports ? 'all' : '7'],\n    queryFn: async () => {\n      const daysParam = showAllReports ? 'all' : '7';\n      const res = await fetch(`/api/daily-reports?days=${daysParam}`, {\n        credentials: 'include'\n      });\n      if (!res.ok) throw new Error('Failed to fetch daily reports');\n      return res.json();\n    },\n  });\n\n  // Query per recuperare tutti i clienti\n  const { data: clients = [], isLoading: isLoadingClients } = useQuery<any[]>({\n    queryKey: ['/api/clients'],\n  });\n\n  // Query per recuperare tutte le commesse\n  const { data: workOrders = [], isLoading: isLoadingWorkOrders } = useQuery<any[]>({\n    queryKey: ['/api/work-orders'],\n  });\n\n  // Query per recuperare le statistiche delle commesse\n  const { data: workOrdersStats = [], isLoading: isLoadingWorkOrdersStats } = useQuery<any[]>({\n    queryKey: ['/api/work-orders/stats'],\n  });\n\n  // Query per recuperare le lavorazioni\n  const { data: workTypes = [], isLoading: isLoadingWorkTypes } = useQuery<any[]>({\n    queryKey: ['/api/work-types'],\n  });\n\n  // Query per recuperare i materiali\n  const { data: materials = [], isLoading: isLoadingMaterials } = useQuery<any[]>({\n    queryKey: ['/api/materials'],\n  });\n\n  // Query per statistiche assenze (caricato solo quando la tab è selezionata)\n  const { data: attendanceStats, isLoading: isLoadingAttendanceStats, isFetching: isFetchingAttendanceStats } = useQuery<{\n    totalAbsences: number;\n    totalStrategicAbsences: number;\n    byEmployee: Array<{ userId: string; fullName: string; totalAbsences: number; strategicAbsences: number }>;\n    byType: Record<string, number>;\n    byDayOfWeek: Record<number, number>;\n    byMonth: Array<{ month: string; count: number }>;\n  }>({\n    queryKey: ['/api/attendance/stats', selectedTab],\n    queryFn: async () => {\n      console.log('[DEBUG] Fetching attendance stats...');\n      const res = await fetch(`/api/attendance/stats?days=90&_t=${Date.now()}`, {\n        credentials: 'include',\n        headers: {\n          'Cache-Control': 'no-cache, no-store, must-revalidate',\n          'Pragma': 'no-cache'\n        }\n      });\n      if (!res.ok) {\n        console.error('[DEBUG] Failed to fetch attendance stats:', res.status);\n        throw new Error('Failed to fetch attendance stats');\n      }\n      const data = await res.json();\n      console.log('[DEBUG] Attendance stats received:', JSON.stringify(data));\n      return data;\n    },\n    enabled: selectedTab === 'absence-stats',\n  });\n\n  // Query per statistiche assenze singolo dipendente\n  const { data: employeeStats, isLoading: isLoadingEmployeeStats } = useQuery<{\n    userId: string;\n    fullName: string;\n    totalAbsences: number;\n    strategicAbsences: number;\n    strategicPercentage: number;\n    byType: Record<string, number>;\n    byDayOfWeek: Record<number, number>;\n    byMonth: Array<{ month: string; count: number }>;\n  }>({\n    queryKey: ['/api/attendance/stats', selectedEmployeeForStats?.id],\n    queryFn: async () => {\n      const res = await fetch(`/api/attendance/stats/${selectedEmployeeForStats?.id}?days=90`, {\n        credentials: 'include'\n      });\n      if (!res.ok) throw new Error('Failed to fetch employee attendance stats');\n      return res.json();\n    },\n    enabled: employeeStatsDialogOpen && !!selectedEmployeeForStats?.id,\n  });\n\n  // Helper function to get work type name by ID\n  const getWorkTypeName = (id: string) => {\n    const workType = (workTypes as any[]).find((wt: any) => wt.id === id);\n    return workType?.name || id;\n  };\n\n  // Helper function to get material name by ID\n  const getMaterialName = (id: string) => {\n    const material = (materials as any[]).find((m: any) => m.id === id);\n    return material?.name || id;\n  };\n\n  // Query per dipendenti mancanti (solo quando il dialog è aperto)\n  const { data: missingEmployeesData, isLoading: isLoadingMissingEmployees, isError: isMissingEmployeesError } = useQuery<any>({\n    queryKey: ['/api/daily-reports/missing-employees', missingEmployeesDate],\n    queryFn: async () => {\n      const res = await fetch(`/api/daily-reports/missing-employees?date=${missingEmployeesDate}`, {\n        credentials: 'include'\n      });\n      if (!res.ok) throw new Error('Failed to fetch missing employees');\n      return res.json();\n    },\n    enabled: missingEmployeesDialogOpen,\n  });\n\n  // Mutation per creare nuovo dipendente\n  const createEmployeeMutation = useMutation({\n    mutationFn: async (data: AddEmployeeForm) => {\n      return apiRequest('POST', '/api/users', {\n        fullName: data.fullName,\n        username: data.username,\n        password: data.password,\n        role: 'employee'\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users'] });\n      toast({\n        title: \"Dipendente aggiunto\",\n        description: \"Il nuovo dipendente è stato aggiunto con successo.\",\n      });\n      form.reset();\n      setAddEmployeeDialogOpen(false);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'aggiunta del dipendente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation per aggiornare dipendente\n  const updateEmployeeMutation = useMutation({\n    mutationFn: async (data: EditEmployeeForm & { id: string }) => {\n      const updateData: any = {\n        fullName: data.fullName,\n        username: data.username,\n        isActive: data.isActive,\n      };\n\n      // Include password only if provided\n      if (data.password && data.password.trim() !== \"\") {\n        updateData.password = data.password;\n      }\n\n      return apiRequest('PUT', `/api/users/${data.id}`, updateData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users'] });\n      toast({\n        title: \"Dipendente aggiornato\",\n        description: \"Il dipendente è stato aggiornato con successo.\",\n      });\n      editForm.reset();\n      setEditEmployeeDialogOpen(false);\n      setSelectedEmployee(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'aggiornamento del dipendente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation per eliminare dipendente\n  const deleteEmployeeMutation = useMutation({\n    mutationFn: async (employeeId: string) => {\n      return apiRequest('DELETE', `/api/users/${employeeId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/daily-reports'] });\n      toast({\n        title: \"Dipendente eliminato\",\n        description: \"Il dipendente è stato eliminato con successo.\",\n      });\n      setDeleteEmployeeDialogOpen(false);\n      setSelectedEmployee(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'eliminazione del dipendente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation per creare nuovo cliente\n  const createClientMutation = useMutation({\n    mutationFn: async (data: AddClientForm) => {\n      return apiRequest('POST', '/api/clients', {\n        name: data.name,\n        description: null,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/clients'] });\n      toast({\n        title: \"Cliente aggiunto\",\n        description: \"Il nuovo cliente è stato aggiunto con successo.\",\n      });\n      clientForm.reset();\n      setAddClientDialogOpen(false);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante la creazione del cliente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation per eliminare cliente\n  const deleteClientMutation = useMutation({\n    mutationFn: async (clientId: string) => {\n      return apiRequest('DELETE', `/api/clients/${clientId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/clients'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/work-orders'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/daily-reports'] });\n      toast({\n        title: \"Cliente eliminato\",\n        description: \"Il cliente e tutte le commesse e operazioni associate sono stati eliminati con successo.\",\n      });\n      setDeleteClientDialogOpen(false);\n      setSelectedClientToDelete(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'eliminazione del cliente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation per creare nuova commessa\n  const createWorkOrderMutation = useMutation({\n    mutationFn: async (data: AddWorkOrderForm) => {\n      return apiRequest('POST', `/api/clients/${data.clientId}/work-orders`, {\n        name: data.name,\n        description: data.description || \"\",\n        isActive: data.isActive,\n        availableWorkTypes: data.availableWorkTypes || [],\n        availableMaterials: data.availableMaterials || [],\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/work-orders'] });\n      toast({\n        title: \"Commessa creata\",\n        description: \"La nuova commessa è stata creata con successo.\",\n      });\n      workOrderForm.reset();\n      setAddWorkOrderDialogOpen(false);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante la creazione della commessa.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation per eliminare commessa\n  const deleteWorkOrderMutation = useMutation({\n    mutationFn: async (workOrderId: string) => {\n      return apiRequest('DELETE', `/api/work-orders/${workOrderId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/work-orders'] });\n      toast({\n        title: \"Commessa eliminata\",\n        description: \"La commessa è stata eliminata con successo.\",\n      });\n      setDeleteWorkOrderDialogOpen(false);\n      setSelectedWorkOrderToDelete(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'eliminazione della commessa.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation per aggiornare stato commessa\n  const updateWorkOrderStatusMutation = useMutation({\n    mutationFn: async ({ workOrderId, isActive }: { workOrderId: string; isActive: boolean }) => {\n      return apiRequest('PATCH', `/api/work-orders/${workOrderId}/status`, { isActive });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/work-orders'] });\n      toast({\n        title: \"Stato aggiornato\",\n        description: \"Lo stato della commessa è stato aggiornato con successo.\"\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore nell'aggiornamento dello stato\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  // Mutation per aggiornare commessa completa\n  const updateWorkOrderMutation = useMutation({\n    mutationFn: async ({ workOrderId, data }: { workOrderId: string; data: AddWorkOrderForm }) => {\n      return apiRequest('PUT', `/api/work-orders/${workOrderId}`, {\n        clientId: data.clientId,\n        name: data.name,\n        description: data.description || \"\",\n        isActive: data.isActive,\n        availableWorkTypes: data.availableWorkTypes || [],\n        availableMaterials: data.availableMaterials || [],\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/work-orders'] });\n      toast({\n        title: \"Commessa aggiornata\",\n        description: \"La commessa è stata aggiornata con successo.\"\n      });\n      editWorkOrderForm.reset();\n      setEditWorkOrderDialogOpen(false);\n      setSelectedWorkOrderToEdit(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'aggiornamento della commessa.\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  // Reset password mutation\n  const resetPasswordMutation = useMutation({\n    mutationFn: async ({ employeeId, newPassword }: { employeeId: string; newPassword: string }) => {\n      const response = await apiRequest('POST', `/api/users/${employeeId}/reset-password`, { newPassword });\n      return response.json(); // Parse JSON response\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users'] }); // Refresh user list\n      setResetPasswordDialogOpen(false);\n      setSelectedEmployee(null);\n      toast({\n        title: \"Password aggiornata\",\n        description: \"La password del dipendente è stata aggiornata con successo.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'aggiornamento della password.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Toggle employee status mutation\n  const toggleEmployeeStatusMutation = useMutation({\n    mutationFn: async ({ employeeId, isActive }: { employeeId: string; isActive: boolean }) => {\n      return apiRequest('PUT', `/api/users/${employeeId}/status`, { isActive });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/users'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/users/active'] });\n      toast({\n        title: \"Stato aggiornato\",\n        description: \"Lo stato del dipendente è stato aggiornato con successo.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'aggiornamento dello stato.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleAddEmployee = (data: AddEmployeeForm) => {\n    createEmployeeMutation.mutate(data);\n  };\n\n  const handleEditEmployee = (employee: any) => {\n    setSelectedEmployee(employee);\n    editForm.reset({\n      fullName: employee.fullName,\n      username: employee.username,\n      password: \"\", // Password vuota per default\n      isActive: employee.isActive ?? true,\n    });\n    setEditEmployeeDialogOpen(true);\n  };\n\n  const handleUpdateEmployee = (data: EditEmployeeForm) => {\n    if (selectedEmployee) {\n      updateEmployeeMutation.mutate({ ...data, id: selectedEmployee.id });\n    }\n  };\n\n  const handleDeleteEmployee = async (employee: any) => {\n    setSelectedEmployee(employee);\n\n    // Fetch daily reports count\n    try {\n      const response = await fetch(`/api/users/${employee.id}/daily-reports/count`);\n      const data = await response.json();\n      setEmployeeReportsCount(data.count || 0);\n    } catch (error) {\n      console.error(\"Error fetching reports count:\", error);\n      setEmployeeReportsCount(0);\n    }\n\n    setDeleteEmployeeDialogOpen(true);\n  };\n\n  const confirmDeleteEmployee = () => {\n    if (selectedEmployee) {\n      deleteEmployeeMutation.mutate(selectedEmployee.id);\n    }\n  };\n\n  const handleAddClient = (data: AddClientForm) => {\n    createClientMutation.mutate(data);\n  };\n\n  const handleAddWorkOrder = (data: AddWorkOrderForm) => {\n    createWorkOrderMutation.mutate(data);\n  };\n\n  const handleEditWorkOrder = (workOrder: any) => {\n    setSelectedWorkOrderToEdit(workOrder);\n    editWorkOrderForm.reset({\n      clientId: workOrder.clientId,\n      name: workOrder.name,\n      description: workOrder.description || \"\",\n      isActive: workOrder.isActive ?? true,\n      availableWorkTypes: workOrder.availableWorkTypes || [],\n      availableMaterials: workOrder.availableMaterials || [],\n    });\n    setEditWorkOrderDialogOpen(true);\n  };\n\n  const handleUpdateWorkOrder = (data: AddWorkOrderForm) => {\n    if (selectedWorkOrderToEdit) {\n      updateWorkOrderMutation.mutate({\n        workOrderId: selectedWorkOrderToEdit.id,\n        data\n      });\n    }\n  };\n\n  const handleDeleteWorkOrder = (workOrder: any) => {\n    setSelectedWorkOrderToDelete(workOrder);\n    setDeleteWorkOrderDialogOpen(true);\n  };\n\n  const confirmDeleteWorkOrder = () => {\n    if (selectedWorkOrderToDelete) {\n      deleteWorkOrderMutation.mutate(selectedWorkOrderToDelete.id);\n    }\n  };\n\n  const handleDeleteClient = async (client: any) => {\n    setSelectedClientToDelete(client);\n\n    // Fetch work orders and operations count\n    try {\n      const [workOrdersResponse, operationsResponse] = await Promise.all([\n        fetch(`/api/clients/${client.id}/work-orders/count`),\n        fetch(`/api/clients/${client.id}/operations/count`)\n      ]);\n      const workOrdersData = await workOrdersResponse.json();\n      const operationsData = await operationsResponse.json();\n      setClientWorkOrdersCount(workOrdersData.count || 0);\n      setClientOperationsCount(operationsData.count || 0);\n    } catch (error) {\n      console.error(\"Error fetching client counts:\", error);\n      setClientWorkOrdersCount(0);\n      setClientOperationsCount(0);\n    }\n\n    setDeleteClientDialogOpen(true);\n  };\n\n  const confirmDeleteClient = () => {\n    if (selectedClientToDelete) {\n      deleteClientMutation.mutate(selectedClientToDelete.id);\n    }\n  };\n\n  const confirmDeleteReport = () => {\n    if (selectedReportToDelete) {\n      deleteReportMutation.mutate(selectedReportToDelete.id);\n    }\n  };\n\n  const handleResetPassword = (employee: any) => {\n    setSelectedEmployee(employee);\n    setNewPassword(\"\");\n    setResetPasswordDialogOpen(true);\n  };\n\n  const confirmResetPassword = () => {\n    if (selectedEmployee && newPassword.trim().length >= 6) {\n      resetPasswordMutation.mutate({\n        employeeId: selectedEmployee.id,\n        newPassword: newPassword.trim()\n      });\n    }\n  };\n\n  // Mutations for Work Types\n  const createWorkTypeMutation = useMutation({\n    mutationFn: async (data: WorkTypeForm) => {\n      return apiRequest('POST', '/api/work-types', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/work-types'] });\n      toast({\n        title: \"Lavorazione aggiunta\",\n        description: \"La nuova lavorazione è stata aggiunta con successo.\",\n      });\n      workTypeForm.reset();\n      setAddWorkTypeDialogOpen(false);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'aggiunta della lavorazione.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateWorkTypeMutation = useMutation({\n    mutationFn: async (data: WorkTypeForm & { id: string }) => {\n      const { id, ...updateData } = data;\n      return apiRequest('PATCH', `/api/work-types/${id}`, updateData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/work-types'] });\n      toast({\n        title: \"Lavorazione aggiornata\",\n        description: \"La lavorazione è stata aggiornata con successo.\",\n      });\n      workTypeForm.reset();\n      setEditWorkTypeDialogOpen(false);\n      setSelectedWorkType(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'aggiornamento della lavorazione.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteWorkTypeMutation = useMutation({\n    mutationFn: async (workTypeId: string) => {\n      return apiRequest('DELETE', `/api/work-types/${workTypeId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/work-types'] });\n      toast({\n        title: \"Lavorazione eliminata\",\n        description: \"La lavorazione è stata eliminata con successo.\",\n      });\n      setDeleteWorkTypeDialogOpen(false);\n      setSelectedWorkType(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'eliminazione della lavorazione.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutations for Materials\n  const createMaterialMutation = useMutation({\n    mutationFn: async (data: MaterialForm) => {\n      return apiRequest('POST', '/api/materials', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/materials'] });\n      toast({\n        title: \"Materiale aggiunto\",\n        description: \"Il nuovo materiale è stato aggiunto con successo.\",\n      });\n      materialForm.reset();\n      setAddMaterialDialogOpen(false);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'aggiunta del materiale.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMaterialMutation = useMutation({\n    mutationFn: async (data: MaterialForm & { id: string }) => {\n      const { id, ...updateData } = data;\n      return apiRequest('PATCH', `/api/materials/${id}`, updateData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/materials'] });\n      toast({\n        title: \"Materiale aggiornato\",\n        description: \"Il materiale è stato aggiornato con successo.\",\n      });\n      materialForm.reset();\n      setEditMaterialDialogOpen(false);\n      setSelectedMaterial(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'aggiornamento del materiale.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMaterialMutation = useMutation({\n    mutationFn: async (materialId: string) => {\n      return apiRequest('DELETE', `/api/materials/${materialId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/materials'] });\n      toast({\n        title: \"Materiale eliminato\",\n        description: \"Il materiale è stato eliminato con successo.\",\n      });\n      setDeleteMaterialDialogOpen(false);\n      setSelectedMaterial(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'eliminazione del materiale.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation per registrare assenze\n  const registerAbsenceMutation = useMutation({\n    mutationFn: async (data: RegisterAbsenceForm) => {\n      // Crea una assenza per ogni userId selezionato\n      const promises = data.userIds.map(userId => \n        apiRequest('POST', '/api/attendance-entries', {\n          userId,\n          date: data.date,\n          absenceType: data.absenceType,\n          notes: data.notes || \"\",\n        })\n      );\n      return Promise.all(promises);\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/attendance-entries'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/attendance/monthly'] });\n      toast({\n        title: \"Assenze registrate\",\n        description: `${variables.userIds.length} assenza/e registrata/e con successo.`,\n      });\n      registerAbsenceForm.reset({\n        date: new Date().toISOString().split('T')[0],\n        userIds: [],\n        absenceType: \"\",\n        notes: \"\",\n      });\n      setSelectedUserIds([]);\n      setRegisterAbsenceDialogOpen(false);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante la registrazione delle assenze.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Quick-add mutations for work order dialog\n  const quickAddWorkTypeMutation = useMutation({\n    mutationFn: async (data: WorkTypeForm) => {\n      return apiRequest('POST', '/api/work-types', data);\n    },\n    onMutate: async (newWorkType: WorkTypeForm) => {\n      // Cancel any outgoing refetches to avoid overwriting optimistic update\n      await queryClient.cancelQueries({ queryKey: ['/api/work-types'] });\n\n      // Snapshot the previous value for rollback\n      const previousWorkTypes = queryClient.getQueryData(['/api/work-types']);\n\n      // Optimistically update the cache with a temporary ID\n      const optimisticWorkType = {\n        id: `temp-${Date.now()}`,\n        name: newWorkType.name,\n        description: newWorkType.description || \"\",\n        isActive: true,\n      };\n\n      queryClient.setQueryData(['/api/work-types'], (old: any) => {\n        return old ? [...old, optimisticWorkType] : [optimisticWorkType];\n      });\n\n      // Auto-select the newly created work type in both forms immediately using the temp ID\n      const currentWorkTypes = workOrderForm.getValues('availableWorkTypes') || [];\n      workOrderForm.setValue('availableWorkTypes', [...currentWorkTypes, optimisticWorkType.id]);\n\n      const currentEditWorkTypes = editWorkOrderForm.getValues('availableWorkTypes') || [];\n      editWorkOrderForm.setValue('availableWorkTypes', [...currentEditWorkTypes, optimisticWorkType.id]);\n\n      // Return context for rollback\n      return { previousWorkTypes, tempId: optimisticWorkType.id };\n    },\n    onSuccess: async (response: any, newWorkType: WorkTypeForm, context: any) => {\n      // Get the real ID from the response\n      const realId = response.id;\n      \n      // Replace temp ID with real ID in both forms\n      if (context?.tempId && realId) {\n        const currentWorkTypes = workOrderForm.getValues('availableWorkTypes') || [];\n        workOrderForm.setValue('availableWorkTypes', currentWorkTypes.map((id: string) => id === context.tempId ? realId : id));\n\n        const currentEditWorkTypes = editWorkOrderForm.getValues('availableWorkTypes') || [];\n        editWorkOrderForm.setValue('availableWorkTypes', currentEditWorkTypes.map((id: string) => id === context.tempId ? realId : id));\n      }\n      \n      // Refetch to get the real data from server\n      queryClient.invalidateQueries({ queryKey: ['/api/work-types'] });\n      toast({\n        title: \"Lavorazione aggiunta\",\n        description: \"La nuova lavorazione è stata aggiunta con successo.\",\n      });\n\n      // Reset quick-add form\n      setQuickAddWorkTypeName(\"\");\n      setShowQuickAddWorkType(false);\n    },\n    onError: (error: any, newWorkType: WorkTypeForm, context: any) => {\n      // Rollback optimistic update\n      if (context?.previousWorkTypes) {\n        queryClient.setQueryData(['/api/work-types'], context.previousWorkTypes);\n      }\n\n      // Remove temp ID from form selections\n      if (context?.tempId) {\n        const currentWorkTypes = workOrderForm.getValues('availableWorkTypes') || [];\n        workOrderForm.setValue('availableWorkTypes', currentWorkTypes.filter((id: string) => id !== context.tempId));\n\n        const currentEditWorkTypes = editWorkOrderForm.getValues('availableWorkTypes') || [];\n        editWorkOrderForm.setValue('availableWorkTypes', currentEditWorkTypes.filter((id: string) => id !== context.tempId));\n      }\n\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'aggiunta della lavorazione.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const quickAddMaterialMutation = useMutation({\n    mutationFn: async (data: MaterialForm) => {\n      return apiRequest('POST', '/api/materials', data);\n    },\n    onMutate: async (newMaterial: MaterialForm) => {\n      // Cancel any outgoing refetches to avoid overwriting optimistic update\n      await queryClient.cancelQueries({ queryKey: ['/api/materials'] });\n\n      // Snapshot the previous value for rollback\n      const previousMaterials = queryClient.getQueryData(['/api/materials']);\n\n      // Optimistically update the cache with a temporary ID\n      const optimisticMaterial = {\n        id: `temp-${Date.now()}`,\n        name: newMaterial.name,\n        description: newMaterial.description || \"\",\n        isActive: true,\n      };\n\n      queryClient.setQueryData(['/api/materials'], (old: any) => {\n        return old ? [...old, optimisticMaterial] : [optimisticMaterial];\n      });\n\n      // Auto-select the newly created material in both forms immediately using the temp ID\n      const currentMaterials = workOrderForm.getValues('availableMaterials') || [];\n      workOrderForm.setValue('availableMaterials', [...currentMaterials, optimisticMaterial.id]);\n\n      const currentEditMaterials = editWorkOrderForm.getValues('availableMaterials') || [];\n      editWorkOrderForm.setValue('availableMaterials', [...currentEditMaterials, optimisticMaterial.id]);\n\n      // Return context for rollback\n      return { previousMaterials, tempId: optimisticMaterial.id };\n    },\n    onSuccess: async (response: any, newMaterial: MaterialForm, context: any) => {\n      // Get the real ID from the response\n      const realId = response.id;\n      \n      // Replace temp ID with real ID in both forms\n      if (context?.tempId && realId) {\n        const currentMaterials = workOrderForm.getValues('availableMaterials') || [];\n        workOrderForm.setValue('availableMaterials', currentMaterials.map((id: string) => id === context.tempId ? realId : id));\n\n        const currentEditMaterials = editWorkOrderForm.getValues('availableMaterials') || [];\n        editWorkOrderForm.setValue('availableMaterials', currentEditMaterials.map((id: string) => id === context.tempId ? realId : id));\n      }\n      \n      // Refetch to get the real data from server\n      queryClient.invalidateQueries({ queryKey: ['/api/materials'] });\n      toast({\n        title: \"Materiale aggiunto\",\n        description: \"Il nuovo materiale è stato aggiunto con successo.\",\n      });\n\n      // Reset quick-add form\n      setQuickAddMaterialName(\"\");\n      setShowQuickAddMaterial(false);\n    },\n    onError: (error: any, newMaterial: MaterialForm, context: any) => {\n      // Rollback optimistic update\n      if (context?.previousMaterials) {\n        queryClient.setQueryData(['/api/materials'], context.previousMaterials);\n      }\n\n      // Remove temp ID from form selections\n      if (context?.tempId) {\n        const currentMaterials = workOrderForm.getValues('availableMaterials') || [];\n        workOrderForm.setValue('availableMaterials', currentMaterials.filter((id: string) => id !== context.tempId));\n\n        const currentEditMaterials = editWorkOrderForm.getValues('availableMaterials') || [];\n        editWorkOrderForm.setValue('availableMaterials', currentEditMaterials.filter((id: string) => id !== context.tempId));\n      }\n\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore durante l'aggiunta del materiale.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Handlers for Work Types\n  const handleAddWorkType = (data: WorkTypeForm) => {\n    createWorkTypeMutation.mutate(data);\n  };\n\n  const handleEditWorkType = (workType: any) => {\n    setSelectedWorkType(workType);\n    workTypeForm.reset({\n      name: workType.name,\n      description: workType.description || \"\",\n      isActive: workType.isActive,\n    });\n    setEditWorkTypeDialogOpen(true);\n  };\n\n  const handleUpdateWorkType = (data: WorkTypeForm) => {\n    if (selectedWorkType) {\n      updateWorkTypeMutation.mutate({ ...data, id: selectedWorkType.id });\n    }\n  };\n\n  const handleDeleteWorkType = (workType: any) => {\n    setSelectedWorkType(workType);\n    setDeleteWorkTypeDialogOpen(true);\n  };\n\n  const confirmDeleteWorkType = () => {\n    if (selectedWorkType) {\n      deleteWorkTypeMutation.mutate(selectedWorkType.id);\n    }\n  };\n\n  // Handlers for Materials\n  const handleAddMaterial = (data: MaterialForm) => {\n    createMaterialMutation.mutate(data);\n  };\n\n  const handleEditMaterial = (material: any) => {\n    setSelectedMaterial(material);\n    materialForm.reset({\n      name: material.name,\n      description: material.description || \"\",\n      isActive: material.isActive,\n    });\n    setEditMaterialDialogOpen(true);\n  };\n\n  const handleUpdateMaterial = (data: MaterialForm) => {\n    if (selectedMaterial) {\n      updateMaterialMutation.mutate({ ...data, id: selectedMaterial.id });\n    }\n  };\n\n  const handleDeleteMaterial = (material: any) => {\n    setSelectedMaterial(material);\n    setDeleteMaterialDialogOpen(true);\n  };\n\n  const confirmDeleteMaterial = () => {\n    if (selectedMaterial) {\n      deleteMaterialMutation.mutate(selectedMaterial.id);\n    }\n  };\n\n  // Handlers for quick-add functionality\n  const handleQuickAddWorkType = () => {\n    if (quickAddWorkTypeName.trim().length >= 2) {\n      quickAddWorkTypeMutation.mutate({\n        name: quickAddWorkTypeName.trim(),\n        isActive: true,\n      });\n    }\n  };\n\n  const handleQuickAddMaterial = () => {\n    if (quickAddMaterialName.trim().length >= 2) {\n      quickAddMaterialMutation.mutate({\n        name: quickAddMaterialName.trim(),\n        isActive: true,\n      });\n    }\n  };\n\n  const filteredReports = (reports as any[])\n    .filter((report: any) => {\n      const employeeName = report.employeeName || report.employee || \"\";\n      const matchesSearch = employeeName.toLowerCase().includes(searchTerm.toLowerCase());\n      const matchesStatus = statusFilter === \"all\" || report.status === statusFilter;\n\n      // Filtro intervallo date\n      let matchesDate = true;\n      if (fromDate || toDate) {\n        const reportDate = new Date(report.date);\n        reportDate.setHours(0, 0, 0, 0);\n\n        if (fromDate && toDate) {\n          const from = new Date(fromDate);\n          const to = new Date(toDate);\n          from.setHours(0, 0, 0, 0);\n          to.setHours(23, 59, 59, 999);\n          matchesDate = reportDate >= from && reportDate <= to;\n        } else if (fromDate) {\n          const from = new Date(fromDate);\n          from.setHours(0, 0, 0, 0);\n          matchesDate = reportDate >= from;\n        } else if (toDate) {\n          const to = new Date(toDate);\n          to.setHours(23, 59, 59, 999);\n          matchesDate = reportDate <= to;\n        }\n      }\n\n      return matchesSearch && matchesStatus && matchesDate;\n    })\n    .sort((a: any, b: any) => {\n      // Prima ordina per data (più recente prima)\n      const dateA = new Date(a.date).getTime();\n      const dateB = new Date(b.date).getTime();\n\n      if (dateA !== dateB) {\n        return dateB - dateA; // Data più recente prima\n      }\n\n      // A parità di data, ordina per stato (In attesa prima di Approvato)\n      if (a.status === \"In attesa\" && b.status === \"Approvato\") {\n        return -1; // a viene prima\n      }\n      if (a.status === \"Approvato\" && b.status === \"In attesa\") {\n        return 1; // b viene prima\n      }\n\n      return 0; // Stesso stato\n    });\n\n  // Mutation per approvare rapportino\n  const approveReportMutation = useMutation({\n    mutationFn: async (reportId: string) => {\n      return apiRequest('PATCH', `/api/daily-reports/${reportId}/approve`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/daily-reports'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/work-orders/stats'] });\n      toast({\n        title: \"Rapportino approvato\",\n        description: \"Il rapportino è stato approvato con successo.\"\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore nell'approvazione del rapportino\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  // Mutation per cambiare data rapportino\n  const changeDateMutation = useMutation({\n    mutationFn: async ({ reportId, newDate }: { reportId: string; newDate: string }) => {\n      return apiRequest('PATCH', `/api/daily-reports/${reportId}/change-date`, { newDate });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/daily-reports'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/work-orders/stats'] });\n      toast({\n        title: \"Data modificata\",\n        description: \"La data del rapportino è stata modificata con successo.\"\n      });\n      setChangeDateDialogOpen(false);\n      setSelectedReportToChangeDate(null);\n      setNewReportDate(\"\");\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Impossibile modificare la data del rapportino\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  // Mutation per eliminare rapportino\n  const deleteReportMutation = useMutation({\n    mutationFn: async (reportId: string) => {\n      return apiRequest('DELETE', `/api/daily-reports/${reportId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/daily-reports'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/work-orders/stats'] });\n      toast({\n        title: \"Rapportino eliminato\",\n        description: \"Il rapportino è stato eliminato con successo.\"\n      });\n      setDeleteReportDialogOpen(false);\n      setSelectedReportToDelete(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Errore nell'eliminazione del rapportino\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  const handleApproveReport = (reportId: string) => {\n    approveReportMutation.mutate(reportId);\n  };\n\n  // Mutation per recuperare singolo rapportino con operazioni\n  const fetchReportMutation = useMutation({\n    mutationFn: async (reportId: string) => {\n      const response = await apiRequest('GET', `/api/daily-reports/${reportId}`);\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setSelectedReport(data);\n      setReportOperations(data.operations || []);\n      setEditReportDialogOpen(true);\n    },\n    onError: (error: any) => {\n      console.error(\"Error fetching report:\", error);\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile caricare il rapportino\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation per aggiornare rapportino\n  const updateReportMutation = useMutation({\n    mutationFn: async ({ reportId, operations }: { reportId: string; operations: any[] }) => {\n      const response = await apiRequest('PUT', `/api/daily-reports/${reportId}`, {\n        operations\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/daily-reports'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/work-orders/stats'] });\n      setEditReportDialogOpen(false);\n      setSelectedReport(null);\n      setReportOperations([]);\n      toast({\n        title: \"Rapportino aggiornato\",\n        description: \"Il rapportino è stato aggiornato con successo.\",\n      });\n    },\n    onError: (error: any) => {\n      console.error(\"Error updating report:\", error);\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile aggiornare il rapportino\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleEditReport = (reportId: string) => {\n    fetchReportMutation.mutate(reportId);\n  };\n\n  const handleUpdateReport = (operations: any[]) => {\n    if (selectedReport) {\n      updateReportMutation.mutate({\n        reportId: selectedReport.id,\n        operations\n      });\n    }\n  };\n\n  // Mutation per espandere e recuperare dettagli rapportino\n  const fetchReportDetailsMutation = useMutation({\n    mutationFn: async (reportId: string) => {\n      const response = await apiRequest('GET', `/api/daily-reports/${reportId}`);\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setExpandedReportData(data);\n    },\n    onError: (error: any) => {\n      console.error(\"Error fetching report details:\", error);\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile caricare i dettagli del rapportino\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleToggleReportExpansion = (reportId: string) => {\n    if (expandedReportId === reportId) {\n      // Collassa se già espanso\n      setExpandedReportId(null);\n      setExpandedReportData(null);\n    } else {\n      // Espandi e carica i dettagli\n      setExpandedReportId(reportId);\n      fetchReportDetailsMutation.mutate(reportId);\n    }\n  };\n\n  const handleExportReports = async (selectedDate?: string) => {\n    try {\n      const exportDate = selectedDate || new Date().toISOString().split('T')[0]; // YYYY-MM-DD format\n      const response = await fetch(`/api/export/daily-reports/${exportDate}`);\n\n      if (response.ok) {\n        const blob = await response.blob();\n        const url = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `Rapportini_${exportDate}.docx`;\n        document.body.appendChild(a);\n        a.click();\n        window.URL.revokeObjectURL(url);\n        document.body.removeChild(a);\n        console.log(\"Word export completed\");\n      } else {\n        const error = await response.json();\n        throw new Error(error.error || \"Failed to export Word document\");\n      }\n    } catch (error) {\n      console.error(\"Error exporting Word document:\", error);\n      if (error instanceof Error) {\n        toast({\n          title: \"Esportazione non riuscita\",\n          description: error.message || \"Errore nell'esportazione del documento Word\",\n          variant: \"destructive\"\n        });\n      } else {\n        toast({\n          title: \"Errore\",\n          description: \"Errore nell'esportazione del documento Word\",\n          variant: \"destructive\"\n        });\n      }\n    }\n  };\n\n  const handleExportFilteredReportsTxt = async () => {\n    try {\n      // Build URL with parameters for date range\n      let url = '/api/export/daily-reports-txt-range';\n      const params = new URLSearchParams();\n\n      if (fromDate) params.append('from', fromDate);\n      if (toDate) params.append('to', toDate);\n      if (statusFilter && statusFilter !== 'all') params.append('status', statusFilter);\n      if (searchTerm) params.append('search', searchTerm);\n\n      if (params.toString()) {\n        url += '?' + params.toString();\n      }\n\n      const response = await fetch(url);\n\n      if (response.ok) {\n        const blob = await response.blob();\n        const url_blob = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url_blob;\n\n        // Dynamic filename based on filters\n        let filename = 'Rapportini';\n        if (fromDate && toDate) {\n          filename += `_${fromDate}_${toDate}`;\n        } else if (fromDate) {\n          filename += `_da_${fromDate}`;\n        } else if (toDate) {\n          filename += `_fino_${toDate}`;\n        } else {\n          filename += `_${new Date().toISOString().split('T')[0]}`;\n        }\n        filename += '.txt';\n\n        a.download = filename;\n        document.body.appendChild(a);\n        a.click();\n        window.URL.revokeObjectURL(url_blob);\n        document.body.removeChild(a);\n        console.log(\"TXT export completed\");\n      } else {\n        const error = await response.json();\n        throw new Error(error.error || \"Failed to export TXT document\");\n      }\n    } catch (error) {\n      console.error(\"Error exporting TXT document:\", error);\n      if (error instanceof Error) {\n        toast({\n          title: \"Esportazione non riuscita\",\n          description: error.message || \"Errore nell'esportazione del documento TXT\",\n          variant: \"destructive\"\n        });\n      } else {\n        toast({\n          title: \"Errore\",\n          description: \"Errore nell'esportazione del documento TXT\",\n          variant: \"destructive\"\n        });\n      }\n    }\n  };\n\n  const handleExportFilteredReports = async () => {\n    try {\n      // Costruisci URL con parametri per intervallo di date\n      let url = '/api/export/daily-reports-range';\n      const params = new URLSearchParams();\n\n      if (fromDate) params.append('from', fromDate);\n      if (toDate) params.append('to', toDate);\n      if (statusFilter && statusFilter !== 'all') params.append('status', statusFilter);\n      if (searchTerm) params.append('search', searchTerm);\n\n      if (params.toString()) {\n        url += '?' + params.toString();\n      }\n\n      const response = await fetch(url);\n\n      if (response.ok) {\n        const blob = await response.blob();\n        const url_blob = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url_blob;\n\n        // Nome file dinamico basato sui filtri\n        let filename = 'Rapportini';\n        if (fromDate && toDate) {\n          filename += `_${fromDate}_${toDate}`;\n        } else if (fromDate) {\n          filename += `_da_${fromDate}`;\n        } else if (toDate) {\n          filename += `_fino_${toDate}`;\n        } else {\n          filename += `_${new Date().toISOString().split('T')[0]}`;\n        }\n        filename += '.docx';\n\n        a.download = filename;\n        document.body.appendChild(a);\n        a.click();\n        window.URL.revokeObjectURL(url_blob);\n        document.body.removeChild(a);\n        toast({\n          title: \"Esportazione completata\",\n          description: `${filteredReports.length} rapportini esportati`\n        });\n      } else {\n        const error = await response.json();\n        throw new Error(error.error || \"Failed to export Word document\");\n      }\n    } catch (error) {\n      console.error(\"Error exporting filtered reports:\", error);\n      if (error instanceof Error) {\n        toast({\n          title: \"Esportazione non riuscita\",\n          description: error.message || \"Errore nell'esportazione dei rapportini\",\n          variant: \"destructive\"\n        });\n      } else {\n        toast({\n          title: \"Errore\",\n          description: \"Errore nell'esportazione dei rapportini\",\n          variant: \"destructive\"\n        });\n      }\n    }\n  };\n\n  const totalPendingReports = (reports as any[]).filter((r: any) => r.status === \"In attesa\").length;\n  const totalOpenWorkOrders = (workOrders as any[]).filter((wo: any) => wo.isActive === true).length;\n\n  const handleViewWorkOrderReport = (operation: any) => {\n    setSelectedWorkOrder({\n      id: operation.workOrderId,\n      number: operation.workOrderNumber,\n      description: operation.workOrderDescription,\n      clientName: operation.clientName\n    });\n    setSelectedTab(\"work-orders\");\n  };\n\n  const handleBackToWorkOrders = () => {\n    setSelectedWorkOrder(null);\n  };\n\n  const handleSelectWorkOrder = (workOrder: any) => {\n    setSelectedWorkOrder({\n      id: workOrder.id,\n      number: workOrder.number,\n      description: workOrder.description,\n      clientName: workOrder.clientName\n    });\n  };\n\n  // Prepara dati commesse con statistiche aggregate\n  const workOrdersWithStats = workOrders.map((wo: any) => {\n    const client = clients.find((c: any) => c.id === wo.clientId);\n    const stats = workOrdersStats.find((s: any) => s.workOrderId === wo.id);\n\n    return {\n      ...wo,\n      clientName: client?.name || \"Cliente eliminato\",\n      totalHours: stats?.totalHours || 0,\n      totalOperations: stats?.totalOperations || 0,\n      lastActivity: stats?.lastActivity || \"Nessuna attività\",\n      status: wo.isActive ? \"In Corso\" : \"Completato\"\n    };\n  });\n\n  // Filtraggio commesse\n  const filteredWorkOrders = workOrdersWithStats.filter((workOrder: any) => {\n    // Filtro per stato\n    if (workOrderStatusFilter !== \"all\") {\n      const status = workOrder.status.toLowerCase().replace(\" \", \"-\");\n      if (status !== workOrderStatusFilter) {\n        return false;\n      }\n    }\n\n    // Filtro per data\n    if (workOrderDateFilter !== \"all\" && workOrder.lastActivity !== \"Nessuna attività\") {\n      const lastActivityDate = new Date(workOrder.lastActivity);\n      const today = new Date();\n      const daysDiff = Math.floor((today.getTime() - lastActivityDate.getTime()) / (1000 * 60 * 60 * 24));\n\n      if (workOrderDateFilter === \"last7days\" && daysDiff > 7) {\n        return false;\n      }\n      if (workOrderDateFilter === \"last30days\" && daysDiff > 30) {\n        return false;\n      }\n      if (workOrderDateFilter === \"last90days\" && daysDiff > 90) {\n        return false;\n      }\n    }\n\n    return true;\n  });\n\n  // Raggruppa commesse per cliente\n  const workOrdersByClient = filteredWorkOrders.reduce((acc: any, workOrder: any) => {\n    // Safety check: assicurati che clientName non sia mai undefined/null/empty\n    const clientName = workOrder.clientName || \"Cliente eliminato\";\n    if (!acc[clientName]) {\n      acc[clientName] = [];\n    }\n    acc[clientName].push(workOrder);\n    return acc;\n  }, {});\n\n  // Ordina i clienti alfabeticamente\n  const sortedClientNames = Object.keys(workOrdersByClient).sort((a, b) => a.localeCompare(b));\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Main Navigation */}\n      <Tabs value={mainSection} onValueChange={setMainSection}>\n        <TabsList className=\"grid w-full max-w-md grid-cols-2\">\n          <TabsTrigger value=\"rapportini\" data-testid=\"tab-main-rapportini\">\n            <FileText className=\"h-4 w-4 mr-2\" />\n            Rapportini\n          </TabsTrigger>\n          <TabsTrigger value=\"rifornimenti\" data-testid=\"tab-main-rifornimenti\">\n            <Package className=\"h-4 w-4 mr-2\" />\n            Rifornimenti\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"rapportini\" className=\"space-y-6 mt-6\">\n\n      {/* Statistics Cards */}\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Rapportini in Attesa</p>\n                <p className=\"text-2xl font-bold\">{totalPendingReports}</p>\n              </div>\n              <Clock className=\"h-8 w-8 text-warning\" />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Commesse Aperte</p>\n                <p className=\"text-2xl font-bold\">{totalOpenWorkOrders}</p>\n              </div>\n              <Wrench className=\"h-8 w-8 text-success\" />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">Dipendenti Attivi</p>\n                <p className=\"text-2xl font-bold\">\n                  {employees ? (employees as any[]).filter((emp: any) => emp.role === 'employee' && emp.isActive === true).length : 0}\n                </p>\n              </div>\n              <Users className=\"h-8 w-8 text-primary\" />\n            </div>\n          </CardContent>\n        </Card>\n\n      </div>\n\n      {/* Main Content Tabs */}\n      <Tabs value={selectedTab} onValueChange={setSelectedTab}>\n        <TabsList className=\"flex-wrap h-auto\">\n          <TabsTrigger value=\"reports\" data-testid=\"tab-reports\">\n            <FileText className=\"h-4 w-4 mr-2\" />\n            Rapportini\n          </TabsTrigger>\n          <TabsTrigger value=\"clients\" data-testid=\"tab-clients\">\n            <Building2 className=\"h-4 w-4 mr-2\" />\n            Clienti\n          </TabsTrigger>\n          <TabsTrigger value=\"work-orders\" data-testid=\"tab-work-orders\">\n            <Wrench className=\"h-4 w-4 mr-2\" />\n            Commesse\n          </TabsTrigger>\n          <TabsTrigger value=\"employees\" data-testid=\"tab-employees\">\n            <Users className=\"h-4 w-4 mr-2\" />\n            Dipendenti\n          </TabsTrigger>\n          <TabsTrigger value=\"work-types\" data-testid=\"tab-work-types\">\n            <Hammer className=\"h-4 w-4 mr-2\" />\n            Configurazione\n          </TabsTrigger>\n          <TabsTrigger value=\"attendance\" data-testid=\"tab-attendance\">\n            <ClipboardList className=\"h-4 w-4 mr-2\" />\n            Presenze\n          </TabsTrigger>\n          <TabsTrigger value=\"absence-stats\" data-testid=\"tab-absence-stats\">\n            <BarChart2 className=\"h-4 w-4 mr-2\" />\n            Statistiche Assenze\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Reports Tab */}\n        <TabsContent value=\"reports\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n                <div className=\"flex items-center gap-2 flex-wrap\">\n                  <CardTitle>Rapportini Giornalieri</CardTitle>\n                  <Button \n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => handleExportFilteredReports()}\n                    data-testid=\"button-export-filtered\"\n                  >\n                    <FileText className=\"h-4 w-4 mr-2\" />\n                    Esporta Word\n                  </Button>\n                  <Button \n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => handleExportFilteredReportsTxt()}\n                    data-testid=\"button-export-txt\"\n                  >\n                    <FileText className=\"h-4 w-4 mr-2\" />\n                    Esporta TXT\n                  </Button>\n                  <Button \n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => setMissingEmployeesDialogOpen(true)}\n                    data-testid=\"button-missing-employees\"\n                  >\n                    <Users className=\"h-4 w-4 mr-2\" />\n                    Dipendenti Mancanti\n                  </Button>\n                </div>\n                <Button \n                  onClick={() => setCreateReportDialogOpen(true)}\n                  data-testid=\"button-create-report\"\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Nuovo Rapportino\n                </Button>\n              </div>\n\n              {/* Filters */}\n              <div className=\"flex flex-col md:flex-row flex-wrap gap-4\">\n                <div className=\"w-[250px] relative\">\n                  <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Cerca dipendente...\"\n                    value={searchTerm}\n                    onChange={(e) => setSearchTerm(e.target.value)}\n                    className=\"pl-9\"\n                    data-testid=\"input-search-employee\"\n                  />\n                </div>\n\n                <Select value={statusFilter} onValueChange={setStatusFilter}>\n                  <SelectTrigger className=\"w-[200px]\" data-testid=\"select-status-filter\">\n                    <Filter className=\"h-4 w-4 mr-2\" />\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Tutti gli stati</SelectItem>\n                    <SelectItem value=\"In attesa\">In attesa</SelectItem>\n                    <SelectItem value=\"Approvato\">Confermato</SelectItem>\n                  </SelectContent>\n                </Select>\n\n                <div className=\"flex items-center gap-2 px-3 py-2 border rounded-md bg-background\">\n                  <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                  <span className=\"text-sm font-medium\">\n                    {showAllReports ? 'Tutti i rapportini' : 'Ultimi 7 giorni'}\n                  </span>\n                  <Switch\n                    checked={showAllReports}\n                    onCheckedChange={setShowAllReports}\n                    data-testid=\"switch-show-all-reports\"\n                  />\n                </div>\n\n                <div className=\"flex gap-2 items-center\">\n                  <div className=\"flex items-center gap-2\">\n                    <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      type=\"date\"\n                      value={fromDate}\n                      onChange={(e) => {\n                        setFromDate(e.target.value);\n                        setTimeout(() => {\n                          toDateInputRef.current?.focus();\n                        }, 0);\n                      }}\n                      placeholder=\"Da\"\n                      className=\"w-[135px]\"\n                      data-testid=\"input-from-date\"\n                    />\n                  </div>\n                  <span className=\"text-muted-foreground\">-</span>\n                  <Input\n                    ref={toDateInputRef}\n                    type=\"date\"\n                    value={toDate}\n                    onChange={(e) => {\n                      setToDate(e.target.value);\n                      setTimeout(() => {\n                        toDateInputRef.current?.blur();\n                      }, 0);\n                    }}\n                    placeholder=\"A\"\n                    className=\"w-[135px]\"\n                    data-testid=\"input-to-date\"\n                  />\n                </div>\n              </div>\n            </CardHeader>\n\n            <CardContent>\n              {isLoadingReports ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <div className=\"text-center\">\n                    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2\"></div>\n                    <p className=\"text-muted-foreground\">Caricamento rapportini...</p>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\" data-testid=\"scroll-table-reports\">\n                  <Table className=\"min-w-[480px] md:min-w-[820px]\">\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead className=\"w-12 hidden md:table-cell\"></TableHead>\n                        <TableHead>Dipendente</TableHead>\n                        <TableHead>Data</TableHead>\n                        <TableHead className=\"hidden md:table-cell\">Ora Creazione</TableHead>\n                        <TableHead>Stato</TableHead>\n                        <TableHead className=\"hidden md:table-cell\">Operazioni</TableHead>\n                        <TableHead className=\"hidden md:table-cell\">Ore Totali</TableHead>\n                        <TableHead>Azioni</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                    {filteredReports.length === 0 ? (\n                      <TableRow>\n                        <TableCell colSpan={8} className=\"text-center py-8\">\n                          <div className=\"text-muted-foreground\">\n                            {searchTerm || statusFilter !== \"all\" || fromDate || toDate\n                              ? \"Nessun rapportino trovato con i filtri applicati\" \n                              : \"Nessun rapportino disponibile\"}\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    ) : (\n                      filteredReports.map((report: any) => {\n                        const isExpanded = expandedReportId === report.id;\n                        const reportDetails = isExpanded ? expandedReportData : null;\n\n                        return (\n                          <Fragment key={report.id}>\n                            <TableRow \n                              className=\"cursor-pointer hover-elevate\"\n                              onClick={() => handleToggleReportExpansion(report.id)}\n                              data-testid={`row-report-${report.id}`}\n                            >\n                              <TableCell className=\"w-12 hidden md:table-cell\">\n                                {isExpanded ? (\n                                  <ChevronUp className=\"h-4 w-4\" />\n                                ) : (\n                                  <ChevronDown className=\"h-4 w-4\" />\n                                )}\n                              </TableCell>\n                              <TableCell className=\"font-medium\">\n                                <div className=\"flex items-center justify-between gap-2\">\n                                  <span>{report.employeeName || report.employee || \"Sconosciuto\"}</span>\n                                  <span className=\"md:hidden\">\n                                    {isExpanded ? (\n                                      <ChevronUp className=\"h-4 w-4 text-muted-foreground\" />\n                                    ) : (\n                                      <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\n                                    )}\n                                  </span>\n                                </div>\n                              </TableCell>\n                              <TableCell>\n                                {formatDateToItalian(report.date)}\n                              </TableCell>\n                              <TableCell className=\"hidden md:table-cell\">\n                                {report.createdAt ? new Date(report.createdAt).toLocaleTimeString(\"it-IT\", { \n                                  hour: '2-digit', \n                                  minute: '2-digit' \n                                }) : \"-\"}\n                              </TableCell>\n                              <TableCell>\n                                <StatusBadge status={report.status} />\n                              </TableCell>\n                              <TableCell className=\"hidden md:table-cell\">{report.operations || 0}</TableCell>\n                              <TableCell className=\"hidden md:table-cell\">{report.totalHours || 0}h</TableCell>\n                              <TableCell onClick={(e) => e.stopPropagation()}>\n                                <div className=\"flex gap-2\">\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => handleEditReport(report.id)}\n                                    data-testid={`button-edit-report-${report.id}`}\n                                  >\n                                    <Edit className=\"h-4 w-4\" />\n                                  </Button>\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => {\n                                      setSelectedReportToChangeDate(report);\n                                      setNewReportDate(report.date);\n                                      setChangeDateDialogOpen(true);\n                                    }}\n                                    data-testid={`button-change-date-${report.id}`}\n                                  >\n                                    <Calendar className=\"h-4 w-4\" />\n                                  </Button>\n                                  {report.status === \"In attesa\" && (\n                                    <Button\n                                      variant=\"default\"\n                                      size=\"sm\"\n                                      onClick={() => handleApproveReport(report.id)}\n                                      disabled={approveReportMutation.isPending}\n                                      data-testid={`button-approve-report-${report.id}`}\n                                    >\n                                      <CheckCircle className=\"h-4 w-4\" />\n                                    </Button>\n                                  )}\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => {\n                                      setSelectedReportToDelete(report);\n                                      setDeleteReportDialogOpen(true);\n                                    }}\n                                    data-testid={`button-delete-report-${report.id}`}\n                                  >\n                                    <Trash className=\"h-4 w-4\" />\n                                  </Button>\n                                </div>\n                              </TableCell>\n                            </TableRow>\n\n                            {/* Riga espandibile con dettagli operazioni */}\n                            {isExpanded && reportDetails && (\n                              <TableRow key={`${report.id}-details`}>\n                                <TableCell colSpan={8} className=\"bg-muted/30 p-6\">\n                                  {fetchReportDetailsMutation.isPending ? (\n                                    <div className=\"flex items-center justify-center py-4\">\n                                      <div className=\"animate-spin rounded-full h-6 w-6 border-b-2 border-primary\"></div>\n                                    </div>\n                                  ) : reportDetails.operations && reportDetails.operations.length > 0 ? (\n                                    <div className=\"space-y-4\">\n                                      {/* Info aggiuntive visibili solo su mobile */}\n                                      <div className=\"md:hidden bg-background rounded-md border p-3 space-y-2\">\n                                        <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                                          <div className=\"flex items-center gap-2\">\n                                            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                                            <span className=\"text-muted-foreground\">Ora creazione:</span>\n                                          </div>\n                                          <div className=\"font-medium\">\n                                            {report.createdAt ? new Date(report.createdAt).toLocaleTimeString(\"it-IT\", { \n                                              hour: '2-digit', \n                                              minute: '2-digit' \n                                            }) : \"-\"}\n                                          </div>\n                                          <div className=\"flex items-center gap-2\">\n                                            <ClipboardList className=\"h-4 w-4 text-muted-foreground\" />\n                                            <span className=\"text-muted-foreground\">Operazioni:</span>\n                                          </div>\n                                          <div className=\"font-medium\">{report.operations || 0}</div>\n                                          <div className=\"flex items-center gap-2\">\n                                            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                                            <span className=\"text-muted-foreground\">Ore totali:</span>\n                                          </div>\n                                          <div className=\"font-medium flex items-center gap-2\">\n                                            {report.totalHours || 0}h\n                                            <Button\n                                              size=\"icon\"\n                                              variant=\"ghost\"\n                                              className=\"h-6 w-6\"\n                                              onClick={async () => {\n                                                setSelectedReportForAdjustment(report.id);\n                                                try {\n                                                  const response = await fetch(`/api/hours-adjustment/${report.id}`);\n                                                  const data = await response.json();\n                                                  setCurrentHoursAdjustment(data);\n                                                } catch (error) {\n                                                  setCurrentHoursAdjustment(null);\n                                                }\n                                                setHoursAdjustmentDialogOpen(true);\n                                              }}\n                                              data-testid={`button-hours-adjustment-${report.id}`}\n                                            >\n                                              <Calculator className=\"h-4 w-4\" />\n                                            </Button>\n                                          </div>\n                                        </div>\n                                      </div>\n\n                                      <div className=\"font-medium text-sm flex items-center gap-2\">\n                                        <ClipboardList className=\"h-4 w-4\" />\n                                        Operazioni del Rapportino\n                                      </div>\n\n                                      <div className=\"grid gap-3\">\n                                        {reportDetails.operations.map((operation: any, index: number) => (\n                                          <div \n                                            key={operation.id} \n                                            className=\"bg-background rounded-md border p-4 space-y-2\"\n                                            data-testid={`operation-${index}`}\n                                          >\n                                            <div className=\"flex items-start justify-between gap-4\">\n                                              <div className=\"flex-1 space-y-2\">\n                                                <div className=\"flex items-center gap-2 flex-wrap\">\n                                                  <Badge variant=\"outline\" className=\"gap-1\">\n                                                    <Building2 className=\"h-3 w-3\" />\n                                                    {operation.clientName || \"Cliente non specificato\"}\n                                                  </Badge>\n                                                  <Badge variant=\"outline\" className=\"gap-1\">\n                                                    <Briefcase className=\"h-3 w-3\" />\n                                                    {operation.workOrderName || \"Commessa non specificata\"}\n                                                  </Badge>\n                                                  <Badge variant=\"secondary\" className=\"gap-1\">\n                                                    <Clock className=\"h-3 w-3\" />\n                                                    {operation.hours}h\n                                                  </Badge>\n                                                </div>\n\n                                                {operation.workTypes && operation.workTypes.length > 0 && (\n                                                  <div className=\"flex items-center gap-2 flex-wrap\">\n                                                    <span className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                                                      <Wrench className=\"h-3 w-3\" />\n                                                      Tipi lavoro:\n                                                    </span>\n                                                    {operation.workTypes.map((type: string, idx: number) => (\n                                                      <Badge key={idx} variant=\"secondary\" className=\"text-xs\">\n                                                        {getWorkTypeName(type)}\n                                                      </Badge>\n                                                    ))}\n                                                  </div>\n                                                )}\n\n                                                {operation.materials && operation.materials.length > 0 && (\n                                                  <div className=\"flex items-center gap-2 flex-wrap\">\n                                                    <span className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                                                      <Package className=\"h-3 w-3\" />\n                                                      Materiali:\n                                                    </span>\n                                                    {operation.materials.map((material: string, idx: number) => (\n                                                      <Badge key={idx} variant=\"outline\" className=\"text-xs\">\n                                                        {getMaterialName(material)}\n                                                      </Badge>\n                                                    ))}\n                                                  </div>\n                                                )}\n\n                                                {operation.notes && (\n                                                  <div className=\"text-sm text-muted-foreground pt-1 border-t\">\n                                                    <span className=\"font-medium\">Note operazione:</span> {operation.notes}\n                                                  </div>\n                                                )}\n\n                                                {operation.photos && operation.photos.length > 0 && (\n                                                  <div className=\"pt-2 border-t\">\n                                                    <span className=\"text-xs text-muted-foreground font-medium flex items-center gap-1 mb-2\">\n                                                      <Camera className=\"h-3 w-3\" />\n                                                      Foto allegate:\n                                                    </span>\n                                                    <div className=\"flex flex-wrap gap-2\">\n                                                      {operation.photos.map((photoPath: string, idx: number) => (\n                                                        <img \n                                                          key={idx}\n                                                          src={photoPath.startsWith('http') ? photoPath : `/objects/${encodeURIComponent(photoPath)}`}\n                                                          alt={`Foto ${idx + 1}`} \n                                                          className=\"w-20 h-20 object-cover rounded-md border\"\n                                                          data-testid={`operation-photo-${index}-${idx}`}\n                                                        />\n                                                      ))}\n                                                    </div>\n                                                  </div>\n                                                )}\n                                              </div>\n                                            </div>\n                                          </div>\n                                        ))}\n                                      </div>\n\n                                      {reportDetails.notes && (\n                                        <div className=\"mt-4 p-4 bg-background rounded-md border\">\n                                          <div className=\"flex items-center gap-2 mb-2\">\n                                            <FileText className=\"h-4 w-4 text-muted-foreground\" />\n                                            <span className=\"font-medium text-sm\">Note Rapportino</span>\n                                          </div>\n                                          <p className=\"text-sm text-muted-foreground\">{reportDetails.notes}</p>\n                                        </div>\n                                      )}\n                                    </div>\n                                  ) : (\n                                    <div className=\"text-center text-muted-foreground py-4\">\n                                      Nessuna operazione registrata\n                                    </div>\n                                  )}\n                                </TableCell>\n                              </TableRow>\n                            )}\n                          </Fragment>\n                        );\n                      })\n                    )}\n                  </TableBody>\n                </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n\n        {/* Work Orders Tab - LAYOUT SISTEMATO */}\n        <TabsContent value=\"work-orders\" className=\"space-y-4\">\n          {selectedWorkOrder ? (\n            <WorkOrderReport\n              workOrderId={selectedWorkOrder.id}\n              workOrderNumber={selectedWorkOrder.number}\n              workOrderDescription={selectedWorkOrder.description}\n              clientName={selectedWorkOrder.clientName}\n              onBack={handleBackToWorkOrders}\n            />\n          ) : (\n            <Card>\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle>Gestione Commesse</CardTitle>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Seleziona una commessa per visualizzare il report dettagliato\n                    </p>\n                  </div>\n                  <Button onClick={() => setAddWorkOrderDialogOpen(true)} data-testid=\"button-add-workorder\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Nuova Commessa\n                  </Button>\n                </div>\n\n                {/* Filtri per commesse */}\n                <div className=\"flex flex-col sm:flex-row flex-wrap gap-4 mt-4\">\n                  <div className=\"flex-1\">\n                    <Label htmlFor=\"status-filter\" className=\"text-sm mb-2 block\">Stato</Label>\n                    <Select\n                      value={workOrderStatusFilter}\n                      onValueChange={setWorkOrderStatusFilter}\n                    >\n                      <SelectTrigger id=\"status-filter\" data-testid=\"select-workorder-status-filter\">\n                        <SelectValue placeholder=\"Tutti\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"all\">Tutti</SelectItem>\n                        <SelectItem value=\"in-corso\">In Corso</SelectItem>\n                        <SelectItem value=\"completato\">Completato</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"flex-1\">\n                    <Label htmlFor=\"date-filter\" className=\"text-sm mb-2 block\">Periodo</Label>\n                    <Select\n                      value={workOrderDateFilter}\n                      onValueChange={setWorkOrderDateFilter}\n                    >\n                      <SelectTrigger id=\"date-filter\" data-testid=\"select-workorder-date-filter\">\n                        <SelectValue placeholder=\"Tutte\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"all\">Tutte</SelectItem>\n                        <SelectItem value=\"last7days\">Ultimi 7 giorni</SelectItem>\n                        <SelectItem value=\"last30days\">Ultimi 30 giorni</SelectItem>\n                        <SelectItem value=\"last90days\">Ultimi 90 giorni</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                {filteredWorkOrders.length === 0 ? (\n                  <div className=\"text-center text-muted-foreground py-8\">\n                    Nessuna commessa trovata con i filtri selezionati\n                  </div>\n                ) : (\n                  <div className=\"space-y-6\" data-testid=\"scroll-table-workorders\">\n                    {sortedClientNames.map((clientName) => (\n                      <div key={clientName} className=\"space-y-3\">\n                        {/* Intestazione Cliente */}\n                        <div className=\"flex items-center gap-2 pb-2 border-b-2 border-primary\">\n                          <Building2 className=\"h-5 w-5 text-primary\" />\n                          <h3 className=\"text-lg font-semibold text-primary\">{clientName}</h3>\n                          <Badge variant=\"outline\" className=\"ml-2\">\n                            {workOrdersByClient[clientName].length} {workOrdersByClient[clientName].length === 1 ? 'commessa' : 'commesse'}\n                          </Badge>\n                        </div>\n\n                        {/* Tabella Commesse del Cliente - LAYOUT MIGLIORATO */}\n                        <div className=\"overflow-x-auto\">\n                          <Table>\n                            <TableHeader>\n                              <TableRow>\n                                <TableHead className=\"w-[35%]\">Nome Commessa</TableHead>\n                                <TableHead className=\"w-[150px]\">Stato</TableHead>\n                                <TableHead className=\"w-[100px] text-right\">Ore</TableHead>\n                                <TableHead className=\"w-[180px]\">Ultima Attività</TableHead>\n                                <TableHead className=\"w-[280px] text-right\">Azioni</TableHead>\n                              </TableRow>\n                            </TableHeader>\n                            <TableBody>\n                              {workOrdersByClient[clientName].map((workOrder: any) => (\n                                <TableRow key={workOrder.id}>\n                                  <TableCell className=\"font-medium\">\n                                    <div className=\"truncate max-w-[300px]\" title={workOrder.name}>\n                                      {workOrder.name}\n                                    </div>\n                                  </TableCell>\n                                  <TableCell>\n                                    <Select\n                                      value={workOrder.isActive ? \"in-corso\" : \"completato\"}\n                                      onValueChange={(value) => {\n                                        const isActive = value === \"in-corso\";\n                                        updateWorkOrderStatusMutation.mutate({ workOrderId: workOrder.id, isActive });\n                                      }}\n                                      disabled={updateWorkOrderStatusMutation.isPending}\n                                    >\n                                      <SelectTrigger \n                                        className=\"w-[130px]\" \n                                        data-testid={`select-workorder-status-${workOrder.id}`}\n                                      >\n                                        <SelectValue />\n                                      </SelectTrigger>\n                                      <SelectContent>\n                                        <SelectItem value=\"in-corso\">In Corso</SelectItem>\n                                        <SelectItem value=\"completato\">Completato</SelectItem>\n                                      </SelectContent>\n                                    </Select>\n                                  </TableCell>\n                                  <TableCell className=\"text-right font-medium tabular-nums\">\n                                    {workOrder.totalHours}h\n                                  </TableCell>\n                                  <TableCell className=\"text-sm text-muted-foreground\">\n                                    {workOrder.lastActivity === \"Nessuna attività\" \n                                      ? workOrder.lastActivity \n                                      : formatDateToItalian(workOrder.lastActivity)}\n                                  </TableCell>\n                                  <TableCell>\n                                    <div className=\"flex gap-2 justify-end\">\n                                      <Button\n                                        variant=\"outline\"\n                                        size=\"sm\"\n                                        onClick={() => handleSelectWorkOrder(workOrder)}\n                                        data-testid={`button-view-workorder-${workOrder.id}`}\n                                      >\n                                        <Eye className=\"h-4 w-4 mr-2\" />\n                                        Visualizza\n                                      </Button>\n                                      <Button\n                                        variant=\"outline\"\n                                        size=\"sm\"\n                                        onClick={() => handleEditWorkOrder(workOrder)}\n                                        data-testid={`button-edit-workorder-${workOrder.id}`}\n                                      >\n                                        <Edit className=\"h-4 w-4\" />\n                                      </Button>\n                                      <Button\n                                        variant=\"outline\"\n                                        size=\"sm\"\n                                        onClick={() => handleDeleteWorkOrder(workOrder)}\n                                        data-testid={`button-delete-workorder-${workOrder.id}`}\n                                      >\n                                        <Trash className=\"h-4 w-4\" />\n                                      </Button>\n                                    </div>\n                                  </TableCell>\n                                </TableRow>\n                              ))}\n                            </TableBody>\n                          </Table>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          )}\n        </TabsContent>\n\n        {/* Clients Tab */}\n        <TabsContent value=\"clients\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle>Gestione Clienti</CardTitle>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Visualizza e gestisci tutti i clienti. L'eliminazione di un cliente non eliminerà le commesse associate.\n                  </p>\n                </div>\n                <Button onClick={() => setAddClientDialogOpen(true)} data-testid=\"button-add-client\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Nuovo Cliente\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"overflow-x-auto\" data-testid=\"scroll-table-clients\">\n                <Table className=\"min-w-[640px]\">\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Nome Cliente</TableHead>\n                      <TableHead>Commesse Attive</TableHead>\n                      <TableHead>Commesse Totali</TableHead>\n                      <TableHead>Azioni</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                  {isLoadingClients ? (\n                    <TableRow>\n                      <TableCell colSpan={4} className=\"text-center py-8\">\n                        Caricamento...\n                      </TableCell>\n                    </TableRow>\n                  ) : (clients as any[]).length === 0 ? (\n                    <TableRow>\n                      <TableCell colSpan={4} className=\"text-center text-muted-foreground py-8\">\n                        Nessun cliente trovato. Aggiungi il primo cliente.\n                      </TableCell>\n                    </TableRow>\n                  ) : (\n                    (clients as any[]).map((client: any) => {\n                      const clientWorkOrders = (workOrders as any[]).filter((wo: any) => wo.clientId === client.id);\n                      const activeWorkOrders = clientWorkOrders.filter((wo: any) => wo.isActive);\n\n                      return (\n                        <TableRow key={client.id}>\n                          <TableCell className=\"font-medium\" data-testid={`text-client-name-${client.id}`}>\n                            {client.name}\n                          </TableCell>\n                          <TableCell data-testid={`text-active-workorders-${client.id}`}>\n                            {activeWorkOrders.length}\n                          </TableCell>\n                          <TableCell data-testid={`text-total-workorders-${client.id}`}>\n                            {clientWorkOrders.length}\n                          </TableCell>\n                          <TableCell>\n                            <Button\n                              variant=\"destructive\"\n                              size=\"sm\"\n                              onClick={() => handleDeleteClient(client)}\n                              data-testid={`button-delete-client-${client.id}`}\n                            >\n                              <Trash className=\"h-4 w-4 mr-2\" />\n                              Elimina\n                            </Button>\n                          </TableCell>\n                        </TableRow>\n                      );\n                    })\n                  )}\n                </TableBody>\n              </Table>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Employees Tab - CONTINUA NELLA PARTE 3 */}\n{/* Employees Tab */}\n        <TabsContent value=\"employees\" className=\"space-y-4\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between\">\n              <CardTitle>Gestione Dipendenti</CardTitle>\n              <Dialog open={addEmployeeDialogOpen} onOpenChange={setAddEmployeeDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button data-testid=\"button-add-employee\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Nuovo Dipendente\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"sm:max-w-[425px]\">\n                  <DialogHeader>\n                    <DialogTitle>Aggiungi Nuovo Dipendente</DialogTitle>\n                    <DialogDescription>\n                      Inserisci i dati del nuovo dipendente.\n                    </DialogDescription>\n                  </DialogHeader>\n                  <Form {...form}>\n                    <form onSubmit={form.handleSubmit(handleAddEmployee)} className=\"space-y-4\">\n                      <FormField\n                        control={form.control}\n                        name=\"fullName\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Nome e Cognome</FormLabel>\n                            <FormControl>\n                              <Input \n                                placeholder=\"Es. Mario Rossi\" \n                                {...field} \n                                data-testid=\"input-full-name\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={form.control}\n                        name=\"username\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Username</FormLabel>\n                            <FormControl>\n                              <Input \n                                placeholder=\"Username unico\" \n                                {...field} \n                                data-testid=\"input-username\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={form.control}\n                        name=\"password\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Password</FormLabel>\n                            <FormControl>\n                              <Input \n                                type=\"password\" \n                                placeholder=\"Password sicura\" \n                                {...field} \n                                data-testid=\"input-password\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <DialogFooter>\n                        <Button \n                          type=\"submit\" \n                          disabled={createEmployeeMutation.isPending}\n                          data-testid=\"button-submit-employee\"\n                        >\n                          {createEmployeeMutation.isPending ? \"Aggiungendo...\" : \"Aggiungi Dipendente\"}\n                        </Button>\n                      </DialogFooter>\n                    </form>\n                  </Form>\n                </DialogContent>\n              </Dialog>\n\n              {/* Dialog modifica dipendente */}\n              <Dialog open={editEmployeeDialogOpen} onOpenChange={setEditEmployeeDialogOpen}>\n                <DialogContent className=\"sm:max-w-[425px]\">\n                  <DialogHeader>\n                    <DialogTitle>Modifica Dipendente</DialogTitle>\n                    <DialogDescription>\n                      Modifica i dati del dipendente. Lascia la password vuota se non vuoi cambiarla.\n                    </DialogDescription>\n                  </DialogHeader>\n                  <Form {...editForm}>\n                    <form onSubmit={editForm.handleSubmit(handleUpdateEmployee)} className=\"space-y-4\">\n                      <FormField\n                        control={editForm.control}\n                        name=\"fullName\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Nome e Cognome</FormLabel>\n                            <FormControl>\n                              <Input \n                                placeholder=\"Es. Mario Rossi\" \n                                {...field} \n                                data-testid=\"input-edit-full-name\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={editForm.control}\n                        name=\"username\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Username</FormLabel>\n                            <FormControl>\n                              <Input \n                                placeholder=\"Username unico\" \n                                {...field} \n                                data-testid=\"input-edit-username\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={editForm.control}\n                        name=\"password\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Password (opzionale)</FormLabel>\n                            <FormControl>\n                              <Input \n                                type=\"password\" \n                                placeholder=\"Lascia vuoto per non modificare\" \n                                {...field} \n                                data-testid=\"input-edit-password\"\n                              />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={editForm.control}\n                        name=\"isActive\"\n                        render={({ field }) => (\n                          <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                            <div className=\"space-y-0.5\">\n                              <FormLabel className=\"text-base\">\n                                Stato Dipendente\n                              </FormLabel>\n                              <div className=\"text-sm text-muted-foreground\">\n                                {field.value ? \"Attivo\" : \"Licenziato\"}\n                              </div>\n                            </div>\n                            <FormControl>\n                              <Switch\n                                checked={field.value}\n                                onCheckedChange={field.onChange}\n                                data-testid=\"switch-employee-active\"\n                              />\n                            </FormControl>\n                          </FormItem>\n                        )}\n                      />\n                      <DialogFooter>\n                        <Button \n                          type=\"button\" \n                          variant=\"outline\" \n                          onClick={() => setEditEmployeeDialogOpen(false)}\n                        >\n                          Annulla\n                        </Button>\n                        <Button \n                          type=\"submit\" \n                          disabled={updateEmployeeMutation.isPending}\n                          data-testid=\"button-update-employee\"\n                        >\n                          {updateEmployeeMutation.isPending ? \"Aggiornando...\" : \"Aggiorna Dipendente\"}\n                        </Button>\n                      </DialogFooter>\n                    </form>\n                  </Form>\n                </DialogContent>\n              </Dialog>\n\n              {/* Dialog conferma eliminazione dipendente */}\n              <AlertDialog open={deleteEmployeeDialogOpen} onOpenChange={setDeleteEmployeeDialogOpen}>\n                <AlertDialogContent>\n                  <AlertDialogHeader>\n                    <AlertDialogTitle>Elimina Dipendente</AlertDialogTitle>\n                    <AlertDialogDescription>\n                      Sei sicuro di voler eliminare il dipendente \"{selectedEmployee?.fullName}\"?\n                      {employeeReportsCount > 0 && (\n                        <span className=\"block mt-2 font-semibold text-destructive\">\n                          Questa operazione eliminerà anche {employeeReportsCount} {employeeReportsCount === 1 ? 'rapportino associato' : 'rapportini associati'}.\n                        </span>\n                      )}\n                      <span className=\"block mt-2\">\n                        Questa azione non può essere annullata.\n                      </span>\n                    </AlertDialogDescription>\n                  </AlertDialogHeader>\n                  <AlertDialogFooter>\n                    <AlertDialogCancel>Annulla</AlertDialogCancel>\n                    <AlertDialogAction \n                      onClick={confirmDeleteEmployee}\n                      disabled={deleteEmployeeMutation.isPending}\n                      className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                      data-testid=\"button-confirm-delete-employee\"\n                    >\n                      {deleteEmployeeMutation.isPending ? \"Eliminando...\" : \"Elimina\"}\n                    </AlertDialogAction>\n                  </AlertDialogFooter>\n                </AlertDialogContent>\n              </AlertDialog>\n\n              {/* AlertDialog conferma cambio stato dipendente */}\n              <AlertDialog open={toggleStatusDialogOpen} onOpenChange={setToggleStatusDialogOpen}>\n                <AlertDialogContent>\n                  <AlertDialogHeader>\n                    <AlertDialogTitle>\n                      {employeeToToggle?.isActive ? \"Disattiva Dipendente\" : \"Riattiva Dipendente\"}\n                    </AlertDialogTitle>\n                    <AlertDialogDescription>\n                      {employeeToToggle?.isActive \n                        ? `Sei sicuro di voler impostare \"${employeeToToggle?.fullName}\" come licenziato? Il dipendente non potrà più accedere al sistema.`\n                        : `Sei sicuro di voler riattivare \"${employeeToToggle?.fullName}\"? Il dipendente potrà nuovamente accedere al sistema.`\n                      }\n                    </AlertDialogDescription>\n                  </AlertDialogHeader>\n                  <AlertDialogFooter>\n                    <AlertDialogCancel data-testid=\"button-cancel-toggle-status\">Annulla</AlertDialogCancel>\n                    <AlertDialogAction \n                      onClick={() => {\n                        if (employeeToToggle) {\n                          toggleEmployeeStatusMutation.mutate({ \n                            employeeId: employeeToToggle.id, \n                            isActive: !employeeToToggle.isActive \n                          });\n                          setToggleStatusDialogOpen(false);\n                          setEmployeeToToggle(null);\n                        }\n                      }}\n                      disabled={toggleEmployeeStatusMutation.isPending}\n                      className={employeeToToggle?.isActive \n                        ? \"bg-orange-600 text-white hover:bg-orange-700\" \n                        : \"bg-green-600 text-white hover:bg-green-700\"\n                      }\n                      data-testid=\"button-confirm-toggle-status\"\n                    >\n                      {toggleEmployeeStatusMutation.isPending \n                        ? \"Aggiornando...\" \n                        : employeeToToggle?.isActive ? \"Disattiva\" : \"Riattiva\"\n                      }\n                    </AlertDialogAction>\n                  </AlertDialogFooter>\n                </AlertDialogContent>\n              </AlertDialog>\n            </CardHeader>\n            <CardContent>\n              <div className=\"mb-4\">\n                <Label>Filtra per Stato</Label>\n                <Select value={employeeStatusFilter} onValueChange={setEmployeeStatusFilter}>\n                  <SelectTrigger className=\"w-[200px]\" data-testid=\"select-employee-status-filter\">\n                    <SelectValue placeholder=\"Seleziona stato\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Tutti i dipendenti</SelectItem>\n                    <SelectItem value=\"active\">Solo attivi</SelectItem>\n                    <SelectItem value=\"inactive\">Solo licenziati</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              {isLoadingEmployees ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  Caricamento dipendenti...\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\" data-testid=\"scroll-table-employees\">\n                  <Table className=\"min-w-[700px]\">\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Nome</TableHead>\n                        <TableHead>Username</TableHead>\n                        <TableHead>Password Attuale</TableHead>\n                        <TableHead>Ruolo</TableHead>\n                        <TableHead>Stato</TableHead>\n                        <TableHead>Azioni</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                    {(employees as any[])\n                      .filter((emp: any) => emp.role === 'employee')\n                      .filter((emp: any) => {\n                        if (employeeStatusFilter === \"active\") return emp.isActive === true;\n                        if (employeeStatusFilter === \"inactive\") return emp.isActive === false;\n                        return true;\n                      })\n                      .sort((a: any, b: any) => {\n                        // Dipendenti attivi prima, licenziati alla fine\n                        if (a.isActive === b.isActive) return 0;\n                        return a.isActive ? -1 : 1;\n                      })\n                      .map((employee: any) => (\n                      <TableRow key={employee.id}>\n                        <TableCell className=\"font-medium\">{employee.fullName}</TableCell>\n                        <TableCell>{employee.username}</TableCell>\n                        <TableCell>\n                          <span className=\"font-mono text-sm bg-muted px-2 py-1 rounded\">\n                            {employee.plainPassword || \"Non disponibile\"}\n                          </span>\n                        </TableCell>\n                        <TableCell>\n                          <Badge variant=\"secondary\">Dipendente</Badge>\n                        </TableCell>\n                        <TableCell data-testid={`text-employee-status-${employee.id}`}>\n                          <Badge variant={employee.isActive ? \"default\" : \"outline\"}>\n                            {employee.isActive ? \"Attivo\" : \"Licenziato\"}\n                          </Badge>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex gap-2\">\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <Button \n                                  variant=\"ghost\" \n                                  size=\"sm\" \n                                  onClick={() => {\n                                    setSelectedEmployeeForStats(employee);\n                                    setEmployeeStatsDialogOpen(true);\n                                  }}\n                                  data-testid={`button-employee-stats-${employee.id}`}\n                                  className=\"text-purple-600 hover:text-purple-700\"\n                                >\n                                  <BarChart2 className=\"h-4 w-4\" />\n                                </Button>\n                              </TooltipTrigger>\n                              <TooltipContent>Statistiche Assenze</TooltipContent>\n                            </Tooltip>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\" \n                              onClick={() => handleEditEmployee(employee)}\n                              data-testid={`button-edit-employee-${employee.id}`}\n                            >\n                              <Edit className=\"h-4 w-4\" />\n                            </Button>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\" \n                              onClick={() => handleResetPassword(employee)}\n                              data-testid={`button-reset-password-${employee.id}`}\n                              className=\"text-blue-600 hover:text-blue-700\"\n                              disabled={resetPasswordMutation.isPending}\n                            >\n                              <Key className=\"h-4 w-4\" />\n                            </Button>\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <Button \n                                  variant=\"ghost\" \n                                  size=\"sm\" \n                                  onClick={() => {\n                                    setEmployeeToToggle(employee);\n                                    setToggleStatusDialogOpen(true);\n                                  }}\n                                  data-testid={`button-toggle-status-${employee.id}`}\n                                  className={employee.isActive ? \"text-orange-600 hover:text-orange-700\" : \"text-green-600 hover:text-green-700\"}\n                                  disabled={toggleEmployeeStatusMutation.isPending}\n                                >\n                                  {employee.isActive ? <UserX className=\"h-4 w-4\" /> : <UserCheck className=\"h-4 w-4\" />}\n                                </Button>\n                              </TooltipTrigger>\n                              <TooltipContent>\n                                {employee.isActive ? \"Imposta come licenziato\" : \"Riattiva dipendente\"}\n                              </TooltipContent>\n                            </Tooltip>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\" \n                              onClick={() => handleDeleteEmployee(employee)}\n                              data-testid={`button-delete-employee-${employee.id}`}\n                              className=\"text-destructive hover:text-destructive\"\n                            >\n                              <Trash className=\"h-4 w-4\" />\n                            </Button>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Configurazione Tab (Lavorazioni e Materiali) */}\n        <TabsContent value=\"work-types\">\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n          {/* Lavorazioni Card */}\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <CardTitle>Lavorazioni</CardTitle>\n                <Button onClick={() => setAddWorkTypeDialogOpen(true)} data-testid=\"button-add-worktype\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Aggiungi Lavorazione\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {isLoadingWorkTypes ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  Caricamento lavorazioni...\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\" data-testid=\"scroll-table-worktypes\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Nome</TableHead>\n                        <TableHead className=\"hidden lg:table-cell\">Descrizione</TableHead>\n                        <TableHead className=\"hidden lg:table-cell\">Stato</TableHead>\n                        <TableHead>Azioni</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                    {(workTypes as any[]).length === 0 ? (\n                      <TableRow>\n                        <TableCell colSpan={2} className=\"text-center text-muted-foreground py-8 lg:hidden\">\n                          Nessuna lavorazione trovata. Aggiungi la prima lavorazione.\n                        </TableCell>\n                        <TableCell colSpan={4} className=\"hidden lg:table-cell text-center text-muted-foreground py-8\">\n                          Nessuna lavorazione trovata. Aggiungi la prima lavorazione.\n                        </TableCell>\n                      </TableRow>\n                    ) : (\n                      (workTypes as any[]).map((workType: any) => (\n                        <TableRow key={workType.id}>\n                          <TableCell className=\"font-medium\" data-testid={`text-worktype-name-${workType.id}`}>\n                            {workType.name}\n                          </TableCell>\n                          <TableCell className=\"hidden lg:table-cell\" data-testid={`text-worktype-description-${workType.id}`}>\n                            {workType.description || \"-\"}\n                          </TableCell>\n                          <TableCell className=\"hidden lg:table-cell\" data-testid={`text-worktype-status-${workType.id}`}>\n                            <Badge variant={workType.isActive ? \"default\" : \"secondary\"}>\n                              {workType.isActive ? \"Attivo\" : \"Non attivo\"}\n                            </Badge>\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"flex gap-2\">\n                              <Button \n                                variant=\"ghost\" \n                                size=\"sm\" \n                                onClick={() => handleEditWorkType(workType)}\n                                data-testid={`button-edit-worktype-${workType.id}`}\n                              >\n                                <Edit className=\"h-4 w-4\" />\n                              </Button>\n                              <Button \n                                variant=\"ghost\" \n                                size=\"sm\" \n                                onClick={() => handleDeleteWorkType(workType)}\n                                data-testid={`button-delete-worktype-${workType.id}`}\n                                className=\"text-destructive hover:text-destructive\"\n                              >\n                                <Trash className=\"h-4 w-4\" />\n                              </Button>\n                            </div>\n                          </TableCell>\n                        </TableRow>\n                      ))\n                    )}\n                  </TableBody>\n                </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Materiali Card */}\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <CardTitle>Materiali</CardTitle>\n                <Button onClick={() => setAddMaterialDialogOpen(true)} data-testid=\"button-add-material\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Aggiungi Materiale\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {isLoadingMaterials ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  Caricamento materiali...\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\" data-testid=\"scroll-table-materials\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Nome</TableHead>\n                        <TableHead className=\"hidden lg:table-cell\">Descrizione</TableHead>\n                        <TableHead className=\"hidden lg:table-cell\">Stato</TableHead>\n                        <TableHead>Azioni</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                    {(materials as any[]).length === 0 ? (\n                      <TableRow>\n                        <TableCell colSpan={2} className=\"text-center text-muted-foreground py-8 lg:hidden\">\n                          Nessun materiale trovato. Aggiungi il primo materiale.\n                        </TableCell>\n                        <TableCell colSpan={4} className=\"hidden lg:table-cell text-center text-muted-foreground py-8\">\n                          Nessun materiale trovato. Aggiungi il primo materiale.\n                        </TableCell>\n                      </TableRow>\n                    ) : (\n                      (materials as any[]).map((material: any) => (\n                        <TableRow key={material.id}>\n                          <TableCell className=\"font-medium\" data-testid={`text-material-name-${material.id}`}>\n                            {material.name}\n                          </TableCell>\n                          <TableCell className=\"hidden lg:table-cell\" data-testid={`text-material-description-${material.id}`}>\n                            {material.description || \"-\"}\n                          </TableCell>\n                          <TableCell className=\"hidden lg:table-cell\" data-testid={`text-material-status-${material.id}`}>\n                            <Badge variant={material.isActive ? \"default\" : \"secondary\"}>\n                              {material.isActive ? \"Attivo\" : \"Non attivo\"}\n                            </Badge>\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"flex gap-2\">\n                              <Button \n                                variant=\"ghost\" \n                                size=\"sm\" \n                                onClick={() => handleEditMaterial(material)}\n                                data-testid={`button-edit-material-${material.id}`}\n                              >\n                                <Edit className=\"h-4 w-4\" />\n                              </Button>\n                              <Button \n                                variant=\"ghost\" \n                                size=\"sm\" \n                                onClick={() => handleDeleteMaterial(material)}\n                                data-testid={`button-delete-material-${material.id}`}\n                                className=\"text-destructive hover:text-destructive\"\n                              >\n                                <Trash className=\"h-4 w-4\" />\n                              </Button>\n                            </div>\n                          </TableCell>\n                        </TableRow>\n                      ))\n                    )}\n                  </TableBody>\n                </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n          </div>\n        </TabsContent>\n\n        {/* Attendance Tab */}\n        <TabsContent value=\"attendance\">\n          <div className=\"flex justify-between items-center mb-4\">\n            <h2 className=\"text-2xl font-bold\">Foglio Presenze</h2>\n            <Button \n              onClick={() => setRegisterAbsenceDialogOpen(true)}\n              data-testid=\"button-register-absence\"\n            >\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Registra Assenze\n            </Button>\n          </div>\n          <AttendanceSheet />\n        </TabsContent>\n\n        {/* Absence Statistics Tab */}\n        <TabsContent value=\"absence-stats\" className=\"space-y-6\">\n          {(isLoadingAttendanceStats || isFetchingAttendanceStats) && !attendanceStats ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <div className=\"text-center\">\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2\"></div>\n                <p className=\"text-muted-foreground\">Caricamento statistiche assenze...</p>\n              </div>\n            </div>\n          ) : attendanceStats ? (\n            <>\n              {/* KPI Cards */}\n              <div className=\"grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-4\">\n                <Card>\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center justify-between gap-2\">\n                      <div>\n                        <p className=\"text-sm font-medium text-muted-foreground\">Totale Assenze (90gg)</p>\n                        <p className=\"text-2xl font-bold\" data-testid=\"text-total-absences\">{attendanceStats.totalAbsences || 0}</p>\n                      </div>\n                      <AlertTriangle className=\"h-8 w-8 text-warning\" />\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center justify-between gap-2\">\n                      <div>\n                        <p className=\"text-sm font-medium text-muted-foreground\">Tipo Più Comune</p>\n                        <p className=\"text-2xl font-bold\" data-testid=\"text-most-common-type\">\n                          {attendanceStats.byType && Object.keys(attendanceStats.byType).length > 0 \n                            ? (() => {\n                                const typeMap: Record<string, string> = {\n                                  'A': 'Assenza',\n                                  'F': 'Ferie',\n                                  'P': 'Permesso',\n                                  'M': 'Malattia',\n                                  'CP': 'Congedo',\n                                  'L104': 'L.104'\n                                };\n                                const sortedTypes = Object.entries(attendanceStats.byType as Record<string, number>)\n                                  .sort((a, b) => b[1] - a[1]);\n                                return sortedTypes.length > 0 \n                                  ? (typeMap[sortedTypes[0][0]] || sortedTypes[0][0])\n                                  : '-';\n                              })()\n                            : '-'}\n                        </p>\n                      </div>\n                      <TrendingUp className=\"h-8 w-8 text-primary\" />\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center justify-between gap-2\">\n                      <div>\n                        <p className=\"text-sm font-medium text-muted-foreground\">Giorno Picco</p>\n                        <p className=\"text-2xl font-bold\" data-testid=\"text-peak-day\">\n                          {attendanceStats.byDayOfWeek && Object.keys(attendanceStats.byDayOfWeek).length > 0 \n                            ? (() => {\n                                const dayMap: Record<number, string> = {\n                                  0: 'Domenica',\n                                  1: 'Lunedì',\n                                  2: 'Martedì',\n                                  3: 'Mercoledì',\n                                  4: 'Giovedì',\n                                  5: 'Venerdì',\n                                  6: 'Sabato'\n                                };\n                                const sortedDays = Object.entries(attendanceStats.byDayOfWeek as Record<number, number>)\n                                  .sort((a, b) => b[1] - a[1]);\n                                return sortedDays.length > 0 \n                                  ? (dayMap[parseInt(sortedDays[0][0])] || '-')\n                                  : '-';\n                              })()\n                            : '-'}\n                        </p>\n                      </div>\n                      <Calendar className=\"h-8 w-8 text-muted-foreground\" />\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center justify-between gap-2\">\n                      <div>\n                        <p className=\"text-sm font-medium text-muted-foreground\">Media per Dipendente</p>\n                        <p className=\"text-2xl font-bold\" data-testid=\"text-avg-absences\">\n                          {attendanceStats.byEmployee && attendanceStats.byEmployee.length > 0 \n                            ? (attendanceStats.totalAbsences / attendanceStats.byEmployee.length).toFixed(1)\n                            : '0'}\n                        </p>\n                      </div>\n                      <Users className=\"h-8 w-8 text-muted-foreground\" />\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Strategic Absences Card */}\n              <Card className=\"border-orange-200 dark:border-orange-800 bg-orange-50 dark:bg-orange-950/30\">\n                <CardHeader className=\"pb-2\">\n                  <div className=\"flex items-center justify-between gap-2\">\n                    <CardTitle className=\"flex items-center gap-2 text-orange-700 dark:text-orange-400\">\n                      <AlertTriangle className=\"h-5 w-5\" />\n                      Assenze Strategiche\n                    </CardTitle>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => {\n                        window.open('/api/attendance/strategic-report?days=90', '_blank');\n                      }}\n                      data-testid=\"button-export-strategic-absences\"\n                    >\n                      <Download className=\"h-4 w-4 mr-1\" />\n                      Export\n                    </Button>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Assenze (escluse Ferie) registrate il giorno prima o dopo weekend/festività\n                  </p>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex items-center gap-4 mb-4\">\n                    <div className=\"text-3xl font-bold text-orange-600 dark:text-orange-400\">\n                      {attendanceStats.totalStrategicAbsences || 0}\n                    </div>\n                    <div className=\"text-sm text-muted-foreground\">\n                      su {attendanceStats.totalAbsences - (attendanceStats.byType?.['F'] || 0)} assenze non-ferie\n                    </div>\n                  </div>\n                  \n                  {/* Strategic absences by employee ranking */}\n                  {attendanceStats.byEmployee && attendanceStats.byEmployee.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <p className=\"text-sm font-medium text-muted-foreground mb-2\">Classifica per assenze strategiche:</p>\n                      <div className=\"space-y-1 max-h-48 overflow-y-auto\">\n                        {attendanceStats.byEmployee\n                          .filter(emp => emp.strategicAbsences > 0)\n                          .sort((a, b) => b.strategicAbsences - a.strategicAbsences)\n                          .slice(0, 10)\n                          .map((emp, index) => (\n                            <div key={emp.userId} className=\"flex items-center justify-between py-1 px-2 rounded bg-background\">\n                              <div className=\"flex items-center gap-2\">\n                                <span className={`text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center ${\n                                  index === 0 ? 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' :\n                                  index === 1 ? 'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300' :\n                                  index === 2 ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300' :\n                                  'bg-muted text-muted-foreground'\n                                }`}>\n                                  {index + 1}\n                                </span>\n                                <span className=\"text-sm\">{emp.fullName}</span>\n                              </div>\n                              <Badge variant={emp.strategicAbsences >= 5 ? \"destructive\" : emp.strategicAbsences >= 3 ? \"secondary\" : \"outline\"}>\n                                {emp.strategicAbsences}\n                              </Badge>\n                            </div>\n                          ))}\n                        {attendanceStats.byEmployee.filter(emp => emp.strategicAbsences > 0).length === 0 && (\n                          <p className=\"text-sm text-muted-foreground text-center py-4\">\n                            Nessuna assenza strategica rilevata\n                          </p>\n                        )}\n                      </div>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n\n              {/* Charts Row */}\n              <div className=\"grid gap-4 grid-cols-1 lg:grid-cols-2\">\n                {/* Monthly Trend Chart */}\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <TrendingUp className=\"h-5 w-5\" />\n                      Trend Mensile Assenze\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {attendanceStats.byMonth && attendanceStats.byMonth.length > 0 ? (\n                      <ResponsiveContainer width=\"100%\" height={250}>\n                        <LineChart data={attendanceStats.byMonth.slice().reverse()}>\n                          <CartesianGrid strokeDasharray=\"3 3\" />\n                          <XAxis \n                            dataKey=\"month\" \n                            tickFormatter={(value) => {\n                              const [year, month] = value.split('-');\n                              const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];\n                              return monthNames[parseInt(month) - 1] || value;\n                            }}\n                          />\n                          <YAxis />\n                          <RechartsTooltip \n                            formatter={(value: number) => [value, 'Assenze']}\n                            labelFormatter={(label) => {\n                              const [year, month] = label.split('-');\n                              const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];\n                              return `${monthNames[parseInt(month) - 1]} ${year}`;\n                            }}\n                          />\n                          <Line type=\"monotone\" dataKey=\"count\" stroke=\"hsl(var(--primary))\" strokeWidth={2} dot={{ r: 4 }} />\n                        </LineChart>\n                      </ResponsiveContainer>\n                    ) : (\n                      <div className=\"flex items-center justify-center py-8 text-muted-foreground\">\n                        Nessun dato disponibile\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n\n                {/* Absence by Type Chart */}\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <BarChart2 className=\"h-5 w-5\" />\n                      Assenze per Tipo\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {attendanceStats.byType && Object.keys(attendanceStats.byType).length > 0 ? (\n                      <ResponsiveContainer width=\"100%\" height={250}>\n                        <BarChart data={Object.entries(attendanceStats.byType as Record<string, number>).map(([type, count]) => {\n                          const typeMap: Record<string, string> = {\n                            'A': 'Assenza',\n                            'F': 'Ferie',\n                            'P': 'Permesso',\n                            'M': 'Malattia',\n                            'CP': 'Congedo',\n                            'L104': 'L.104'\n                          };\n                          return { type: typeMap[type] || type, count };\n                        })}>\n                          <CartesianGrid strokeDasharray=\"3 3\" />\n                          <XAxis dataKey=\"type\" />\n                          <YAxis />\n                          <RechartsTooltip formatter={(value: number) => [value, 'Assenze']} />\n                          <Bar dataKey=\"count\" fill=\"hsl(var(--primary))\" radius={[4, 4, 0, 0]} />\n                        </BarChart>\n                      </ResponsiveContainer>\n                    ) : (\n                      <div className=\"flex items-center justify-center py-8 text-muted-foreground\">\n                        Nessun dato disponibile\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Absence by Day of Week */}\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Calendar className=\"h-5 w-5\" />\n                    Assenze per Giorno della Settimana\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {attendanceStats.byDayOfWeek && Object.keys(attendanceStats.byDayOfWeek).length > 0 ? (\n                    <ResponsiveContainer width=\"100%\" height={200}>\n                      <BarChart data={(() => {\n                        const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];\n                        const byDayRecord = attendanceStats.byDayOfWeek as Record<number, number>;\n                        return [1, 2, 3, 4, 5, 6, 0].map(dayNum => ({\n                          day: dayNames[dayNum],\n                          count: byDayRecord[dayNum] || 0\n                        }));\n                      })()}>\n                        <CartesianGrid strokeDasharray=\"3 3\" />\n                        <XAxis dataKey=\"day\" />\n                        <YAxis />\n                        <RechartsTooltip formatter={(value: number) => [value, 'Assenze']} />\n                        <Bar dataKey=\"count\" fill=\"hsl(var(--chart-2))\" radius={[4, 4, 0, 0]} />\n                      </BarChart>\n                    </ResponsiveContainer>\n                  ) : (\n                    <div className=\"flex items-center justify-center py-8 text-muted-foreground\">\n                      Nessun dato disponibile\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n\n              {/* Employee Absence Table */}\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Users className=\"h-5 w-5\" />\n                    Dipendenti con Più Assenze\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {attendanceStats.byEmployee && attendanceStats.byEmployee.length > 0 ? (\n                    <div className=\"overflow-x-auto\">\n                      <Table>\n                        <TableHeader>\n                          <TableRow>\n                            <TableHead className=\"w-12\">Pos.</TableHead>\n                            <TableHead>Dipendente</TableHead>\n                            <TableHead className=\"text-right\">Totale Assenze</TableHead>\n                            <TableHead className=\"text-right\">% sul Totale</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          {attendanceStats.byEmployee\n                            .slice(0, 10)\n                            .sort((a: any, b: any) => b.totalAbsences - a.totalAbsences)\n                            .map((emp: any, index: number) => (\n                            <TableRow key={emp.userId} data-testid={`row-employee-absence-${index}`}>\n                              <TableCell>\n                                <Badge variant={index < 3 ? \"default\" : \"outline\"}>\n                                  #{index + 1}\n                                </Badge>\n                              </TableCell>\n                              <TableCell className=\"font-medium\">{emp.fullName}</TableCell>\n                              <TableCell className=\"text-right\">{emp.totalAbsences}</TableCell>\n                              <TableCell className=\"text-right\">\n                                {attendanceStats.totalAbsences > 0 \n                                  ? ((emp.totalAbsences / attendanceStats.totalAbsences) * 100).toFixed(1)\n                                  : '0'}%\n                              </TableCell>\n                            </TableRow>\n                          ))}\n                        </TableBody>\n                      </Table>\n                    </div>\n                  ) : (\n                    <div className=\"flex items-center justify-center py-8 text-muted-foreground\">\n                      Nessun dato disponibile\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </>\n          ) : (\n            <div className=\"flex items-center justify-center py-12 text-muted-foreground\">\n              Nessun dato disponibile per le statistiche assenze.\n            </div>\n          )}\n        </TabsContent>\n      </Tabs>\n      </TabsContent>\n\n      {/* TUTTI I DIALOG - INIZIO */}\n\n      {/* Dialog per impostare nuova password */}\n      <Dialog open={resetPasswordDialogOpen} onOpenChange={setResetPasswordDialogOpen}>\n        <DialogContent className=\"sm:max-w-[425px]\">\n          <DialogHeader>\n            <DialogTitle>Imposta Nuova Password</DialogTitle>\n            <DialogDescription>\n              Inserisci la nuova password per il dipendente.\n            </DialogDescription>\n          </DialogHeader>\n\n          {selectedEmployee && (\n            <div className=\"space-y-4\">\n              <div className=\"bg-muted p-4 rounded-lg\">\n                <div className=\"space-y-2\">\n                  <div>\n                    <Label className=\"text-sm font-medium\">Dipendente:</Label>\n                    <p className=\"text-sm\">{selectedEmployee.fullName}</p>\n                  </div>\n                  <div>\n                    <Label className=\"text-sm font-medium\">Username:</Label>\n                    <p className=\"text-sm font-mono\">{selectedEmployee.username}</p>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"newPassword\">Nuova Password</Label>\n                <Input\n                  id=\"newPassword\"\n                  type=\"text\"\n                  value={newPassword}\n                  onChange={(e) => setNewPassword(e.target.value)}\n                  placeholder=\"Inserisci la nuova password (min. 6 caratteri)\"\n                  data-testid=\"input-new-password\"\n                />\n                {newPassword.length > 0 && newPassword.length < 6 && (\n                  <p className=\"text-sm text-destructive\">Password deve essere di almeno 6 caratteri</p>\n                )}\n              </div>\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => setResetPasswordDialogOpen(false)}\n              data-testid=\"button-cancel-password\"\n            >\n              Annulla\n            </Button>\n            <Button \n              onClick={confirmResetPassword}\n              disabled={resetPasswordMutation.isPending || newPassword.trim().length < 6}\n              data-testid=\"button-confirm-password\"\n            >\n              {resetPasswordMutation.isPending ? \"Aggiornando...\" : \"Aggiorna Password\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog per cambiare data rapportino */}\n      <Dialog open={changeDateDialogOpen} onOpenChange={setChangeDateDialogOpen}>\n        <DialogContent className=\"sm:max-w-[425px]\">\n          <DialogHeader>\n            <DialogTitle>Modifica Data Rapportino</DialogTitle>\n            <DialogDescription>\n              Seleziona la nuova data per il rapportino giornaliero.\n            </DialogDescription>\n          </DialogHeader>\n\n          {selectedReportToChangeDate && (\n            <div className=\"space-y-4\">\n              <div className=\"bg-muted p-4 rounded-lg\">\n                <div className=\"space-y-2\">\n                  <div>\n                    <Label className=\"text-sm font-medium\">Dipendente:</Label>\n                    <p className=\"text-sm\">{selectedReportToChangeDate.employeeName || \"Sconosciuto\"}</p>\n                  </div>\n                  <div>\n                    <Label className=\"text-sm font-medium\">Data attuale:</Label>\n                    <p className=\"text-sm\">{formatDateToItalian(selectedReportToChangeDate.date)}</p>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"newDate\">Nuova Data</Label>\n                <Input\n                  id=\"newDate\"\n                  type=\"date\"\n                  value={newReportDate}\n                  onChange={(e) => setNewReportDate(e.target.value)}\n                  data-testid=\"input-new-date\"\n                />\n              </div>\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => setChangeDateDialogOpen(false)}\n              data-testid=\"button-cancel-change-date\"\n            >\n              Annulla\n            </Button>\n            <Button \n              onClick={() => {\n                if (selectedReportToChangeDate && newReportDate) {\n                  changeDateMutation.mutate({\n                    reportId: selectedReportToChangeDate.id,\n                    newDate: newReportDate\n                  });\n                }\n              }}\n              disabled={changeDateMutation.isPending || !newReportDate}\n              data-testid=\"button-confirm-change-date\"\n            >\n              {changeDateMutation.isPending ? \"Salvando...\" : \"Salva\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog per modifica rapportino */}\n      <Dialog open={editReportDialogOpen} onOpenChange={setEditReportDialogOpen}>\n        <DialogContent className=\"sm:max-w-[90vw] md:max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Modifica Rapportino</DialogTitle>\n            <DialogDescription>\n              Modifica le operazioni del rapportino giornaliero.\n            </DialogDescription>\n          </DialogHeader>\n\n          {selectedReport && (\n            <div className=\"mt-4\">\n              <DailyReportForm\n                employeeName={selectedReport.employeeName || \"Dipendente\"}\n                date={formatDateToItalian(selectedReport.date)}\n                onSubmit={handleUpdateReport}\n                initialOperations={reportOperations}\n                isEditing={true}\n              />\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => setEditReportDialogOpen(false)}\n              data-testid=\"button-cancel-edit-report\"\n            >\n              Annulla\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog per creazione rapportino da amministratore */}\n      <Dialog \n        open={createReportDialogOpen} \n        onOpenChange={(open) => {\n          setCreateReportDialogOpen(open);\n          if (!open) {\n            setSelectedEmployeeForReport(null);\n          }\n        }}\n      >\n        <DialogContent className=\"sm:max-w-[90vw] md:max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Crea Rapportino per Dipendente</DialogTitle>\n            <DialogDescription>\n              Seleziona un dipendente e compila il rapportino giornaliero.\n            </DialogDescription>\n          </DialogHeader>\n\n          {!selectedEmployeeForReport ? (\n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label>Dipendente</Label>\n                <Select\n                  onValueChange={(value) => {\n                    const emp = (employees as any[]).find((e: any) => e.id === value);\n                    setSelectedEmployeeForReport(emp);\n                  }}\n                >\n                  <SelectTrigger data-testid=\"select-employee-for-report\">\n                    <SelectValue placeholder=\"Seleziona dipendente\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {(activeEmployees as any[])\n                      .filter((emp: any) => emp.role === 'employee')\n                      .map((emp: any) => (\n                        <SelectItem key={emp.id} value={emp.id}>\n                          {emp.fullName}\n                        </SelectItem>\n                      ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          ) : (\n            <div className=\"mt-4\">\n              <div className=\"mb-4 p-4 bg-muted rounded-md\">\n                <p className=\"text-sm font-medium\">\n                  Creazione rapportino per: <span className=\"text-primary\">{selectedEmployeeForReport.fullName}</span>\n                </p>\n                <p className=\"text-sm text-muted-foreground\">\n                  Data: {formatDateToItalian(new Date().toISOString().split('T')[0])}\n                </p>\n              </div>\n              <DailyReportForm\n                employeeName={selectedEmployeeForReport.fullName}\n                date={formatDateToItalian(new Date().toISOString().split('T')[0])}\n                onSubmit={async (operations) => {\n                  try {\n                    await apiRequest('POST', '/api/daily-reports', {\n                      employeeId: selectedEmployeeForReport.id,\n                      date: new Date().toISOString().split('T')[0],\n                      status: 'In attesa',\n                      operations: operations\n                    });\n\n                    queryClient.invalidateQueries({ queryKey: ['/api/daily-reports'] });\n                    queryClient.invalidateQueries({ queryKey: ['/api/work-orders/stats'] });\n                    toast({\n                      title: \"Rapportino creato\",\n                      description: `Rapportino per ${selectedEmployeeForReport.fullName} creato con successo.`\n                    });\n                    setCreateReportDialogOpen(false);\n                    setSelectedEmployeeForReport(null);\n                  } catch (error: any) {\n                    toast({\n                      title: \"Errore\",\n                      description: error.message || \"Errore nella creazione del rapportino\",\n                      variant: \"destructive\"\n                    });\n                  }\n                }}\n                isEditing={false}\n              />\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => {\n                setCreateReportDialogOpen(false);\n                setSelectedEmployeeForReport(null);\n              }}\n              data-testid=\"button-cancel-create-report\"\n            >\n              {selectedEmployeeForReport ? \"Indietro\" : \"Annulla\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* CONTINUA PARTE 3... */}\n{/* Dialog per aggiungere nuova commessa */}\n      <Dialog open={addWorkOrderDialogOpen} onOpenChange={setAddWorkOrderDialogOpen}>\n        <DialogContent className=\"sm:max-w-[425px] max-h-[85vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Aggiungi Nuova Commessa</DialogTitle>\n            <DialogDescription>\n              Inserisci i dati della nuova commessa.\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...workOrderForm}>\n            <form onSubmit={workOrderForm.handleSubmit(handleAddWorkOrder)} className=\"space-y-4\">\n              <FormField\n                control={workOrderForm.control}\n                name=\"clientId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Cliente</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-client\">\n                          <SelectValue placeholder=\"Seleziona cliente\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {(clients as any[]).map((client: any) => (\n                          <SelectItem key={client.id} value={client.id}>\n                            {client.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={workOrderForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Nome Commessa</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Es. Cancello Automatico\" \n                        {...field} \n                        data-testid=\"input-work-order-name\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={workOrderForm.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Descrizione (opzionale)</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Descrizione della commessa\" \n                        {...field} \n                        data-testid=\"input-work-order-description\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={workOrderForm.control}\n                name=\"availableWorkTypes\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Lavorazioni Disponibili</FormLabel>\n                    <div className=\"border rounded-md p-4 max-h-48 overflow-y-auto space-y-2\">\n                      {(workTypes as any[])\n                        .filter((wt: any) => wt.isActive)\n                        .map((workType: any) => (\n                          <label \n                            key={workType.id} \n                            className=\"flex items-center space-x-2 cursor-pointer hover-elevate p-2 rounded\"\n                          >\n                            <input\n                              type=\"checkbox\"\n                              checked={field.value?.includes(workType.id) || false}\n                              onChange={(e) => {\n                                const checked = e.target.checked;\n                                const newValue = checked\n                                  ? [...(field.value || []), workType.id]\n                                  : (field.value || []).filter((id: string) => id !== workType.id);\n                                field.onChange(newValue);\n                              }}\n                              className=\"h-4 w-4\"\n                              data-testid={`checkbox-worktype-${workType.id}`}\n                            />\n                            <span className=\"text-sm\">{workType.name}</span>\n                          </label>\n                        ))}\n                      {(workTypes as any[]).filter((wt: any) => wt.isActive).length === 0 && (\n                        <p className=\"text-sm text-muted-foreground text-center py-2\">\n                          Nessuna lavorazione disponibile. Aggiungile nella tab Configurazione.\n                        </p>\n                      )}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={workOrderForm.control}\n                name=\"availableMaterials\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Materiali Disponibili</FormLabel>\n                    <div className=\"border rounded-md p-4 max-h-48 overflow-y-auto space-y-2\">\n                      {(materials as any[])\n                        .filter((m: any) => m.isActive)\n                        .map((material: any) => (\n                          <label \n                            key={material.id} \n                            className=\"flex items-center space-x-2 cursor-pointer hover-elevate p-2 rounded\"\n                          >\n                            <input\n                              type=\"checkbox\"\n                              checked={field.value?.includes(material.id) || false}\n                              onChange={(e) => {\n                                const checked = e.target.checked;\n                                const newValue = checked\n                                  ? [...(field.value || []), material.id]\n                                  : (field.value || []).filter((id: string) => id !== material.id);\n                                field.onChange(newValue);\n                              }}\n                              className=\"h-4 w-4\"\n                              data-testid={`checkbox-material-${material.id}`}\n                            />\n                            <span className=\"text-sm\">{material.name}</span>\n                          </label>\n                        ))}\n                      {(materials as any[]).filter((m: any) => m.isActive).length === 0 && (\n                        <p className=\"text-sm text-muted-foreground text-center py-2\">\n                          Nessun materiale disponibile. Aggiungili nella tab Configurazione.\n                        </p>\n                      )}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={workOrderForm.control}\n                name=\"isActive\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                    <div className=\"space-y-0.5\">\n                      <FormLabel className=\"text-base\">\n                        Stato Commessa\n                      </FormLabel>\n                      <div className=\"text-sm text-muted-foreground\">\n                        {field.value ? \"Attiva\" : \"Archiviata\"}\n                      </div>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-work-order-active\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button \n                  type=\"button\" \n                  variant=\"outline\" \n                  onClick={() => setAddWorkOrderDialogOpen(false)}\n                  data-testid=\"button-cancel-add-work-order\"\n                >\n                  Annulla\n                </Button>\n                <Button \n                  type=\"submit\" \n                  disabled={createWorkOrderMutation.isPending}\n                  data-testid=\"button-submit-work-order\"\n                >\n                  {createWorkOrderMutation.isPending ? \"Creazione...\" : \"Crea Commessa\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* TUTTI GLI ALTRI DIALOG SONO COMPLETI NEL FILE ORIGINALE */}\n      {/* Per brevità non li riporto tutti qui, ma sono presenti nel tuo file originale */}\n\n      {/* Dialog conferma eliminazione rapportino */}\n      <AlertDialog open={deleteReportDialogOpen} onOpenChange={setDeleteReportDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Elimina Rapportino</AlertDialogTitle>\n            <AlertDialogDescription>\n              Sei sicuro di voler eliminare questo rapportino?\n              <span className=\"block mt-2\">\n                Questa azione eliminerà il rapportino e tutte le operazioni associate. Questa azione non può essere annullata.\n              </span>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Annulla</AlertDialogCancel>\n            <AlertDialogAction \n              onClick={confirmDeleteReport}\n              disabled={deleteReportMutation.isPending}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete-report\"\n            >\n              {deleteReportMutation.isPending ? \"Eliminando...\" : \"Elimina\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Dialog dipendenti mancanti */}\n      <Dialog open={missingEmployeesDialogOpen} onOpenChange={setMissingEmployeesDialogOpen}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>Dipendenti Mancanti</DialogTitle>\n            <DialogDescription>\n              Dipendenti che non hanno inviato il rapportino per la data selezionata\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center gap-4\">\n              <Label htmlFor=\"missing-employees-date\">Data:</Label>\n              <Input\n                id=\"missing-employees-date\"\n                type=\"date\"\n                value={missingEmployeesDate}\n                onChange={(e) => setMissingEmployeesDate(e.target.value)}\n                className=\"w-[200px]\"\n                data-testid=\"input-missing-employees-date\"\n              />\n            </div>\n            {isLoadingMissingEmployees ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                Caricamento...\n              </div>\n            ) : isMissingEmployeesError ? (\n              <div className=\"text-center py-8 text-destructive\">\n                <p className=\"mb-2\">Errore nel caricamento dei dati</p>\n                <p className=\"text-sm text-muted-foreground\">\n                  Si è verificato un errore durante il recupero dei dipendenti mancanti.\n                </p>\n              </div>\n            ) : missingEmployeesData && missingEmployeesData.missingEmployees && missingEmployeesData.missingEmployees.length > 0 ? (\n              <div className=\"space-y-2\">\n                <p className=\"text-sm text-muted-foreground\">\n                  {missingEmployeesData.missingEmployees.length} {missingEmployeesData.missingEmployees.length === 1 ? 'dipendente non ha' : 'dipendenti non hanno'} inviato il rapportino per il{' '}\n                  {new Date(missingEmployeesDate + 'T00:00:00').toLocaleDateString('it-IT', { \n                    day: '2-digit', \n                    month: '2-digit', \n                    year: 'numeric' \n                  })}\n                </p>\n                <div className=\"border rounded-lg divide-y\">\n                  {missingEmployeesData.missingEmployees.map((employee: any) => (\n                    <div key={employee.id} className=\"p-3 flex items-center justify-between hover:bg-muted/50\">\n                      <div>\n                        <p className=\"font-medium\">{employee.fullName}</p>\n                        <p className=\"text-sm text-muted-foreground\">{employee.username}</p>\n                      </div>\n                      <Users className=\"h-4 w-4 text-muted-foreground\" />\n                    </div>\n                  ))}\n                </div>\n              </div>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Users className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                <p>Tutti i dipendenti hanno inviato il rapportino per questa data!</p>\n              </div>\n            )}\n          </div>\n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => setMissingEmployeesDialogOpen(false)}\n              data-testid=\"button-close-missing-employees\"\n            >\n              Chiudi\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog per aggiungere nuovo cliente */}\n      <Dialog open={addClientDialogOpen} onOpenChange={setAddClientDialogOpen}>\n        <DialogContent className=\"sm:max-w-[425px]\">\n          <DialogHeader>\n            <DialogTitle>Aggiungi Nuovo Cliente</DialogTitle>\n            <DialogDescription>\n              Inserisci il nome del nuovo cliente.\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...clientForm}>\n            <form onSubmit={clientForm.handleSubmit(handleAddClient)} className=\"space-y-4\">\n              <FormField\n                control={clientForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Nome Cliente</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Es. Acme Corporation\" \n                        {...field} \n                        data-testid=\"input-client-name\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button \n                  type=\"button\" \n                  variant=\"outline\" \n                  onClick={() => setAddClientDialogOpen(false)}\n                  data-testid=\"button-cancel-add-client\"\n                >\n                  Annulla\n                </Button>\n                <Button \n                  type=\"submit\" \n                  disabled={createClientMutation.isPending}\n                  data-testid=\"button-submit-client\"\n                >\n                  {createClientMutation.isPending ? \"Aggiungendo...\" : \"Aggiungi Cliente\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog conferma eliminazione cliente */}\n      <AlertDialog open={deleteClientDialogOpen} onOpenChange={setDeleteClientDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Elimina Cliente</AlertDialogTitle>\n            <AlertDialogDescription>\n              Sei sicuro di voler eliminare il cliente \"{selectedClientToDelete?.name}\"?\n              {(clientWorkOrdersCount > 0 || clientOperationsCount > 0) && (\n                <span className=\"block mt-2 font-semibold text-destructive\">\n                  Questa operazione eliminerà anche:\n                  {clientWorkOrdersCount > 0 && (\n                    <span className=\"block\">• {clientWorkOrdersCount} {clientWorkOrdersCount === 1 ? 'commessa' : 'commesse'}</span>\n                  )}\n                  {clientOperationsCount > 0 && (\n                    <span className=\"block\">• {clientOperationsCount} {clientOperationsCount === 1 ? 'operazione' : 'operazioni'}</span>\n                  )}\n                </span>\n              )}\n              <span className=\"block mt-2\">\n                Questa azione non può essere annullata.\n              </span>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete-client\">Annulla</AlertDialogCancel>\n            <AlertDialogAction \n              onClick={confirmDeleteClient}\n              disabled={deleteClientMutation.isPending}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete-client\"\n            >\n              {deleteClientMutation.isPending ? \"Eliminando...\" : \"Elimina\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Dialog per modificare commessa */}\n      <Dialog open={editWorkOrderDialogOpen} onOpenChange={setEditWorkOrderDialogOpen}>\n        <DialogContent className=\"sm:max-w-[425px] max-h-[85vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Modifica Commessa</DialogTitle>\n            <DialogDescription>\n              Modifica i dati della commessa.\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...editWorkOrderForm}>\n            <form onSubmit={editWorkOrderForm.handleSubmit(handleUpdateWorkOrder)} className=\"space-y-4\">\n              <FormField\n                control={editWorkOrderForm.control}\n                name=\"clientId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Cliente</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-edit-client\">\n                          <SelectValue placeholder=\"Seleziona cliente\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {(clients as any[]).map((client: any) => (\n                          <SelectItem key={client.id} value={client.id}>\n                            {client.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={editWorkOrderForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Nome Commessa</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Es. Cancello Automatico\" \n                        {...field} \n                        data-testid=\"input-edit-work-order-name\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={editWorkOrderForm.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Descrizione (opzionale)</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Descrizione della commessa\" \n                        {...field} \n                        data-testid=\"input-edit-work-order-description\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={editWorkOrderForm.control}\n                name=\"availableWorkTypes\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Lavorazioni Disponibili</FormLabel>\n                    <div className=\"border rounded-md p-4 max-h-48 overflow-y-auto space-y-2\">\n                      {(workTypes as any[])\n                        .filter((wt: any) => wt.isActive)\n                        .map((workType: any) => (\n                          <label \n                            key={workType.id} \n                            className=\"flex items-center space-x-2 cursor-pointer hover-elevate p-2 rounded\"\n                          >\n                            <input\n                              type=\"checkbox\"\n                              checked={field.value?.includes(workType.id) || false}\n                              onChange={(e) => {\n                                const checked = e.target.checked;\n                                const newValue = checked\n                                  ? [...(field.value || []), workType.id]\n                                  : (field.value || []).filter((id: string) => id !== workType.id);\n                                field.onChange(newValue);\n                              }}\n                              className=\"h-4 w-4\"\n                              data-testid={`checkbox-edit-worktype-${workType.id}`}\n                            />\n                            <span className=\"text-sm\">{workType.name}</span>\n                          </label>\n                        ))}\n                      {(workTypes as any[]).filter((wt: any) => wt.isActive).length === 0 && (\n                        <p className=\"text-sm text-muted-foreground text-center py-2\">\n                          Nessuna lavorazione disponibile. Aggiungile nella tab Configurazione.\n                        </p>\n                      )}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={editWorkOrderForm.control}\n                name=\"availableMaterials\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Materiali Disponibili</FormLabel>\n                    <div className=\"border rounded-md p-4 max-h-48 overflow-y-auto space-y-2\">\n                      {(materials as any[])\n                        .filter((m: any) => m.isActive)\n                        .map((material: any) => (\n                          <label \n                            key={material.id} \n                            className=\"flex items-center space-x-2 cursor-pointer hover-elevate p-2 rounded\"\n                          >\n                            <input\n                              type=\"checkbox\"\n                              checked={field.value?.includes(material.id) || false}\n                              onChange={(e) => {\n                                const checked = e.target.checked;\n                                const newValue = checked\n                                  ? [...(field.value || []), material.id]\n                                  : (field.value || []).filter((id: string) => id !== material.id);\n                                field.onChange(newValue);\n                              }}\n                              className=\"h-4 w-4\"\n                              data-testid={`checkbox-edit-material-${material.id}`}\n                            />\n                            <span className=\"text-sm\">{material.name}</span>\n                          </label>\n                        ))}\n                      {(materials as any[]).filter((m: any) => m.isActive).length === 0 && (\n                        <p className=\"text-sm text-muted-foreground text-center py-2\">\n                          Nessun materiale disponibile. Aggiungili nella tab Configurazione.\n                        </p>\n                      )}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={editWorkOrderForm.control}\n                name=\"isActive\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                    <div className=\"space-y-0.5\">\n                      <FormLabel className=\"text-base\">\n                        Stato Commessa\n                      </FormLabel>\n                      <div className=\"text-sm text-muted-foreground\">\n                        {field.value ? \"Attiva\" : \"Archiviata\"}\n                      </div>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-edit-work-order-active\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button \n                  type=\"button\" \n                  variant=\"outline\" \n                  onClick={() => setEditWorkOrderDialogOpen(false)}\n                  data-testid=\"button-cancel-edit-work-order\"\n                >\n                  Annulla\n                </Button>\n                <Button \n                  type=\"submit\" \n                  disabled={updateWorkOrderMutation.isPending}\n                  data-testid=\"button-submit-edit-work-order\"\n                >\n                  {updateWorkOrderMutation.isPending ? \"Aggiornando...\" : \"Aggiorna Commessa\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog conferma eliminazione commessa */}\n      <AlertDialog open={deleteWorkOrderDialogOpen} onOpenChange={setDeleteWorkOrderDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Elimina Commessa</AlertDialogTitle>\n            <AlertDialogDescription>\n              Sei sicuro di voler eliminare la commessa \"{selectedWorkOrderToDelete?.name}\"?\n              <span className=\"block mt-2\">\n                Questa azione eliminerà la commessa e tutte le operazioni associate. Questa azione non può essere annullata.\n              </span>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete-work-order\">Annulla</AlertDialogCancel>\n            <AlertDialogAction \n              onClick={confirmDeleteWorkOrder}\n              disabled={deleteWorkOrderMutation.isPending}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete-work-order\"\n            >\n              {deleteWorkOrderMutation.isPending ? \"Eliminando...\" : \"Elimina\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Dialog per aggiungere tipo lavorazione */}\n      <Dialog open={addWorkTypeDialogOpen} onOpenChange={setAddWorkTypeDialogOpen}>\n        <DialogContent className=\"sm:max-w-[425px]\">\n          <DialogHeader>\n            <DialogTitle>Aggiungi Tipo Lavorazione</DialogTitle>\n            <DialogDescription>\n              Inserisci i dati del nuovo tipo di lavorazione.\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...workTypeForm}>\n            <form onSubmit={workTypeForm.handleSubmit(handleAddWorkType)} className=\"space-y-4\">\n              <FormField\n                control={workTypeForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Nome Lavorazione</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Es. Saldatura\" \n                        {...field} \n                        data-testid=\"input-work-type-name\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={workTypeForm.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Descrizione (opzionale)</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Descrizione della lavorazione\" \n                        {...field} \n                        data-testid=\"input-work-type-description\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={workTypeForm.control}\n                name=\"isActive\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                    <div className=\"space-y-0.5\">\n                      <FormLabel className=\"text-base\">\n                        Stato\n                      </FormLabel>\n                      <div className=\"text-sm text-muted-foreground\">\n                        {field.value ? \"Attiva\" : \"Non attiva\"}\n                      </div>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-work-type-active\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button \n                  type=\"button\" \n                  variant=\"outline\" \n                  onClick={() => setAddWorkTypeDialogOpen(false)}\n                  data-testid=\"button-cancel-add-work-type\"\n                >\n                  Annulla\n                </Button>\n                <Button \n                  type=\"submit\" \n                  disabled={createWorkTypeMutation.isPending}\n                  data-testid=\"button-submit-work-type\"\n                >\n                  {createWorkTypeMutation.isPending ? \"Aggiungendo...\" : \"Aggiungi Lavorazione\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog per modificare tipo lavorazione */}\n      <Dialog open={editWorkTypeDialogOpen} onOpenChange={setEditWorkTypeDialogOpen}>\n        <DialogContent className=\"sm:max-w-[425px]\">\n          <DialogHeader>\n            <DialogTitle>Modifica Tipo Lavorazione</DialogTitle>\n            <DialogDescription>\n              Modifica i dati del tipo di lavorazione.\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...workTypeForm}>\n            <form onSubmit={workTypeForm.handleSubmit(handleUpdateWorkType)} className=\"space-y-4\">\n              <FormField\n                control={workTypeForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Nome Lavorazione</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Es. Saldatura\" \n                        {...field} \n                        data-testid=\"input-edit-work-type-name\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={workTypeForm.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Descrizione (opzionale)</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Descrizione della lavorazione\" \n                        {...field} \n                        data-testid=\"input-edit-work-type-description\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={workTypeForm.control}\n                name=\"isActive\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                    <div className=\"space-y-0.5\">\n                      <FormLabel className=\"text-base\">\n                        Stato\n                      </FormLabel>\n                      <div className=\"text-sm text-muted-foreground\">\n                        {field.value ? \"Attiva\" : \"Non attiva\"}\n                      </div>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-edit-work-type-active\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button \n                  type=\"button\" \n                  variant=\"outline\" \n                  onClick={() => setEditWorkTypeDialogOpen(false)}\n                  data-testid=\"button-cancel-edit-work-type\"\n                >\n                  Annulla\n                </Button>\n                <Button \n                  type=\"submit\" \n                  disabled={updateWorkTypeMutation.isPending}\n                  data-testid=\"button-submit-edit-work-type\"\n                >\n                  {updateWorkTypeMutation.isPending ? \"Aggiornando...\" : \"Aggiorna Lavorazione\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog conferma eliminazione tipo lavorazione */}\n      <AlertDialog open={deleteWorkTypeDialogOpen} onOpenChange={setDeleteWorkTypeDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Elimina Tipo Lavorazione</AlertDialogTitle>\n            <AlertDialogDescription>\n              Sei sicuro di voler eliminare il tipo di lavorazione \"{selectedWorkType?.name}\"?\n              <span className=\"block mt-2\">\n                Questa azione non può essere annullata.\n              </span>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete-work-type\">Annulla</AlertDialogCancel>\n            <AlertDialogAction \n              onClick={confirmDeleteWorkType}\n              disabled={deleteWorkTypeMutation.isPending}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete-work-type\"\n            >\n              {deleteWorkTypeMutation.isPending ? \"Eliminando...\" : \"Elimina\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Dialog per aggiungere materiale */}\n      <Dialog open={addMaterialDialogOpen} onOpenChange={setAddMaterialDialogOpen}>\n        <DialogContent className=\"sm:max-w-[425px]\">\n          <DialogHeader>\n            <DialogTitle>Aggiungi Materiale</DialogTitle>\n            <DialogDescription>\n              Inserisci i dati del nuovo materiale.\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...materialForm}>\n            <form onSubmit={materialForm.handleSubmit(handleAddMaterial)} className=\"space-y-4\">\n              <FormField\n                control={materialForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Nome Materiale</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Es. Acciaio Inox\" \n                        {...field} \n                        data-testid=\"input-material-name\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={materialForm.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Descrizione (opzionale)</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Descrizione del materiale\" \n                        {...field} \n                        data-testid=\"input-material-description\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={materialForm.control}\n                name=\"isActive\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                    <div className=\"space-y-0.5\">\n                      <FormLabel className=\"text-base\">\n                        Stato\n                      </FormLabel>\n                      <div className=\"text-sm text-muted-foreground\">\n                        {field.value ? \"Attivo\" : \"Non attivo\"}\n                      </div>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-material-active\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button \n                  type=\"button\" \n                  variant=\"outline\" \n                  onClick={() => setAddMaterialDialogOpen(false)}\n                  data-testid=\"button-cancel-add-material\"\n                >\n                  Annulla\n                </Button>\n                <Button \n                  type=\"submit\" \n                  disabled={createMaterialMutation.isPending}\n                  data-testid=\"button-submit-material\"\n                >\n                  {createMaterialMutation.isPending ? \"Aggiungendo...\" : \"Aggiungi Materiale\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog per modificare materiale */}\n      <Dialog open={editMaterialDialogOpen} onOpenChange={setEditMaterialDialogOpen}>\n        <DialogContent className=\"sm:max-w-[425px]\">\n          <DialogHeader>\n            <DialogTitle>Modifica Materiale</DialogTitle>\n            <DialogDescription>\n              Modifica i dati del materiale.\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...materialForm}>\n            <form onSubmit={materialForm.handleSubmit(handleUpdateMaterial)} className=\"space-y-4\">\n              <FormField\n                control={materialForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Nome Materiale</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Es. Acciaio Inox\" \n                        {...field} \n                        data-testid=\"input-edit-material-name\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={materialForm.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Descrizione (opzionale)</FormLabel>\n                    <FormControl>\n                      <Input \n                        placeholder=\"Descrizione del materiale\" \n                        {...field} \n                        data-testid=\"input-edit-material-description\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={materialForm.control}\n                name=\"isActive\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                    <div className=\"space-y-0.5\">\n                      <FormLabel className=\"text-base\">\n                        Stato\n                      </FormLabel>\n                      <div className=\"text-sm text-muted-foreground\">\n                        {field.value ? \"Attivo\" : \"Non attivo\"}\n                      </div>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-edit-material-active\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button \n                  type=\"button\" \n                  variant=\"outline\" \n                  onClick={() => setEditMaterialDialogOpen(false)}\n                  data-testid=\"button-cancel-edit-material\"\n                >\n                  Annulla\n                </Button>\n                <Button \n                  type=\"submit\" \n                  disabled={updateMaterialMutation.isPending}\n                  data-testid=\"button-submit-edit-material\"\n                >\n                  {updateMaterialMutation.isPending ? \"Aggiornando...\" : \"Aggiorna Materiale\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog conferma eliminazione materiale */}\n      <AlertDialog open={deleteMaterialDialogOpen} onOpenChange={setDeleteMaterialDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Elimina Materiale</AlertDialogTitle>\n            <AlertDialogDescription>\n              Sei sicuro di voler eliminare il materiale \"{selectedMaterial?.name}\"?\n              <span className=\"block mt-2\">\n                Questa azione non può essere annullata.\n              </span>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete-material\">Annulla</AlertDialogCancel>\n            <AlertDialogAction \n              onClick={confirmDeleteMaterial}\n              disabled={deleteMaterialMutation.isPending}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete-material\"\n            >\n              {deleteMaterialMutation.isPending ? \"Eliminando...\" : \"Elimina\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Dialog per aggiustamento ore */}\n      <HoursAdjustmentDialog\n        open={hoursAdjustmentDialogOpen}\n        onOpenChange={setHoursAdjustmentDialogOpen}\n        dailyReportId={selectedReportForAdjustment || \"\"}\n        currentAdjustment={currentHoursAdjustment}\n      />\n\n      {/* Dialog per registrazione assenze */}\n      <Dialog open={registerAbsenceDialogOpen} onOpenChange={setRegisterAbsenceDialogOpen}>\n        <DialogContent className=\"sm:max-w-[500px]\">\n          <DialogHeader>\n            <DialogTitle>Registra Assenze</DialogTitle>\n            <DialogDescription>\n              Seleziona i dipendenti e registra le assenze per la data indicata.\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...registerAbsenceForm}>\n            <form onSubmit={registerAbsenceForm.handleSubmit((data) => registerAbsenceMutation.mutate(data))} className=\"space-y-4\">\n              <FormField\n                control={registerAbsenceForm.control}\n                name=\"date\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Data</FormLabel>\n                    <FormControl>\n                      <Input \n                        type=\"date\" \n                        {...field}\n                        data-testid=\"input-absence-date\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              \n              <FormField\n                control={registerAbsenceForm.control}\n                name=\"userIds\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Dipendenti</FormLabel>\n                    <div className=\"border rounded-md p-4 max-h-48 overflow-y-auto space-y-2\">\n                      {employees\n                        .filter((emp: any) => emp.role === 'employee' && emp.isActive)\n                        .map((employee: any) => (\n                          <label \n                            key={employee.id} \n                            className=\"flex items-center space-x-2 cursor-pointer hover-elevate p-2 rounded\"\n                          >\n                            <input\n                              type=\"checkbox\"\n                              checked={field.value.includes(employee.id)}\n                              onChange={(e) => {\n                                const checked = e.target.checked;\n                                const newValue = checked\n                                  ? [...field.value, employee.id]\n                                  : field.value.filter((id: string) => id !== employee.id);\n                                field.onChange(newValue);\n                              }}\n                              className=\"h-4 w-4\"\n                              data-testid={`checkbox-employee-${employee.id}`}\n                            />\n                            <span className=\"text-sm\">{employee.fullName}</span>\n                          </label>\n                        ))}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={registerAbsenceForm.control}\n                name=\"absenceType\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Tipo</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-absence-type\">\n                          <SelectValue placeholder=\"Seleziona tipo...\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"A\">A - Assenza</SelectItem>\n                        <SelectItem value=\"F\">F - Ferie</SelectItem>\n                        <SelectItem value=\"P\">P - Permesso</SelectItem>\n                        <SelectItem value=\"M\">M - Malattia</SelectItem>\n                        <SelectItem value=\"CP\">CP - Congedo Parentale</SelectItem>\n                        <SelectItem value=\"L104\">L104 - Legge 104</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={registerAbsenceForm.control}\n                name=\"notes\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Note (opzionale)</FormLabel>\n                    <FormControl>\n                      <Input \n                        {...field}\n                        placeholder=\"Note aggiuntive...\"\n                        data-testid=\"input-absence-notes\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <DialogFooter>\n                <Button \n                  type=\"button\" \n                  variant=\"outline\" \n                  onClick={() => setRegisterAbsenceDialogOpen(false)}\n                  data-testid=\"button-cancel-register-absence\"\n                >\n                  Annulla\n                </Button>\n                <Button \n                  type=\"submit\" \n                  disabled={registerAbsenceMutation.isPending}\n                  data-testid=\"button-submit-register-absence\"\n                >\n                  {registerAbsenceMutation.isPending ? \"Registrando...\" : \"Registra Assenze\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog Statistiche Assenze Dipendente */}\n      <Dialog open={employeeStatsDialogOpen} onOpenChange={setEmployeeStatsDialogOpen}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <BarChart2 className=\"h-5 w-5\" />\n              Statistiche Assenze - {selectedEmployeeForStats?.fullName}\n            </DialogTitle>\n            <DialogDescription>\n              Statistiche delle assenze negli ultimi 90 giorni\n            </DialogDescription>\n          </DialogHeader>\n          \n          {isLoadingEmployeeStats ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <div className=\"text-center\">\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2\"></div>\n                <p className=\"text-muted-foreground\">Caricamento statistiche...</p>\n              </div>\n            </div>\n          ) : employeeStats ? (\n            <div className=\"space-y-6\">\n              {/* KPI Cards */}\n              <div className=\"grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-4\">\n                <Card>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center justify-between gap-2\">\n                      <div>\n                        <p className=\"text-sm font-medium text-muted-foreground\">Totale Assenze (90gg)</p>\n                        <p className=\"text-2xl font-bold\">{employeeStats.totalAbsences || 0}</p>\n                      </div>\n                      <AlertTriangle className=\"h-6 w-6 text-warning\" />\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className={employeeStats.strategicAbsences > 0 ? \"border-orange-200 dark:border-orange-800\" : \"\"}>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center justify-between gap-2\">\n                      <div>\n                        <p className=\"text-sm font-medium text-muted-foreground\">Assenze Strategiche</p>\n                        <p className={`text-2xl font-bold ${employeeStats.strategicAbsences >= 5 ? 'text-red-600' : employeeStats.strategicAbsences >= 3 ? 'text-orange-600' : ''}`}>\n                          {employeeStats.strategicAbsences || 0}\n                        </p>\n                        {employeeStats.strategicPercentage > 0 && (\n                          <p className=\"text-xs text-muted-foreground\">\n                            {employeeStats.strategicPercentage}% delle assenze\n                          </p>\n                        )}\n                      </div>\n                      <Badge variant={employeeStats.strategicAbsences >= 5 ? \"destructive\" : employeeStats.strategicAbsences >= 3 ? \"secondary\" : \"outline\"} className=\"h-8 w-8 rounded-full p-0 flex items-center justify-center\">\n                        <AlertTriangle className=\"h-4 w-4\" />\n                      </Badge>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center justify-between gap-2\">\n                      <div>\n                        <p className=\"text-sm font-medium text-muted-foreground\">Tipo Più Comune</p>\n                        <p className=\"text-2xl font-bold\">\n                          {employeeStats.byType && Object.keys(employeeStats.byType).length > 0 \n                            ? (() => {\n                                const typeMap: Record<string, string> = {\n                                  'A': 'Assenza',\n                                  'F': 'Ferie',\n                                  'P': 'Permesso',\n                                  'M': 'Malattia',\n                                  'CP': 'Congedo',\n                                  'L104': 'L.104'\n                                };\n                                const sortedTypes = Object.entries(employeeStats.byType as Record<string, number>)\n                                  .sort((a, b) => b[1] - a[1]);\n                                return sortedTypes.length > 0 \n                                  ? (typeMap[sortedTypes[0][0]] || sortedTypes[0][0])\n                                  : '-';\n                              })()\n                            : '-'}\n                        </p>\n                      </div>\n                      <TrendingUp className=\"h-6 w-6 text-primary\" />\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-center justify-between gap-2\">\n                      <div>\n                        <p className=\"text-sm font-medium text-muted-foreground\">Giorno Picco</p>\n                        <p className=\"text-2xl font-bold\">\n                          {employeeStats.byDayOfWeek && Object.keys(employeeStats.byDayOfWeek).length > 0 \n                            ? (() => {\n                                const dayMap: Record<number, string> = {\n                                  0: 'Dom',\n                                  1: 'Lun',\n                                  2: 'Mar',\n                                  3: 'Mer',\n                                  4: 'Gio',\n                                  5: 'Ven',\n                                  6: 'Sab'\n                                };\n                                const sortedDays = Object.entries(employeeStats.byDayOfWeek as Record<number, number>)\n                                  .filter(([_, count]) => count > 0)\n                                  .sort((a, b) => b[1] - a[1]);\n                                return sortedDays.length > 0 \n                                  ? (dayMap[parseInt(sortedDays[0][0])] || '-')\n                                  : '-';\n                              })()\n                            : '-'}\n                        </p>\n                      </div>\n                      <Calendar className=\"h-6 w-6 text-muted-foreground\" />\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Charts Row */}\n              <div className=\"grid gap-4 grid-cols-1 lg:grid-cols-2\">\n                {/* Monthly Trend Chart */}\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <TrendingUp className=\"h-4 w-4\" />\n                      Trend Mensile\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {employeeStats.byMonth && employeeStats.byMonth.length > 0 ? (\n                      <ResponsiveContainer width=\"100%\" height={200}>\n                        <LineChart data={employeeStats.byMonth.slice().reverse()}>\n                          <CartesianGrid strokeDasharray=\"3 3\" />\n                          <XAxis \n                            dataKey=\"month\" \n                            tickFormatter={(value) => {\n                              const [year, month] = value.split('-');\n                              const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];\n                              return monthNames[parseInt(month) - 1] || value;\n                            }}\n                          />\n                          <YAxis />\n                          <RechartsTooltip \n                            formatter={(value: number) => [value, 'Assenze']}\n                            labelFormatter={(label) => {\n                              const [year, month] = label.split('-');\n                              const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];\n                              return `${monthNames[parseInt(month) - 1]} ${year}`;\n                            }}\n                          />\n                          <Line type=\"monotone\" dataKey=\"count\" stroke=\"hsl(var(--primary))\" strokeWidth={2} dot={{ r: 4 }} />\n                        </LineChart>\n                      </ResponsiveContainer>\n                    ) : (\n                      <div className=\"flex items-center justify-center py-8 text-muted-foreground\">\n                        Nessun dato disponibile\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n\n                {/* Absence by Type Chart */}\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-base flex items-center gap-2\">\n                      <BarChart2 className=\"h-4 w-4\" />\n                      Assenze per Tipo\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {employeeStats.byType && Object.keys(employeeStats.byType).length > 0 ? (\n                      <ResponsiveContainer width=\"100%\" height={200}>\n                        <BarChart data={Object.entries(employeeStats.byType as Record<string, number>).map(([type, count]) => {\n                          const typeMap: Record<string, string> = {\n                            'A': 'Assenza',\n                            'F': 'Ferie',\n                            'P': 'Permesso',\n                            'M': 'Malattia',\n                            'CP': 'Congedo',\n                            'L104': 'L.104'\n                          };\n                          return { type: typeMap[type] || type, count };\n                        })}>\n                          <CartesianGrid strokeDasharray=\"3 3\" />\n                          <XAxis dataKey=\"type\" />\n                          <YAxis />\n                          <RechartsTooltip formatter={(value: number) => [value, 'Assenze']} />\n                          <Bar dataKey=\"count\" fill=\"hsl(var(--primary))\" radius={[4, 4, 0, 0]} />\n                        </BarChart>\n                      </ResponsiveContainer>\n                    ) : (\n                      <div className=\"flex items-center justify-center py-8 text-muted-foreground\">\n                        Nessun dato disponibile\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Absence by Day of Week */}\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-base flex items-center gap-2\">\n                    <Calendar className=\"h-4 w-4\" />\n                    Assenze per Giorno della Settimana\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {employeeStats.byDayOfWeek && Object.values(employeeStats.byDayOfWeek).some(v => v > 0) ? (\n                    <ResponsiveContainer width=\"100%\" height={150}>\n                      <BarChart data={(() => {\n                        const dayNames = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];\n                        const byDayRecord = employeeStats.byDayOfWeek as Record<number, number>;\n                        return [1, 2, 3, 4, 5, 6, 0].map(dayNum => ({\n                          day: dayNames[dayNum],\n                          count: byDayRecord[dayNum] || 0\n                        }));\n                      })()}>\n                        <CartesianGrid strokeDasharray=\"3 3\" />\n                        <XAxis dataKey=\"day\" />\n                        <YAxis />\n                        <RechartsTooltip formatter={(value: number) => [value, 'Assenze']} />\n                        <Bar dataKey=\"count\" fill=\"hsl(var(--chart-2))\" radius={[4, 4, 0, 0]} />\n                      </BarChart>\n                    </ResponsiveContainer>\n                  ) : (\n                    <div className=\"flex items-center justify-center py-8 text-muted-foreground\">\n                      Nessun dato disponibile\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n          ) : (\n            <div className=\"flex items-center justify-center py-12 text-muted-foreground\">\n              Nessun dato disponibile per questo dipendente.\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n\n        <TabsContent value=\"rifornimenti\" className=\"space-y-6 mt-6\">\n          <Tabs defaultValue=\"refills\">\n            <TabsList>\n              <TabsTrigger value=\"refills\" data-testid=\"tab-refills\">\n                Rifornimenti\n              </TabsTrigger>\n              <TabsTrigger value=\"vehicles\" data-testid=\"tab-vehicles\">\n                Mezzi\n              </TabsTrigger>\n              <TabsTrigger value=\"statistics\" data-testid=\"tab-statistics\">\n                Statistiche\n              </TabsTrigger>\n            </TabsList>\n            <TabsContent value=\"refills\" className=\"mt-6\">\n              <FuelRefillsManagement />\n            </TabsContent>\n            <TabsContent value=\"vehicles\" className=\"mt-6\">\n              <VehiclesManagement />\n            </TabsContent>\n            <TabsContent value=\"statistics\" className=\"mt-6\">\n              <FuelStatistics />\n            </TabsContent>\n          </Tabs>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}","path":null,"size_bytes":223952,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2263,"size_tokens":null},"server/auth.ts":{"content":"import bcrypt from 'bcrypt';\n\nconst SALT_ROUNDS = 12;\n\nexport async function hashPassword(password: string): Promise<string> {\n  return bcrypt.hash(password, SALT_ROUNDS);\n}\n\nexport async function verifyPassword(password: string, hashedPassword: string): Promise<boolean> {\n  return bcrypt.compare(password, hashedPassword);\n}\n\n// Validazione password sicura\nexport function validatePassword(password: string): { isValid: boolean; errors: string[] } {\n  const errors: string[] = [];\n  \n  if (password.length < 8) {\n    errors.push('Password deve essere di almeno 8 caratteri');\n  }\n  \n  if (!/[A-Z]/.test(password)) {\n    errors.push('Password deve contenere almeno una lettera maiuscola');\n  }\n  \n  if (!/[a-z]/.test(password)) {\n    errors.push('Password deve contenere almeno una lettera minuscola');\n  }\n  \n  if (!/[0-9]/.test(password)) {\n    errors.push('Password deve contenere almeno un numero');\n  }\n  \n  return {\n    isValid: errors.length === 0,\n    errors\n  };\n}","path":null,"size_bytes":974,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"client/src/components/HoursAdjustmentDialog.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Button } from \"@/components/ui/button\";\nimport { Calculator } from \"lucide-react\";\n\nconst adjustmentSchema = z.object({\n  adjustment: z.string()\n    .min(1, \"L'aggiustamento è richiesto\")\n    .refine((val) => !isNaN(parseFloat(val)), \"Deve essere un numero valido\")\n    .refine((val) => parseFloat(val) !== 0, \"L'aggiustamento non può essere zero\"),\n  reason: z.string().optional(),\n});\n\ntype AdjustmentFormData = z.infer<typeof adjustmentSchema>;\n\ninterface HoursAdjustmentDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  dailyReportId: string;\n  currentAdjustment?: {\n    id: string;\n    adjustment: string;\n    reason?: string | null;\n  } | null;\n}\n\nexport function HoursAdjustmentDialog({\n  open,\n  onOpenChange,\n  dailyReportId,\n  currentAdjustment,\n}: HoursAdjustmentDialogProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [isDeleting, setIsDeleting] = useState(false);\n\n  const form = useForm<AdjustmentFormData>({\n    resolver: zodResolver(adjustmentSchema),\n    defaultValues: {\n      adjustment: currentAdjustment?.adjustment || \"\",\n      reason: currentAdjustment?.reason || \"\",\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: AdjustmentFormData) => {\n      return await apiRequest(\"POST\", \"/api/hours-adjustment\", {\n        dailyReportId,\n        adjustment: data.adjustment,\n        reason: data.reason || null,\n      });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Aggiustamento creato\",\n        description: \"L'aggiustamento ore è stato creato con successo\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-reports\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/hours-adjustment\", dailyReportId] });\n      onOpenChange(false);\n      form.reset();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Impossibile creare l'aggiustamento\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: AdjustmentFormData) => {\n      return await apiRequest(\"PATCH\", `/api/hours-adjustment/${currentAdjustment?.id}`, {\n        adjustment: data.adjustment,\n        reason: data.reason || null,\n      });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Aggiustamento aggiornato\",\n        description: \"L'aggiustamento ore è stato aggiornato con successo\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-reports\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/hours-adjustment\", dailyReportId] });\n      onOpenChange(false);\n      form.reset();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Impossibile aggiornare l'aggiustamento\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async () => {\n      return await apiRequest(\"DELETE\", `/api/hours-adjustment/${currentAdjustment?.id}`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Aggiustamento eliminato\",\n        description: \"L'aggiustamento ore è stato eliminato con successo\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-reports\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/hours-adjustment\", dailyReportId] });\n      onOpenChange(false);\n      form.reset();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Impossibile eliminare l'aggiustamento\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: AdjustmentFormData) => {\n    if (currentAdjustment) {\n      updateMutation.mutate(data);\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  const handleDelete = () => {\n    if (confirm(\"Sei sicuro di voler eliminare questo aggiustamento?\")) {\n      setIsDeleting(true);\n      deleteMutation.mutate();\n    }\n  };\n\n  const isPending = createMutation.isPending || updateMutation.isPending || deleteMutation.isPending;\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-[500px]\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Calculator className=\"h-5 w-5\" />\n            {currentAdjustment ? \"Modifica Aggiustamento Ore\" : \"Aggiungi Aggiustamento Ore\"}\n          </DialogTitle>\n        </DialogHeader>\n\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n            <FormField\n              control={form.control}\n              name=\"adjustment\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>\n                    Aggiustamento Ore\n                    <span className=\"text-xs text-muted-foreground ml-2\">\n                      (usa + o - per aggiungere/sottrarre ore, es: +0.5 o -1.5)\n                    </span>\n                  </FormLabel>\n                  <FormControl>\n                    <Input\n                      {...field}\n                      placeholder=\"+0.5 o -1.5\"\n                      data-testid=\"input-adjustment\"\n                      disabled={isPending}\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"reason\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Motivo (opzionale)</FormLabel>\n                  <FormControl>\n                    <Textarea\n                      {...field}\n                      placeholder=\"Es: Pausa pranzo non retribuita, straordinari approvati, ecc.\"\n                      rows={3}\n                      data-testid=\"input-reason\"\n                      disabled={isPending}\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <DialogFooter className=\"gap-2 sm:gap-0\">\n              {currentAdjustment && (\n                <Button\n                  type=\"button\"\n                  variant=\"destructive\"\n                  onClick={handleDelete}\n                  disabled={isPending}\n                  data-testid=\"button-delete-adjustment\"\n                >\n                  Elimina\n                </Button>\n              )}\n              <Button\n                type=\"submit\"\n                disabled={isPending}\n                data-testid=\"button-save-adjustment\"\n              >\n                {isPending ? \"Salvataggio...\" : currentAdjustment ? \"Aggiorna\" : \"Crea\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </Form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":7556,"size_tokens":null},"client/src/components/VehiclesManagement.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from \"@/components/ui/alert-dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, Edit, Trash, Truck, Search } from \"lucide-react\";\nimport type { Vehicle, InsertVehicle, UpdateVehicle } from \"@shared/schema\";\n\nconst vehicleSchema = z.object({\n  name: z.string().min(2, \"Il nome deve essere di almeno 2 caratteri\"),\n  licensePlate: z.string().min(2, \"La targa è richiesta\"),\n  fuelType: z.enum([\"benzina\", \"diesel\", \"gpl\", \"metano\", \"elettrico\"], {\n    required_error: \"Tipo carburante è richiesto\",\n  }),\n  isActive: z.boolean().default(true),\n});\n\ntype VehicleForm = z.infer<typeof vehicleSchema>;\n\nexport default function VehiclesManagement() {\n  const { toast } = useToast();\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [addDialogOpen, setAddDialogOpen] = useState(false);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [selectedVehicle, setSelectedVehicle] = useState<Vehicle | null>(null);\n\n  const addForm = useForm<VehicleForm>({\n    resolver: zodResolver(vehicleSchema),\n    defaultValues: {\n      name: \"\",\n      licensePlate: \"\",\n      fuelType: \"diesel\",\n      isActive: true,\n    },\n  });\n\n  const editForm = useForm<VehicleForm>({\n    resolver: zodResolver(vehicleSchema),\n    defaultValues: {\n      name: \"\",\n      licensePlate: \"\",\n      fuelType: \"diesel\",\n      isActive: true,\n    },\n  });\n\n  const { data: vehicles = [], isLoading } = useQuery({\n    queryKey: [\"/api/vehicles\"],\n  });\n\n  const createVehicleMutation = useMutation({\n    mutationFn: async (data: VehicleForm) => {\n      const response = await fetch(\"/api/vehicles\", {\n        method: \"POST\",\n        body: JSON.stringify(data),\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to create vehicle\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/vehicles\"] });\n      toast({\n        title: \"Mezzo aggiunto\",\n        description: \"Il mezzo è stato aggiunto con successo\",\n      });\n      setAddDialogOpen(false);\n      addForm.reset();\n    },\n    onError: () => {\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile aggiungere il mezzo\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateVehicleMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: UpdateVehicle }) => {\n      const response = await fetch(`/api/vehicles/${id}`, {\n        method: \"PATCH\",\n        body: JSON.stringify(data),\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to update vehicle\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/vehicles\"] });\n      toast({\n        title: \"Mezzo aggiornato\",\n        description: \"Il mezzo è stato aggiornato con successo\",\n      });\n      setEditDialogOpen(false);\n      editForm.reset();\n      setSelectedVehicle(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile aggiornare il mezzo\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteVehicleMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/vehicles/${id}`, {\n        method: \"DELETE\",\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to delete vehicle\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/vehicles\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/fuel-refills\"] });\n      toast({\n        title: \"Mezzo eliminato\",\n        description: \"Il mezzo e i suoi rifornimenti sono stati eliminati\",\n      });\n      setDeleteDialogOpen(false);\n      setSelectedVehicle(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile eliminare il mezzo\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleEdit = (vehicle: any) => {\n    setSelectedVehicle(vehicle);\n    editForm.reset({\n      name: vehicle.name,\n      licensePlate: vehicle.licensePlate,\n      fuelType: vehicle.fuelType as VehicleForm[\"fuelType\"],\n      isActive: vehicle.isActive,\n    });\n    setEditDialogOpen(true);\n  };\n\n  const handleDelete = (vehicle: any) => {\n    setSelectedVehicle(vehicle);\n    setDeleteDialogOpen(true);\n  };\n\n  const filteredVehicles = (vehicles as any[]).filter((vehicle: any) => {\n    if (!searchTerm) return true;\n    const search = searchTerm.toLowerCase();\n    return (\n      vehicle.name.toLowerCase().includes(search) ||\n      vehicle.licensePlate.toLowerCase().includes(search)\n    );\n  });\n\n  const getFuelTypeLabel = (fuelType: string) => {\n    const labels: Record<string, string> = {\n      benzina: \"Benzina\",\n      diesel: \"Diesel\",\n      gpl: \"GPL\",\n      metano: \"Metano\",\n      elettrico: \"Elettrico\",\n    };\n    return labels[fuelType] || fuelType;\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n            <div>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Truck className=\"h-5 w-5\" />\n                Gestione Mezzi\n              </CardTitle>\n            </div>\n            <Dialog open={addDialogOpen} onOpenChange={setAddDialogOpen}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"button-add-vehicle\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Aggiungi Mezzo\n                </Button>\n              </DialogTrigger>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Aggiungi Nuovo Mezzo</DialogTitle>\n                  <DialogDescription>\n                    Inserisci le informazioni del nuovo mezzo\n                  </DialogDescription>\n                </DialogHeader>\n                <Form {...addForm}>\n                  <form onSubmit={addForm.handleSubmit((data) => createVehicleMutation.mutate(data))} className=\"space-y-4\">\n                    <FormField\n                      control={addForm.control}\n                      name=\"name\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Nome/Descrizione</FormLabel>\n                          <FormControl>\n                            <Input {...field} placeholder=\"es: Furgone bianco\" data-testid=\"input-vehicle-name\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addForm.control}\n                      name=\"licensePlate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Targa</FormLabel>\n                          <FormControl>\n                            <Input {...field} placeholder=\"es: AB123CD\" data-testid=\"input-vehicle-plate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addForm.control}\n                      name=\"fuelType\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Tipo Carburante</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-vehicle-type\">\n                                <SelectValue placeholder=\"Seleziona tipo carburante\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"benzina\">Benzina</SelectItem>\n                              <SelectItem value=\"diesel\">Diesel</SelectItem>\n                              <SelectItem value=\"gpl\">GPL</SelectItem>\n                              <SelectItem value=\"metano\">Metano</SelectItem>\n                              <SelectItem value=\"elettrico\">Elettrico</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addForm.control}\n                      name=\"isActive\"\n                      render={({ field }) => (\n                        <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-3\">\n                          <div className=\"space-y-0.5\">\n                            <FormLabel>Mezzo Attivo</FormLabel>\n                          </div>\n                          <FormControl>\n                            <Switch\n                              checked={field.value}\n                              onCheckedChange={field.onChange}\n                              data-testid=\"switch-vehicle-active\"\n                            />\n                          </FormControl>\n                        </FormItem>\n                      )}\n                    />\n                    <DialogFooter>\n                      <Button type=\"button\" variant=\"outline\" onClick={() => setAddDialogOpen(false)}>\n                        Annulla\n                      </Button>\n                      <Button type=\"submit\" disabled={createVehicleMutation.isPending} data-testid=\"button-save-vehicle\">\n                        {createVehicleMutation.isPending ? \"Salvataggio...\" : \"Salva\"}\n                      </Button>\n                    </DialogFooter>\n                  </form>\n                </Form>\n              </DialogContent>\n            </Dialog>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"mb-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Cerca per nome o targa...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-8\"\n                data-testid=\"input-search-vehicles\"\n              />\n            </div>\n          </div>\n\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <div className=\"text-center\">\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2\"></div>\n                <p className=\"text-muted-foreground\">Caricamento mezzi...</p>\n              </div>\n            </div>\n          ) : filteredVehicles.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <p className=\"text-muted-foreground\">\n                {searchTerm ? \"Nessun mezzo trovato\" : \"Nessun mezzo registrato\"}\n              </p>\n            </div>\n          ) : (\n            <div className=\"rounded-md border\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Nome/Descrizione</TableHead>\n                    <TableHead>Targa</TableHead>\n                    <TableHead>Carburante</TableHead>\n                    <TableHead>Stato</TableHead>\n                    <TableHead className=\"text-right\">Azioni</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredVehicles.map((vehicle) => (\n                    <TableRow key={vehicle.id} data-testid={`row-vehicle-${vehicle.id}`}>\n                      <TableCell className=\"font-medium\">{vehicle.name}</TableCell>\n                      <TableCell>{vehicle.licensePlate}</TableCell>\n                      <TableCell>{getFuelTypeLabel(vehicle.fuelType)}</TableCell>\n                      <TableCell>\n                        <Badge variant={vehicle.isActive ? \"default\" : \"secondary\"}>\n                          {vehicle.isActive ? \"Attivo\" : \"Inattivo\"}\n                        </Badge>\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex justify-end gap-2\">\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => handleEdit(vehicle)}\n                            data-testid={`button-edit-vehicle-${vehicle.id}`}\n                          >\n                            <Edit className=\"h-4 w-4\" />\n                          </Button>\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => handleDelete(vehicle)}\n                            data-testid={`button-delete-vehicle-${vehicle.id}`}\n                          >\n                            <Trash className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Edit Dialog */}\n      <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Modifica Mezzo</DialogTitle>\n            <DialogDescription>\n              Modifica le informazioni del mezzo\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...editForm}>\n            <form onSubmit={editForm.handleSubmit((data) => {\n              if (selectedVehicle) {\n                updateVehicleMutation.mutate({ id: selectedVehicle.id, data });\n              }\n            })} className=\"space-y-4\">\n              <FormField\n                control={editForm.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Nome/Descrizione</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"es: Furgone bianco\" data-testid=\"input-edit-vehicle-name\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={editForm.control}\n                name=\"licensePlate\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Targa</FormLabel>\n                    <FormControl>\n                      <Input {...field} placeholder=\"es: AB123CD\" data-testid=\"input-edit-vehicle-plate\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={editForm.control}\n                name=\"fuelType\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Tipo Carburante</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-edit-vehicle-type\">\n                          <SelectValue placeholder=\"Seleziona tipo carburante\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"benzina\">Benzina</SelectItem>\n                        <SelectItem value=\"diesel\">Diesel</SelectItem>\n                        <SelectItem value=\"gpl\">GPL</SelectItem>\n                        <SelectItem value=\"metano\">Metano</SelectItem>\n                        <SelectItem value=\"elettrico\">Elettrico</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={editForm.control}\n                name=\"isActive\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-3\">\n                    <div className=\"space-y-0.5\">\n                      <FormLabel>Mezzo Attivo</FormLabel>\n                    </div>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-edit-vehicle-active\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button type=\"button\" variant=\"outline\" onClick={() => setEditDialogOpen(false)}>\n                  Annulla\n                </Button>\n                <Button type=\"submit\" disabled={updateVehicleMutation.isPending} data-testid=\"button-update-vehicle\">\n                  {updateVehicleMutation.isPending ? \"Salvataggio...\" : \"Salva Modifiche\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Dialog */}\n      <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Conferma Eliminazione</AlertDialogTitle>\n            <AlertDialogDescription>\n              Sei sicuro di voler eliminare il mezzo \"{selectedVehicle?.name}\"?\n              Questa azione eliminerà anche tutti i rifornimenti associati e non può essere annullata.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete-vehicle\">Annulla</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => {\n                if (selectedVehicle) {\n                  deleteVehicleMutation.mutate(selectedVehicle.id);\n                }\n              }}\n              disabled={deleteVehicleMutation.isPending}\n              data-testid=\"button-confirm-delete-vehicle\"\n            >\n              {deleteVehicleMutation.isPending ? \"Eliminazione...\" : \"Elimina\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":20046,"size_tokens":null},"client/src/components/FuelRefillsManagement.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from \"@/components/ui/alert-dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { formatDateToItalian } from \"@/lib/dateUtils\";\nimport { Plus, Edit, Trash, Fuel, Filter, Download } from \"lucide-react\";\nimport type { FuelRefill, Vehicle } from \"@shared/schema\";\n\nconst fuelRefillSchema = z.object({\n  vehicleId: z.string().min(1, \"Mezzo è richiesto\"),\n  refillDate: z.string().min(1, \"Data è richiesta\"),\n  refillTime: z.string().min(1, \"Ora è richiesta\"),\n  litersBefore: z.string().min(1, \"Litri prima è richiesto\"),\n  litersAfter: z.string().min(1, \"Litri dopo è richiesto\"),\n  km: z.string().optional(),\n  hours: z.string().optional(),\n  notes: z.string().optional(),\n});\n\nconst fuelTankLoadSchema = z.object({\n  loadDate: z.string().min(1, \"Data è richiesta\"),\n  loadTime: z.string().min(1, \"Ora è richiesta\"),\n  liters: z.string().min(1, \"Litri è richiesto\"),\n  totalCost: z.string().optional(),\n  supplier: z.string().optional(),\n  notes: z.string().optional(),\n});\n\ntype FuelRefillForm = z.infer<typeof fuelRefillSchema>;\ntype FuelTankLoadForm = z.infer<typeof fuelTankLoadSchema>;\n\nexport default function FuelRefillsManagement() {\n  const { toast } = useToast();\n  const [vehicleFilter, setVehicleFilter] = useState(\"all\");\n  const [monthFilter, setMonthFilter] = useState(\"all\");\n  const [yearFilter, setYearFilter] = useState(\"all\");\n  const [typeFilter, setTypeFilter] = useState(\"all\");\n  const [addDialogOpen, setAddDialogOpen] = useState(false);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [selectedRefill, setSelectedRefill] = useState<any | null>(null);\n  const [addLoadDialogOpen, setAddLoadDialogOpen] = useState(false);\n\n\n  const addForm = useForm<FuelRefillForm>({\n    resolver: zodResolver(fuelRefillSchema),\n    defaultValues: {\n      vehicleId: \"\",\n      refillDate: new Date().toISOString().split('T')[0],\n      refillTime: new Date().toTimeString().slice(0,5),\n      litersBefore: \"\",\n      litersAfter: \"\",\n      km: \"\",\n      hours: \"\",\n      notes: \"\",\n    },\n  });\n\n  const editForm = useForm<FuelRefillForm>({\n    resolver: zodResolver(fuelRefillSchema),\n    defaultValues: {\n      vehicleId: \"\",\n      refillDate: \"\",\n      refillTime: \"\",\n      litersBefore: \"\",\n      litersAfter: \"\",\n      km: \"\",\n      hours: \"\",\n      notes: \"\",\n    },\n  });\n\n  const loadForm = useForm<FuelTankLoadForm>({\n    resolver: zodResolver(fuelTankLoadSchema),\n    defaultValues: {\n      loadDate: new Date().toISOString().split('T')[0],\n      loadTime: new Date().toTimeString().slice(0,5),\n      liters: \"\",\n      totalCost: \"\",\n      supplier: \"\",\n      notes: \"\",\n    },\n  });\n\n  const { data: vehicles = [], isLoading: isLoadingVehicles } = useQuery({\n    queryKey: [\"/api/vehicles\"],\n  });\n\n  const { data: refills = [], isLoading: isLoadingRefills } = useQuery({\n    queryKey: [\"/api/fuel-refills\"],\n  });\n\n  const { data: currentUser } = useQuery({\n    queryKey: [\"/api/me\"],\n  });\n\n  const { data: fuelRemainingData } = useQuery({\n    queryKey: [\"/api/fuel-remaining\"],\n  });\n\n  const { data: tankLoads = [], isLoading: isLoadingTankLoads } = useQuery({\n    queryKey: [\"/api/fuel-tank-loads\"],\n  });\n\n  const remainingLiters = (fuelRemainingData as any)?.remaining || 0;\n\n  // Effect to precompile \"Litri Prima\" when opening the add refill dialog\n  useEffect(() => {\n    if (addDialogOpen && refills && (refills as any[]).length > 0) {\n      // Get the most recent refill by date\n      const sortedRefills = [...(refills as any[])].sort((a, b) => \n        new Date(b.refillDate).getTime() - new Date(a.refillDate).getTime()\n      );\n      const lastRefill = sortedRefills[0];\n      if (lastRefill?.litersAfter) {\n        addForm.setValue('litersBefore', lastRefill.litersAfter.toString());\n      }\n    }\n  }, [addDialogOpen, refills, addForm]);\n\n  const createRefillMutation = useMutation({\n    mutationFn: async (data: FuelRefillForm) => {\n      const refillDateTime = `${data.refillDate}T${data.refillTime}:00`;\n      const litersBefore = parseFloat(data.litersBefore);\n      const litersAfter = parseFloat(data.litersAfter);\n      const litersRefilled = litersAfter - litersBefore;\n      \n      const payload = {\n        vehicleId: data.vehicleId,\n        refillDate: refillDateTime,\n        operatorId: (currentUser as any)?.id,\n        litersBefore: litersBefore.toString(),\n        litersAfter: litersAfter.toString(),\n        litersRefilled: litersRefilled.toString(),\n        kmReading: data.km ? parseFloat(data.km).toString() : null,\n        engineHoursReading: data.hours ? parseFloat(data.hours).toString() : null,\n        notes: data.notes || null,\n      };\n      const response = await fetch(\"/api/fuel-refills\", {\n        method: \"POST\",\n        body: JSON.stringify(payload),\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to create fuel refill\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/fuel-refills\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/fuel-remaining\"] });\n      toast({\n        title: \"Rifornimento registrato\",\n        description: \"Il rifornimento è stato registrato con successo\",\n      });\n      setAddDialogOpen(false);\n      addForm.reset();\n    },\n    onError: () => {\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile registrare il rifornimento\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateRefillMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: FuelRefillForm }) => {\n      const refillDateTime = `${data.refillDate}T${data.refillTime}:00`;\n      const litersBefore = parseFloat(data.litersBefore);\n      const litersAfter = parseFloat(data.litersAfter);\n      const litersRefilled = litersAfter - litersBefore;\n      \n      const payload = {\n        vehicleId: data.vehicleId,\n        refillDate: refillDateTime,\n        litersBefore: litersBefore.toString(),\n        litersAfter: litersAfter.toString(),\n        litersRefilled: litersRefilled.toString(),\n        kmReading: data.km ? parseFloat(data.km).toString() : null,\n        engineHoursReading: data.hours ? parseFloat(data.hours).toString() : null,\n        notes: data.notes || null,\n      };\n      const response = await fetch(`/api/fuel-refills/${id}`, {\n        method: \"PATCH\",\n        body: JSON.stringify(payload),\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to update fuel refill\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/fuel-refills\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/fuel-remaining\"] });\n      toast({\n        title: \"Rifornimento aggiornato\",\n        description: \"Il rifornimento è stato aggiornato con successo\",\n      });\n      setEditDialogOpen(false);\n      editForm.reset();\n      setSelectedRefill(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile aggiornare il rifornimento\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteRefillMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/fuel-refills/${id}`, {\n        method: \"DELETE\",\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to delete fuel refill\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/fuel-refills\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/fuel-remaining\"] });\n      toast({\n        title: \"Rifornimento eliminato\",\n        description: \"Il rifornimento è stato eliminato con successo\",\n      });\n      setDeleteDialogOpen(false);\n      setSelectedRefill(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile eliminare il rifornimento\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createTankLoadMutation = useMutation({\n    mutationFn: async (data: FuelTankLoadForm) => {\n      const loadDateTime = `${data.loadDate}T${data.loadTime}:00`;\n      const payload = {\n        loadDate: loadDateTime,\n        liters: parseFloat(data.liters),\n        totalCost: data.totalCost ? parseFloat(data.totalCost) : null,\n        supplier: data.supplier || null,\n        notes: data.notes || null,\n      };\n      const response = await fetch(\"/api/fuel-tank-loads\", {\n        method: \"POST\",\n        body: JSON.stringify(payload),\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to create fuel tank load\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/fuel-tank-loads\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/fuel-remaining\"] });\n      toast({\n        title: \"Carico registrato\",\n        description: \"Il carico della cisterna è stato registrato con successo\",\n      });\n      setAddLoadDialogOpen(false);\n      loadForm.reset();\n    },\n    onError: () => {\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile registrare il carico\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteTankLoadMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/fuel-tank-loads/${id}`, {\n        method: \"DELETE\",\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to delete fuel tank load\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/fuel-tank-loads\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/fuel-remaining\"] });\n      toast({\n        title: \"Carico eliminato\",\n        description: \"Il carico è stato eliminato con successo\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile eliminare il carico\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleEdit = (refill: any) => {\n    setSelectedRefill(refill);\n    const refillDateTime = new Date(refill.refillDate);\n    const date = refillDateTime.toISOString().split('T')[0];\n    const time = refillDateTime.toTimeString().slice(0,5);\n    editForm.reset({\n      vehicleId: refill.vehicleId,\n      refillDate: date,\n      refillTime: time,\n      litersBefore: refill.litersBefore?.toString() || \"\",\n      litersAfter: refill.litersAfter?.toString() || \"\",\n      km: refill.kmReading?.toString() || \"\",\n      hours: refill.engineHoursReading?.toString() || \"\",\n      notes: refill.notes || \"\",\n    });\n    setEditDialogOpen(true);\n  };\n\n  const handleDelete = (refill: any) => {\n    setSelectedRefill(refill);\n    setDeleteDialogOpen(true);\n  };\n\n  // Unisce refills e tankLoads in un unico array con campo \"type\"\n  const unifiedMovements = [\n    ...(refills as any[]).map((refill: any) => ({\n      ...refill,\n      type: 'scarico',\n      date: new Date(refill.refillDate),\n    })),\n    ...(tankLoads as any[]).map((load: any) => ({\n      ...load,\n      type: 'carico',\n      date: new Date(load.loadDate),\n    }))\n  ].sort((a, b) => b.date.getTime() - a.date.getTime());\n\n  const filteredMovements = unifiedMovements.filter((movement: any) => {\n    const movementDate = movement.date;\n    const movementMonth = (movementDate.getMonth() + 1).toString();\n    const movementYear = movementDate.getFullYear().toString();\n    \n    // Filtro per tipo\n    if (typeFilter !== \"all\" && movement.type !== typeFilter) return false;\n    \n    // Filtro per veicolo (solo per scarichi)\n    if (vehicleFilter !== \"all\" && movement.type === 'scarico' && movement.vehicleId !== vehicleFilter) return false;\n    \n    // Filtri per data\n    if (monthFilter !== \"all\" && movementMonth !== monthFilter) return false;\n    if (yearFilter !== \"all\" && movementYear !== yearFilter) return false;\n    \n    return true;\n  });\n\n  // Manteniamo anche filteredRefills per compatibilità con codice esistente\n  const filteredRefills = (refills as any[]).filter((refill: any) => {\n    const refillDate = new Date(refill.refillDate);\n    const refillMonth = (refillDate.getMonth() + 1).toString();\n    const refillYear = refillDate.getFullYear().toString();\n    \n    if (vehicleFilter !== \"all\" && refill.vehicleId !== vehicleFilter) return false;\n    if (monthFilter !== \"all\" && refillMonth !== monthFilter) return false;\n    if (yearFilter !== \"all\" && refillYear !== yearFilter) return false;\n    \n    return true;\n  });\n\n  const getVehicleName = (vehicleId: string) => {\n    const vehicle = (vehicles as any[]).find((v: any) => v.id === vehicleId);\n    return vehicle ? `${vehicle.name} (${vehicle.licensePlate})` : \"Sconosciuto\";\n  };\n\n  const litersBefore = addForm.watch(\"litersBefore\");\n  const litersAfter = addForm.watch(\"litersAfter\");\n  const editLitersBefore = editForm.watch(\"litersBefore\");\n  const editLitersAfter = editForm.watch(\"litersAfter\");\n\n  const calculateDispensed = (before: string, after: string) => {\n    const b = parseFloat(before);\n    const a = parseFloat(after);\n    if (isNaN(b) || isNaN(a)) return \"-\";\n    return (a - b).toFixed(2);\n  };\n\n  const handleExport = async () => {\n    try {\n      const params = new URLSearchParams();\n      if (vehicleFilter !== \"all\") params.append(\"vehicleId\", vehicleFilter);\n      if (monthFilter !== \"all\") params.append(\"month\", monthFilter);\n      if (yearFilter !== \"all\") params.append(\"year\", yearFilter);\n\n      const response = await fetch(`/api/fuel-refills/export?${params.toString()}`, {\n        method: \"GET\",\n        credentials: \"include\",\n      });\n\n      if (!response.ok) throw new Error(\"Export failed\");\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = response.headers.get(\"Content-Disposition\")?.split(\"filename=\")[1]?.replace(/\"/g, \"\") || \"rifornimenti.xlsx\";\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n\n      toast({\n        title: \"Export completato\",\n        description: \"Il file Excel è stato scaricato con successo\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile esportare i dati\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Litri Rimanenti Card */}\n      <Card className=\"border-l-4 border-l-primary\">\n        <CardHeader>\n          <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n            Litri Rimanenti in Cisterna\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-4xl font-bold text-primary\">\n            {parseFloat(remainingLiters as any).toFixed(2)} L\n          </div>\n          <p className=\"text-sm text-muted-foreground mt-2\">\n            Carburante disponibile per i mezzi\n          </p>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-3\">\n              <CardTitle className=\"flex items-center gap-2\">\n                <Fuel className=\"h-5 w-5\" />\n                Gestione Rifornimenti\n              </CardTitle>\n              <Button \n                variant=\"outline\" \n                size=\"icon\"\n                onClick={handleExport} \n                data-testid=\"button-export-refills\"\n                title=\"Esporta Excel\"\n              >\n                <Download className=\"h-4 w-4\" />\n              </Button>\n            </div>\n            <div className=\"flex gap-2\">\n              <Dialog open={addLoadDialogOpen} onOpenChange={setAddLoadDialogOpen}>\n                <DialogTrigger asChild>\n                  <Button variant=\"secondary\" data-testid=\"button-add-load\">\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Carico\n                  </Button>\n                </DialogTrigger>\n                <DialogContent className=\"max-w-xl\">\n                  <DialogHeader>\n                    <DialogTitle>Registra Carico Cisterna</DialogTitle>\n                    <DialogDescription>\n                      Inserisci i dettagli del carico di carburante nella cisterna\n                    </DialogDescription>\n                  </DialogHeader>\n                  <Form {...loadForm}>\n                    <form onSubmit={loadForm.handleSubmit((data) => createTankLoadMutation.mutate(data))} className=\"space-y-4\">\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <FormField\n                          control={loadForm.control}\n                          name=\"loadDate\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Data</FormLabel>\n                              <FormControl>\n                                <Input {...field} type=\"date\" data-testid=\"input-load-date\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={loadForm.control}\n                          name=\"loadTime\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>Ora</FormLabel>\n                              <FormControl>\n                                <Input {...field} type=\"time\" data-testid=\"input-load-time\" />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                      </div>\n\n                      <FormField\n                        control={loadForm.control}\n                        name=\"liters\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Litri Caricati</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"number\" step=\"0.01\" placeholder=\"0.00\" data-testid=\"input-load-liters\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={loadForm.control}\n                        name=\"totalCost\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Costo Totale (€)</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"number\" step=\"0.01\" placeholder=\"0.00\" data-testid=\"input-load-cost\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={loadForm.control}\n                        name=\"supplier\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Fornitore</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"Nome fornitore\" data-testid=\"input-load-supplier\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={loadForm.control}\n                        name=\"notes\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Note</FormLabel>\n                            <FormControl>\n                              <Textarea {...field} placeholder=\"Note aggiuntive\" data-testid=\"textarea-load-notes\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <DialogFooter>\n                        <Button type=\"submit\" disabled={createTankLoadMutation.isPending} data-testid=\"button-submit-load\">\n                          {createTankLoadMutation.isPending ? \"Salvataggio...\" : \"Registra Carico\"}\n                        </Button>\n                      </DialogFooter>\n                    </form>\n                  </Form>\n                </DialogContent>\n              </Dialog>\n              \n              <Dialog open={addDialogOpen} onOpenChange={setAddDialogOpen}>\n              <DialogTrigger asChild>\n                <Button variant=\"default\" data-testid=\"button-add-refill\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Scarico\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle>Registra Nuovo Rifornimento</DialogTitle>\n                  <DialogDescription>\n                    Inserisci i dettagli del rifornimento\n                  </DialogDescription>\n                </DialogHeader>\n                <Form {...addForm}>\n                  <form onSubmit={addForm.handleSubmit((data) => createRefillMutation.mutate(data))} className=\"space-y-4\">\n                    <FormField\n                      control={addForm.control}\n                      name=\"vehicleId\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Mezzo</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-refill-vehicle\">\n                                <SelectValue placeholder=\"Seleziona mezzo\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              {(vehicles as any[])\n                                .filter((v: any) => v.isActive)\n                                .map((vehicle: any) => (\n                                  <SelectItem key={vehicle.id} value={vehicle.id}>\n                                    {vehicle.name} ({vehicle.licensePlate})\n                                  </SelectItem>\n                                ))}\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={addForm.control}\n                        name=\"refillDate\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Data</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"date\" data-testid=\"input-refill-date\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={addForm.control}\n                        name=\"refillTime\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Ora</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"time\" data-testid=\"input-refill-time\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={addForm.control}\n                        name=\"litersBefore\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Litri Prima</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"number\" step=\"0.01\" placeholder=\"0.00\" data-testid=\"input-refill-liters-before\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={addForm.control}\n                        name=\"litersAfter\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Litri Dopo</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"number\" step=\"0.01\" placeholder=\"0.00\" data-testid=\"input-refill-liters-after\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <div className=\"p-3 bg-muted rounded-md\">\n                      <p className=\"text-sm font-medium\">Litri Erogati: {calculateDispensed(litersBefore, litersAfter)}</p>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <FormField\n                        control={addForm.control}\n                        name=\"km\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Km (opzionale)</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"number\" step=\"0.01\" placeholder=\"0.00\" data-testid=\"input-refill-km\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                      <FormField\n                        control={addForm.control}\n                        name=\"hours\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Ore Motore (opzionale)</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"number\" step=\"0.01\" placeholder=\"0.00\" data-testid=\"input-refill-hours\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <FormField\n                      control={addForm.control}\n                      name=\"notes\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Note (opzionale)</FormLabel>\n                          <FormControl>\n                            <Textarea {...field} placeholder=\"Note aggiuntive...\" rows={3} data-testid=\"input-refill-notes\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <DialogFooter>\n                      <Button type=\"button\" variant=\"outline\" onClick={() => setAddDialogOpen(false)}>\n                        Annulla\n                      </Button>\n                      <Button type=\"submit\" disabled={createRefillMutation.isPending} data-testid=\"button-save-refill\">\n                        {createRefillMutation.isPending ? \"Salvataggio...\" : \"Salva\"}\n                      </Button>\n                    </DialogFooter>\n                  </form>\n                </Form>\n              </DialogContent>\n            </Dialog>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"mb-4 space-y-3\">\n            <div className=\"flex flex-col md:flex-row items-start md:items-center gap-3\">\n              <div className=\"flex items-center gap-2 w-full md:w-auto\">\n                <Filter className=\"h-4 w-4 text-muted-foreground\" />\n                <Select value={typeFilter} onValueChange={setTypeFilter}>\n                  <SelectTrigger className=\"w-full md:w-40\" data-testid=\"select-filter-type\">\n                    <SelectValue placeholder=\"Tipo\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Tutti</SelectItem>\n                    <SelectItem value=\"carico\">Carico</SelectItem>\n                    <SelectItem value=\"scarico\">Scarico</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"flex items-center gap-2 w-full md:w-auto\">\n                <Select value={vehicleFilter} onValueChange={setVehicleFilter}>\n                  <SelectTrigger className=\"w-full md:w-64\" data-testid=\"select-filter-vehicle\">\n                    <SelectValue placeholder=\"Tutti i mezzi\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Tutti i mezzi</SelectItem>\n                    {(vehicles as any[]).map((vehicle: any) => (\n                      <SelectItem key={vehicle.id} value={vehicle.id}>\n                        {vehicle.name} ({vehicle.licensePlate})\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div className=\"flex items-center gap-2 w-full md:w-auto\">\n                <Select value={monthFilter} onValueChange={setMonthFilter}>\n                  <SelectTrigger className=\"w-full md:w-40\" data-testid=\"select-filter-month\">\n                    <SelectValue placeholder=\"Tutti i mesi\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Tutti i mesi</SelectItem>\n                    <SelectItem value=\"1\">Gennaio</SelectItem>\n                    <SelectItem value=\"2\">Febbraio</SelectItem>\n                    <SelectItem value=\"3\">Marzo</SelectItem>\n                    <SelectItem value=\"4\">Aprile</SelectItem>\n                    <SelectItem value=\"5\">Maggio</SelectItem>\n                    <SelectItem value=\"6\">Giugno</SelectItem>\n                    <SelectItem value=\"7\">Luglio</SelectItem>\n                    <SelectItem value=\"8\">Agosto</SelectItem>\n                    <SelectItem value=\"9\">Settembre</SelectItem>\n                    <SelectItem value=\"10\">Ottobre</SelectItem>\n                    <SelectItem value=\"11\">Novembre</SelectItem>\n                    <SelectItem value=\"12\">Dicembre</SelectItem>\n                  </SelectContent>\n                </Select>\n                \n                <Select value={yearFilter} onValueChange={setYearFilter}>\n                  <SelectTrigger className=\"w-full md:w-32\" data-testid=\"select-filter-year\">\n                    <SelectValue placeholder=\"Anno\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Tutti gli anni</SelectItem>\n                    <SelectItem value=\"2024\">2024</SelectItem>\n                    <SelectItem value=\"2025\">2025</SelectItem>\n                    <SelectItem value=\"2026\">2026</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          </div>\n\n          {isLoadingRefills || isLoadingVehicles || isLoadingTankLoads ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <div className=\"text-center\">\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2\"></div>\n                <p className=\"text-muted-foreground\">Caricamento movimenti...</p>\n              </div>\n            </div>\n          ) : filteredMovements.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <p className=\"text-muted-foreground\">\n                Nessun movimento registrato\n              </p>\n            </div>\n          ) : (\n            <div className=\"rounded-md border\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Tipo</TableHead>\n                    <TableHead>Data/Ora</TableHead>\n                    <TableHead>Dettagli</TableHead>\n                    <TableHead className=\"text-right\">Litri</TableHead>\n                    <TableHead className=\"text-right\">Info</TableHead>\n                    <TableHead className=\"text-right\">Azioni</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredMovements.map((movement: any) => (\n                    <TableRow key={`${movement.type}-${movement.id}`} data-testid={`row-movement-${movement.id}`}>\n                      <TableCell>\n                        <span className={`inline-flex px-2 py-1 rounded text-xs font-medium ${\n                          movement.type === 'carico' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'\n                        }`}>\n                          {movement.type === 'carico' ? 'Carico' : 'Scarico'}\n                        </span>\n                      </TableCell>\n                      <TableCell>\n                        {formatDateToItalian(movement.type === 'carico' ? movement.loadDate : movement.refillDate)}{' '}\n                        {movement.date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}\n                      </TableCell>\n                      <TableCell>\n                        {movement.type === 'scarico' ? (\n                          <div>\n                            <div className=\"font-medium\">{getVehicleName(movement.vehicleId)}</div>\n                            <div className=\"text-xs text-muted-foreground\">\n                              {movement.litersBefore && movement.litersAfter && `${parseFloat(movement.litersBefore).toFixed(1)}L → ${parseFloat(movement.litersAfter).toFixed(1)}L`}\n                            </div>\n                          </div>\n                        ) : (\n                          <div>\n                            <div className=\"font-medium\">Cisterna</div>\n                            {movement.supplier && <div className=\"text-xs text-muted-foreground\">{movement.supplier}</div>}\n                          </div>\n                        )}\n                      </TableCell>\n                      <TableCell className=\"text-right font-medium\">\n                        {movement.type === 'scarico' \n                          ? `${movement.litersRefilled ? parseFloat(movement.litersRefilled).toFixed(2) : '-'} L`\n                          : `${movement.liters ? parseFloat(movement.liters).toFixed(2) : '-'} L`\n                        }\n                      </TableCell>\n                      <TableCell className=\"text-right text-sm text-muted-foreground\">\n                        {movement.type === 'scarico' ? (\n                          movement.kmReading ? `${parseFloat(movement.kmReading).toFixed(0)} km` : '-'\n                        ) : (\n                          movement.totalCost ? `€ ${parseFloat(movement.totalCost).toFixed(2)}` : '-'\n                        )}\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex justify-end gap-2\">\n                          {movement.type === 'scarico' ? (\n                            <>\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                onClick={() => handleEdit(movement)}\n                                data-testid={`button-edit-refill-${movement.id}`}\n                              >\n                                <Edit className=\"h-4 w-4\" />\n                              </Button>\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                onClick={() => handleDelete(movement)}\n                                data-testid={`button-delete-refill-${movement.id}`}\n                              >\n                                <Trash className=\"h-4 w-4\" />\n                              </Button>\n                            </>\n                          ) : (\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={() => {\n                                if (window.confirm(\"Sei sicuro di voler eliminare questo carico?\")) {\n                                  deleteTankLoadMutation.mutate(movement.id);\n                                }\n                              }}\n                              data-testid={`button-delete-tank-load-${movement.id}`}\n                            >\n                              <Trash className=\"h-4 w-4\" />\n                            </Button>\n                          )}\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Edit Dialog */}\n      <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Modifica Rifornimento</DialogTitle>\n            <DialogDescription>\n              Modifica i dettagli del rifornimento\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...editForm}>\n            <form onSubmit={editForm.handleSubmit((data) => {\n              if (selectedRefill) {\n                updateRefillMutation.mutate({ id: selectedRefill.id, data });\n              }\n            })} className=\"space-y-4\">\n              <FormField\n                control={editForm.control}\n                name=\"vehicleId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Mezzo</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-edit-refill-vehicle\">\n                          <SelectValue placeholder=\"Seleziona mezzo\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        {(vehicles as any[])\n                          .filter((v: any) => v.isActive)\n                          .map((vehicle: any) => (\n                            <SelectItem key={vehicle.id} value={vehicle.id}>\n                              {vehicle.name} ({vehicle.licensePlate})\n                            </SelectItem>\n                          ))}\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={editForm.control}\n                  name=\"refillDate\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Data</FormLabel>\n                      <FormControl>\n                        <Input {...field} type=\"date\" data-testid=\"input-edit-refill-date\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={editForm.control}\n                  name=\"refillTime\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Ora</FormLabel>\n                      <FormControl>\n                        <Input {...field} type=\"time\" data-testid=\"input-edit-refill-time\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={editForm.control}\n                  name=\"litersBefore\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Litri Prima</FormLabel>\n                      <FormControl>\n                        <Input {...field} type=\"number\" step=\"0.01\" placeholder=\"0.00\" data-testid=\"input-edit-refill-liters-before\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={editForm.control}\n                  name=\"litersAfter\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Litri Dopo</FormLabel>\n                      <FormControl>\n                        <Input {...field} type=\"number\" step=\"0.01\" placeholder=\"0.00\" data-testid=\"input-edit-refill-liters-after\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"p-3 bg-muted rounded-md\">\n                <p className=\"text-sm font-medium\">Litri Erogati: {calculateDispensed(editLitersBefore, editLitersAfter)}</p>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={editForm.control}\n                  name=\"km\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Km (opzionale)</FormLabel>\n                      <FormControl>\n                        <Input {...field} type=\"number\" step=\"0.01\" placeholder=\"0.00\" data-testid=\"input-edit-refill-km\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={editForm.control}\n                  name=\"hours\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Ore Motore (opzionale)</FormLabel>\n                      <FormControl>\n                        <Input {...field} type=\"number\" step=\"0.01\" placeholder=\"0.00\" data-testid=\"input-edit-refill-hours\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <FormField\n                control={editForm.control}\n                name=\"notes\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Note (opzionale)</FormLabel>\n                    <FormControl>\n                      <Textarea {...field} placeholder=\"Note aggiuntive...\" rows={3} data-testid=\"input-edit-refill-notes\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <DialogFooter>\n                <Button type=\"button\" variant=\"outline\" onClick={() => setEditDialogOpen(false)}>\n                  Annulla\n                </Button>\n                <Button type=\"submit\" disabled={updateRefillMutation.isPending} data-testid=\"button-update-refill\">\n                  {updateRefillMutation.isPending ? \"Salvataggio...\" : \"Salva Modifiche\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Dialog */}\n      <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Conferma Eliminazione</AlertDialogTitle>\n            <AlertDialogDescription>\n              Sei sicuro di voler eliminare questo rifornimento?\n              Questa azione non può essere annullata.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete-refill\">Annulla</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => {\n                if (selectedRefill) {\n                  deleteRefillMutation.mutate(selectedRefill.id);\n                }\n              }}\n              disabled={deleteRefillMutation.isPending}\n              data-testid=\"button-confirm-delete-refill\"\n            >\n              {deleteRefillMutation.isPending ? \"Eliminazione...\" : \"Elimina\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n    </div>\n  );\n}\n","path":null,"size_bytes":47058,"size_tokens":null},"client/src/components/FuelStatistics.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } from \"recharts\";\nimport { TrendingUp, Calendar } from \"lucide-react\";\n\nexport default function FuelStatistics() {\n  const currentYear = new Date().getFullYear().toString();\n  const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');\n  \n  const [selectedYear, setSelectedYear] = useState(currentYear);\n  const [selectedMonth, setSelectedMonth] = useState(\"all\");\n  \n  const { data: statistics, isLoading } = useQuery({\n    queryKey: [\"/api/fuel-refills/statistics\", selectedYear, selectedMonth],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (selectedYear !== \"all\") params.append(\"year\", selectedYear);\n      if (selectedMonth !== \"all\") params.append(\"month\", selectedMonth);\n      \n      const response = await fetch(`/api/fuel-refills/statistics?${params.toString()}`, {\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch statistics\");\n      return response.json();\n    },\n  });\n\n  const years = Array.from({ length: 5 }, (_, i) => (parseInt(currentYear) - i).toString());\n  const months = [\n    { value: \"01\", label: \"Gennaio\" },\n    { value: \"02\", label: \"Febbraio\" },\n    { value: \"03\", label: \"Marzo\" },\n    { value: \"04\", label: \"Aprile\" },\n    { value: \"05\", label: \"Maggio\" },\n    { value: \"06\", label: \"Giugno\" },\n    { value: \"07\", label: \"Luglio\" },\n    { value: \"08\", label: \"Agosto\" },\n    { value: \"09\", label: \"Settembre\" },\n    { value: \"10\", label: \"Ottobre\" },\n    { value: \"11\", label: \"Novembre\" },\n    { value: \"12\", label: \"Dicembre\" },\n  ];\n\n  const monthNames: Record<string, string> = {\n    \"01\": \"Gen\", \"02\": \"Feb\", \"03\": \"Mar\", \"04\": \"Apr\",\n    \"05\": \"Mag\", \"06\": \"Giu\", \"07\": \"Lug\", \"08\": \"Ago\",\n    \"09\": \"Set\", \"10\": \"Ott\", \"11\": \"Nov\", \"12\": \"Dic\"\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Filtri */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Calendar className=\"h-5 w-5\" />\n            Filtri Periodo\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <label className=\"text-sm font-medium mb-2 block\">Anno</label>\n              <Select value={selectedYear} onValueChange={setSelectedYear}>\n                <SelectTrigger data-testid=\"select-stats-year\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Tutti gli anni</SelectItem>\n                  {years.map((year) => (\n                    <SelectItem key={year} value={year}>\n                      {year}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <label className=\"text-sm font-medium mb-2 block\">Mese</label>\n              <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n                <SelectTrigger data-testid=\"select-stats-month\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Tutti i mesi</SelectItem>\n                  {months.map((month) => (\n                    <SelectItem key={month.value} value={month.value}>\n                      {month.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {isLoading ? (\n        <div className=\"text-center py-12 text-muted-foreground\">Caricamento statistiche...</div>\n      ) : !statistics ? (\n        <div className=\"text-center py-12 text-muted-foreground\">Nessun dato disponibile</div>\n      ) : (\n        <>\n          {/* Consumi per Mezzo */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <TrendingUp className=\"h-5 w-5\" />\n                Consumi per Mezzo\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {statistics.byVehicle && statistics.byVehicle.length > 0 ? (\n                <ResponsiveContainer width=\"100%\" height={400}>\n                  <BarChart data={statistics.byVehicle}>\n                    <CartesianGrid strokeDasharray=\"3 3\" />\n                    <XAxis \n                      dataKey=\"vehicleName\" \n                      angle={-45}\n                      textAnchor=\"end\"\n                      height={100}\n                    />\n                    <YAxis />\n                    <Tooltip />\n                    <Legend />\n                    <Bar dataKey=\"totalLiters\" fill=\"hsl(var(--primary))\" name=\"Litri Totali\" />\n                    <Bar dataKey=\"refillCount\" fill=\"hsl(var(--secondary))\" name=\"N° Rifornimenti\" />\n                  </BarChart>\n                </ResponsiveContainer>\n              ) : (\n                <div className=\"text-center py-12 text-muted-foreground\">\n                  Nessun dato disponibile per il periodo selezionato\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Andamento Mensile */}\n          {selectedMonth === \"all\" && statistics.byMonth && statistics.byMonth.length > 0 && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <TrendingUp className=\"h-5 w-5\" />\n                  Andamento Erogazioni nel Tempo\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <ResponsiveContainer width=\"100%\" height={400}>\n                  <LineChart data={statistics.byMonth}>\n                    <CartesianGrid strokeDasharray=\"3 3\" />\n                    <XAxis \n                      dataKey=\"month\"\n                      tickFormatter={(value) => monthNames[value] || value}\n                    />\n                    <YAxis />\n                    <Tooltip \n                      labelFormatter={(value) => `${monthNames[value as string] || value}`}\n                    />\n                    <Legend />\n                    <Line \n                      type=\"monotone\" \n                      dataKey=\"totalLiters\" \n                      stroke=\"hsl(var(--primary))\" \n                      name=\"Litri Erogati\"\n                      strokeWidth={2}\n                    />\n                    <Line \n                      type=\"monotone\" \n                      dataKey=\"refillCount\" \n                      stroke=\"hsl(var(--secondary))\" \n                      name=\"N° Rifornimenti\"\n                      strokeWidth={2}\n                    />\n                  </LineChart>\n                </ResponsiveContainer>\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Tabella Riepilogo per Mezzo */}\n          {statistics.byVehicle && statistics.byVehicle.length > 0 && (\n            <Card>\n              <CardHeader>\n                <CardTitle>Riepilogo Dettagliato per Mezzo</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"rounded-md border\">\n                  <table className=\"w-full\">\n                    <thead>\n                      <tr className=\"border-b bg-muted/50\">\n                        <th className=\"p-3 text-left font-medium\">Mezzo</th>\n                        <th className=\"p-3 text-right font-medium\">Litri Totali</th>\n                        <th className=\"p-3 text-right font-medium\">N° Rifornimenti</th>\n                        <th className=\"p-3 text-right font-medium\">Media per Rifornimento</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {statistics.byVehicle.map((vehicle: any) => (\n                        <tr key={vehicle.vehicleId} className=\"border-b\" data-testid={`row-stats-vehicle-${vehicle.vehicleId}`}>\n                          <td className=\"p-3\">{vehicle.vehicleName}</td>\n                          <td className=\"p-3 text-right font-medium\">{parseFloat(vehicle.totalLiters).toFixed(2)} L</td>\n                          <td className=\"p-3 text-right\">{vehicle.refillCount}</td>\n                          <td className=\"p-3 text-right\">\n                            {vehicle.refillCount > 0 \n                              ? (parseFloat(vehicle.totalLiters) / vehicle.refillCount).toFixed(2) \n                              : \"0.00\"} L\n                          </td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":9126,"size_tokens":null},"server/txtService.ts":{"content":"import { storage } from './storage';\nimport { DailyReport, Operation, User, Client, WorkOrder } from '@shared/schema';\n\nexport class TxtService {\n  \n  async generateDailyReportTxt(date: string, organizationId: string): Promise<string> {\n    const reports = await storage.getDailyReportsByDate(date, organizationId);\n    \n    if (reports.length === 0) {\n      // Format date in Italian format for user-friendly error message\n      const [year, month, day] = date.split('-');\n      const italianDate = `${day}/${month}/${year}`;\n      throw new Error(`Nessun rapportino trovato per la data ${italianDate}. Verifica che ci siano rapportini approvati per questa data.`);\n    }\n\n    // Get all related data\n    const clients = await storage.getAllClients(organizationId);\n    const clientsMap = new Map(clients.map(c => [c.id, c]));\n    \n    // Get all work orders\n    const allWorkOrders: WorkOrder[] = [];\n    for (const client of clients) {\n      const workOrders = await storage.getWorkOrdersByClient(client.id, organizationId);\n      allWorkOrders.push(...workOrders);\n    }\n    const workOrdersMap = new Map(allWorkOrders.map(wo => [wo.id, wo]));\n\n    // Get all hours adjustments for these reports\n    const adjustmentsPromises = reports.map(r => storage.getHoursAdjustment(r.id, organizationId));\n    const adjustments = await Promise.all(adjustmentsPromises);\n    const adjustmentsMap = new Map(\n      adjustments\n        .filter((adj): adj is NonNullable<typeof adj> => adj !== undefined && adj !== null)\n        .map(adj => [adj.dailyReportId, adj])\n    );\n\n    // Build text content\n    let txtContent = '';\n    \n    // Document header\n    txtContent += '='.repeat(80) + '\\n';\n    txtContent += ' '.repeat(20) + 'METALTEC Scoccia S.R.L.\\n';\n    txtContent += ' '.repeat(15) + `Rapportini Giornalieri - ${this.formatDate(date)}\\n`;\n    txtContent += '='.repeat(80) + '\\n\\n';\n    \n    // Build content for each employee\n    for (let i = 0; i < reports.length; i++) {\n      const report = reports[i];\n      const user = await storage.getUser(report.employeeId);\n      const operations = await storage.getOperationsByReportId(report.id);\n      const adjustment = adjustmentsMap.get(report.id);\n      \n      if (user && operations.length > 0) {\n        txtContent += this.createEmployeeSection(\n          user,\n          report,\n          operations,\n          clientsMap,\n          workOrdersMap,\n          adjustment\n        );\n        \n        // Add separator between employees\n        if (i < reports.length - 1) {\n          txtContent += '\\n' + '-'.repeat(80) + '\\n\\n';\n        }\n      }\n    }\n\n    txtContent += '\\n' + '='.repeat(80) + '\\n';\n    txtContent += ' '.repeat(30) + 'Fine Rapportini\\n';\n    txtContent += '='.repeat(80) + '\\n';\n\n    return txtContent;\n  }\n\n  // Calculate hours from the hours field (which is already a string like \"3.5\")\n  private parseHours(hoursStr: string): number {\n    const hours = parseFloat(hoursStr);\n    return isNaN(hours) ? 0 : hours;\n  }\n\n  private createEmployeeSection(\n    user: User,\n    report: DailyReport,\n    operations: Operation[],\n    clientsMap: Map<string, Client>,\n    workOrdersMap: Map<string, WorkOrder>,\n    adjustment?: any\n  ): string {\n    \n    let totalHours = operations.reduce((sum, op) => sum + this.parseHours(op.hours), 0);\n    const originalHours = totalHours;\n    \n    // Apply hours adjustment if exists\n    if (adjustment) {\n      const adjustmentValue = parseFloat(adjustment.adjustment);\n      if (!isNaN(adjustmentValue)) {\n        totalHours += adjustmentValue;\n      }\n    }\n\n    let section = '';\n    \n    // Employee header\n    section += `DIPENDENTE: ${user.fullName}\\n`;\n    section += `ORE TOTALI: ${totalHours.toFixed(2)}`;\n    \n    if (adjustment) {\n      const adjustmentValue = parseFloat(adjustment.adjustment);\n      section += ` (Originali: ${originalHours.toFixed(2)}, Aggiustamento: ${adjustmentValue >= 0 ? '+' : ''}${adjustmentValue.toFixed(2)})`;\n    }\n    section += '\\n\\n';\n\n    // Group operations by client and work order\n    const groupedOps = this.groupOperationsByClientAndWorkOrder(operations, clientsMap, workOrdersMap);\n    \n    for (const [clientName, workOrders] of Array.from(groupedOps)) {\n      section += `Cliente: ${clientName}\\n`;\n      \n      for (const [workOrderName, ops] of Array.from(workOrders)) {\n        section += `  Commessa: ${workOrderName}\\n`;\n        \n        for (let i = 0; i < ops.length; i++) {\n          const op = ops[i];\n          section += `    Operazione ${i + 1}:\\n`;\n          section += `      Ore: ${parseFloat(op.hours).toFixed(2)}\\n`;\n          \n          if (op.workTypes && op.workTypes.length > 0) {\n            section += `      Lavorazioni: ${op.workTypes.join(', ')}\\n`;\n          }\n          \n          if (op.materials && op.materials.length > 0) {\n            section += `      Materiali: ${op.materials.join(', ')}\\n`;\n          }\n          \n          if (op.notes && op.notes.trim()) {\n            section += `      Note: ${op.notes}\\n`;\n          }\n          \n          section += '\\n';\n        }\n      }\n    }\n\n    // Add adjustment note if exists\n    if (adjustment && adjustment.notes && adjustment.notes.trim()) {\n      section += `NOTE AGGIUSTAMENTO ORE: ${adjustment.notes}\\n\\n`;\n    }\n\n    return section;\n  }\n\n  private groupOperationsByClientAndWorkOrder(\n    operations: Operation[],\n    clientsMap: Map<string, Client>,\n    workOrdersMap: Map<string, WorkOrder>\n  ): Map<string, Map<string, Operation[]>> {\n    const grouped = new Map<string, Map<string, Operation[]>>();\n    \n    for (const op of operations) {\n      const workOrder = workOrdersMap.get(op.workOrderId);\n      const client = workOrder ? clientsMap.get(workOrder.clientId) : undefined;\n      \n      const clientName = client?.name || 'Cliente sconosciuto';\n      const workOrderName = workOrder?.name || 'Commessa sconosciuta';\n      \n      if (!grouped.has(clientName)) {\n        grouped.set(clientName, new Map());\n      }\n      \n      const clientGroup = grouped.get(clientName)!;\n      if (!clientGroup.has(workOrderName)) {\n        clientGroup.set(workOrderName, []);\n      }\n      \n      clientGroup.get(workOrderName)!.push(op);\n    }\n    \n    return grouped;\n  }\n\n  private formatDate(date: string): string {\n    const [year, month, day] = date.split('-');\n    const dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));\n    const options: Intl.DateTimeFormatOptions = { \n      weekday: 'long', \n      year: 'numeric', \n      month: 'long', \n      day: 'numeric' \n    };\n    return dateObj.toLocaleDateString('it-IT', options);\n  }\n\n  async generateDailyReportTxtRange(filters: {\n    fromDate?: string;\n    toDate?: string;\n    status?: string;\n    searchTerm?: string;\n  }, organizationId: string): Promise<string> {\n    // Get all reports\n    let allReports = await storage.getAllDailyReports(organizationId);\n    \n    // Apply filters\n    let filteredReports = allReports;\n    \n    // Filter by date range\n    if (filters.fromDate || filters.toDate) {\n      filteredReports = filteredReports.filter(report => {\n        const reportDate = report.date;\n        \n        if (filters.fromDate && filters.toDate) {\n          return reportDate >= filters.fromDate && reportDate <= filters.toDate;\n        } else if (filters.fromDate) {\n          return reportDate >= filters.fromDate;\n        } else if (filters.toDate) {\n          return reportDate <= filters.toDate;\n        }\n        return true;\n      });\n    }\n    \n    // Filter by status\n    if (filters.status && filters.status !== 'all') {\n      filteredReports = filteredReports.filter(report => report.status === filters.status);\n    }\n    \n    // Filter by search term (employee name)\n    if (filters.searchTerm) {\n      const users = await storage.getAllUsers(organizationId);\n      const usersMap = new Map(users.map(u => [u.id, u]));\n      filteredReports = filteredReports.filter(report => {\n        const user = usersMap.get(report.employeeId);\n        return user?.fullName.toLowerCase().includes(filters.searchTerm!.toLowerCase());\n      });\n    }\n    \n    if (filteredReports.length === 0) {\n      throw new Error('Nessun rapportino trovato con i filtri specificati.');\n    }\n\n    // Get all related data\n    const clients = await storage.getAllClients(organizationId);\n    const clientsMap = new Map(clients.map(c => [c.id, c]));\n    \n    // Get all work orders\n    const allWorkOrders: WorkOrder[] = [];\n    for (const client of clients) {\n      const workOrders = await storage.getWorkOrdersByClient(client.id, organizationId);\n      allWorkOrders.push(...workOrders);\n    }\n    const workOrdersMap = new Map(allWorkOrders.map(wo => [wo.id, wo]));\n\n    // Get all hours adjustments for these reports\n    const adjustmentsPromises = filteredReports.map(r => storage.getHoursAdjustment(r.id, organizationId));\n    const adjustments = await Promise.all(adjustmentsPromises);\n    const adjustmentsMap = new Map(\n      adjustments\n        .filter((adj): adj is NonNullable<typeof adj> => adj !== undefined && adj !== null)\n        .map(adj => [adj.dailyReportId, adj])\n    );\n\n    // Build text content\n    let txtContent = '';\n    \n    // Document header\n    txtContent += '='.repeat(80) + '\\n';\n    txtContent += ' '.repeat(20) + 'METALTEC Scoccia S.R.L.\\n';\n    \n    // Dynamic title based on filters\n    let title = 'Rapportini Giornalieri';\n    if (filters.fromDate && filters.toDate) {\n      title += ` dal ${this.formatDate(filters.fromDate)} al ${this.formatDate(filters.toDate)}`;\n    } else if (filters.fromDate) {\n      title += ` da ${this.formatDate(filters.fromDate)}`;\n    } else if (filters.toDate) {\n      title += ` fino al ${this.formatDate(filters.toDate)}`;\n    }\n    \n    txtContent += ' '.repeat(Math.max(0, (80 - title.length) / 2)) + title + '\\n';\n    txtContent += '='.repeat(80) + '\\n\\n';\n    \n    // Sort reports by date and employee name for better organization\n    const sortedReports = filteredReports.sort((a, b) => {\n      const dateCompare = a.date.localeCompare(b.date);\n      if (dateCompare !== 0) return dateCompare;\n      return a.employeeId.localeCompare(b.employeeId);\n    });\n    \n    // Build content for each employee\n    for (let i = 0; i < sortedReports.length; i++) {\n      const report = sortedReports[i];\n      const user = await storage.getUser(report.employeeId);\n      const operations = await storage.getOperationsByReportId(report.id);\n      const adjustment = adjustmentsMap.get(report.id);\n      \n      if (user && operations.length > 0) {\n        // Add date header if it changed\n        if (i === 0 || sortedReports[i - 1].date !== report.date) {\n          if (i > 0) {\n            txtContent += '\\n';\n          }\n          txtContent += `DATA: ${this.formatDate(report.date)}\\n`;\n          txtContent += '-'.repeat(80) + '\\n\\n';\n        }\n        \n        txtContent += this.createEmployeeSection(\n          user,\n          report,\n          operations,\n          clientsMap,\n          workOrdersMap,\n          adjustment\n        );\n        \n        // Add separator between employees\n        if (i < sortedReports.length - 1) {\n          txtContent += '\\n' + '-'.repeat(80) + '\\n\\n';\n        }\n      }\n    }\n\n    txtContent += '\\n' + '='.repeat(80) + '\\n';\n    txtContent += ' '.repeat(30) + 'Fine Rapportini\\n';\n    txtContent += '='.repeat(80) + '\\n';\n\n    return txtContent;\n  }\n}\n\nexport const txtService = new TxtService();\n","path":null,"size_bytes":11421,"size_tokens":null},"README.md":{"content":"# rapportini360\n","path":null,"size_bytes":16,"size_tokens":null},"client/src/components/SuperAdminDashboard.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Building2,\n  Plus,\n  UserPlus,\n  Power,\n  PowerOff,\n  Loader2,\n} from \"lucide-react\";\nimport { formatDateToItalian } from \"@/lib/dateUtils\";\n\ntype Organization = {\n  id: string;\n  name: string;\n  isActive: boolean;\n  createdAt: string;\n};\n\nexport default function SuperAdminDashboard() {\n  const { toast } = useToast();\n  const [createOrgOpen, setCreateOrgOpen] = useState(false);\n  const [createAdminOpen, setCreateAdminOpen] = useState(false);\n  const [selectedOrg, setSelectedOrg] = useState<Organization | null>(null);\n  const [newOrgName, setNewOrgName] = useState(\"\");\n  const [newAdminUsername, setNewAdminUsername] = useState(\"\");\n  const [newAdminPassword, setNewAdminPassword] = useState(\"\");\n  const [newAdminFullName, setNewAdminFullName] = useState(\"\");\n\n  const { data: organizations, isLoading } = useQuery<Organization[]>({\n    queryKey: [\"/api/superadmin/organizations\"],\n  });\n\n  const createOrgMutation = useMutation({\n    mutationFn: async (name: string) => {\n      const response = await apiRequest(\"POST\", \"/api/superadmin/organizations\", { name });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/superadmin/organizations\"] });\n      setCreateOrgOpen(false);\n      setNewOrgName(\"\");\n      toast({\n        title: \"Organizzazione creata\",\n        description: \"L'organizzazione è stata creata con successo.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Impossibile creare l'organizzazione.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const toggleOrgStatusMutation = useMutation({\n    mutationFn: async ({ id, isActive }: { id: string; isActive: boolean }) => {\n      const response = await apiRequest(\"PUT\", `/api/superadmin/organizations/${id}/status`, { isActive });\n      return response.json();\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/superadmin/organizations\"] });\n      toast({\n        title: variables.isActive ? \"Organizzazione attivata\" : \"Organizzazione disattivata\",\n        description: `L'organizzazione è stata ${variables.isActive ? \"attivata\" : \"disattivata\"} con successo.`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Errore\",\n        description: \"Impossibile modificare lo stato dell'organizzazione.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createAdminMutation = useMutation({\n    mutationFn: async ({ orgId, username, password, fullName }: { orgId: string; username: string; password: string; fullName: string }) => {\n      const response = await apiRequest(\"POST\", `/api/superadmin/organizations/${orgId}/admin`, { username, password, fullName });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/superadmin/organizations\"] });\n      setCreateAdminOpen(false);\n      setSelectedOrg(null);\n      setNewAdminUsername(\"\");\n      setNewAdminPassword(\"\");\n      setNewAdminFullName(\"\");\n      toast({\n        title: \"Admin creato\",\n        description: \"L'amministratore è stato creato con successo.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Errore\",\n        description: error.message || \"Impossibile creare l'amministratore.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleCreateOrg = () => {\n    if (!newOrgName.trim()) {\n      toast({\n        title: \"Errore\",\n        description: \"Inserisci un nome per l'organizzazione.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createOrgMutation.mutate(newOrgName.trim());\n  };\n\n  const handleCreateAdmin = () => {\n    if (!newAdminUsername.trim() || !newAdminPassword.trim() || !newAdminFullName.trim()) {\n      toast({\n        title: \"Errore\",\n        description: \"Compila tutti i campi.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    if (!selectedOrg) return;\n    \n    createAdminMutation.mutate({\n      orgId: selectedOrg.id,\n      username: newAdminUsername.trim(),\n      password: newAdminPassword.trim(),\n      fullName: newAdminFullName.trim(),\n    });\n  };\n\n  const openCreateAdminDialog = (org: Organization) => {\n    setSelectedOrg(org);\n    setNewAdminUsername(\"\");\n    setNewAdminPassword(\"\");\n    setNewAdminFullName(\"\");\n    setCreateAdminOpen(true);\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold\" data-testid=\"text-superadmin-title\">\n            Gestione Organizzazioni\n          </h2>\n          <p className=\"text-muted-foreground\">\n            Crea e gestisci le organizzazioni clienti\n          </p>\n        </div>\n\n        <Dialog open={createOrgOpen} onOpenChange={setCreateOrgOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-create-org\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Nuova Organizzazione\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Crea Nuova Organizzazione</DialogTitle>\n              <DialogDescription>\n                Inserisci il nome dell'organizzazione da creare.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"org-name\">Nome Organizzazione</Label>\n                <Input\n                  id=\"org-name\"\n                  placeholder=\"Es. Azienda SRL\"\n                  value={newOrgName}\n                  onChange={(e) => setNewOrgName(e.target.value)}\n                  data-testid=\"input-org-name\"\n                />\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setCreateOrgOpen(false)} data-testid=\"button-cancel-create-org\">\n                Annulla\n              </Button>\n              <Button\n                onClick={handleCreateOrg}\n                disabled={createOrgMutation.isPending}\n                data-testid=\"button-confirm-create-org\"\n              >\n                {createOrgMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n                Crea\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Building2 className=\"h-5 w-5\" />\n            Organizzazioni\n          </CardTitle>\n          <CardDescription>\n            Elenco di tutte le organizzazioni registrate\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin\" />\n            </div>\n          ) : !organizations || organizations.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Nessuna organizzazione trovata. Crea la prima organizzazione.\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Nome</TableHead>\n                  <TableHead>Stato</TableHead>\n                  <TableHead>Data Creazione</TableHead>\n                  <TableHead className=\"text-right\">Azioni</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {organizations.map((org) => (\n                  <TableRow key={org.id} data-testid={`row-org-${org.id}`}>\n                    <TableCell className=\"font-medium\">\n                      <div className=\"flex items-center gap-2\">\n                        <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n                        <span data-testid={`text-org-name-${org.id}`}>{org.name}</span>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant={org.isActive ? \"default\" : \"secondary\"} data-testid={`badge-org-status-${org.id}`}>\n                        {org.isActive ? \"Attiva\" : \"Disattivata\"}\n                      </Badge>\n                    </TableCell>\n                    <TableCell data-testid={`text-org-date-${org.id}`}>{formatDateToItalian(org.createdAt)}</TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center justify-end gap-2\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => openCreateAdminDialog(org)}\n                          data-testid={`button-add-admin-${org.id}`}\n                        >\n                          <UserPlus className=\"h-4 w-4 mr-1\" />\n                          Aggiungi Admin\n                        </Button>\n                        <Button\n                          size=\"sm\"\n                          variant={org.isActive ? \"destructive\" : \"default\"}\n                          onClick={() => toggleOrgStatusMutation.mutate({ id: org.id, isActive: !org.isActive })}\n                          disabled={toggleOrgStatusMutation.isPending}\n                          data-testid={`button-toggle-status-${org.id}`}\n                        >\n                          {org.isActive ? (\n                            <>\n                              <PowerOff className=\"h-4 w-4 mr-1\" />\n                              Disattiva\n                            </>\n                          ) : (\n                            <>\n                              <Power className=\"h-4 w-4 mr-1\" />\n                              Attiva\n                            </>\n                          )}\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={createAdminOpen} onOpenChange={setCreateAdminOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Crea Amministratore</DialogTitle>\n            <DialogDescription>\n              {selectedOrg && (\n                <span>Crea un nuovo amministratore per <strong>{selectedOrg.name}</strong></span>\n              )}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"admin-fullname\">Nome Completo</Label>\n              <Input\n                id=\"admin-fullname\"\n                placeholder=\"Es. Mario Rossi\"\n                value={newAdminFullName}\n                onChange={(e) => setNewAdminFullName(e.target.value)}\n                data-testid=\"input-admin-fullname\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"admin-username\">Username</Label>\n              <Input\n                id=\"admin-username\"\n                placeholder=\"Es. mario.rossi\"\n                value={newAdminUsername}\n                onChange={(e) => setNewAdminUsername(e.target.value)}\n                data-testid=\"input-admin-username\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"admin-password\">Password</Label>\n              <Input\n                id=\"admin-password\"\n                type=\"password\"\n                placeholder=\"Inserisci password\"\n                value={newAdminPassword}\n                onChange={(e) => setNewAdminPassword(e.target.value)}\n                data-testid=\"input-admin-password\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setCreateAdminOpen(false)} data-testid=\"button-cancel-create-admin\">\n              Annulla\n            </Button>\n            <Button\n              onClick={handleCreateAdmin}\n              disabled={createAdminMutation.isPending}\n              data-testid=\"button-confirm-create-admin\"\n            >\n              {createAdminMutation.isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              Crea Admin\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":13212,"size_tokens":null},"export_data.js":{"content":"const { Pool } = require('pg');\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: { rejectUnauthorized: false }\n});\n\nasync function escapeValue(val) {\n  if (val === null) return 'NULL';\n  if (typeof val === 'boolean') return val ? 'true' : 'false';\n  if (typeof val === 'number') return val.toString();\n  if (Array.isArray(val)) {\n    const escaped = val.map(v => v.replace(/\"/g, '\\\\\"')).join('\",\"');\n    return `'{\"${escaped}\"}'`;\n  }\n  if (typeof val === 'string') {\n    return \"'\" + val.replace(/'/g, \"''\").replace(/\\\\/g, '\\\\\\\\') + \"'\";\n  }\n  return \"'\" + String(val).replace(/'/g, \"''\") + \"'\";\n}\n\nasync function exportTable(tableName, columns) {\n  const result = await pool.query(`SELECT * FROM ${tableName}`);\n  const inserts = [];\n  \n  for (const row of result.rows) {\n    const values = await Promise.all(columns.map(col => escapeValue(row[col])));\n    inserts.push(`INSERT INTO ${tableName} (${columns.join(', ')}) VALUES (${values.join(', ')});`);\n  }\n  \n  return inserts.join('\\n');\n}\n\nasync function main() {\n  const tables = [\n    { name: 'organizations', cols: ['id', 'name', 'subdomain', 'logo', 'is_active', 'created_at'] },\n    { name: 'clients', cols: ['id', 'name', 'description', 'organization_id'] },\n    { name: 'users', cols: ['id', 'username', 'password', 'plain_password', 'role', 'full_name', 'is_active', 'organization_id'] },\n    { name: 'work_types', cols: ['id', 'name', 'description', 'organization_id'] },\n    { name: 'materials', cols: ['id', 'name', 'description', 'organization_id'] },\n    { name: 'work_orders', cols: ['id', 'code', 'description', 'client_id', 'is_active', 'organization_id'] },\n    { name: 'daily_reports', cols: ['id', 'employee_id', 'date', 'status', 'created_at', 'updated_at', 'organization_id'] },\n    { name: 'operations', cols: ['id', 'daily_report_id', 'client_id', 'work_order_id', 'work_types', 'hours', 'notes', 'materials', 'photos'] }\n  ];\n  \n  let output = '-- Metaltec Data Export - Generated with proper escaping\\n\\n';\n  \n  for (const table of tables) {\n    console.error(`Exporting ${table.name}...`);\n    const sql = await exportTable(table.name, table.cols);\n    output += `-- ${table.name}\\n${sql}\\n\\n`;\n  }\n  \n  console.log(output);\n  await pool.end();\n}\n\nmain().catch(console.error);\n","path":null,"size_bytes":2287,"size_tokens":null},"migrate.js":{"content":"import pg from 'pg';\n\nconst { Client } = pg;\n\nconst sourceUrl = process.env.DATABASE_URL; // Replit database\nconst targetUrl = \"postgresql://neondb_owner:npg_3HneIc0stbXv@ep-empty-dust-agik4hk2-pooler.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require\"; // Neon database\n\nasync function migrate() {\n  console.log('🚀 Starting migration...');\n  \n  // Connect to source (Replit)\n  const sourceClient = new Client({ connectionString: sourceUrl });\n  await sourceClient.connect();\n  console.log('✓ Connected to source database');\n  \n  // Connect to target (Neon)\n  const targetClient = new Client({ connectionString: targetUrl });\n  await targetClient.connect();\n  console.log('✓ Connected to target database');\n  \n  try {\n    // Get all tables\n    const tables = await sourceClient.query(`\n      SELECT tablename FROM pg_tables \n      WHERE schemaname = 'public'\n    `);\n    \n    console.log(`📋 Found ${tables.rows.length} tables to migrate`);\n    \n    for (const { tablename } of tables.rows) {\n      console.log(`\\n📦 Migrating table: ${tablename}`);\n      \n      // Get all data from source\n      const data = await sourceClient.query(`SELECT * FROM \"${tablename}\"`);\n      console.log(`  Found ${data.rows.length} rows`);\n      \n      if (data.rows.length > 0) {\n        // Get column names\n        const columns = Object.keys(data.rows[0]);\n        \n        // Insert into target\n        for (const row of data.rows) {\n          const values = columns.map(col => row[col]);\n          const placeholders = columns.map((_, i) => `$${i + 1}`).join(', ');\n          const columnNames = columns.map(c => `\"${c}\"`).join(', ');\n          \n          await targetClient.query(\n            `INSERT INTO \"${tablename}\" (${columnNames}) VALUES (${placeholders}) ON CONFLICT DO NOTHING`,\n            values\n          );\n        }\n        console.log(`  ✓ Migrated ${data.rows.length} rows`);\n      }\n    }\n    \n    console.log('\\n✅ Migration completed successfully!');\n  } catch (error) {\n    console.error('❌ Migration error:', error);\n  } finally {\n    await sourceClient.end();\n    await targetClient.end();\n  }\n}\n\nmigrate();\n","path":null,"size_bytes":2138,"size_tokens":null},"scripts/report-strategic-absences.ts":{"content":"import { db } from \"../server/db\";\nimport { attendanceEntries, users } from \"../shared/schema\";\nimport { eq, and, ne } from \"drizzle-orm\";\nimport * as fs from \"fs\";\n\n// Helper functions for strategic absences detection (same logic as server/storage.ts)\nconst holidaysCache = new Map<number, Set<string>>();\n\nfunction getItalianHolidays(year: number): Set<string> {\n  if (holidaysCache.has(year)) {\n    return holidaysCache.get(year)!;\n  }\n  \n  const holidays = new Set<string>();\n  \n  // Fixed Italian national holidays\n  holidays.add(`${year}-01-01`); // Capodanno\n  holidays.add(`${year}-01-06`); // Epifania\n  holidays.add(`${year}-04-25`); // Liberazione\n  holidays.add(`${year}-05-01`); // Festa del Lavoro\n  holidays.add(`${year}-06-02`); // Festa della Repubblica\n  holidays.add(`${year}-08-15`); // Ferragosto\n  holidays.add(`${year}-11-01`); // Ognissanti\n  holidays.add(`${year}-12-08`); // Immacolata\n  holidays.add(`${year}-12-25`); // Natale\n  holidays.add(`${year}-12-26`); // Santo Stefano\n  \n  // Easter and Easter Monday (calculated)\n  const easter = calculateEaster(year);\n  const easterMonday = new Date(easter);\n  easterMonday.setDate(easterMonday.getDate() + 1);\n  holidays.add(formatDateToString(easter));\n  holidays.add(formatDateToString(easterMonday));\n  \n  holidaysCache.set(year, holidays);\n  return holidays;\n}\n\nfunction formatDateToString(date: Date): string {\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  return `${year}-${month}-${day}`;\n}\n\nfunction calculateEaster(year: number): Date {\n  const a = year % 19;\n  const b = Math.floor(year / 100);\n  const c = year % 100;\n  const d = Math.floor(b / 4);\n  const e = b % 4;\n  const f = Math.floor((b + 8) / 25);\n  const g = Math.floor((b - f + 1) / 3);\n  const h = (19 * a + b - d - g + 15) % 30;\n  const i = Math.floor(c / 4);\n  const k = c % 4;\n  const l = (32 + 2 * e + 2 * i - h - k) % 7;\n  const m = Math.floor((a + 11 * h + 22 * l) / 451);\n  const month = Math.floor((h + l - 7 * m + 114) / 31);\n  const day = ((h + l - 7 * m + 114) % 31) + 1;\n  return new Date(year, month - 1, day);\n}\n\nfunction getAllHolidaysForDateRange(dateStr: string): Set<string> {\n  const date = new Date(dateStr + 'T12:00:00');\n  const year = date.getFullYear();\n  const allHolidays = new Set<string>();\n  \n  [year - 1, year, year + 1].forEach(y => {\n    getItalianHolidays(y).forEach(h => allHolidays.add(h));\n  });\n  \n  return allHolidays;\n}\n\nfunction isNonWorkingDay(date: Date, holidays: Set<string>): boolean {\n  const dayOfWeek = date.getDay();\n  if (dayOfWeek === 0 || dayOfWeek === 6) return true;\n  const dateStr = formatDateToString(date);\n  return holidays.has(dateStr);\n}\n\nfunction getAdjacentInfo(dateStr: string): { isStrategic: boolean; reason: string } {\n  const date = new Date(dateStr + 'T12:00:00');\n  const holidays = getAllHolidaysForDateRange(dateStr);\n  \n  const dayBefore = new Date(date);\n  dayBefore.setDate(dayBefore.getDate() - 1);\n  const dayBeforeStr = formatDateToString(dayBefore);\n  const beforeDayOfWeek = dayBefore.getDay();\n  const beforeIsWeekend = beforeDayOfWeek === 0 || beforeDayOfWeek === 6;\n  const beforeIsHoliday = holidays.has(dayBeforeStr);\n  \n  const dayAfter = new Date(date);\n  dayAfter.setDate(dayAfter.getDate() + 1);\n  const dayAfterStr = formatDateToString(dayAfter);\n  const afterDayOfWeek = dayAfter.getDay();\n  const afterIsWeekend = afterDayOfWeek === 0 || afterDayOfWeek === 6;\n  const afterIsHoliday = holidays.has(dayAfterStr);\n  \n  const reasons: string[] = [];\n  \n  if (beforeIsWeekend) {\n    reasons.push(`giorno prima (${dayBeforeStr}) è weekend`);\n  } else if (beforeIsHoliday) {\n    reasons.push(`giorno prima (${dayBeforeStr}) è festività`);\n  }\n  \n  if (afterIsWeekend) {\n    reasons.push(`giorno dopo (${dayAfterStr}) è weekend`);\n  } else if (afterIsHoliday) {\n    reasons.push(`giorno dopo (${dayAfterStr}) è festività`);\n  }\n  \n  return {\n    isStrategic: reasons.length > 0,\n    reason: reasons.join('; ')\n  };\n}\n\nconst dayNames = ['Domenica', 'Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato'];\n\nconst absenceTypeNames: Record<string, string> = {\n  'A': 'Assenza',\n  'P': 'Permesso',\n  'M': 'Malattia',\n  'CP': 'Cassa Integrazione/Permesso',\n  'L104': 'Legge 104',\n  'F': 'Ferie'\n};\n\nasync function generateReport() {\n  console.log('Caricamento assenze dal database...');\n  \n  // Get all attendance entries that are absences (not 'F' = Ferie)\n  const allEntries = await db\n    .select({\n      id: attendanceEntries.id,\n      userId: attendanceEntries.userId,\n      date: attendanceEntries.date,\n      absenceType: attendanceEntries.absenceType,\n      userFullName: users.fullName\n    })\n    .from(attendanceEntries)\n    .innerJoin(users, eq(attendanceEntries.userId, users.id))\n    .where(\n      ne(attendanceEntries.absenceType, 'F')  // Exclude Ferie\n    );\n  \n  console.log(`Trovate ${allEntries.length} assenze (escluse Ferie e Presenze)`);\n  \n  const strategicAbsences: Array<{\n    date: string;\n    dayOfWeek: string;\n    employee: string;\n    type: string;\n    typeName: string;\n    reason: string;\n  }> = [];\n  \n  for (const entry of allEntries) {\n    const info = getAdjacentInfo(entry.date);\n    if (info.isStrategic) {\n      const date = new Date(entry.date + 'T12:00:00');\n      strategicAbsences.push({\n        date: entry.date,\n        dayOfWeek: dayNames[date.getDay()],\n        employee: entry.userFullName,\n        type: entry.absenceType,\n        typeName: absenceTypeNames[entry.absenceType] || entry.absenceType,\n        reason: info.reason\n      });\n    }\n  }\n  \n  // Sort by date descending\n  strategicAbsences.sort((a, b) => b.date.localeCompare(a.date));\n  \n  console.log(`Trovate ${strategicAbsences.length} assenze strategiche`);\n  \n  // Generate report\n  const lines: string[] = [];\n  lines.push('='.repeat(80));\n  lines.push('REPORT ASSENZE STRATEGICHE');\n  lines.push('Assenze (escluse Ferie) registrate il giorno prima o dopo weekend/festività');\n  lines.push('='.repeat(80));\n  lines.push(`Generato il: ${new Date().toLocaleString('it-IT')}`);\n  lines.push(`Totale assenze strategiche: ${strategicAbsences.length}`);\n  lines.push('');\n  lines.push('-'.repeat(80));\n  lines.push('');\n  \n  // Group by employee\n  const byEmployee = new Map<string, typeof strategicAbsences>();\n  for (const absence of strategicAbsences) {\n    if (!byEmployee.has(absence.employee)) {\n      byEmployee.set(absence.employee, []);\n    }\n    byEmployee.get(absence.employee)!.push(absence);\n  }\n  \n  // Sort employees by count descending\n  const sortedEmployees = [...byEmployee.entries()].sort((a, b) => b[1].length - a[1].length);\n  \n  lines.push('RIEPILOGO PER DIPENDENTE:');\n  lines.push('');\n  for (const [employee, absences] of sortedEmployees) {\n    lines.push(`  ${employee}: ${absences.length} assenze strategiche`);\n  }\n  lines.push('');\n  lines.push('-'.repeat(80));\n  lines.push('');\n  lines.push('DETTAGLIO ASSENZE STRATEGICHE:');\n  lines.push('');\n  \n  for (const [employee, absences] of sortedEmployees) {\n    lines.push(`\\n${employee} (${absences.length} assenze):`);\n    lines.push('-'.repeat(40));\n    for (const absence of absences) {\n      const dateFormatted = absence.date.split('-').reverse().join('/');\n      lines.push(`  ${dateFormatted} (${absence.dayOfWeek}) - ${absence.typeName}`);\n      lines.push(`    Motivo: ${absence.reason}`);\n    }\n  }\n  \n  lines.push('');\n  lines.push('='.repeat(80));\n  lines.push('LEGENDA TIPI ASSENZA:');\n  lines.push('  A  = Assenza');\n  lines.push('  P  = Permesso');\n  lines.push('  M  = Malattia');\n  lines.push('  CP = Cassa Integrazione/Permesso');\n  lines.push('  L104 = Legge 104');\n  lines.push('='.repeat(80));\n  \n  const reportContent = lines.join('\\n');\n  const filename = `report_assenze_strategiche_${new Date().toISOString().split('T')[0]}.txt`;\n  \n  fs.writeFileSync(filename, reportContent, 'utf-8');\n  console.log(`\\nReport salvato in: ${filename}`);\n  console.log('\\n' + reportContent);\n}\n\ngenerateReport()\n  .then(() => process.exit(0))\n  .catch((err) => {\n    console.error('Errore:', err);\n    process.exit(1);\n  });\n","path":null,"size_bytes":8176,"size_tokens":null}},"version":2}